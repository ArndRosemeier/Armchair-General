var Me=Object.defineProperty;var Ae=(k,e,n)=>e in k?Me(k,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):k[e]=n;var b=(k,e,n)=>Ae(k,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const ke="modulepreload",Se=function(k){return"/Armchair-General/"+k},me={},V=function(e,n,t){let o=Promise.resolve();if(n&&n.length>0){let s=function(c){return Promise.all(c.map(a=>Promise.resolve(a).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),d=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=s(n.map(c=>{if(c=Se(c),c in me)return;me[c]=!0;const a=c.endsWith(".css"),l=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${l}`))return;const h=document.createElement("link");if(h.rel=a?"stylesheet":ke,a||(h.as="script"),h.crossOrigin="",h.href=c,d&&h.setAttribute("nonce",d),document.head.appendChild(h),a)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return o.then(s=>{for(const i of s||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})};class Ie{constructor(e=[]){b(this,"countries");this.countries=e}}const we=Math.sqrt(3),Te=.5*(we-1),Q=(3-we)/6,ye=k=>Math.floor(k)|0,pe=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function ie(k=Math.random){const e=Ee(k),n=new Float64Array(e).map(o=>pe[o%12*2]),t=new Float64Array(e).map(o=>pe[o%12*2+1]);return function(r,s){let i=0,d=0,c=0;const a=(r+s)*Te,l=ye(r+a),h=ye(s+a),f=(l+h)*Q,g=l-f,m=h-f,C=r-g,y=s-m;let w,u;C>y?(w=1,u=0):(w=0,u=1);const p=C-w+Q,x=y-u+Q,M=C-1+2*Q,v=y-1+2*Q,I=l&255,S=h&255;let A=.5-C*C-y*y;if(A>=0){const N=I+e[S],O=n[N],B=t[N];A*=A,i=A*A*(O*C+B*y)}let T=.5-p*p-x*x;if(T>=0){const N=I+w+e[S+u],O=n[N],B=t[N];T*=T,d=T*T*(O*p+B*x)}let P=.5-M*M-v*v;if(P>=0){const N=I+1+e[S+1],O=n[N],B=t[N];P*=P,c=P*P*(O*M+B*v)}return 70*(i+d+c)}}function Ee(k){const n=new Uint8Array(512);for(let t=0;t<512/2;t++)n[t]=t;for(let t=0;t<512/2-1;t++){const o=t+~~(k()*(256-t)),r=n[t];n[t]=n[o],n[o]=r}for(let t=256;t<512;t++)n[t]=n[t-256];return n}function Pe(k,e,n,t=1e3){var c;const o=k.length,r=((c=k[0])==null?void 0:c.length)||0,s=Array.from({length:o},()=>Array(r).fill(!1)),i=[[1,0],[-1,0],[0,1],[0,-1]],d=k.map(a=>a.slice());for(let a=0;a<o;a++)for(let l=0;l<r;l++)if(!s[a][l]&&k[a][l]===n){const h=[[a,l]],f=[[a,l]];for(s[a][l]=!0;h.length;){const[g,m]=h.shift();for(const[C,y]of i){const w=g+C,u=m+y;w>=0&&w<o&&u>=0&&u<r&&!s[w][u]&&k[w][u]===n&&(s[w][u]=!0,h.push([w,u]),f.push([w,u]))}}if(f.length<t)for(const[g,m]of f)d[g][m]=e}return d}function Ne(k,e,n){var c;const t=k.length,o=((c=k[0])==null?void 0:c.length)||0,r=Array.from({length:t},()=>Array(o).fill(!1)),s=[];for(let a=0;a<o;a++)k[0][a]===e&&(s.push([0,a]),r[0][a]=!0),k[t-1][a]===e&&(s.push([t-1,a]),r[t-1][a]=!0);for(let a=1;a<t-1;a++)k[a][0]===e&&(s.push([a,0]),r[a][0]=!0),k[a][o-1]===e&&(s.push([a,o-1]),r[a][o-1]=!0);const i=[[1,0],[-1,0],[0,1],[0,-1]];for(;s.length;){const[a,l]=s.shift();for(const[h,f]of i){const g=a+h,m=l+f;g>=0&&g<t&&m>=0&&m<o&&!r[g][m]&&k[g][m]===e&&(r[g][m]=!0,s.push([g,m]))}}return k.map((a,l)=>a.map((h,f)=>h===e&&!r[l][f]?n:h))}function Oe(k,e){return Ce(k,e,{scale:.0018,threshold:-.05,borderStrength:.5,borderWidth:.15,octaves:6,persistence:.5,seed:Math.floor(Math.random()*1e9)})}function Ce(k,e,n){const t=(n==null?void 0:n.scale)??.015,o=(n==null?void 0:n.threshold)??0,r=(n==null?void 0:n.seed)!==void 0?Re(n.seed):Math.random,s=ie(r),i=(n==null?void 0:n.borderStrength)??.5,d=(n==null?void 0:n.borderWidth)??.2,c=(n==null?void 0:n.octaves)??4,a=(n==null?void 0:n.persistence)??.5,l=[];for(let f=0;f<e;f++){const g=[];for(let m=0;m<k;m++){const C=m-k/2,y=f-e/2;let w=0,u=0,p=1,x=1;for(let A=0;A<c;A++)w+=s(C*t*p,y*t*p)*x,u+=x,x*=a,p*=2;w/=u;const M=Math.min(m,k-1-m)/(k/2),v=Math.min(f,e-1-f)/(e/2),I=Math.min(M,v);let S=w;if(I<d){const A=i*(1-I/d);S=w*(1-A)+D*A}g.push(S>o?H:D)}l.push(g)}let h=Ne(l,D,H);return h=Pe(h,D,H,1e3),h}function Re(k){return function(){let e=k+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class ae{constructor(e,n=null,t=0,o=0){b(this,"name");b(this,"owner");b(this,"armies");b(this,"income");b(this,"coordinates");b(this,"border");b(this,"oceanBorder");b(this,"neighbors");b(this,"color");b(this,"fortified",!1);b(this,"nationalPride");b(this,"unrestLevel",0);b(this,"_center",null);this.name=e,this.owner=n,this.armies=t,this.income=o,this.coordinates=[],this.border=[],this.oceanBorder=[],this.neighbors=[],this.color=[Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150)];const r=1e3,s=1e5,i=Math.random()*Math.random();this.nationalPride=Math.floor(r+(s-r)*i),this.unrestLevel=0}setOwner(e){this.owner=e}setArmies(e){this.armies=e}center(){if(this._center)return this._center;if(!this.coordinates.length)return this._center=[0,0],this._center;let e=0,n=0;for(const[t,o]of this.coordinates)e+=t,n+=o;return this._center=[e/this.coordinates.length,n/this.coordinates.length],this._center}canBeFortified(){if(this.fortified)return!1;if(this.owner){for(const[e,n]of this.owner.plannedFortifications)if(e===this)return!1}return!0}toJSON(){return{id:this.name,name:this.name,ownerId:this.owner?this.owner.name:null,armies:this.armies,income:this.income,coordinates:this.coordinates,border:this.border,oceanBorder:this.oceanBorder,neighborIds:this.neighbors.map(e=>e.name),color:this.color,fortified:this.fortified,nationalPride:this.nationalPride,unrestLevel:this.unrestLevel}}static fromJSON(e,n,t){const o=new ae(e.name,null,e.armies,e.income);return o.coordinates=e.coordinates,o.border=e.border,o.oceanBorder=e.oceanBorder,o.color=e.color,o.fortified=e.fortified,o.nationalPride=e.nationalPride??1e3,o.unrestLevel=e.unrestLevel??0,o._ownerId=e.ownerId,o._neighborIds=e.neighborIds,t[e.name]=o,o}resolveReferences(e,n){this.owner=this._ownerId?e[this._ownerId]:null,this.neighbors=(this._neighborIds||[]).map(t=>n[t]).filter(Boolean),delete this._ownerId,delete this._neighborIds}}class Be{static generateCountriesMap(e,n={}){if(!e||e.length===0||!e[0])throw new Error("continentMap must be a non-empty 2D array");const t=e.length,o=e[0].length,r=n.countryCount??12,s=n.scale??.09,i=n.minResistance??10,d=n.maxResistance??50,c=n.skipProbability??.9,a=n.seed!==void 0?Ge(n.seed):Math.random,l=ie(a),h=[];for(let u=0;u<t;u++){const p=[];for(let x=0;x<o;x++)p.push(e[u][x]===H?i+(d-i)*Math.abs(l(x*s,u*s)):1/0);h.push(p)}const f=[],g=[];for(let u=0;u<t;u++)for(let p=0;p<o;p++)e[u][p]===H&&g.push([p,u]);for(let u=0;u<r&&g.length>0;u++){const p=Math.floor(a()*g.length),[x,M]=g.splice(p,1)[0];f.push({x,y:M,idx:u})}for(let u=0;u<t;u++)for(let p=0;p<o;p++)e[u][p]!==D&&(e[u][p]=H);for(const{x:u,y:p,idx:x}of f)e[p][u]=x;const m=f.map(({x:u,y:p,idx:x})=>[u,p,x]),C=(i+d)/2;for(;m.length>0;){const u=Math.floor(a()*m.length),[p,x,M]=m.splice(u,1)[0],v=[];for(const[I,S]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=p+I,T=x+S;A>=0&&A<o&&T>=0&&T<t&&e[T][A]===H&&v.push([A,T])}if(v.length!==0)for(const[I,S]of v)h[S][I]>C&&a()<c||(e[S][I]=M,m.push([I,S,M]))}const y=Array.from({length:t},()=>Array(o).fill(!1));let w=0;for(let u=0;u<t;u++)for(let p=0;p<o;p++)e[u][p]>=0&&e[u][p]+1>w&&(w=e[u][p]+1);for(let u=0;u<t;u++)for(let p=0;p<o;p++)if(e[u][p]===H&&!y[u][p]){const x=[[p,u]];for(y[u][p]=!0;x.length>0;){const[M,v]=x.pop();e[v][M]=w;for(const[I,S]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=M+I,T=v+S;A>=0&&A<o&&T>=0&&T<t&&e[T][A]===H&&!y[T][A]&&(x.push([A,T]),y[T][A]=!0)}}w++}return e}static generateCountriesInternal(e,n){const t=this.generateCountriesMap(e,n);if(!t||t.length===0||!t[0])throw new Error("map must be a non-empty 2D array");const o=t.length,r=t[0].length,s={};for(let c=0;c<o;c++)for(let a=0;a<r;a++){const l=t[c][a];if(l>=0){if(!s[l]){const h=new ae(`Country ${l}`);h.id=l,s[l]=h}s[l].coordinates.push([a,c])}}const i=Math.max(...Object.keys(s).map(Number)),d=Array.from({length:i+1},(c,a)=>s[a]);return this.findCountryBorders(t,d,r,o),{map:t,countries:d}}static findCountryBorders(e,n,t,o){const r=[[1,0],[0,1],[-1,0],[0,-1]];for(const s of n){const i=s.id;s.border=[],s.oceanBorder=[];for(const[d,c]of s.coordinates){let a=!1,l=!1;for(const[h,f]of r){const g=d+h,m=c+f;(g<0||g>=t||m<0||m>=o||e[m][g]!==i)&&(a=!0,(g<0||g>=t||m<0||m>=o||e[m][g]===D)&&(l=!0))}a&&s.border.push([d,c]),l&&s.oceanBorder.push([d,c])}}}static findNeighbors(e){const n=new Map;for(const t of e)for(const[o,r]of t.border)n.set(`${o},${r}`,t);for(const t of e){const o=new Set;for(const[r,s]of t.border)for(const[i,d]of[[1,0],[0,1],[-1,0],[0,-1]]){const c=r+i,a=s+d,l=n.get(`${c},${a}`);l&&l!==t&&o.add(l)}t.neighbors=Array.from(o)}}static mergeSmallCountries(e,n=1e3,t){let o=!0;for(;o;){o=!1;for(let r=e.length-1;r>=0;r--){const s=e[r];if(s.coordinates.length<n&&s.neighbors.length>0){let i=s.neighbors[0];for(const d of s.neighbors)d.coordinates.length<i.coordinates.length&&(i=d);if(i.coordinates.push(...s.coordinates),t&&i.id!==void 0&&s.id!==void 0)for(const[d,c]of s.coordinates)t[c][d]=i.id;e.splice(r,1),o=!0}}o&&(this.findNeighbors(e),console.log("Merged countries"))}}static generateCountries(e,n={}){const{map:t,countries:o}=this.generateCountriesInternal(e,n);this.findNeighbors(o);const r=(n==null?void 0:n.minCountrySize)??1e3;if(this.mergeSmallCountries(o,r,t),!t||t.length===0||!t[0])throw new Error("map must be a non-empty 2D array");const s=t[0].length,i=t.length;return this.findCountryBorders(t,o,s,i),this.findNeighbors(o),{map:t,countries:o}}}function Ge(k){return function(){let e=k+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function Le(k,e){return Be.generateCountries(k,{countryCount:e,minResistance:0,maxResistance:130,skipProbability:0})}const D=-1,H=-2,j=class j{constructor(e,n,t=[]){b(this,"countries");b(this,"map");b(this,"continents",[]);this.countries=t,this.map=j.createOceanMap(e,n)}static logCountryNamesInOrder(e,n=""){const t=e.map((o,r)=>`${r}: ${o.name}`);console.log(`[WorldMap] Country order${n?" - "+n:""}:
`+t.join(", "))}static checkMapCountryConsistency(e,n){if(!Array.isArray(e)||!Array.isArray(n))return console.error("[WorldMap] Consistency check failed: map or countries not arrays"),!1;let t=!0;for(let o=0;o<e.length;++o)for(let r=0;r<e[o].length;++r){const s=e[o][r];s>=0&&(n[s]?typeof n[s].name!="string"&&(console.error(`[WorldMap] Inconsistent: countries[${s}] has no valid name at map[${o}][${r}]`),t=!1):(console.error(`[WorldMap] Inconsistent: map[${o}][${r}] = ${s}, but countries[${s}] is undefined`),t=!1))}return t}assignRandomCountryNames(){let e=!1;for(;!e;){const n=new Set;for(const t of this.countries){let o,r=0;do if(o=j.generateRandomName(),r++,r>1e3)throw new Error("Failed to generate unique random country names");while(n.has(o));t.name=o,n.add(o)}e=n.size===this.countries.length}}assignRealCountryNames(){let e=!1;for(;!e;){const n=[...j.REAL_COUNTRY_NAMES],t=new Set;for(const o of this.countries){let r;if(n.length>0){const s=Math.floor(Math.random()*n.length);r=n.splice(s,1)[0]}else{let s=0;do if(r=j.generateRandomName(),s++,s>1e3)throw new Error("Failed to generate unique fallback country names");while(t.has(r))}o.name=r,t.add(r)}e=t.size===this.countries.length}}static generateRandomName(){const e=["zan","mor","vek","tal","rin","dor","lek","sha","val","nor","ka","bel","dra","sil","tur","gar","fen","mir","sol","vor","lin","sar","qu","zel","ron","bar","zen","tir","lom","kal","vin","lor","mel","dar","gol","han","jor","ken","lun","mar"],n=2+Math.floor(Math.random()*2);let t="";for(let o=0;o<n;o++)t+=e[Math.floor(Math.random()*e.length)];return t.charAt(0).toUpperCase()+t.slice(1)}static createOceanMap(e,n){return Array.from({length:n},()=>Array(e).fill(D))}static generateContinentsMap(e,n,t){return Ce(e,n,t)}static createMap(e,n,t=40,o=!0){const r=Oe(e,n),{map:s,countries:i}=Le(r,t),d=new j(e,n,i);return d.map=s,o?d.assignRealCountryNames():d.assignRandomCountryNames(),d.regenerateMapFromCountries(d.countries),d.createContinents(),d}addCountry(e){this.countries.push(e)}createContinents(){const e=new Set,n=[];for(const t of this.countries)if(!e.has(t)){const o=[t],r=[];for(e.add(t);o.length>0;){const s=o.shift();r.push(s);for(const i of s.neighbors)e.has(i)||(e.add(i),o.push(i))}n.push(new Ie(r))}this.continents=n}getCountries(){return this.countries}distance(e,n){const[t,o]=e.center(),[r,s]=n.center(),i=Math.sqrt((t-r)**2+(o-s)**2);if(e.neighbors.includes(n)||n.neighbors.includes(e))return i;const d=e.oceanBorder&&e.oceanBorder.length>0,c=n.oceanBorder&&n.oceanBorder.length>0;return d&&c?i*3:null}getMap(){return this.map}regenerateMapFromCountries(e){if(!this.map||!Array.isArray(this.map)||this.map.length===0||this.map[0].length===0)throw new Error("WorldMap.map is not initialized or has invalid dimensions");const n=this.map.length,t=this.map[0].length,o=j.createOceanMap(t,n);for(let r=0;r<e.length;++r){const s=e[r];if(!s.coordinates||!Array.isArray(s.coordinates))throw new Error(`Country at index ${r} has no valid coordinates array`);for(const[i,d]of s.coordinates){if(typeof i!="number"||typeof d!="number"||i<0||i>=t||d<0||d>=n)throw new Error(`Country index ${r} has out-of-bounds coordinate (${i}, ${d})`);o[d][i]=r}}this.map=o}};b(j,"REAL_COUNTRY_NAMES",["Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia"]);let ce=j;function $e(k){if(!k.length)throw new Error("No countries provided");let e=0,n=0;for(const s of k)for(const[i,d]of s.coordinates)i>e&&(e=i),d>n&&(n=d);const t=e+1,o=n+1,r=new ce(t,o,k);return r.regenerateMapFromCountries(k),r.createContinents(),r}const $=class ${static render(e,n=[],t=[],o=!1,r=null){var g;const s=e.getMap(),i=((g=e.getCountries)==null?void 0:g.call(e))||[],d=s.length,c=s[0].length,a=document.createElement("canvas");a.width=c,a.height=d;const l=a.getContext("2d");if(!l)throw new Error("Could not get canvas context");const h=l.createImageData(c,d),f=h.data;for(let m=0;m<d;m++)for(let C=0;C<c;C++){const y=s[m][C],[w,u,p]=$.getRGBForValue(y,i,C,m,s),x=(m*c+C)*4;f[x]=w,f[x+1]=u,f[x+2]=p,f[x+3]=255}if(n&&n.length>0){for(const m of n)if(!(!m||!m.coordinates)){for(const[C,y]of m.coordinates)if(C>=0&&C<c&&y>=0&&y<d){const w=(y*c+C)*4;f[w]=Math.min(255,Math.round(.6*255+.4*f[w])),f[w+1]=Math.min(255,Math.round(.6*255+.4*f[w+1])),f[w+2]=Math.round(.4*f[w+2]),f[w+3]=255}}}for(const m of i){const C=m.owner&&m.owner.homeCountry===m,y=C?[255,140,0]:[0,0,0];for(const[w,u]of m.border||[])if(C)for(let p=-1;p<=1;p++)for(let x=-1;x<=1;x++){const M=w+x,v=u+p;if(M>=0&&M<c&&v>=0&&v<d){const I=(v*c+M)*4;f[I]=y[0],f[I+1]=y[1],f[I+2]=y[2],f[I+3]=255}}else if(w>=0&&w<c&&u>=0&&u<d){const p=(u*c+w)*4;f[p]=y[0],f[p+1]=y[1],f[p+2]=y[2],f[p+3]=255}}l.putImageData(h,0,0),l.save(),l.font="bold 10px MedievalSharp, Verdana, serif",l.textAlign="center",l.textBaseline="middle";for(const m of i){if(!m.name)continue;const[C,y]=m.center?m.center():[0,0],w=m.fortified?"🛡️ "+m.name:m.name;l.lineWidth=3,l.strokeStyle="black",l.strokeText(w,C,y);const u=t.some(M=>M===m);m.unrestLevel>0?(l.font="italic bold 10px MedievalSharp, Verdana, serif",l.fillStyle="#FF0000",l.fillText(w,C,y)):(l.font="bold 10px MedievalSharp, Verdana, serif",l.fillStyle=u?"#90EE90":"white",l.fillText(w,C,y));let p=!1;(o||r&&m.owner===r&&!r.isAI||r&&typeof r.armyKnown=="function"&&r.armyKnown(m)&&!r.isAI)&&(p=!0);let x=13;if(p){const M=m.armies||0,v=`${Math.round(M/1e3)}k`;l.font="bold 9px MedievalSharp, Verdana, serif",l.lineWidth=2,l.strokeStyle="black",l.strokeText(v,C,y+x),l.fillStyle="#FFD700",l.fillText(v,C,y+x),l.font="bold 10px MedievalSharp, Verdana, serif",x+=13}m.unrestLevel>0&&(l.font="italic bold 8px MedievalSharp, Verdana, serif",l.strokeText("Rioting",C,y+x),l.fillStyle="#FF0000",l.fillText("Rioting",C,y+x))}return l.restore(),a}static displayWithPanZoom(e,n,t=512,o=512,r=[]){let s=null,i=$.render(e,[],r);const d=i.width,c=i.height,a=document.createElement("canvas");a.width=t,a.height=o,a.style.border="1px solid #888",n.appendChild(a);const l=a.getContext("2d");if(!l)throw new Error("Could not get canvas context");let h=Math.min(a.width/d,a.height/c),f=(a.width-d*h)/2,g=(a.height-c*h)/2,m=!1,C=0,y=0;function w(){i=$.render(e,s?[s]:[],r),l.setTransform(1,0,0,1,0,0),l.clearRect(0,0,a.width,a.height),l.setTransform(h,0,0,h,f,g),l.drawImage(i,0,0)}return a.addEventListener("mousedown",u=>{const p=a.getBoundingClientRect(),x=(u.clientX-p.left-f)/h,M=(u.clientY-p.top-g)/h,v=e.getMap(),I=e.getCountries(),S=Math.floor(x),A=Math.floor(M);let T=null;if(S>=0&&A>=0&&A<v.length&&S<v[0].length){const P=v[A][S];P>=0&&I[P]&&(T=I[P])}if(T){s=T,w();return}m=!0,C=u.clientX,y=u.clientY}),window.addEventListener("mousemove",u=>{if(!m)return;const p=u.clientX-C,x=u.clientY-y;f+=p,g+=x,C=u.clientX,y=u.clientY,w()}),window.addEventListener("mouseup",()=>{m=!1}),a.addEventListener("wheel",u=>{u.preventDefault();const p=u.offsetX,x=u.offsetY,M=Math.exp(-u.deltaY*.001);f=p-(p-f)*M,g=x-(x-g)*M,h*=M,w()}),w(),a}static getRGBForValue(e,n,t,o,r){var s,i,d;if(e===D){t=t??0,o=o??0,r=r??[];const c=((s=r[0])==null?void 0:s.length)||1024,a=r.length||768,l=o/a;let h=Math.round(30*(1-l)+10*l),f=Math.round(144*(1-l)+80*l),g=Math.round(255*(1-l)+180*l);const m=$._oceanNoise2D(t*.03,o*.03),C=Math.floor(18*m);h+=C,f+=C,g+=C;let y=!1;if(r&&t>0&&o>0&&t<c-1&&o<a-1)for(const[w,u]of[[1,0],[-1,0],[0,1],[0,-1]]){const p=t+w,x=o+u;if(r[x][p]!==D){y=!0;break}}return y&&(h=Math.min(255,h+40),f=Math.min(255,f+40),g=Math.min(255,g+40)),[h,f,g]}if(e===H){t=t??0,o=o??0,r=r??[];const c=((i=r[0])==null?void 0:i.length)||1024,a=r.length||768,l=$._landNoise2D(t*.04,o*.04),h=[34,139,34],f=[80,180,80],g=.5+.5*l;let m=Math.round(h[0]*(1-g)+f[0]*g),C=Math.round(h[1]*(1-g)+f[1]*g),y=Math.round(h[2]*(1-g)+f[2]*g),w=!1;if(r&&t>0&&o>0&&t<c-1&&o<a-1)for(const[u,p]of[[1,0],[-1,0],[0,1],[0,-1]]){const x=t+u,M=o+p;if(r[M][x]===D){w=!0;break}}return w&&(m=Math.min(255,m+30),C=Math.min(255,C+30),y=Math.min(255,y+30)),[m,C,y]}if(e>=0){const c=n[e];let a=[200,200,200];if(c)if(c.owner&&typeof c.owner.RGBColor=="string"){const I=c.owner.RGBColor.split(",").map(Number);I.length===3&&I.every(S=>!isNaN(S))&&(a=[I[0],I[1],I[2]])}else c.color&&(a=c.color);t=t??0,o=o??0,r=r??[];const l=((d=r[0])==null?void 0:d.length)||1024,h=r.length||768,f=$._landNoise2D(t*.02,o*.02),g=Math.round(18*f),m=a,C=[Math.max(0,a[0]-32),Math.max(0,a[1]-48),Math.max(0,a[2]-32)],y=.5+.5*f;let w=Math.round(m[0]*(1-y)+C[0]*y)+g,u=Math.round(m[1]*(1-y)+C[1]*y)+g,p=Math.round(m[2]*(1-y)+C[2]*y)+g;const x=$._landNoise2D(t*.006+100,o*.006+100),M=Math.round(18*x);w=Math.min(255,Math.max(0,w+M)),u=Math.min(255,Math.max(0,u+M)),p=Math.min(255,Math.max(0,p+M));let v=!1;if(r&&t>0&&o>0&&t<l-1&&o<h-1)for(const[I,S]of[[1,0],[-1,0],[0,1],[0,-1]]){const A=t+I,T=o+S;if(r[T][A]===D){v=!0;break}}return v&&(w=Math.min(255,w+12),u=Math.min(255,u+12),p=Math.min(255,p+12)),[w,u,p]}return[255,255,255]}static drawCountryGlow(e,n,t,o){function r(i,d,c){return[Math.round(i[0]+(d[0]-i[0])*c),Math.round(i[1]+(d[1]-i[1])*c),Math.round(i[2]+(d[2]-i[2])*c)]}let s=new Set(n.coordinates.map(([i,d])=>`${i},${d}`));for(let i=0;i<10;++i){const d=[];for(const l of s){const[h,f]=l.split(",").map(Number),g=[[h-1,f],[h+1,f],[h,f-1],[h,f+1]];for(const[m,C]of g)if(!s.has(`${m},${C}`)){d.push([h,f]);break}}const c=i/9,a=r(t,o,c);e.save(),e.fillStyle=`rgb(${a[0]},${a[1]},${a[2]})`;for(const[l,h]of d)e.fillRect(l,h,1,1);e.restore();for(const[l,h]of d)s.delete(`${l},${h}`);if(s.size===0)break}e.save();for(const i of s){const[d,c]=i.split(",").map(Number);let a=[200,200,200];if(n)if(n.owner&&typeof n.owner.RGBColor=="string"){const x=n.owner.RGBColor.split(",").map(Number);x.length===3&&x.every(M=>!isNaN(M))&&(a=[x[0],x[1],x[2]])}else n.color&&(a=n.color);const l=$._landNoise2D(d*.02,c*.02),h=Math.round(18*l),f=a,g=[Math.max(0,a[0]-32),Math.max(0,a[1]-48),Math.max(0,a[2]-32)],m=.5+.5*l;let C=Math.round(f[0]*(1-m)+g[0]*m)+h,y=Math.round(f[1]*(1-m)+g[1]*m)+h,w=Math.round(f[2]*(1-m)+g[2]*m)+h;const u=$._landNoise2D(d*.006+100,c*.006+100),p=Math.round(18*u);C=Math.min(255,Math.max(0,C+p)),y=Math.min(255,Math.max(0,y+p)),w=Math.min(255,Math.max(0,w+p)),e.fillStyle=`rgb(${C},${y},${w})`,e.fillRect(d,c,1,1)}e.restore()}};b($,"drawBorders",!0),b($,"_oceanNoise2D",ie()),b($,"_landNoise2D",ie());let ee=$;class J{RequiresAmount(e,n,t){return null}}class F{constructor(e,n,t,o,r=null){b(this,"countries");b(this,"amount");b(this,"action");b(this,"score");b(this,"followUp");this.countries=e,this.amount=n,this.action=t,this.score=o,this.followUp=r}}class Fe{constructor(e,n,t){b(this,"canvas");b(this,"ctx");b(this,"start");b(this,"end");this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Could not get canvas context");this.ctx=o,this.start=n,this.end=t}draw(){const e=this.ctx,{start:n,end:t}=this,o=(n.x+t.x)/2,r=(n.y+t.y)/2,s=t.x-n.x,i=t.y-n.y,d=Math.sqrt(s*s+i*i),c=.25*d,a=-i/d*c,l=s/d*c,h=o+a,f=r+l,g=e.createLinearGradient(n.x,n.y,t.x,t.y);g.addColorStop(0,"#fff"),g.addColorStop(.5,"#0ff"),g.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=12,e.strokeStyle=g,e.beginPath(),e.moveTo(n.x,n.y),e.quadraticCurveTo(h,f,t.x,t.y),e.stroke();const m=.95,C=this.getQuadraticPoint(n,{x:h,y:f},t,m),y=this.getQuadraticTangent(n,{x:h,y:f},t,m);this.drawArrowhead(C,y),e.restore()}getQuadraticPoint(e,n,t,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*n.x+o*o*t.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*n.y+o*o*t.y;return{x:r,y:s}}getQuadraticTangent(e,n,t,o){const r=2*(1-o)*(n.x-e.x)+2*o*(t.x-n.x),s=2*(1-o)*(n.y-e.y)+2*o*(t.y-n.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,n){const t=this.ctx;t.save(),t.translate(e.x,e.y);const o=Math.atan2(n.y,n.x);t.rotate(o),t.beginPath(),t.moveTo(0,0),t.lineTo(-18,7),t.lineTo(-12,0),t.lineTo(-18,-7),t.closePath(),t.fillStyle="rgba(0,255,255,0.95)",t.shadowColor="#fff",t.shadowBlur=8,t.fill(),t.restore()}}class De{constructor(e,n,t){b(this,"canvas");b(this,"attacker");b(this,"defender");this.canvas=e,this.attacker=n,this.defender=t}async start(){const e=this.canvas.getContext("2d");if(!e)return;const[n,t]=this.attacker.center(),[o,r]=this.defender.center(),s={x:n,y:t},i={x:o,y:r};new Fe(this.canvas,s,i);const d=500,c=this.attacker,a=this.defender;return new Promise(l=>{const h=f=>{const m=performance.now()-f,C=Math.min(m/d,1);e.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCountry(e,c,"attacker"),this.drawCountry(e,a,"defender"),this.drawAnimatedArrow(e,s,i,C),C<1?requestAnimationFrame(()=>h(f)):l()};requestAnimationFrame(f=>h(f))})}drawAnimatedArrow(e,n,t,o){const r=(n.x+t.x)/2,s=(n.y+t.y)/2,i=t.x-n.x,d=t.y-n.y,c=Math.sqrt(i*i+d*d),a=.25*c,l=-d/c*a,h=i/c*a,f=r+l,g=s+h,m=e.createLinearGradient(n.x,n.y,t.x,t.y);m.addColorStop(0,"#fff"),m.addColorStop(.5,"#0ff"),m.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=16,e.strokeStyle=m,e.beginPath(),e.moveTo(n.x,n.y);const C=60;for(let y=1;y<=Math.floor(C*o);++y){const w=y/C,u=this.getQuadraticPoint(n,{x:f,y:g},t,w);e.lineTo(u.x,u.y)}if(e.stroke(),o>.05){const y=o,w=this.getQuadraticPoint(n,{x:f,y:g},t,y),u=this.getQuadraticTangent(n,{x:f,y:g},t,y);this.drawArrowhead(e,w,u)}e.restore()}drawCountry(e,n,t){let o;t==="attacker"?o=[180,0,0]:t==="defender"?o=[0,0,180]:o=n.color||[200,200,200],ee.drawCountryGlow(e,n,o,n.color);const[r,s]=n.center?n.center():[0,0],i=n.fortified?"🛡️ "+n.name:n.name;if(e.save(),e.font="bold 10px Verdana, Geneva, sans-serif",e.textAlign="center",e.textBaseline="middle",e.lineWidth=3,e.strokeStyle="black",e.strokeText(i,r,s),e.fillStyle="white",e.fillText(i,r,s),typeof n.armies=="number"&&R.showArmies){const d=`${Math.round(n.armies/1e3)}k`;e.font="bold 9px Verdana, Geneva, sans-serif",e.lineWidth=2,e.strokeStyle="black",e.strokeText(d,r,s+13),e.fillStyle="#FFD700",e.fillText(d,r,s+13)}e.restore()}getQuadraticPoint(e,n,t,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*n.x+o*o*t.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*n.y+o*o*t.y;return{x:r,y:s}}getQuadraticTangent(e,n,t,o){const r=2*(1-o)*(n.x-e.x)+2*o*(t.x-n.x),s=2*(1-o)*(n.y-e.y)+2*o*(t.y-n.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,n,t){e.save(),e.translate(n.x,n.y);const o=Math.atan2(t.y,t.x);e.rotate(o),e.beginPath(),e.moveTo(0,0),e.lineTo(-18,7),e.lineTo(-12,0),e.lineTo(-18,-7),e.closePath(),e.fillStyle="rgba(0,255,255,0.95)",e.shadowColor="#fff",e.shadowBlur=8,e.fill(),e.restore()}}class z extends J{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];if(t.owner!==n||t===o)return null;const r=t.neighbors.includes(o),s=t.oceanBorder.length>0&&o.oceanBorder.length>0;return!r&&!s||o.owner===n?null:`Attack ${o.name} from ${t.name}`}async Act(e,n,t,o=0){var u,p;if(!t)throw new Error("Internal error: currentGame is required.");if(e.length<2)throw new Error("Select source and target countries to attack.");const r=e[e.length-2],s=e[e.length-1];if(r.owner!==n)throw new Error("You must own the attacking country.");const i=r.neighbors.includes(s),d=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!d)throw new Error("Target country must be a neighbor or reachable by naval attack.");if(s.owner===n)throw new Error("Cannot attack your own country.");if(o<=0||o>=r.armies)throw new Error("Invalid number of armies committed.");if(!n.game)throw new Error("ActionAttack: activePlayer.game is missing");if(!n.game.gui)throw new Error("ActionAttack: activePlayer.game.gui is missing");const a=n.game.gui.getWorldMapCanvas(),l=a.parentElement;if(!l)throw new Error("ActionAttack: mapCanvas.parentElement is null");l.style.position="relative";let h=document.getElementById("attack-animation-overlay");h&&((u=h.parentElement)==null||u.removeChild(h));let f=document.createElement("canvas");f.id="attack-animation-overlay",f.width=a.width,f.height=a.height,f.style.position="absolute",f.style.left="0",f.style.top="0",f.style.pointerEvents="none",f.style.zIndex="9999",f.style.width="100%",f.style.height="100%",f.style.background="rgba(255,255,255,0.01)",l.appendChild(f),new De(f,r,s).start(),await new Promise(x=>setTimeout(x,0)),await new Promise(x=>setTimeout(x,1e3)),(p=f==null?void 0:f.parentElement)==null||p.removeChild(f);const m=z.AttackChance(r.armies,s.armies,t.worldMap.distance(r,s)||0,s.fortified,t),C=Math.random(),y=Math.sqrt(Math.abs(C-m));let w="";if(r.armies-=o,C<m){const x=s.owner;x&&(x.ownedCountries=x.ownedCountries.filter(v=>v!==s),x.plannedFortifications=x.plannedFortifications.filter(([v,I])=>v!==s)),s.owner=n,n.ownedCountries.push(s);let M=Math.max(1,Math.round(o*Math.sqrt(y)));M>0&&(M=Math.max(1e3,Math.round(M/1e3)*1e3)),s.armies=M,s.fortified=!1,x&&x.ownedCountries.length===0&&t.players.includes(x)&&(t.players=t.players.filter(v=>v!==x),t.activePlayerIndex>=t.players.length&&(t.activePlayerIndex=0)),n.ownedCountries.length===0&&t.players.includes(n)&&(t.players=t.players.filter(v=>v!==n),t.activePlayerIndex>=t.players.length&&(t.activePlayerIndex=0));for(const v of t.players)v.knowledge=v.knowledge.filter(I=>I.country!==s);w=`Attack successful! ${M} of your ${o} armies occupy ${s.name}.`}else{let x=Math.round(s.armies*Math.sqrt(y));x>0&&(x=Math.max(1e3,Math.round(x/1e3)*1e3)),s.armies=Math.max(1,s.armies-x),s.armies>0&&(s.armies=Math.max(1e3,Math.round(s.armies/1e3)*1e3)),w=`Attack failed! All ${o} attacking armies lost. Defenders lost ${x} troops.`}return w}static AttackChance(e,n,t,o,r){return t===null?0:(n*=t/100,o&&(n*=2),e>=3*n?1:e<=n/3?0:e<n?.5*(e-n/3)/(n-n/3):.5+.5*(e-n)/(2*n))}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Attack"}ActionString(e,n,t,o=0){if(e.length<2)return"Attack: Not enough countries selected.";const r=e[e.length-2];return`Attacking ${e[e.length-1].name} from ${r.name} with ${o} soldiers`}}class re extends J{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];return!t||!o||t.owner!==n||o.owner!==n||t===o?null:`Move armies from ${t.name} to ${o.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to move armies.";const r=e[e.length-2],s=e[e.length-1];return r.owner!==n||s.owner!==n?"Both countries must be owned by you.":r===s?"Source and target countries must be different.":o<=0||o>=r.armies?"Invalid number of armies to move.":(r.armies-=o,s.armies+=o,`Moved ${o} armies from ${r.name} to ${s.name}.`)}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Move"}ActionString(e,n,t,o=0){if(e.length<2)return"Move: Not enough countries selected.";const r=e[e.length-2],s=e[e.length-1];return`Moving ${o} armies from ${r.name} to ${s.name}`}}class xe extends J{GetButtonText(e,n){if(e.length===0)return null;const t=e[e.length-1];return t.owner!==n||t.fortified?null:`Fortify ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length===0)return"Please select a country to fortify.";const r=e[e.length-1];return r.canBeFortified()?n.money<R.fortifyCost?`Not enough money to fortify. You need $${R.fortifyCost}.`:(n.money-=R.fortifyCost,n.plannedFortifications.push([r,t.gameTurn+2]),`Fortification planned for ${r.name} on turn ${t.gameTurn+2}.`):`${r.name} cannot be fortified.`}RequiresAmount(e,n,t){return null}get countryCountNeeded(){return 1}Type(){return"Fortify"}ActionString(e,n,t,o=0){return e.length<1?"Fortify: No country selected.":`Fortifying ${e[e.length-1].name}`}}class se extends J{GetButtonText(e,n){if(e.length<1)return null;const t=e[e.length-1];return!t||t.owner!==n?null:`Buy armies for ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<1)return"Select a friendly country to buy armies for.";const r=e[e.length-1];if(r.owner!==n)return"You must own the target country.";if(o<=0)return"Invalid number of armies to buy.";const s=o*R.armyCost;return n.money<s?`Not enough money. Need ${s.toLocaleString()}, have ${n.money.toLocaleString()}.`:(n.money-=s,r.armies+=o,`Bought ${o} armies for ${r.name} at a cost of ${s.toLocaleString()}.`)}RequiresAmount(e,n,t){const o=Math.floor(n.money/R.armyCost/1e3)*1e3;return o<1e3?null:[1e3,o]}get countryCountNeeded(){return 1}Type(){return"BuyArmies"}ActionString(e,n,t,o=0){if(e.length<1)return"Buy Armies: No country selected.";const r=e[e.length-1];return`Buying ${o} soldiers for ${r.name}`}}const q=class q{constructor(e,n){b(this,"player");b(this,"game");b(this,"actionPlan",[]);this.player=e,this.game=n}GetBestArmies(e){return!this.player.ownedCountries||this.player.ownedCountries.length===0?[]:this.player.ownedCountries.slice().sort((n,t)=>(t.armies||0)-(n.armies||0)).slice(0,e)}FindSpyOpportunities(){const e=new ve,n=[],t=this.getNonOwnedCountriesSortedByDistance(),s=this.game.worldMap.getCountries().filter(a=>a.owner&&a.owner!==this.player),i=Math.min(5,this.player.ownedCountries.length);let d=0;for(const a of s){const l=this.player.knowledge.find(h=>h.country===a);a.owner&&a.owner!==this.player?l&&this.game.gameTurn-l.gameTurn<=3&&d++:a.owner||l&&d++}let c=1;d<i&&(c=10);for(const{country:a,distance:l}of t){const h=this.player.knowledge.find(g=>g.country===a);if(!a.owner&&h||a.owner&&a.owner!==this.player&&h&&this.game.gameTurn-h.gameTurn<=3)continue;let f=3e3-Math.sqrt(l);if(f*=c,f>0){const g=a.fortified?R.spyFortifiedCost:R.spyCost;if(this.player.money>=g){const m=f*(this.player.totalIncome()/5e6);n.push(new F([a],0,e,m))}}}return n}FindAttackOpportunities(){const e=new z,t=this.game.worldMap.getCountries(),o=[];for(const r of t){if(r.owner===this.player)continue;const[s,i]=this.countryBestAttackerScore(r);if(!s)continue;const d=Math.floor(s.armies*q.ATTACK_COMMIT/1e3)*1e3;d<1e3||o.push(new F([s,r],d,e,i*this.player.aggressivity))}return o}async takeAction(){if(this.player.actionsLeft<=0)return!1;if(this.player.actionsLeft>=4&&Math.random()<.2&&this.actionPlan.length===0)return this.PlanSurpriseAttack(),!0;let e=null;if(this.actionPlan.length>0){e=this.actionPlan.shift();const o=e.action,r=e.countries,s=e.amount;if(o instanceof re){const i=r[0];if(!i||i.armies<s+1e3)return console.warn("Skipping invalid move from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof z){const i=r[0],d=r[1];if(!i||!d||d.owner===this.player||i.armies<s)return console.warn("Skipping invalid attack from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof se&&this.player.money<s*R.armyCost)return console.warn("Skipping invalid buy from actionPlan:",e),this.actionPlan=[],!1}else e=this.findBestOpportunity();if(!e)return!1;const n=await e.action.Act(e.countries,this.player,this.game,e.amount),t=e.countries.slice(-e.action.countryCountNeeded);return this.player.actionLog.push({actionType:e.action.Type(),countries:t,amount:e.amount,result:n??null}),e.followUp&&this.actionPlan.length===0&&this.actionPlan.push(e.followUp),this.player.useAction(),!0}countryDefenseEstimate(e){let n;const t=this.player.knowledge.find(r=>r.country===e),o=e.owner&&e.owner!==this.player;return o&&(!t||this.game.gameTurn-t.gameTurn>3)?n=1e5:!o&&!t?n=7e4:t?n=t.army:n=7e4,e.fortified&&(n*=2),n}countryScore(e){let n;const t=this.player.knowledge.find(r=>r.country===e);t&&typeof t.income=="number"?n=t.income:n=1e6;const o=this.countryDefenseEstimate(e);return n/o}countryBestAttackerScore(e){const n=this.countryDefenseEstimate(e);let t=0,o=null;for(const r of this.player.ownedCountries){const s=this.game.worldMap.distance(r,e);if(s===null)continue;const i=Math.round((r.armies||0)*q.ATTACK_COMMIT/1e3)*1e3;if(i<1e3)continue;const d=z.AttackChance(i,n,s,!1,this.game);let c=0;d>=.7&&(c=d*d*this.countryScore(e)*1e3),c>t&&(t=c,o=r)}return[o,t]}FindMoveOpportunities(e){const n=[];if(this.player.ownedCountries.length===0)return n;const t=this.player.ownedCountries.reduce((c,a)=>a.armies>c.armies?a:c,this.player.ownedCountries[0]);let o=null,r=-1/0,s=null;for(const c of this.player.ownedCountries){const a=this.getReachableNonOwnedCountries(c);for(const{country:l,distance:h}of a){let f=1;h>100&&(f=Math.max(0,1-(h-100)/900));const g=this.countryScore(l)*f;g>r&&(r=g,o=c,s=l)}}if(o&&o!==t){const c=Math.floor(t.armies*.5/1e3)*1e3;if(c>0&&t!==o){let a=null;if(this.actionPlan.length===0&&s){const l=o.armies+c,h=Object.create(o);if(h.armies=l,this.isAttackFeasible(h,s,q.ATTACK_COMMIT)){const f=new z,g=Math.floor(l*q.ATTACK_COMMIT/1e3)*1e3;a=new F([o,s],g,f,100)}}n.push(new F([t,o],c,e,r,a))}}const i=this.player.totalArmies()/this.player.ownedCountries.length,d=this.player.ownedCountries.reduce((c,a)=>a.armies<c.armies?a:c,this.player.ownedCountries[0]);if(d.armies<i/2&&d!==t){const c=i/2,a=Math.floor((c-d.armies)/1e3)*1e3,l=Math.max(0,Math.min(a,t.armies-1e3));l>0&&t!==d&&n.push(new F([t,d],l,e,i-d.armies))}return n}FindFortifyOpportunities(e){const n=[],t=this.player.ownedCountries.filter(o=>!o.fortified).length;for(const o of this.player.ownedCountries)if(o.canBeFortified()&&this.player.money>=R.fortifyCost){let r=o.income/100;r*=t,n.push(new F([o],0,e,r))}return n}FindBuyOpportunities(){if(this.player.money<=2e6)return[];const n=[],t=new se,o=this.player.money,r=R.armyCost,s=Math.max(0,o-2e6);if(this.player.ownedCountries.length===0||s<r)return n;const i=Math.floor(this.player.totalArmies()/this.player.ownedCountries.length),d=this.player.ownedCountries.reduce((h,f)=>f.armies<h.armies?f:h,this.player.ownedCountries[0]);if(d.armies<i){const h=i-d.armies,f=Math.floor(s/r),g=Math.min(h,f,1e5),m=Math.floor(g/1e3)*1e3;if(m>0){let C=(i-d.armies)/1e3;d.unrestLevel>0&&(C+=10),n.push(new F([d],m,t,C))}}let c=null,a=-1/0,l=null;for(const h of this.player.ownedCountries){const f=this.getReachableNonOwnedCountries(h);for(const{country:g,distance:m}of f){let C=1;m>100&&(C=Math.max(0,1-(m-100)/900));const y=this.countryScore(g)*C;y>a&&(a=y,c=h,l=g)}}if(c||(c=this.player.homeCountry),c){const h=Math.floor((s-2e6)/r),f=Math.floor(h/1e3)*1e3;if(f>0){let g=null;if(this.actionPlan.length===0&&l){const m=c.armies+f,C=Object.create(c);if(C.armies=m,this.isAttackFeasible(C,l,q.ATTACK_COMMIT)){const y=new z,w=Math.floor(m*q.ATTACK_COMMIT/1e3)*1e3;g=new F([c,l],w,y,100)}}n.push(new F([c],f,t,a*1e3,g))}}if(s>0&&this.player.ownedCountries.length>0){const h=this.findMostThreatenedOwnedCountry();if(!h)throw new Error("findMostThreatenedOwnedCountry() returned null, which should not happen if there are owned countries.");const f=Math.floor(s/r),g=Math.floor(f/1e3)*1e3;if(g>0){const m=s/1e3;n.push(new F([h],g,t,m))}}return n}findBestOpportunity(){const e=new re,n=new xe,t=[];if(t.push(...this.FindSpyOpportunities()),t.push(...this.FindAttackOpportunities()),t.push(...this.FindMoveOpportunities(e)),t.push(...this.FindFortifyOpportunities(n)),t.push(...this.FindBuyOpportunities()),t.length===0)return null;const o=.5,r=Math.max(...t.map(l=>l.score)),s=t.map(l=>Math.exp((l.score-r)/o)),i=s.reduce((l,h)=>l+h,0),d=s.map(l=>l/i),c=Math.random();let a=0;for(let l=0;l<t.length;++l)if(a+=d[l],c<a)return t[l];throw new Error("Softmax selection failed to pick an opportunity.")}getNonOwnedCountriesSortedByDistance(){const e=this.game.worldMap,n=e.getCountries(),t=[];for(const o of n){if(o.owner===this.player)continue;let r=1e4;for(const s of this.player.ownedCountries){const i=e.distance(s,o);i!==null&&(r=Math.min(r,i))}t.push({country:o,distance:r})}return t.sort((o,r)=>o.distance-r.distance),t}getReachableNonOwnedCountries(e){const n=this.game.worldMap,t=n.getCountries(),o=[];for(const r of t){if(r.owner===this.player)continue;const s=n.distance(e,r);s!==null&&o.push({country:r,distance:s})}return o.sort((r,s)=>r.distance-s.distance),o}MakeAttackPlan(e){if(this.actionPlan.length>0)return;const n=z,t=re,o=se,r=this.player.ownedCountries;if(r.length===0||e.owner===this.player)return;let s=1/0,i=null;for(const M of r){const v=this.game.worldMap.distance(M,e);v!==null&&v<s&&(s=v,i=M)}if(!i)return;const d=new Map;for(const M of r)d.set(M,M.armies);let c=this.player.money;const a=[],l=new o,h=R.armyCost,f=Math.floor(c/h);if(f>0){const M=Math.floor(f/1e3)*1e3;M>0&&(a.push(new F([i],M,l,1)),d.set(i,d.get(i)+M),c-=M*h)}const g=new t;let m=0,C=d.get(i);const y=r.filter(M=>M!==i).sort((M,v)=>v.armies-M.armies);for(const M of y){if(m>=2)break;const v=this.game.worldMap.distance(M,i),I=d.get(M);if(v!==null&&I>1e3){const S=Math.floor((I-1e3)/1e3)*1e3;S>0&&(a.push(new F([M,i],S,g,1)),d.set(M,I-S),C+=S,d.set(i,C),m++)}}const w=this.countryDefenseEstimate(e),u=this.game.worldMap.distance(i,e)||1,p=Math.floor(C*q.ATTACK_COMMIT/1e3)*1e3,x=n.AttackChance(p,w,u,e.fortified,this.game);if(x>.7&&p>=1e3){const M=new n;a.push(new F([i,e],p,M,x*100)),d.set(i,1e3),this.actionPlan.push(...a)}}PlanSurpriseAttack(){if(this.actionPlan.length>0)return;const e=this.game.worldMap.getCountries();let n=1/0,t=null;for(const s of e)if(!s.owner){const i=this.countryDefenseEstimate(s);i<n&&(n=i,t=s)}if(t){this.MakeAttackPlan(t);return}let o=1/0,r=null;for(const s of e)if(s.owner&&s.owner!==this.player){const i=this.countryDefenseEstimate(s);i<o&&(o=i,r=s)}r&&this.MakeAttackPlan(r)}isAttackFeasible(e,n,t=.8){if(!e||!n||e.owner!==this.player||n.owner===this.player||e===n)return!1;const o=e.neighbors.includes(n),r=e.oceanBorder.length>0&&n.oceanBorder.length>0;if(!o&&!r||typeof e.armies!="number"||e.armies<=1e3)return!1;const s=this.countryDefenseEstimate(n),i=this.game.worldMap.distance(e,n);if(i===null)return!1;const d=Math.floor(e.armies*t);return!(z.AttackChance(d,s,i,n.fortified,this.game)<.7)}findMostThreatenedOwnedCountry(){if(!this.player.ownedCountries||this.player.ownedCountries.length===0)throw new Error("AI has no owned countries to evaluate for threat.");const e=this.game.worldMap,n=e.getCountries();let t=null,o=-1/0;for(const r of this.player.ownedCountries){let s=0;for(const i of n){if(!i.owner||i.owner===this.player)continue;const d=e.distance(r,i);d===null||d===0||(s+=1/d)}s>o&&(o=s,t=r)}if(!t)throw new Error("No threatened country found. This should not happen if there are enemy countries.");return t}};b(q,"ATTACK_COMMIT",.8);let te=q;const _=class _{constructor(e,n,t=[],o=null,r=[],s=0,i=!1){b(this,"actionsLeft",_.ACTIONS_PER_TURN);b(this,"game");b(this,"actionLog",[]);b(this,"name");b(this,"color");b(this,"ownedCountries");b(this,"homeCountry");b(this,"isAI");b(this,"AI");b(this,"money");b(this,"knowledge");b(this,"plannedFortifications",[]);b(this,"aggressivity");this.name=e,this.color=n,this.ownedCountries=t,this.homeCountry=o,this.knowledge=r,this.money=s,this.isAI=i,this.actionsLeft=_.ACTIONS_PER_TURN,this.aggressivity=Math.floor(Math.random()*8)+2,this.AI=new te(this,void 0)}resetActions(){this.actionsLeft=_.ACTIONS_PER_TURN}useAction(){this.actionsLeft>0&&this.actionsLeft--}get RGBColor(){return _.COLOR_RGBS[this.color]||"0,0,0"}getKnownCountries(){const e=new Set;this.knowledge.forEach(t=>e.add(t.country));const n=Array.from(e).filter(t=>!this.ownedCountries.includes(t));return{owned:[...this.ownedCountries],known:n}}getCountryInfo(e,n){if(e.owner===this)return{name:e.name,owner:e.owner,income:e.income,army:e.armies,recency:0};{const t=this.knowledge.find(o=>o.country===e);return{name:e.name,owner:e.owner,income:t?t.income:void 0,army:t?t.army:void 0,recency:t?n-t.gameTurn:void 0}}}totalIncome(){return this.ownedCountries.reduce((e,n)=>n.unrestLevel>0?e:e+(n.income??0),0)}totalArmies(){return this.ownedCountries.reduce((e,n)=>e+(n.armies??0),0)}startTurn(){this.resetActions()}get IncomeShare(){if(!this.game||!this.game.players||this.game.players.length===0)return 0;const e=this.game.players.reduce((n,t)=>{var o;return n+(((o=t.totalIncome)==null?void 0:o.call(t))??0)},0);return e===0?0:this.totalIncome()/e}armyKnown(e){if(e.owner===this)return!0;const n=this.knowledge.find(t=>t.country===e);return!!(!e.owner&&n||e.owner&&e.owner!==this&&n&&this.game&&n.gameTurn===this.game.gameTurn)}toJSON(){return{id:this.name,name:this.name,color:this.color,ownedCountryIds:this.ownedCountries.map(e=>e.name),homeCountryId:this.homeCountry?this.homeCountry.name:null,isAI:this.isAI,money:this.money,knowledge:this.knowledge.map(e=>({countryId:e.country.name,gameTurn:e.gameTurn,army:e.army,income:e.income})),plannedFortifications:this.plannedFortifications.map(([e,n])=>[e.name,n]),aggressivity:this.aggressivity,actionsLeft:this.actionsLeft}}static fromJSON(e,n){const t=new _(e.name,e.color,[],null,[],e.money,e.isAI);return t.aggressivity=e.aggressivity,t.actionsLeft=e.actionsLeft??_.ACTIONS_PER_TURN,t._ownedCountryIds=e.ownedCountryIds,t._homeCountryId=e.homeCountryId,t._knowledgeRaw=e.knowledge,t._plannedFortificationsRaw=e.plannedFortifications,t}resolveReferences(e){this.ownedCountries=(this._ownedCountryIds||[]).map(n=>e[n]).filter(Boolean),this.homeCountry=this._homeCountryId?e[this._homeCountryId]:null,this.knowledge=(this._knowledgeRaw||[]).map(n=>({country:e[n.countryId],gameTurn:n.gameTurn,army:n.army,income:n.income})),this.plannedFortifications=(this._plannedFortificationsRaw||[]).map(([n,t])=>[e[n],t]),delete this._ownedCountryIds,delete this._homeCountryId,delete this._knowledgeRaw,delete this._plannedFortificationsRaw}};b(_,"ACTIONS_PER_TURN",5),b(_,"COLOR_RGBS",{red:"255,0,0",blue:"0,0,255",green:"0,128,0",yellow:"255,255,0",purple:"128,0,128",orange:"255,140,0",teal:"0,128,128",brown:"139,69,19"}),b(_,"COLORS",["red","blue","green","yellow","purple","orange","teal","brown"]);let Y=_;const _e=Object.freeze(Object.defineProperty({__proto__:null,Player:Y},Symbol.toStringTag,{value:"Module"})),L=class L{constructor(e,n=[]){b(this,"worldMap");b(this,"players");b(this,"gameTurn");b(this,"activePlayerIndex");b(this,"gui");b(this,"advisedOpportunity");this.worldMap=e,this.players=n,this.gameTurn=1,this.activePlayerIndex=0,this.advisedOpportunity=null,this.players.length>0&&this.activePlayer.startTurn()}get activePlayer(){return this.players[this.activePlayerIndex]}nextTurn(){this.activePlayer.money+=this.activePlayer.totalIncome(),this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayerIndex===0&&(this.gameTurn++,this.handleUnrest());const e=this.activePlayer;e.plannedFortifications=e.plannedFortifications.filter(([n,t])=>t===this.gameTurn?(n.fortified=!0,!1):!0),this.activePlayer.startTurn(),this.advisedOpportunity=null}static initNewGame(e,n,t){for(const l of n)l.money=L.initialPlayerMoney,l.homeCountry=null,l.ownedCountries=[],l.isAI&&(l.AI=new te(l,null));const o=e.getCountries();for(const l of o)l.income=Math.floor((5e5+Math.random()*2e6)/1e3)*1e3,l.owner=null;let r=-1,s=[];const i=n.length,d=10;function c(l,h){if(!l.center||!h.center)return 0;const[f,g]=l.center(),[m,C]=h.center();return Math.sqrt((f-m)**2+(g-C)**2)}for(let l=0;l<d;++l){const h=[...o];for(let m=h.length-1;m>0;m--){const C=Math.floor(Math.random()*(m+1));[h[m],h[C]]=[h[C],h[m]]}const f=h.slice(0,i);let g=1/0;for(let m=0;m<f.length;++m)for(let C=m+1;C<f.length;++C)g=Math.min(g,c(f[m],f[C]));g>r&&(r=g,s=f)}for(let l=0;l<n.length;++l){const h=s[l];n[l].homeCountry=h,h.owner=n[l],n[l].ownedCountries.push(h),h.income=L.homeCountryIncome,h.fortified=!0}for(const l of e.getCountries())if(l.owner)l.armies=1e5;else{const h=Math.round((Math.random()*Math.random()*99e3+1e3)/1e3)*1e3;l.armies=h}const a=new L(e,n);t&&(a.gui=t);for(const l of n)l.game=a,l.isAI&&l.AI&&(l.AI.game=a,l.AI.player=l);return a}toJSON(){var e;return{gameTurn:this.gameTurn,activePlayerName:((e=this.players[this.activePlayerIndex])==null?void 0:e.name)??null,playerNames:this.players.map(n=>n.name)}}static fromJSON(e,n,t){const o=new L(t,n);o.gameTurn=e.gameTurn,o.activePlayerIndex=n.findIndex(r=>r.name===e.activePlayerName),o.activePlayerIndex===-1&&(o.activePlayerIndex=0);for(const r of n)r.game=o,r.isAI&&r.AI&&(r.AI.game=o,r.AI.player=r);return o}AddPlayer(e){return this.players.length>=8?!1:(this.players.push(e),!0)}static generateAIName(){const e=["Augustus","Charlemagne","Qin Shi Huang","Akbar","Justinian","Napoleon","Constantine","Ashoka","Catherine","Meiji","Trajan","Hadrian","Aurangzeb","Elizabeth","Peter","Victoria","Franz Joseph","Wilhelm","Haile Selassie","Menelik"];return e[Math.floor(Math.random()*e.length)]}handleUnrest(){for(const e of this.worldMap.getCountries()){if(!e.owner)continue;if(Math.floor(Math.random()*99e3)+1e3+e.armies<e.nationalPride?(e.unrestLevel=Math.min(e.unrestLevel+1,2),e.nationalPride=Math.min(e.nationalPride+1e3,1e5)):(e.unrestLevel=Math.max(e.unrestLevel-1,0),e.nationalPride=Math.max(e.nationalPride-1e3,1e3)),e.unrestLevel===2){const o=new Y(L.generateAIName(),Y.COLORS[this.players.length%Y.COLORS.length],[],null,[],0,!0);if(this.AddPlayer(o)){const r=e.owner;r&&(r.ownedCountries=r.ownedCountries.filter(s=>s!==e)),this.UnKnowCountry(e),e.nationalPride=1e3,e.unrestLevel=0,e.income*=2,o.homeCountry=e,o.ownedCountries.push(e),e.owner=o,e.armies=e.nationalPride*2,e.fortified=!0,o.game=this,o.AI=new te(o,this)}else{const r=e.owner;r&&(r.ownedCountries=r.ownedCountries.filter(s=>s!==e)),this.UnKnowCountry(e),e.owner=null,e.armies=e.nationalPride,e.fortified=!1}}}}UnKnowCountry(e){for(const n of this.players)n.knowledge=n.knowledge.filter(t=>t.country!==e)}};b(L,"armyCost",100),b(L,"spyCost",2e5),b(L,"spyFortifiedCost",1e6),b(L,"initialPlayerMoney",1e7),b(L,"homeCountryIncome",4e6),b(L,"fortifyCost",1e5),b(L,"showArmies",!1),b(L,"INCOME_SHARE_WIN",.8);let R=L;const ze=Object.freeze(Object.defineProperty({__proto__:null,Game:R},Symbol.toStringTag,{value:"Module"}));class ve extends J{GetButtonText(e,n){var s;if(e.length===0)return null;const t=e[e.length-1];if(t.owner==n)return null;const o=n.knowledge.find(i=>i.country===t),r=(s=n.game)==null?void 0:s.gameTurn;return!t.owner&&o||t.owner&&t.owner!==n&&o&&o.gameTurn===r?null:`Spy on ${t.name}`}async Act(e,n,t,o=0){if(e.length===0)return"Please select a country to spy on.";const r=e[e.length-1],s=r.fortified?R.spyFortifiedCost:R.spyCost;if(n.money<s)return`Not enough money to spy. You need $${s}.`;const i=n.knowledge.find(a=>a.country===r);if(!t)return"Internal error: currentGame is required.";const d=t.gameTurn;if(i&&i.gameTurn===d)return"You already have recent information about this country.";n.money-=s;const c={country:r,gameTurn:d,army:r.armies,income:r.income};return i?(i.gameTurn=c.gameTurn,i.army=c.army,i.income=c.income):n.knowledge.push(c),null}RequiresAmount(e,n,t){return null}get countryCountNeeded(){return 1}Type(){return"Spy"}ActionString(e,n,t,o=0){return e.length<1?"Spy: No country selected.":`Spying on ${e[e.length-1].name}`}}function We(k,e,n=k){return new Promise(t=>{const o=document.createElement("div");o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.5)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="10000";const r=document.createElement("div");r.style.background="#fff",r.style.padding="32px 40px",r.style.borderRadius="12px",r.style.boxShadow="0 2px 16px rgba(0,0,0,0.2)",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="18px";const s=document.createElement("div");s.textContent="Select amount to commit:",s.style.fontSize="1.2rem",s.style.marginBottom="8px",r.appendChild(s);const i=document.createElement("div");i.textContent=`Maximum: ${e.toLocaleString()}`,i.style.fontSize="1rem",i.style.color="#555",i.style.marginBottom="4px",r.appendChild(i);let d=Math.max(k,Math.min(e,n));const c=document.createElement("div");c.textContent=d.toLocaleString(),c.style.fontSize="2rem",c.style.fontWeight="bold",c.style.margin="8px 0",r.appendChild(c);const a=document.createElement("div");a.style.display="flex",a.style.gap="6px";function l(C){d=Math.max(k,Math.min(e,C)),c.textContent=d.toLocaleString()}function h(C,y){const w=document.createElement("button");return w.textContent=C,w.style.padding="6px 14px",w.style.fontSize="1.1rem",w.style.border="none",w.style.borderRadius="6px",w.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",w.style.color="#fff",w.style.cursor="pointer",w.onclick=y,w}a.appendChild(h("-100k",()=>l(d-1e5))),a.appendChild(h("-10k",()=>l(d-1e4))),a.appendChild(h("-1k",()=>l(d-1e3))),a.appendChild(h("Min",()=>l(k))),a.appendChild(h("Half",()=>l(Math.floor(e/2/1e3)*1e3))),a.appendChild(h("Max",()=>l(e))),a.appendChild(h("+1k",()=>l(d+1e3))),a.appendChild(h("+10k",()=>l(d+1e4))),a.appendChild(h("+100k",()=>l(d+1e5))),r.appendChild(a);const f=document.createElement("div");f.style.display="flex",f.style.gap="12px",f.style.marginTop="18px";const g=h("OK",()=>{document.body.removeChild(o),t(d)});g.style.background="linear-gradient(90deg,#43cea2 0%,#43e97b 100%)",g.style.fontWeight="bold";const m=h("Cancel",()=>{document.body.removeChild(o),t(null)});m.style.background="linear-gradient(90deg,#e57373 0%,#ffb74d 100%)",f.appendChild(g),f.appendChild(m),r.appendChild(f),o.appendChild(r),document.body.appendChild(o),g.focus()})}class qe extends J{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];if(t.owner!==n||t===o||!(n.knowledge&&n.knowledge.some(d=>d.country===o)))return null;const s=t.neighbors.includes(o),i=t.oceanBorder.length>0&&o.oceanBorder.length>0;return!s&&!i||o.owner===n?null:`Calculate attack chance for ${o.name} from ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to calculate attack.";const r=e[e.length-2],s=e[e.length-1];if(r.owner!==n)return"You must own the attacking country.";const i=r.neighbors.includes(s),d=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!d)return"Target country must be a neighbor or reachable by naval attack.";if(s.owner===n)return"Cannot attack your own country.";if(o<=0||o>=r.armies)return"Invalid number of armies committed.";const c=n.getCountryInfo(s,t.gameTurn),a=t.worldMap.distance(r,s);let h=`Attack chance: ${(z.AttackChance(r.armies,c.army||0,a||0,s.fortified,t)*100).toFixed(2)}%`;return c.recency&&c.recency>0&&(h+=`
Warning: Information about ${s.name} may be outdated (last spied ${c.recency} turn(s) ago).`),h}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}Type(){return"CalculateAttack"}get countryCountNeeded(){return 2}ActionString(e,n,t,o=0){if(e.length<2)return"Calculate Attack: Not enough countries selected.";const r=e[e.length-2];return`Calculating attack chance for ${e[e.length-1].name} from ${r.name} with ${o} soldiers`}}function be(k,e,n){let t=document.getElementById("gamegui-win-modal");if(t)return;t=document.createElement("div"),t.id="gamegui-win-modal",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.85)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="99999";const o=document.createElement("canvas");o.width=window.innerWidth,o.height=window.innerHeight,o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.zIndex="0",o.style.pointerEvents="none",t.appendChild(o);function r(){o.width=window.innerWidth,o.height=window.innerHeight}window.addEventListener("resize",r);const s=document.createElement("div");s.style.width="50vw",s.style.height="50vh",s.style.background='url("Won.png") center/cover no-repeat',s.style.padding="48px 64px",s.style.borderRadius="24px",s.style.boxShadow="0 4px 32px rgba(0,0,0,0.25)",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.gap="32px",s.style.position="relative",s.style.zIndex="1";const i=document.createElement("div");i.style.position="absolute",i.style.top="32px",i.style.right="48px",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="flex-end",i.style.zIndex="2",i.style.padding="12px 24px",i.style.background="rgba(255,255,255,0.0)";const d=document.createElement("div");d.textContent="WINNER",d.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",d.style.fontSize="2.7rem",d.style.fontWeight="bold",d.style.color="#222",d.style.textShadow="0 2px 8px #fff,0 0 8px #000",i.appendChild(d);const c=document.createElement("div");c.textContent=k,c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",c.style.fontSize="2.1rem",c.style.fontWeight="bold",c.style.color="#fff",c.style.marginTop="8px",c.style.textShadow="0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6",c.style.animation="win-glow 2.2s linear infinite";const a=document.createElement("style");a.textContent=`@keyframes win-glow {
    0% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
    25% { text-shadow: 0 0 24px #43cea2, 0 0 40px #ffd700, 0 0 56px #00e6e6, 0 0 72px #ff00cc; }
    50% { text-shadow: 0 0 32px #ff00cc, 0 0 48px #00e6e6, 0 0 64px #ffd700, 0 0 80px #43cea2; }
    75% { text-shadow: 0 0 24px #00e6e6, 0 0 40px #ff00cc, 0 0 56px #43cea2, 0 0 72px #ffd700; }
    100% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
  }`,document.head.appendChild(a),i.appendChild(c);const l=document.createElement("button");l.textContent="OK",l.style.marginTop="18px",l.style.padding="12px 36px",l.style.fontSize="1.3rem",l.style.border="none",l.style.borderRadius="8px",l.style.background="linear-gradient(90deg,#43cea2 0%,#ffd700 100%)",l.style.color="#222",l.style.fontWeight="bold",l.style.cursor="pointer",l.style.textShadow="0 2px 8px #fff,0 0 8px #000",l.onclick=()=>{y=!1,window.removeEventListener("resize",r),t&&t.parentNode&&t.parentNode.removeChild(t),n&&n()},i.appendChild(l),s.appendChild(i),t.appendChild(s),document.body.appendChild(t);const h=o.getContext("2d"),f=[];let g=o.height;function m(){const u=Math.random()*o.width*.8+o.width*.1,p=o.height*.02+Math.random()*o.height*.04,x=(Math.random()-.5)*2,M=(-8-Math.random()*4)*2,v=`hsl(${Math.random()*360},90%,60%)`;f.push({x:u,y:o.height,vx:x,vy:M,color:v,exploded:!1,particles:[],age:0,targetY:p})}function C(u){for(let p=0;p<48;p++){const x=p/48*2*Math.PI,M=2+Math.random()*2.5;u.particles.push({x:u.x,y:u.y,vx:Math.cos(x)*M,vy:Math.sin(x)*M,color:u.color,alpha:1,age:0})}}let y=!0;function w(){if(!(!y||!h)){h.clearRect(0,0,o.width,o.height),Math.random()<.06&&f.length<7&&m();for(const u of f)if(!u.exploded)u.x+=u.vx,u.y+=u.vy,u.vy+=.13,u.age++,u.y<g&&(g=u.y),h.save(),h.beginPath(),h.arc(u.x,u.y,4,0,2*Math.PI),h.fillStyle=u.color,h.globalAlpha=.9,h.shadowColor=u.color,h.shadowBlur=16,h.fill(),h.restore(),u.y<=u.targetY&&(u.exploded=!0,C(u));else{for(const p of u.particles)p.x+=p.vx,p.y+=p.vy,p.vy+=.04,p.alpha-=.012+Math.random()*.01,p.age++,h.save(),h.beginPath(),h.arc(p.x,p.y,2.2,0,2*Math.PI),h.fillStyle=p.color,h.globalAlpha=Math.max(0,p.alpha),h.shadowColor=p.color,h.shadowBlur=8,h.fill(),h.restore();u.particles=u.particles.filter(p=>p.alpha>.05&&p.age<90)}for(let u=f.length-1;u>=0;u--)f[u].exploded&&f[u].particles.length===0&&f.splice(u,1);requestAnimationFrame(w)}}w()}const He=Object.freeze(Object.defineProperty({__proto__:null,showWinDialog:be},Symbol.toStringTag,{value:"Module"}));class je{constructor(e,n,t,o){b(this,"overlay");b(this,"ctx");b(this,"width");b(this,"height");b(this,"fish",[]);b(this,"running",!1);b(this,"lastSpawn",0);b(this,"nextSpawn",0);b(this,"getOceanPredicate");b(this,"animationFrameId",null);b(this,"timeoutId",null);b(this,"loop",e=>{this.ctx.clearRect(0,0,this.width,this.height),this.fish=this.fish.filter(n=>!n.done);for(const n of this.fish)n.update(e),n.draw(this.ctx);e>this.nextSpawn&&(this.spawnFish(),this.scheduleNextSpawn()),this.fish.length>0||this.nextSpawn-e<2e3?this.animationFrameId=requestAnimationFrame(this.loop):(this.running=!1,this.timeoutId=setTimeout(()=>this.start(),this.nextSpawn-e))});this.width=n,this.height=t,this.getOceanPredicate=o,this.overlay=document.createElement("canvas"),this.overlay.width=n,this.overlay.height=t,this.overlay.style.position="absolute",this.overlay.style.left="0",this.overlay.style.top="0",this.overlay.style.pointerEvents="none",this.overlay.style.width="100%",this.overlay.style.height="100%",this.overlay.style.zIndex="20",e.appendChild(this.overlay);const r=this.overlay.getContext("2d");if(!r)throw new Error("Could not get canvas context for FishOverlay");this.ctx=r,this.scheduleNextSpawn(),this.start()}scheduleNextSpawn(){this.nextSpawn=performance.now()+5e3+Math.random()*1e4}spawnFish(){for(let e=0;e<10;e++){const n=Math.floor(Math.random()*this.width),t=Math.floor(this.height*(.4+.5*Math.random())),o=Math.random()<.5?1:-1,r=32+Math.random()*24,s=n+o*r;if(this.getOceanPredicate(n,t)&&this.getOceanPredicate(Math.round(s),t)){const i="#444";this.fish.push(new Ue(n,t,o,i));break}}}start(){this.running||(this.running=!0,this.animationFrameId=requestAnimationFrame(this.loop))}stop(){this.running=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}resume(){this.running||this.start()}}class Ue{constructor(e,n,t,o){b(this,"x0");b(this,"y0");b(this,"x1");b(this,"y1");b(this,"dir");b(this,"color","#444");b(this,"t0");b(this,"duration");b(this,"done",!1);b(this,"splash",!1);b(this,"splashStart",0);b(this,"splashDuration",1200);this.x0=e,this.y0=n;const r=32+Math.random()*24;this.x1=e+t*r,this.y1=n,this.dir=t,this.t0=performance.now(),this.duration=(1200+Math.random()*400)/2}update(e){const n=(e-this.t0)/this.duration;if(!this.splash&&n>.95&&(this.splash=!0,this.splashStart=e),n>1&&this.splash){e-this.splashStart>this.splashDuration&&(this.done=!0);return}if(n>1){this.done=!0;return}}draw(e){const n=performance.now(),t=Math.min(1,(n-this.t0)/this.duration),o=18,r=this.x0+(this.x1-this.x0)*t,s=this.y0-(1-4*Math.pow(t-.5,2))*o,i=1+.18*Math.sin(Math.PI*t),d=.5*Math.sin(Math.PI*t);if(t<=.95){e.save(),e.translate(r,s);const c=1/3,a=e.createRadialGradient(0,0,.3,0,0,7*i*c);a.addColorStop(0,"#222"),a.addColorStop(.7,"#666"),a.addColorStop(1,"#bbb"),e.fillStyle=a,e.beginPath(),e.ellipse(0,0,7*i*c,3*c,0,0,2*Math.PI),e.fill(),e.save(),e.beginPath(),e.moveTo(-7*i*c,0),e.lineTo(-11*i*c,-4*c),e.lineTo(-11*i*c,4*c),e.closePath(),e.fillStyle="#222",e.globalAlpha=.8,e.fill(),e.restore(),e.save(),e.beginPath(),e.ellipse(-2*i*c,2.2*c,2*c,.7*c,Math.PI/4+d,0,2*Math.PI),e.ellipse(-2*i*c,-2.2*c,2*c,.7*c,-Math.PI/4-d,0,2*Math.PI),e.fillStyle="#888",e.globalAlpha=.7,e.fill(),e.restore(),e.restore()}if(this.splash){const c=Math.min(1,(n-this.splashStart)/this.splashDuration);for(let a=0;a<3;a++){const l=10+12*c+a*6;e.save(),e.beginPath(),e.arc(this.x1,this.y1,l,0,2*Math.PI),e.strokeStyle=`rgba(10,10,10,${.7*(1-c)})`,e.lineWidth=2.5-a*.5,e.globalAlpha=1*(1-c),e.stroke(),e.restore()}}}}function Ye(k){var l;let e=document.getElementById("action-log-dialog");e&&e.remove();const n=document.createElement("div");n.id="action-log-dialog",n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.6)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="99999",(l=X.getInstance())==null||l.pauseGame();const t=document.createElement("div");t.style.background="#fff",t.style.width="100vw",t.style.height="100vh",t.style.padding="0",t.style.borderRadius="0",t.style.boxShadow="none",t.style.maxWidth="100vw",t.style.maxHeight="100vh",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="stretch",t.style.gap="0",t.style.overflow="hidden";const o=document.createElement("button");o.textContent="Close",o.style.alignSelf="flex-end",o.style.margin="16px 24px 0 0",o.style.padding="10px 32px",o.style.fontSize="1.2rem",o.style.border="none",o.style.borderRadius="8px",o.style.background="linear-gradient(90deg,#ff9966 0%,#ff5e62 100%)",o.style.color="#fff",o.style.cursor="pointer",o.onclick=()=>{var f,g;(f=X.getInstance())==null||f.resumeGame(),n.remove();const h=X.getInstance();h&&h.currentGame&&!h.canceled&&((g=h.currentGame.activePlayer)!=null&&g.isAI)&&setTimeout(()=>h.turnStarted(),0)},t.appendChild(o);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.gap="16px",r.style.padding="24px 32px 8px 32px",r.style.background="#f5f5f5";const s=document.createElement("select");s.style.fontSize="1.1rem",s.style.padding="6px 12px";for(const h of k.players){const f=document.createElement("option");f.value=h.name,f.textContent=h.name+(h.isAI?" (AI)":""),s.appendChild(f)}r.appendChild(s);const i=document.createElement("input");i.type="text",i.placeholder="Filter (wildcard, all fields)",i.style.fontSize="1.1rem",i.style.padding="6px 12px",i.style.borderRadius="6px",i.style.border="1px solid #aaa",r.appendChild(i),t.appendChild(r);const d=document.createElement("div");d.style.overflow="auto",d.style.flex="1",d.style.padding="0 32px 32px 32px",d.style.background="#fff",t.appendChild(d);function c(h,f){d.innerHTML="";const g=document.createElement("table");g.style.width="100%",g.style.borderCollapse="collapse",g.style.fontSize="1.05rem";const m=document.createElement("thead"),C=document.createElement("tr");for(const u of["#","Action","Countries","Amount","Result"]){const p=document.createElement("th");p.textContent=u,p.style.borderBottom="2px solid #888",p.style.padding="8px 12px",p.style.background="#eee",C.appendChild(p)}m.appendChild(C),g.appendChild(m);const y=document.createElement("tbody");let w=h.actionLog;if(f.trim()){const u=f.trim().toLowerCase();w=w.filter(p=>p.actionType.toLowerCase().includes(u)||p.countries.map(x=>x.name).join(",").toLowerCase().includes(u)||(""+p.amount).includes(u)||(p.result?p.result.toLowerCase():"").includes(u))}w.forEach((u,p)=>{const x=document.createElement("tr");x.style.borderBottom="1px solid #ddd";const M=document.createElement("td");M.textContent=(p+1).toString(),M.style.padding="6px 12px",x.appendChild(M);const v=document.createElement("td");v.textContent=u.actionType,v.style.padding="6px 12px",x.appendChild(v);const I=document.createElement("td");I.textContent=u.countries.map(T=>T.name).join(", "),I.style.padding="6px 12px",x.appendChild(I);const S=document.createElement("td");S.textContent=u.amount.toString(),S.style.padding="6px 12px",x.appendChild(S);const A=document.createElement("td");A.textContent=u.result??"",A.style.padding="6px 12px",x.appendChild(A),y.appendChild(x)}),g.appendChild(y),d.appendChild(g)}let a=k.players[0];c(a,""),s.onchange=()=>{a=k.players.find(h=>h.name===s.value)||k.players[0],c(a,i.value)},i.oninput=()=>{c(a,i.value)},n.appendChild(t),document.body.appendChild(n)}class ge{static serialize(e){const n=e.worldMap.getCountries(),t=e.players;return JSON.stringify({countries:n.map(o=>o.toJSON()),players:t.map(o=>o.toJSON()),game:e.toJSON()})}static deserialize(e){const n=JSON.parse(e),t={},o=n.countries.map(c=>ae.fromJSON(c,{},t)),r={},s=n.players.map(c=>{const a=Y.fromJSON(c,t);return r[a.name]=a,a});o.forEach(c=>c.resolveReferences(r,t)),s.forEach(c=>c.resolveReferences(t));const i=$e(o);return R.fromJSON(n.game,s,i)}}const Z=class Z{constructor(){b(this,"state");b(this,"currentGame",null);b(this,"rootContainer",null);b(this,"canceled",!1);b(this,"paused",!1);b(this,"clickedCountryNames",[]);b(this,"worldMapCanvas",null);b(this,"mapDirty",!0);b(this,"actions");b(this,"fishOverlay",null);b(this,"_onResize",()=>{this.markMapDirty(),this.rootContainer&&this.renderMainGui(this.rootContainer,this.currentGame)});this.state="initialized",this.actions=[new ve,new xe,new z,new qe,new re,new se],Z._instance=this,window.addEventListener("keydown",e=>{e.key==="F9"&&this.currentGame&&Ye(this.currentGame),e.key==="F8"&&V(()=>Promise.resolve().then(()=>He),void 0).then(n=>{var o,r;const t=((r=(o=this.currentGame)==null?void 0:o.activePlayer)==null?void 0:r.name)||"Player";n.showWinDialog(t,100)})})}pauseGame(){if(this.paused=!0,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.stop=="function"?(console.log("Pausing FishOverlay",this.fishOverlay),this.fishOverlay.stop()):console.log("No FishOverlay to pause")}resumeGame(){if(this.paused=!1,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.resume=="function"?(console.log("Resuming FishOverlay",this.fishOverlay),this.fishOverlay.resume()):console.log("No FishOverlay to resume")}isPaused(){return this.paused}static getInstance(){return Z._instance}afterAction(){if(this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],t=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(t&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(t,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");if(r){const s=t.unrestLevel>0?"color: red; font-style: italic;":"",i=t.unrestLevel>0?'<div style="color: red; font-style: italic;">Rioting</div>':"",d=t.unrestLevel>0?"color: red; text-decoration: line-through;":"";r.innerHTML=`
            <div><b>Name:</b> <span style="${s}">${o.name}</span></div>
            <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
            <div><b>Income:</b> <span style="${d}">${o.income!==void 0?o.income:"?"}</span></div>
            <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
            <div><b>Recency:</b> ${o.recency!==void 0?o.recency:"?"}</div>
            ${i}
          `}}}if(this.markMapDirty(),this.rootContainer&&(this.renderMainGui(this.rootContainer,this.currentGame),this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap)){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],t=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(t&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(t,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");if(r){const s=t.unrestLevel>0?"color: red; font-style: italic;":"",i=t.unrestLevel>0?'<div style="color: red; font-style: italic;">Rioting</div>':"",d=t.unrestLevel>0?"color: red; text-decoration: line-through;":"";r.innerHTML=`
              <div><b>Name:</b> <span style="${s}">${o.name}</span></div>
              <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
              <div><b>Income:</b> <span style="${d}">${o.income!==void 0?o.income:"?"}</span></div>
              <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
              <div><b>Recency:</b> ${o.recency!==void 0?o.recency:"?"}</div>
              ${i}
            `}}}this.updateActionButtons()}updateActionButtons(){if(this.paused)return;const e=document.getElementById("action-buttons-area");if(!e)return;const n=[];if(Array.from(e.children).forEach(s=>{s instanceof HTMLElement&&(s.classList.contains("persistent-action-btn")?(n.push(s),s.textContent&&s.textContent.trim()==="New Game"&&(s.disabled=!1)):e.removeChild(s))}),!this.currentGame||!this.currentGame.players||!this.currentGame.activePlayer)return;const t=this.currentGame.worldMap?this.currentGame.worldMap.getCountries():[],o=this.clickedCountryNames.map(s=>t.find(i=>i.name===s)).filter(Boolean);if(this.currentGame.activePlayer.actionsLeft<=0){const s=document.createElement("div");s.textContent="You are out of actions for this turn!",s.style.background="linear-gradient(90deg,#ff5e62 0%,#ff9966 100%)",s.style.color="#fff",s.style.fontSize="1.5rem",s.style.fontWeight="bold",s.style.padding="32px 0",s.style.borderRadius="12px",s.style.textAlign="center",s.style.margin="24px 0",e.appendChild(s);return}const r=[];for(const s of this.actions){const i=s.GetButtonText(o,this.currentGame.activePlayer);if(i){const d=document.createElement("button");d.textContent=i,d.style.padding="12px 0",d.style.fontSize="1.1rem",d.style.background="linear-gradient(90deg,#00c3ff 0%,#ffff1c 100%)",d.style.color="#222",d.style.border="none",d.style.borderRadius="8px",d.style.cursor="pointer",d.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",d.style.marginBottom="8px",d.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",d.onclick=async()=>{const c=s.RequiresAmount(o,this.currentGame.activePlayer,this.currentGame);let a=null,l=0;if(c){const[f,g]=c;let m=g;if(this.currentGame&&this.currentGame.advisedOpportunity){const y=this.currentGame.advisedOpportunity,w=this.currentGame.worldMap.getCountries();for(const x of y.countries){const M=w.find(v=>v.name===x.name);M&&M!==x&&console.warn("[Advisor/Action] Country instance mismatch:",x.name,x,M)}const u=y.action.Type()===s.Type(),p=y.countries.length===o.length&&y.countries.every((x,M)=>x===o[M]);u&&p&&(m=y.amount)}const C=await We(f,g,m);if(C===null)return;l=C,a=await s.Act(o,this.currentGame.activePlayer,this.currentGame,C)}else a=await s.Act(o,this.currentGame.activePlayer,this.currentGame);const h=o.slice(-s.countryCountNeeded);this.currentGame.activePlayer.actionLog.push({actionType:s.Type(),countries:h,amount:l,result:a??null}),this.currentGame.activePlayer.useAction(),typeof a=="string"&&a!==null?(this.afterAction(),this.showActionResult(a)):this.afterAction(),this.currentGame&&(this.currentGame.advisedOpportunity=null)},r.push(d)}}if(r.length&&n.length){const s=document.createElement("div");s.style.height="16px",s.style.width="100%",e.insertBefore(s,n[0]),r.forEach(i=>e.insertBefore(i,s))}else r.length&&r.forEach(s=>e.appendChild(s))}showActionResult(e){const n=document.getElementById("action-result-panel");n&&(n.innerHTML=`<span style="color:#fff">${e}</span>`)}clearActionResult(){const e=document.getElementById("action-result-panel");e&&(e.innerHTML='<span style="color:#888">No recent action.</span>')}markMapDirty(){this.mapDirty=!0}getWorldMapCanvas(){if(this.paused)throw new Error("Game is paused");if(!this.currentGame||!this.currentGame.worldMap)throw new Error("GameGui.getWorldMapCanvas: currentGame or worldMap is missing");if(this.mapDirty||!this.worldMapCanvas){let e=[];if(this.currentGame.activePlayer){const n=this.currentGame.activePlayer.getKnownCountries();e=n.owned.concat(n.known)}this.worldMapCanvas=ee.render(this.currentGame.worldMap,[],e,R.showArmies,this.currentGame.activePlayer),this.mapDirty=!1}return this.worldMapCanvas}async mount(e){this.rootContainer=e,window.addEventListener("resize",this._onResize),this.renderMainGui(e,this.currentGame)}unmount(){window.removeEventListener("resize",this._onResize)}async turnStarted(){var t,o;if(this.paused)return;if(this.clearActionResult(),this.currentGame&&this.currentGame.activePlayer&&this.currentGame.activePlayer.IncomeShare>=R.INCOME_SHARE_WIN){be(this.currentGame.activePlayer.name,R.INCOME_SHARE_WIN*100,()=>{this.canceled=!0}),this.canceled=!0;return}if(this.renderMainGui(this.rootContainer,this.currentGame),this.canceled||!((o=(t=this.currentGame)==null?void 0:t.activePlayer)!=null&&o.isAI))return;const e=this.currentGame.activePlayer.AI;if(!e)return;const n=async()=>{if(this.paused||this.canceled)return;const r=await e.takeAction();this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),r?setTimeout(()=>n(),100):(this.currentGame.nextTurn(),this.markMapDirty(),this.currentGame.activePlayer.isAI?setTimeout(()=>this.turnStarted(),100):this.turnStarted())};n()}async startNewGame(){this.canceled=!0;const e=this.rootContainer,{showNewGameDialog:n}=await V(async()=>{const{showNewGameDialog:t}=await import("./NewGameDialog-vfDKbVZJ.js");return{showNewGameDialog:t}},[]);try{const t=await n(e),o=await V(()=>Promise.resolve().then(()=>_e),void 0),r=await V(()=>Promise.resolve().then(()=>ze),void 0);r.Game.showArmies=t.showArmies;const s=["#4fc3f7","#81c784","#ffb74d","#e57373","#ba68c8","#ffd54f","#64b5f6","#a1887f"],i=o.Player.COLORS??s,d=t.players.map((c,a)=>new o.Player(c.name,i[a%i.length],[],null,[],0,c.isAI));this.currentGame=r.Game.initNewGame(t.map,d,this),this.markMapDirty(),this.getWorldMapCanvas(),this.renderMainGui(e,this.currentGame),this.currentGame&&this.currentGame.players.length>0&&(this.canceled=!1,this.currentGame.activePlayer.startTurn(),this.turnStarted())}catch(t){console.error("NewGameDialog error or cancellation:",t)}}renderMainGui(e,n){if(this.paused)return;const t=this.rootContainer;if(!t)throw new Error("rootContainer is not set (null) in renderMainGui");const o=t.querySelector('div[style*="flex: 3"]');if(o&&o._fishOverlay){const v=o._fishOverlay;typeof v.stop=="function"&&v.stop(),v.overlay&&v.overlay.parentNode&&v.overlay.parentNode.removeChild(v.overlay),o._fishOverlay=null}t.innerHTML="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100vw",r.style.height="100vh",r.style.background="linear-gradient(120deg, #232526 0%, #414345 100%)",r.style.borderRadius="0",r.style.boxShadow="none",r.style.overflow="hidden",r.style.margin="0",r.style.maxWidth="100vw";const s=document.createElement("div");s.style.flex="3",s.style.background="#222",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.position="relative",s.style.borderRight="2px solid #333";let i=null;n&&n.worldMap&&(i=this.getWorldMapCanvas()),this.clickedCountryNames||(this.clickedCountryNames=[]);const d=document.createElement("div");if(d.id="country-info-panel",d.style.background="#a67c52",d.style.border="1px solid #555",d.style.borderRadius="8px",d.style.padding="10px 12px",d.style.marginBottom="18px",d.style.color="#b3e5fc",d.style.fontSize="1.05rem",d.style.minHeight="100px",d.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",d.innerHTML='<span style="color:#888">Click a country to view details.</span>',i){let v=function(){S||(S=document.createElement("canvas"),S.width=i.width,S.height=i.height,S.style.position="absolute",S.style.left="0",S.style.top="0",S.style.pointerEvents="none",S.style.width="100%",S.style.height="100%",s.appendChild(S))},I=function(){if(S){const T=S.getContext("2d");T&&T.clearRect(0,0,S.width,S.height)}};i.style.width="100%",i.style.height="100%",i.style.display="block",s.appendChild(i);let S=null;if(!s._fishOverlay){const T=n.worldMap.getMap(),P=i.width,N=i.height,O=(B,W)=>B<0||W<0||W>=T.length||B>=T[0].length?!1:T[W][B]===D;s._fishOverlay=new je(s,P,N,O)}this.fishOverlay=s._fishOverlay,i._countryClickHandler&&i.removeEventListener("mousedown",i._countryClickHandler);const A=T=>{if(this.paused)return;const P=i.width,N=i.height,O=Math.floor(T.offsetX*(P/i.clientWidth)),B=Math.floor(T.offsetY*(N/i.clientHeight)),W=n.worldMap.getMap(),de=n.worldMap.getCountries();let G=null;if(O>=0&&B>=0&&B<W.length&&O<W[0].length){const le=W[B][O];if(le>=0&&de[le]){if(G=de[le],G.coordinates.some(([E,U])=>E===O&&U===B)||console.warn(`[GameGui] Click at (${O},${B}) is not in coordinates of country: ${G.name}`),this.clickedCountryNames.push(G.name),v(),I(),S&&G){const E=S.getContext("2d");if(E){ee.drawCountryGlow(E,G,[0,0,0],G.color);const[U,K]=G.center?G.center():[0,0],ne=G.fortified?"🛡️ "+G.name:G.name;if(E.save(),E.font="bold 10px Verdana, Geneva, sans-serif",E.textAlign="center",E.textBaseline="middle",E.lineWidth=3,E.strokeStyle="black",E.strokeText(ne,U,K),E.fillStyle="white",E.fillText(ne,U,K),R.showArmies&&typeof G.armies=="number"){const fe=`${Math.round(G.armies/1e3)}k`;E.font="bold 9px Verdana, Geneva, sans-serif",E.lineWidth=2,E.strokeStyle="black",E.strokeText(fe,U,K+13),E.fillStyle="#FFD700",E.fillText(fe,U,K+13)}E.restore()}}this.updateActionButtons();const he=document.getElementById("country-info-panel");if(he&&n&&n.activePlayer&&typeof n.gameTurn=="number"){const E=n.activePlayer.getCountryInfo(G,n.gameTurn),U=G.unrestLevel>0?"color: red; font-style: italic;":"",K=G.unrestLevel>0?'<div style="color: red; font-style: italic;">Rioting</div>':"",ne=G.unrestLevel>0?"color: red; text-decoration: line-through;":"";he.innerHTML=`
                <div><b>Name:</b> <span style="${U}">${E.name}</span></div>
                <div><b>Owner:</b> ${E.owner?E.owner.name:"None"}</div>
                <div><b>Income:</b> <span style="${ne}">${E.income!==void 0?E.income:"?"}</span></div>
                <div><b>Army:</b> ${E.army!==void 0?E.army:"?"}</div>
                <div><b>Recency:</b> ${E.recency!==void 0?E.recency:"?"}</div>
                ${K}
              `}const ue=document.getElementById("last-clicked-country-info-panel");if(ue&&n&&n.activePlayer&&typeof n.gameTurn=="number"){const E=n.activePlayer.getCountryInfo(G,n.gameTurn);ue.innerHTML=`
                <b>Last Clicked Country Info</b><br>
                <div><b>Name:</b> ${E.name}</div>
                <div><b>Owner:</b> ${E.owner?E.owner.name:"None"}</div>
                <div><b>Income:</b> ${E.income!==void 0?E.income:"?"}</div>
                <div><b>Army:</b> ${E.army!==void 0?E.army:"?"}</div>
                <div><b>Recency:</b> ${E.recency!==void 0?E.recency:"?"}</div>
              `}}}};i.addEventListener("mousedown",A),i._countryClickHandler=A}else{const v=document.createElement("div");v.style.width="100%",v.style.height="100%",v.style.background="repeating-linear-gradient(135deg,#444 0 10px,#333 10px 20px)",v.style.border="4px solid #666",v.style.borderRadius="12px",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center";const I=document.createElement("img");I.src="riskStartup.png",I.alt="Risk Startup",I.style.width="100%",I.style.height="100%",I.style.objectFit="cover",I.style.borderRadius="8px",v.appendChild(I),s.appendChild(v)}const c=document.createElement("div"),a=document.createElement("div");a.style.display="flex",a.style.flexDirection="row",a.style.justifyContent="center",a.style.alignItems="center",a.style.gap="18px",a.style.marginBottom="24px",a.style.width="100%",a.style.minWidth="0";function l(v,I,S){const A=document.createElement("img");return A.src=v,A.alt=I,A.style.flex="1 1 0",A.style.width="0",A.style.minWidth="0",A.style.height="auto",A.style.objectFit="contain",A.style.cursor="pointer",A.style.borderRadius="8px",A.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",A.style.transition="transform 0.1s, box-shadow 0.1s",A.addEventListener("mouseenter",()=>{A.style.transform="scale(1.08)",A.style.boxShadow="0 4px 16px #ffd700"}),A.addEventListener("mouseleave",()=>{A.style.transform="scale(1)",A.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)"}),A.onclick=S,A.style.display="block",A.style.margin="0 0",A}const h=l("newgame.png","New Game",()=>this.startNewGame()),f=l("savegame.png","Save Game",()=>{try{if(!this.currentGame)throw new Error("No game to save");const v=ge.serialize(this.currentGame),I=new Blob([v],{type:"application/json"}),S=URL.createObjectURL(I),A=document.createElement("a");A.href=S,A.download="armchair-general-save.json",document.body.appendChild(A),A.click(),setTimeout(()=>{document.body.removeChild(A),URL.revokeObjectURL(S)},100)}catch(v){throw alert("Save failed: "+(v&&v.message?v.message:v)),v}}),g=l("loadgame.png","Load Game",()=>{const v=document.createElement("input");v.type="file",v.accept=".json,application/json",v.onchange=I=>{const S=I.target.files[0];if(!S)return;const A=new FileReader;A.onload=()=>{try{const T=A.result,P=ge.deserialize(T);P.gui=this;for(const N of P.players)N.game=P,N.isAI&&N.AI&&(N.AI.game=P,N.AI.player=N);this.currentGame=P,this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted()}catch(T){throw alert("Load failed: "+(T&&T.message?T.message:T)),T}},A.readAsText(S)},v.click()});a.appendChild(h),a.appendChild(f),a.appendChild(g),c.appendChild(a),c.appendChild(d),c.style.flex="1",c.style.background="#3b2412",c.style.display="flex",c.style.flexDirection="column",c.style.padding="32px 24px",c.style.color="#fff",c.style.minWidth="320px",c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif";const m=document.createElement("div");m.style.marginBottom="32px";const C=document.createElement("div");if(C.style.fontSize="1.2rem",C.style.fontWeight="bold",n&&n.players&&n.players.length>0){const v=n.activePlayer;C.textContent=`Turn: ${n.gameTurn} | Player: ${v.name}`;const I=document.createElement("div"),S=v.constructor.ACTIONS_PER_TURN||5,A=v.actionsLeft;I.style.margin="8px 0 0 0",I.style.fontSize="2rem",I.style.letterSpacing="0.2rem";for(let T=0;T<S;T++){const P=document.createElement("span");P.textContent=T<A?"★":"☆",P.style.color=T<A?"#ffd700":"#888",I.appendChild(P)}I.title=`${A} of ${S} actions remaining`,m.appendChild(I)}else C.textContent="No game loaded. Start a new game to play!";if(m.appendChild(C),c.appendChild(m),n&&n.players&&n.players.length>0){const v=document.createElement("div");v.textContent="Players",v.style.fontWeight="bold",v.style.marginBottom="8px",c.appendChild(v);const I=document.createElement("ul");I.style.listStyle="none",I.style.padding="0",I.style.margin="0 0 24px 0";for(const S of n.players){const A=document.createElement("li");A.style.display="flex",A.style.alignItems="center",A.style.marginBottom="8px",S===n.activePlayer&&(A.style.boxShadow="0 0 16px 4px #ffd700, 0 0 4px 2px #fff",A.style.border="2px solid #ffd700",A.style.borderRadius="12px",A.style.background="rgba(255, 215, 0, 0.10)");const T=document.createElement("span");T.style.display="inline-block",T.style.width="16px",T.style.height="16px",T.style.borderRadius="50%",T.style.background=S.color,T.style.marginRight="8px",A.appendChild(T);const P=document.createElement("span");if(P.textContent=S.name+(S.isAI?" (AI)":""),P.style.flex="1",A.appendChild(P),typeof S.money=="number"){const N=document.createElement("span");N.textContent=`💰 ${S.money}`,N.style.marginLeft="8px",A.appendChild(N);const O=document.createElement("span");O.style.display="inline-block",O.style.width="54px",O.style.height="12px",O.style.marginLeft="8px",O.style.verticalAlign="middle",O.style.background="#222",O.style.border="1px solid #444",O.style.borderRadius="6px",O.style.overflow="hidden";const B=document.createElement("span"),W=Math.min(S.IncomeShare/R.INCOME_SHARE_WIN,1);B.style.display="inline-block",B.style.height="100%",B.style.width=`${Math.round(W*100)}%`,B.style.background=W>=1?"linear-gradient(90deg,#43cea2,#ffd700)":"linear-gradient(90deg,#43cea2,#185a9d)",B.style.transition="width 0.3s",O.title=`Income share: ${(S.IncomeShare*100).toFixed(1)}% (win at ${(R.INCOME_SHARE_WIN*100).toFixed(0)}%)`,O.appendChild(B),A.appendChild(O)}I.appendChild(A)}c.appendChild(I)}const y=document.createElement("div");y.id="action-result-panel",y.style.background="#a67c52",y.style.border="1px solid #555",y.style.borderRadius="8px",y.style.padding="10px 12px",y.style.marginBottom="18px",y.style.color="#fff",y.style.fontSize="1.05rem",y.style.minHeight="60px",y.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",y.innerHTML='<span style="color:#888">No recent action.</span>',c.appendChild(y);const w=document.createElement("div");w.id="action-panel",w.style.display="flex",w.style.flexDirection="row",w.style.alignItems="flex-start",w.style.background="#a67c52",w.style.border="1px solid #555",w.style.borderRadius="8px",w.style.padding="16px 12px",w.style.marginTop="auto",w.style.marginBottom="18px",w.style.minHeight="120px";const u=document.createElement("div");u.id="action-buttons-area",u.style.display="flex",u.style.flexDirection="column",u.style.gap="12px",u.style.flex="0 1 80%",u.style.maxWidth="80%";const p=document.createElement("div");p.style.flex="1 1 20%",p.style.display="flex",p.style.alignItems="flex-end",p.style.justifyContent="center",p.style.height="100%",p.style.marginLeft="12px";const x=document.createElement("img");x.src="Advisor.png",x.alt="Advisor",x.style.maxWidth="100%",x.style.maxHeight="96px",x.style.objectFit="contain",x.style.borderRadius="6px",p.appendChild(x),w.appendChild(u),w.appendChild(p),c.appendChild(w);const M=document.createElement("button");M.textContent="End Turn",M.classList.add("persistent-action-btn"),M.style.padding="12px 0",M.style.fontSize="1.1rem",M.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",M.style.color="#fff",M.style.border="none",M.style.borderRadius="8px",M.style.cursor="pointer",M.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",M.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",M.style.marginBottom="18px",M.onclick=()=>{this.paused||this.currentGame&&(this.currentGame.nextTurn(),this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted())},c.appendChild(M),r.appendChild(s),r.appendChild(c),t.appendChild(r),x.addEventListener("click",async()=>{var P;const v=(P=this.currentGame)==null?void 0:P.activePlayer;if(!v||!v.AI)return;v.AI.game=this.currentGame;const I=v.AI.findBestOpportunity(),S=document.getElementById("action-result-panel");if(!I){S&&(S.innerHTML='<span style="color:#fff">Sorry, sir, I have no idea what to do!</span>');return}this.currentGame&&(this.currentGame.advisedOpportunity=I);const{runAdvisorAnimation:A}=await V(async()=>{const{runAdvisorAnimation:N}=await import("./AdvisorAnimation-rb4PdAq1.js");return{runAdvisorAnimation:N}},[]);await A(this,I);let T=I.action.ActionString(I.countries,v,this.currentGame,I.amount);if(T.length>0&&(T=T.charAt(0).toLowerCase()+T.slice(1)),S&&(S.innerHTML=`<span style="color:#fff">I think, ${T} would be a good idea.</span>`),S){const N=S.style.background;S.style.transition="background 0.2s",S.style.background="#ffd700",setTimeout(()=>{S.style.background=N},200)}})}setClickedCountryNames(e){this.clickedCountryNames=e}};b(Z,"_instance",null);let X=Z;function Ke(k,e){const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.width="100%",n.style.height="100%",n.style.zIndex="10000",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="none",n.style.overflow="hidden";const t=document.createElement("div");t.innerText="Armchair",t.style.position="relative",t.style.color="#fffbe6",t.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',t.style.fontSize="6vw",t.style.fontWeight="bold",t.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",t.style.letterSpacing="0.18em",t.style.opacity="0",t.style.transform="translateX(-120%) skew(-12deg)",t.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",t.style.filter="drop-shadow(0 0 12px #fffbe6)",t.style.background="",t.style.webkitBackgroundClip="",t.style.backgroundClip="",t.style.webkitTextFillColor="";const o=document.createElement("div");o.innerText="General",o.style.position="relative",o.style.color="#fffbe6",o.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',o.style.fontSize="6vw",o.style.fontWeight="bold",o.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",o.style.letterSpacing="0.18em",o.style.opacity="0",o.style.transform="translateX(120%) skew(12deg)",o.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",o.style.filter="drop-shadow(0 0 12px #fffbe6)",o.style.background="",o.style.webkitBackgroundClip="",o.style.backgroundClip="",o.style.webkitTextFillColor="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="1vw",r.style.pointerEvents="none",r.appendChild(t),r.appendChild(o),n.appendChild(r),k.appendChild(n);const s=document.createElement("canvas");s.width=k.offsetWidth||800,s.height=k.offsetHeight||600,s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",n.appendChild(s);const i=s.getContext("2d"),d=10,c=[];s.width/2;const a=s.height*.8;for(let m=0;m<d;m++){const y=m%2===0?s.width*.05:s.width*.95,w=s.width*(.15+.7*Math.random()),u=a-s.height*.25+Math.random()*s.height*.1,p=a-s.height*.05+Math.random()*s.height*.18,x=1200+Math.random()*400,M=s.height*(.32+Math.random()*.12);c.push({startX:y,startY:u,endX:w,endY:p,duration:x,startTime:null,exploded:!1,explosionTime:null,arcHeight:M})}function l(m,C,y){i&&(i.save(),i.beginPath(),i.arc(m,C,18*y,0,2*Math.PI),i.fillStyle="rgba(40,40,40,0.95)",i.shadowColor="#222",i.shadowBlur=12*y,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(m-6*y,C-6*y,5*y,0,2*Math.PI),i.fillStyle="rgba(200,200,200,0.18)",i.fill(),i.restore())}function h(m,C,y){if(i){if(y<.15){const w=38+60*y;i.save(),i.beginPath(),i.arc(m,C,w,0,2*Math.PI),i.fillStyle=`rgba(255,255,220,${.7*(1-y/.15)})`,i.shadowColor="#fffbe6",i.shadowBlur=48,i.fill(),i.restore()}if(y<.6){const w=32+80*y;i.save(),i.beginPath(),i.arc(m,C,w,0,2*Math.PI),i.fillStyle=`rgba(255,120,40,${.5*(1-y/.6)})`,i.shadowColor="#ffae42",i.shadowBlur=32,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(m,C,w*.5,0,2*Math.PI),i.fillStyle=`rgba(255,220,120,${.7*(1-y/.6)})`,i.shadowColor="#fffbe6",i.shadowBlur=16,i.fill(),i.restore()}if(y>.2){const w=(y-.2)/.8;for(let u=0;u<4;u++){const p=Math.PI*2*(u/4)+Math.random()*.2,x=38+60*y+Math.random()*10,M=m+Math.cos(p)*x*.7*w,v=C+Math.sin(p)*x*.5*w+10*w;i.save(),i.beginPath(),i.arc(M,v,18+18*w,0,2*Math.PI),i.fillStyle=`rgba(80,60,40,${.18*(1-w)})`,i.shadowColor="#222",i.shadowBlur=8,i.fill(),i.restore()}}}}function f(m){i.clearRect(0,0,s.width,s.height);let C=!0;for(const y of c){y.startTime||(y.startTime=m);const w=m-y.startTime;if(y.exploded){if(y.explosionTime&&m-y.explosionTime<700){const u=(m-y.explosionTime)/700;h(y.endX,y.endY,u),C=!1}}else{C=!1;const u=Math.min(w/y.duration,1),p=y.startX+(y.endX-y.startX)*u,x=(1-u)*y.startY+u*y.endY-y.arcHeight*4*u*(1-u),M=.9+.3*(1-Math.abs(2*u-1));l(p,x,M),u>=1&&(y.exploded=!0,y.explosionTime=m)}}C||requestAnimationFrame(f)}requestAnimationFrame(f),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(0) skew(0)",o.style.opacity="1",o.style.transform="translateX(0) skew(0)"},400),setTimeout(()=>{},3200);const g=document.createElement("link");g.rel="stylesheet",g.href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=UnifrakturCook:wght@700&display=swap",document.head.appendChild(g)}const oe=document.getElementById("app");if(oe)oe.innerHTML="",new X().mount(oe),setTimeout(()=>{const e=oe.querySelector('div[style*="flex: 3"]');e&&Ke(e)},0);else throw new Error("No app element found in index.html");export{ae as C,Y as P,ee as R,ce as W};
