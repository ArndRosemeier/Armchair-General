var dt=Object.defineProperty;var ht=(S,e,t)=>e in S?dt(S,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):S[e]=t;var b=(S,e,t)=>ht(S,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const ut="modulepreload",ft=function(S){return"/Armchair-General/"+S},We={},pe=function(e,t,n){let o=Promise.resolve();if(t&&t.length>0){let r=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=r(t.map(l=>{if(l=ft(l),l in We)return;We[l]=!0;const c=l.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":ut,c||(h.as="script"),h.crossOrigin="",h.href=l,a&&h.setAttribute("nonce",a),document.head.appendChild(h),c)return new Promise((f,x)=>{h.addEventListener("load",f),h.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return o.then(r=>{for(const i of r||[])i.status==="rejected"&&s(i.reason);return e().catch(s)})};class yt{constructor(e=[]){b(this,"countries");this.countries=e}}const Xe=Math.sqrt(3),mt=.5*(Xe-1),ge=(3-Xe)/6,He=S=>Math.floor(S)|0,je=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function Te(S=Math.random){const e=pt(S),t=new Float64Array(e).map(o=>je[o%12*2]),n=new Float64Array(e).map(o=>je[o%12*2+1]);return function(s,r){let i=0,a=0,l=0;const c=(s+r)*mt,d=He(s+c),h=He(r+c),f=(d+h)*ge,x=d-f,u=h-f,w=s-x,g=r-u;let p,y;w>g?(p=1,y=0):(p=0,y=1);const m=w-p+ge,v=g-y+ge,M=w-1+2*ge,T=g-1+2*ge,I=d&255,C=h&255;let A=.5-w*w-g*g;if(A>=0){const P=I+e[C],L=t[P],$=n[P];A*=A,i=A*A*(L*w+$*g)}let k=.5-m*m-v*v;if(k>=0){const P=I+p+e[C+y],L=t[P],$=n[P];k*=k,a=k*k*(L*m+$*v)}let E=.5-M*M-T*T;if(E>=0){const P=I+1+e[C+1],L=t[P],$=n[P];E*=E,l=E*E*(L*M+$*T)}return 70*(i+a+l)}}function pt(S){const t=new Uint8Array(512);for(let n=0;n<512/2;n++)t[n]=n;for(let n=0;n<512/2-1;n++){const o=n+~~(S()*(256-n)),s=t[n];t[n]=t[o],t[o]=s}for(let n=256;n<512;n++)t[n]=t[n-256];return t}function gt(S,e,t,n=1e3){var l;const o=S.length,s=((l=S[0])==null?void 0:l.length)||0,r=Array.from({length:o},()=>Array(s).fill(!1)),i=[[1,0],[-1,0],[0,1],[0,-1]],a=S.map(c=>c.slice());for(let c=0;c<o;c++)for(let d=0;d<s;d++)if(!r[c][d]&&S[c][d]===t){const h=[[c,d]],f=[[c,d]];for(r[c][d]=!0;h.length;){const[x,u]=h.shift();for(const[w,g]of i){const p=x+w,y=u+g;p>=0&&p<o&&y>=0&&y<s&&!r[p][y]&&S[p][y]===t&&(r[p][y]=!0,h.push([p,y]),f.push([p,y]))}}if(f.length<n)for(const[x,u]of f)a[x][u]=e}return a}function wt(S,e,t){var l;const n=S.length,o=((l=S[0])==null?void 0:l.length)||0,s=Array.from({length:n},()=>Array(o).fill(!1)),r=[];for(let c=0;c<o;c++)S[0][c]===e&&(r.push([0,c]),s[0][c]=!0),S[n-1][c]===e&&(r.push([n-1,c]),s[n-1][c]=!0);for(let c=1;c<n-1;c++)S[c][0]===e&&(r.push([c,0]),s[c][0]=!0),S[c][o-1]===e&&(r.push([c,o-1]),s[c][o-1]=!0);const i=[[1,0],[-1,0],[0,1],[0,-1]];for(;r.length;){const[c,d]=r.shift();for(const[h,f]of i){const x=c+h,u=d+f;x>=0&&x<n&&u>=0&&u<o&&!s[x][u]&&S[x][u]===e&&(s[x][u]=!0,r.push([x,u]))}}return S.map((c,d)=>c.map((h,f)=>h===e&&!s[d][f]?t:h))}function xt(S,e){return Ke(S,e,{scale:.0018,threshold:-.05,borderStrength:.5,borderWidth:.15,octaves:6,persistence:.5,seed:Math.floor(Math.random()*1e9)})}function Ke(S,e,t){const n=(t==null?void 0:t.scale)??.015,o=(t==null?void 0:t.threshold)??0,s=(t==null?void 0:t.seed)!==void 0?vt(t.seed):Math.random,r=Te(s),i=(t==null?void 0:t.borderStrength)??.5,a=(t==null?void 0:t.borderWidth)??.2,l=(t==null?void 0:t.octaves)??4,c=(t==null?void 0:t.persistence)??.5,d=[];for(let f=0;f<e;f++){const x=[];for(let u=0;u<S;u++){const w=u-S/2,g=f-e/2;let p=0,y=0,m=1,v=1;for(let A=0;A<l;A++)p+=r(w*n*m,g*n*m)*v,y+=v,v*=c,m*=2;p/=y;const M=Math.min(u,S-1-u)/(S/2),T=Math.min(f,e-1-f)/(e/2),I=Math.min(M,T);let C=p;if(I<a){const A=i*(1-I/a);C=p*(1-A)+Q*A}x.push(C>o?ne:Q)}d.push(x)}let h=wt(d,Q,ne);return h=gt(h,Q,ne,1e3),h}function vt(S){return function(){let e=S+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class Ie{constructor(e,t=null,n=0,o=0){b(this,"name");b(this,"owner");b(this,"armies");b(this,"income");b(this,"coordinates");b(this,"border");b(this,"oceanBorder");b(this,"neighbors");b(this,"color");b(this,"fortified",!1);b(this,"nationalPride");b(this,"unrestLevel",0);b(this,"_center",null);this.name=e,this.owner=t,this.armies=n,this.income=o,this.coordinates=[],this.border=[],this.oceanBorder=[],this.neighbors=[],this.color=[Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150)];const s=1e3,r=1e5,i=Math.random()*Math.random();this.nationalPride=Math.floor(s+(r-s)*i),this.unrestLevel=0}setOwner(e){this.owner=e}setArmies(e){this.armies=e}center(){if(this._center)return this._center;if(!this.coordinates.length)return this._center=[0,0],this._center;let e=0,t=0;for(const[n,o]of this.coordinates)e+=n,t+=o;return this._center=[e/this.coordinates.length,t/this.coordinates.length],this._center}canBeFortified(){if(this.fortified)return!1;if(this.owner){for(const[e,t]of this.owner.plannedFortifications)if(e===this)return!1}return!0}toJSON(){return{id:this.name,name:this.name,ownerId:this.owner?this.owner.name:null,armies:this.armies,income:this.income,coordinates:this.coordinates,border:this.border,oceanBorder:this.oceanBorder,neighborIds:this.neighbors.map(e=>e.name),color:this.color,fortified:this.fortified,nationalPride:this.nationalPride,unrestLevel:this.unrestLevel}}static fromJSON(e,t,n){const o=new Ie(e.name,null,e.armies,e.income);return o.coordinates=e.coordinates,o.border=e.border,o.oceanBorder=e.oceanBorder,o.color=e.color,o.fortified=e.fortified,o.nationalPride=e.nationalPride??1e3,o.unrestLevel=e.unrestLevel??0,o._ownerId=e.ownerId,o._neighborIds=e.neighborIds,n[e.name]=o,o}resolveReferences(e,t){this.owner=this._ownerId?e[this._ownerId]:null,this.neighbors=(this._neighborIds||[]).map(n=>t[n]).filter(Boolean),delete this._ownerId,delete this._neighborIds}}class Ct{static generateCountriesMap(e,t={}){if(!e||e.length===0||!e[0])throw new Error("continentMap must be a non-empty 2D array");const n=e.length,o=e[0].length,s=t.countryCount??12,r=t.scale??.09,i=t.minResistance??10,a=t.maxResistance??50,l=t.skipProbability??.9,c=t.seed!==void 0?bt(t.seed):Math.random,d=Te(c),h=[];for(let y=0;y<n;y++){const m=[];for(let v=0;v<o;v++)m.push(e[y][v]===ne?i+(a-i)*Math.abs(d(v*r,y*r)):1/0);h.push(m)}const f=[],x=[];for(let y=0;y<n;y++)for(let m=0;m<o;m++)e[y][m]===ne&&x.push([m,y]);for(let y=0;y<s&&x.length>0;y++){const m=Math.floor(c()*x.length),[v,M]=x.splice(m,1)[0];f.push({x:v,y:M,idx:y})}for(let y=0;y<n;y++)for(let m=0;m<o;m++)e[y][m]!==Q&&(e[y][m]=ne);for(const{x:y,y:m,idx:v}of f)e[m][y]=v;const u=f.map(({x:y,y:m,idx:v})=>[y,m,v]),w=(i+a)/2;for(;u.length>0;){const y=Math.floor(c()*u.length),[m,v,M]=u.splice(y,1)[0],T=[];for(const[I,C]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=m+I,k=v+C;A>=0&&A<o&&k>=0&&k<n&&e[k][A]===ne&&T.push([A,k])}if(T.length!==0)for(const[I,C]of T)h[C][I]>w&&c()<l||(e[C][I]=M,u.push([I,C,M]))}const g=Array.from({length:n},()=>Array(o).fill(!1));let p=0;for(let y=0;y<n;y++)for(let m=0;m<o;m++)e[y][m]>=0&&e[y][m]+1>p&&(p=e[y][m]+1);for(let y=0;y<n;y++)for(let m=0;m<o;m++)if(e[y][m]===ne&&!g[y][m]){const v=[[m,y]];for(g[y][m]=!0;v.length>0;){const[M,T]=v.pop();e[T][M]=p;for(const[I,C]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=M+I,k=T+C;A>=0&&A<o&&k>=0&&k<n&&e[k][A]===ne&&!g[k][A]&&(v.push([A,k]),g[k][A]=!0)}}p++}return e}static generateCountriesInternal(e,t){const n=this.generateCountriesMap(e,t);if(!n||n.length===0||!n[0])throw new Error("map must be a non-empty 2D array");const o=n.length,s=n[0].length,r={};for(let l=0;l<o;l++)for(let c=0;c<s;c++){const d=n[l][c];if(d>=0){if(!r[d]){const h=new Ie(`Country ${d}`);h.id=d,r[d]=h}r[d].coordinates.push([c,l])}}const i=Math.max(...Object.keys(r).map(Number)),a=Array.from({length:i+1},(l,c)=>r[c]);return this.findCountryBorders(n,a,s,o),{map:n,countries:a}}static findCountryBorders(e,t,n,o){const s=[[1,0],[0,1],[-1,0],[0,-1]];for(const r of t){const i=r.id;r.border=[],r.oceanBorder=[];for(const[a,l]of r.coordinates){let c=!1,d=!1;for(const[h,f]of s){const x=a+h,u=l+f;(x<0||x>=n||u<0||u>=o||e[u][x]!==i)&&(c=!0,(x<0||x>=n||u<0||u>=o||e[u][x]===Q)&&(d=!0))}c&&r.border.push([a,l]),d&&r.oceanBorder.push([a,l])}}}static findNeighbors(e){const t=new Map;for(const n of e)for(const[o,s]of n.border)t.set(`${o},${s}`,n);for(const n of e){const o=new Set;for(const[s,r]of n.border)for(const[i,a]of[[1,0],[0,1],[-1,0],[0,-1]]){const l=s+i,c=r+a,d=t.get(`${l},${c}`);d&&d!==n&&o.add(d)}n.neighbors=Array.from(o)}}static mergeSmallCountries(e,t=1e3,n){let o=!0;for(;o;){o=!1;for(let s=e.length-1;s>=0;s--){const r=e[s];if(r.coordinates.length<t&&r.neighbors.length>0){let i=r.neighbors[0];for(const a of r.neighbors)a.coordinates.length<i.coordinates.length&&(i=a);if(i.coordinates.push(...r.coordinates),n&&i.id!==void 0&&r.id!==void 0)for(const[a,l]of r.coordinates)n[l][a]=i.id;e.splice(s,1),o=!0}}o&&(this.findNeighbors(e),console.log("Merged countries"))}}static generateCountries(e,t={}){const{map:n,countries:o}=this.generateCountriesInternal(e,t);this.findNeighbors(o);const s=(t==null?void 0:t.minCountrySize)??1e3;if(this.mergeSmallCountries(o,s,n),!n||n.length===0||!n[0])throw new Error("map must be a non-empty 2D array");const r=n[0].length,i=n.length;return this.findCountryBorders(n,o,r,i),this.findNeighbors(o),{map:n,countries:o}}}function bt(S){return function(){let e=S+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function Mt(S,e){return Ct.generateCountries(S,{countryCount:e,minResistance:0,maxResistance:130,skipProbability:0})}const Q=-1,ne=-2,re=class re{constructor(e,t,n=[]){b(this,"countries");b(this,"map");b(this,"continents",[]);this.countries=n,this.map=re.createOceanMap(e,t)}static logCountryNamesInOrder(e,t=""){const n=e.map((o,s)=>`${s}: ${o.name}`);console.log(`[WorldMap] Country order${t?" - "+t:""}:
`+n.join(", "))}static checkMapCountryConsistency(e,t){if(!Array.isArray(e)||!Array.isArray(t))return console.error("[WorldMap] Consistency check failed: map or countries not arrays"),!1;let n=!0;for(let o=0;o<e.length;++o)for(let s=0;s<e[o].length;++s){const r=e[o][s];r>=0&&(t[r]?typeof t[r].name!="string"&&(console.error(`[WorldMap] Inconsistent: countries[${r}] has no valid name at map[${o}][${s}]`),n=!1):(console.error(`[WorldMap] Inconsistent: map[${o}][${s}] = ${r}, but countries[${r}] is undefined`),n=!1))}return n}assignRandomCountryNames(){let e=!1;for(;!e;){const t=new Set;for(const n of this.countries){let o,s=0;do if(o=re.generateRandomName(),s++,s>1e3)throw new Error("Failed to generate unique random country names");while(t.has(o));n.name=o,t.add(o)}e=t.size===this.countries.length}}assignRealCountryNames(){let e=!1;for(;!e;){const t=[...re.REAL_COUNTRY_NAMES],n=new Set;for(const o of this.countries){let s;if(t.length>0){const r=Math.floor(Math.random()*t.length);s=t.splice(r,1)[0]}else{let r=0;do if(s=re.generateRandomName(),r++,r>1e3)throw new Error("Failed to generate unique fallback country names");while(n.has(s))}o.name=s,n.add(s)}e=n.size===this.countries.length}}static generateRandomName(){const e=["zan","mor","vek","tal","rin","dor","lek","sha","val","nor","ka","bel","dra","sil","tur","gar","fen","mir","sol","vor","lin","sar","qu","zel","ron","bar","zen","tir","lom","kal","vin","lor","mel","dar","gol","han","jor","ken","lun","mar"],t=2+Math.floor(Math.random()*2);let n="";for(let o=0;o<t;o++)n+=e[Math.floor(Math.random()*e.length)];return n.charAt(0).toUpperCase()+n.slice(1)}static createOceanMap(e,t){return Array.from({length:t},()=>Array(e).fill(Q))}static generateContinentsMap(e,t,n){return Ke(e,t,n)}static createMap(e,t,n=40,o=!0){const s=xt(e,t),{map:r,countries:i}=Mt(s,n),a=new re(e,t,i);return a.map=r,o?a.assignRealCountryNames():a.assignRandomCountryNames(),a.regenerateMapFromCountries(a.countries),a.createContinents(),a}addCountry(e){this.countries.push(e)}createContinents(){const e=new Set,t=[];for(const n of this.countries)if(!e.has(n)){const o=[n],s=[];for(e.add(n);o.length>0;){const r=o.shift();s.push(r);for(const i of r.neighbors)e.has(i)||(e.add(i),o.push(i))}t.push(new yt(s))}this.continents=t}getCountries(){return this.countries}distance(e,t){const[n,o]=e.center(),[s,r]=t.center(),i=Math.sqrt((n-s)**2+(o-r)**2);if(e.neighbors.includes(t)||t.neighbors.includes(e))return i;const a=e.oceanBorder&&e.oceanBorder.length>0,l=t.oceanBorder&&t.oceanBorder.length>0;return a&&l?i*3:null}getMap(){return this.map}regenerateMapFromCountries(e){if(!this.map||!Array.isArray(this.map)||this.map.length===0||this.map[0].length===0)throw new Error("WorldMap.map is not initialized or has invalid dimensions");const t=this.map.length,n=this.map[0].length,o=re.createOceanMap(n,t);for(let s=0;s<e.length;++s){const r=e[s];if(!r.coordinates||!Array.isArray(r.coordinates))throw new Error(`Country at index ${s} has no valid coordinates array`);for(const[i,a]of r.coordinates){if(typeof i!="number"||typeof a!="number"||i<0||i>=n||a<0||a>=t)throw new Error(`Country index ${s} has out-of-bounds coordinate (${i}, ${a})`);o[a][i]=s}}this.map=o}};b(re,"REAL_COUNTRY_NAMES",["Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia"]);let Ge=re;function At(S){if(!S.length)throw new Error("No countries provided");let e=0,t=0;for(const r of S)for(const[i,a]of r.coordinates)i>e&&(e=i),a>t&&(t=a);const n=e+1,o=t+1,s=new Ge(n,o,S);return s.regenerateMapFromCountries(S),s.createContinents(),s}const K=class K{static render(e,t=[],n=[],o=!1,s=null){var x;const r=e.getMap(),i=((x=e.getCountries)==null?void 0:x.call(e))||[],a=r.length,l=r[0].length,c=document.createElement("canvas");c.width=l,c.height=a;const d=c.getContext("2d");if(!d)throw new Error("Could not get canvas context");const h=d.createImageData(l,a),f=h.data;for(let u=0;u<a;u++)for(let w=0;w<l;w++){const g=r[u][w],[p,y,m]=K.getRGBForValue(g,i,w,u,r),v=(u*l+w)*4;f[v]=p,f[v+1]=y,f[v+2]=m,f[v+3]=255}if(t&&t.length>0){for(const u of t)if(!(!u||!u.coordinates)){for(const[w,g]of u.coordinates)if(w>=0&&w<l&&g>=0&&g<a){const p=(g*l+w)*4;f[p]=Math.min(255,Math.round(.6*255+.4*f[p])),f[p+1]=Math.min(255,Math.round(.6*255+.4*f[p+1])),f[p+2]=Math.round(.4*f[p+2]),f[p+3]=255}}}for(const u of i){const w=u.owner&&u.owner.homeCountry===u,g=w?[255,140,0]:[0,0,0];for(const[p,y]of u.border||[])if(w)for(let m=-1;m<=1;m++)for(let v=-1;v<=1;v++){const M=p+v,T=y+m;if(M>=0&&M<l&&T>=0&&T<a){const I=(T*l+M)*4;f[I]=g[0],f[I+1]=g[1],f[I+2]=g[2],f[I+3]=255}}else if(p>=0&&p<l&&y>=0&&y<a){const m=(y*l+p)*4;f[m]=g[0],f[m+1]=g[1],f[m+2]=g[2],f[m+3]=255}}d.putImageData(h,0,0),d.save(),d.font="bold 10px MedievalSharp, Verdana, serif",d.textAlign="center",d.textBaseline="middle";for(const u of i){if(!u.name)continue;const[w,g]=u.center?u.center():[0,0],p=u.fortified?"🛡️ "+u.name:u.name;d.lineWidth=3,d.strokeStyle="black",d.strokeText(p,w,g);const y=n.some(M=>M===u);u.unrestLevel>0?(d.font="italic bold 10px MedievalSharp, Verdana, serif",d.fillStyle="#FF0000",d.fillText(p,w,g)):(d.font="bold 10px MedievalSharp, Verdana, serif",d.fillStyle=y?"#90EE90":"white",d.fillText(p,w,g));let m=!1;(o||s&&u.owner===s&&!s.isAI||s&&typeof s.armyKnown=="function"&&s.armyKnown(u)&&!s.isAI)&&(m=!0);let v=13;if(m){const M=u.armies||0,T=`${Math.round(M/1e3)}k`;d.font="bold 9px MedievalSharp, Verdana, serif",d.lineWidth=2,d.strokeStyle="black",d.strokeText(T,w,g+v),d.fillStyle="#FFD700",d.fillText(T,w,g+v),d.font="bold 10px MedievalSharp, Verdana, serif",v+=13}u.unrestLevel>0&&(d.font="italic bold 8px MedievalSharp, Verdana, serif",d.strokeText("Rioting",w,g+v),d.fillStyle="#FF0000",d.fillText("Rioting",w,g+v))}return d.restore(),c}static displayWithPanZoom(e,t,n=512,o=512,s=[]){let r=null,i=K.render(e,[],s);const a=i.width,l=i.height,c=document.createElement("canvas");c.width=n,c.height=o,c.style.border="1px solid #888",t.appendChild(c);const d=c.getContext("2d");if(!d)throw new Error("Could not get canvas context");let h=Math.min(c.width/a,c.height/l),f=(c.width-a*h)/2,x=(c.height-l*h)/2,u=!1,w=0,g=0;function p(){i=K.render(e,r?[r]:[],s),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,c.width,c.height),d.setTransform(h,0,0,h,f,x),d.drawImage(i,0,0)}return c.addEventListener("mousedown",y=>{const m=c.getBoundingClientRect(),v=(y.clientX-m.left-f)/h,M=(y.clientY-m.top-x)/h,T=e.getMap(),I=e.getCountries(),C=Math.floor(v),A=Math.floor(M);let k=null;if(C>=0&&A>=0&&A<T.length&&C<T[0].length){const E=T[A][C];E>=0&&I[E]&&(k=I[E])}if(k){r=k,p();return}u=!0,w=y.clientX,g=y.clientY}),window.addEventListener("mousemove",y=>{if(!u)return;const m=y.clientX-w,v=y.clientY-g;f+=m,x+=v,w=y.clientX,g=y.clientY,p()}),window.addEventListener("mouseup",()=>{u=!1}),c.addEventListener("wheel",y=>{y.preventDefault();const m=y.offsetX,v=y.offsetY,M=Math.exp(-y.deltaY*.001);f=m-(m-f)*M,x=v-(v-x)*M,h*=M,p()}),p(),c}static getRGBForValue(e,t,n,o,s){var r,i,a;if(e===Q){n=n??0,o=o??0,s=s??[];const l=((r=s[0])==null?void 0:r.length)||1024,c=s.length||768,d=o/c;let h=Math.round(30*(1-d)+10*d),f=Math.round(144*(1-d)+80*d),x=Math.round(255*(1-d)+180*d);const u=K._oceanNoise2D(n*.03,o*.03),w=Math.floor(18*u);h+=w,f+=w,x+=w;let g=!1;if(s&&n>0&&o>0&&n<l-1&&o<c-1)for(const[p,y]of[[1,0],[-1,0],[0,1],[0,-1]]){const m=n+p,v=o+y;if(s[v][m]!==Q){g=!0;break}}return g&&(h=Math.min(255,h+40),f=Math.min(255,f+40),x=Math.min(255,x+40)),[h,f,x]}if(e===ne){n=n??0,o=o??0,s=s??[];const l=((i=s[0])==null?void 0:i.length)||1024,c=s.length||768,d=K._landNoise2D(n*.04,o*.04),h=[34,139,34],f=[80,180,80],x=.5+.5*d;let u=Math.round(h[0]*(1-x)+f[0]*x),w=Math.round(h[1]*(1-x)+f[1]*x),g=Math.round(h[2]*(1-x)+f[2]*x),p=!1;if(s&&n>0&&o>0&&n<l-1&&o<c-1)for(const[y,m]of[[1,0],[-1,0],[0,1],[0,-1]]){const v=n+y,M=o+m;if(s[M][v]===Q){p=!0;break}}return p&&(u=Math.min(255,u+30),w=Math.min(255,w+30),g=Math.min(255,g+30)),[u,w,g]}if(e>=0){const l=t[e];let c=[200,200,200];if(l)if(l.owner&&typeof l.owner.RGBColor=="string"){const I=l.owner.RGBColor.split(",").map(Number);I.length===3&&I.every(C=>!isNaN(C))&&(c=[I[0],I[1],I[2]])}else l.color&&(c=l.color);n=n??0,o=o??0,s=s??[];const d=((a=s[0])==null?void 0:a.length)||1024,h=s.length||768,f=K._landNoise2D(n*.02,o*.02),x=Math.round(18*f),u=c,w=[Math.max(0,c[0]-32),Math.max(0,c[1]-48),Math.max(0,c[2]-32)],g=.5+.5*f;let p=Math.round(u[0]*(1-g)+w[0]*g)+x,y=Math.round(u[1]*(1-g)+w[1]*g)+x,m=Math.round(u[2]*(1-g)+w[2]*g)+x;const v=K._landNoise2D(n*.006+100,o*.006+100),M=Math.round(18*v);p=Math.min(255,Math.max(0,p+M)),y=Math.min(255,Math.max(0,y+M)),m=Math.min(255,Math.max(0,m+M));let T=!1;if(s&&n>0&&o>0&&n<d-1&&o<h-1)for(const[I,C]of[[1,0],[-1,0],[0,1],[0,-1]]){const A=n+I,k=o+C;if(s[k][A]===Q){T=!0;break}}return T&&(p=Math.min(255,p+12),y=Math.min(255,y+12),m=Math.min(255,m+12)),[p,y,m]}return[255,255,255]}static drawCountryGlow(e,t,n,o){function s(i,a,l){return[Math.round(i[0]+(a[0]-i[0])*l),Math.round(i[1]+(a[1]-i[1])*l),Math.round(i[2]+(a[2]-i[2])*l)]}let r=new Set(t.coordinates.map(([i,a])=>`${i},${a}`));for(let i=0;i<10;++i){const a=[];for(const d of r){const[h,f]=d.split(",").map(Number),x=[[h-1,f],[h+1,f],[h,f-1],[h,f+1]];for(const[u,w]of x)if(!r.has(`${u},${w}`)){a.push([h,f]);break}}const l=i/9,c=s(n,o,l);e.save(),e.fillStyle=`rgb(${c[0]},${c[1]},${c[2]})`;for(const[d,h]of a)e.fillRect(d,h,1,1);e.restore();for(const[d,h]of a)r.delete(`${d},${h}`);if(r.size===0)break}e.save();for(const i of r){const[a,l]=i.split(",").map(Number);let c=[200,200,200];if(t)if(t.owner&&typeof t.owner.RGBColor=="string"){const v=t.owner.RGBColor.split(",").map(Number);v.length===3&&v.every(M=>!isNaN(M))&&(c=[v[0],v[1],v[2]])}else t.color&&(c=t.color);const d=K._landNoise2D(a*.02,l*.02),h=Math.round(18*d),f=c,x=[Math.max(0,c[0]-32),Math.max(0,c[1]-48),Math.max(0,c[2]-32)],u=.5+.5*d;let w=Math.round(f[0]*(1-u)+x[0]*u)+h,g=Math.round(f[1]*(1-u)+x[1]*u)+h,p=Math.round(f[2]*(1-u)+x[2]*u)+h;const y=K._landNoise2D(a*.006+100,l*.006+100),m=Math.round(18*y);w=Math.min(255,Math.max(0,w+m)),g=Math.min(255,Math.max(0,g+m)),p=Math.min(255,Math.max(0,p+m)),e.fillStyle=`rgb(${w},${g},${p})`,e.fillRect(a,l,1,1)}e.restore()}};b(K,"drawBorders",!0),b(K,"_oceanNoise2D",Te()),b(K,"_landNoise2D",Te());let xe=K;class fe{RequiresAmount(e,t,n){return null}}class X{constructor(e,t,n,o,s=null){b(this,"countries");b(this,"amount");b(this,"action");b(this,"score");b(this,"followUp");this.countries=e,this.amount=t,this.action=n,this.score=o,this.followUp=s}}class kt{constructor(e,t,n){b(this,"canvas");b(this,"ctx");b(this,"start");b(this,"end");this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Could not get canvas context");this.ctx=o,this.start=t,this.end=n}draw(){const e=this.ctx,{start:t,end:n}=this,o=(t.x+n.x)/2,s=(t.y+n.y)/2,r=n.x-t.x,i=n.y-t.y,a=Math.sqrt(r*r+i*i),l=.25*a,c=-i/a*l,d=r/a*l,h=o+c,f=s+d,x=e.createLinearGradient(t.x,t.y,n.x,n.y);x.addColorStop(0,"#fff"),x.addColorStop(.5,"#0ff"),x.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=12,e.strokeStyle=x,e.beginPath(),e.moveTo(t.x,t.y),e.quadraticCurveTo(h,f,n.x,n.y),e.stroke();const u=.95,w=this.getQuadraticPoint(t,{x:h,y:f},n,u),g=this.getQuadraticTangent(t,{x:h,y:f},n,u);this.drawArrowhead(w,g),e.restore()}getQuadraticPoint(e,t,n,o){const s=(1-o)*(1-o)*e.x+2*(1-o)*o*t.x+o*o*n.x,r=(1-o)*(1-o)*e.y+2*(1-o)*o*t.y+o*o*n.y;return{x:s,y:r}}getQuadraticTangent(e,t,n,o){const s=2*(1-o)*(t.x-e.x)+2*o*(n.x-t.x),r=2*(1-o)*(t.y-e.y)+2*o*(n.y-t.y),i=Math.sqrt(s*s+r*r);return{x:s/i,y:r/i}}drawArrowhead(e,t){const n=this.ctx;n.save(),n.translate(e.x,e.y);const o=Math.atan2(t.y,t.x);n.rotate(o),n.beginPath(),n.moveTo(0,0),n.lineTo(-18,7),n.lineTo(-12,0),n.lineTo(-18,-7),n.closePath(),n.fillStyle="rgba(0,255,255,0.95)",n.shadowColor="#fff",n.shadowBlur=8,n.fill(),n.restore()}}class St{constructor(e,t,n){b(this,"canvas");b(this,"attacker");b(this,"defender");this.canvas=e,this.attacker=t,this.defender=n}async start(){const e=this.canvas.getContext("2d");if(!e)return;const[t,n]=this.attacker.center(),[o,s]=this.defender.center(),r={x:t,y:n},i={x:o,y:s};new kt(this.canvas,r,i);const a=500,l=this.attacker,c=this.defender;return new Promise(d=>{const h=f=>{const u=performance.now()-f,w=Math.min(u/a,1);e.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCountry(e,l,"attacker"),this.drawCountry(e,c,"defender"),this.drawAnimatedArrow(e,r,i,w),w<1?requestAnimationFrame(()=>h(f)):d()};requestAnimationFrame(f=>h(f))})}drawAnimatedArrow(e,t,n,o){const s=(t.x+n.x)/2,r=(t.y+n.y)/2,i=n.x-t.x,a=n.y-t.y,l=Math.sqrt(i*i+a*a),c=.25*l,d=-a/l*c,h=i/l*c,f=s+d,x=r+h,u=e.createLinearGradient(t.x,t.y,n.x,n.y);u.addColorStop(0,"#fff"),u.addColorStop(.5,"#0ff"),u.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=16,e.strokeStyle=u,e.beginPath(),e.moveTo(t.x,t.y);const w=60;for(let g=1;g<=Math.floor(w*o);++g){const p=g/w,y=this.getQuadraticPoint(t,{x:f,y:x},n,p);e.lineTo(y.x,y.y)}if(e.stroke(),o>.05){const g=o,p=this.getQuadraticPoint(t,{x:f,y:x},n,g),y=this.getQuadraticTangent(t,{x:f,y:x},n,g);this.drawArrowhead(e,p,y)}e.restore()}drawCountry(e,t,n){let o;n==="attacker"?o=[180,0,0]:n==="defender"?o=[0,0,180]:o=t.color||[200,200,200],xe.drawCountryGlow(e,t,o,t.color);const[s,r]=t.center?t.center():[0,0],i=t.fortified?"🛡️ "+t.name:t.name;if(e.save(),e.font="bold 10px Verdana, Geneva, sans-serif",e.textAlign="center",e.textBaseline="middle",e.lineWidth=3,e.strokeStyle="black",e.strokeText(i,s,r),e.fillStyle="white",e.fillText(i,s,r),typeof t.armies=="number"&&D.showArmies){const a=`${Math.round(t.armies/1e3)}k`;e.font="bold 9px Verdana, Geneva, sans-serif",e.lineWidth=2,e.strokeStyle="black",e.strokeText(a,s,r+13),e.fillStyle="#FFD700",e.fillText(a,s,r+13)}e.restore()}getQuadraticPoint(e,t,n,o){const s=(1-o)*(1-o)*e.x+2*(1-o)*o*t.x+o*o*n.x,r=(1-o)*(1-o)*e.y+2*(1-o)*o*t.y+o*o*n.y;return{x:s,y:r}}getQuadraticTangent(e,t,n,o){const s=2*(1-o)*(t.x-e.x)+2*o*(n.x-t.x),r=2*(1-o)*(t.y-e.y)+2*o*(n.y-t.y),i=Math.sqrt(s*s+r*r);return{x:s/i,y:r/i}}drawArrowhead(e,t,n){e.save(),e.translate(t.x,t.y);const o=Math.atan2(n.y,n.x);e.rotate(o),e.beginPath(),e.moveTo(0,0),e.lineTo(-18,7),e.lineTo(-12,0),e.lineTo(-18,-7),e.closePath(),e.fillStyle="rgba(0,255,255,0.95)",e.shadowColor="#fff",e.shadowBlur=8,e.fill(),e.restore()}}class Z extends fe{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];if(n.owner!==t||n===o)return null;const s=n.neighbors.includes(o),r=n.oceanBorder.length>0&&o.oceanBorder.length>0;return!s&&!r||o.owner===t?null:`Attack ${o.name} from ${n.name}`}async Act(e,t,n,o=0){var y,m;if(!n)throw new Error("Internal error: currentGame is required.");if(e.length<2)throw new Error("Select source and target countries to attack.");const s=e[e.length-2],r=e[e.length-1];if(s.owner!==t)throw new Error("You must own the attacking country.");const i=s.neighbors.includes(r),a=s.oceanBorder.length>0&&r.oceanBorder.length>0;if(!i&&!a)throw new Error("Target country must be a neighbor or reachable by naval attack.");if(r.owner===t)throw new Error("Cannot attack your own country.");if(o<=0||o>=s.armies)throw new Error("Invalid number of armies committed.");if(!t.game)throw new Error("ActionAttack: activePlayer.game is missing");if(!t.game.gui)throw new Error("ActionAttack: activePlayer.game.gui is missing");const c=t.game.gui.getWorldMapCanvas(),d=c.parentElement;if(!d)throw new Error("ActionAttack: mapCanvas.parentElement is null");d.style.position="relative";let h=document.getElementById("attack-animation-overlay");h&&((y=h.parentElement)==null||y.removeChild(h));let f=document.createElement("canvas");f.id="attack-animation-overlay",f.width=c.width,f.height=c.height,f.style.position="absolute",f.style.left="0",f.style.top="0",f.style.pointerEvents="none",f.style.zIndex="9999",f.style.width="100%",f.style.height="100%",f.style.background="rgba(255,255,255,0.01)",d.appendChild(f),new St(f,s,r).start(),await new Promise(v=>setTimeout(v,0)),await new Promise(v=>setTimeout(v,1e3)),(m=f==null?void 0:f.parentElement)==null||m.removeChild(f);const u=Z.AttackChance(s.armies,r.armies,n.worldMap.distance(s,r)||0,r.fortified,n),w=Math.random(),g=Math.sqrt(Math.abs(w-u));let p="";if(s.armies-=o,w<u){const v=r.owner;v&&(v.ownedCountries=v.ownedCountries.filter(T=>T!==r),v.plannedFortifications=v.plannedFortifications.filter(([T,I])=>T!==r)),r.owner=t,t.ownedCountries.push(r);let M=Math.max(1,Math.round(o*Math.sqrt(g)));M>0&&(M=Math.max(1e3,Math.round(M/1e3)*1e3)),r.armies=M,r.fortified=!1,v&&v.ownedCountries.length===0&&n.players.includes(v)&&(n.players=n.players.filter(T=>T!==v),n.activePlayerIndex>=n.players.length&&(n.activePlayerIndex=0)),t.ownedCountries.length===0&&n.players.includes(t)&&(n.players=n.players.filter(T=>T!==t),n.activePlayerIndex>=n.players.length&&(n.activePlayerIndex=0));for(const T of n.players)T.knowledge=T.knowledge.filter(I=>I.country!==r);p=`Attack successful! ${M} of your ${o} armies occupy ${r.name}.`}else{let v=Math.round(r.armies*Math.sqrt(g));v>0&&(v=Math.max(1e3,Math.round(v/1e3)*1e3)),r.armies=Math.max(1,r.armies-v),r.armies>0&&(r.armies=Math.max(1e3,Math.round(r.armies/1e3)*1e3)),p=`Attack failed! All ${o} attacking armies lost. Defenders lost ${v} troops.`}return p}static AttackChance(e,t,n,o,s){return n===null?0:(t*=n/100,o&&(t*=2),e>=3*t?1:e<=t/3?0:e<t?.5*(e-t/3)/(t-t/3):.5+.5*(e-t)/(2*t))}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Attack"}ActionString(e,t,n,o=0){if(e.length<2)return"Attack: Not enough countries selected.";const s=e[e.length-2];return`Attacking ${e[e.length-1].name} from ${s.name} with ${o} soldiers`}}class ke extends fe{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];return!n||!o||n.owner!==t||o.owner!==t||n===o?null:`Move armies from ${n.name} to ${o.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to move armies.";const s=e[e.length-2],r=e[e.length-1];return s.owner!==t||r.owner!==t?"Both countries must be owned by you.":s===r?"Source and target countries must be different.":o<=0||o>=s.armies?"Invalid number of armies to move.":(s.armies-=o,r.armies+=o,`Moved ${o} armies from ${s.name} to ${r.name}.`)}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Move"}ActionString(e,t,n,o=0){if(e.length<2)return"Move: Not enough countries selected.";const s=e[e.length-2],r=e[e.length-1];return`Moving ${o} armies from ${s.name} to ${r.name}`}}class Je extends fe{GetButtonText(e,t){if(e.length===0)return null;const n=e[e.length-1];return n.canBeFortified()?`Fortify ${n.name}`:null}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length===0)return"Please select a country to fortify.";const s=e[e.length-1];return s.canBeFortified()?t.money<D.fortifyCost?`Not enough money to fortify. You need $${D.fortifyCost}.`:(t.money-=D.fortifyCost,t.plannedFortifications.push([s,n.gameTurn+2]),`Fortification planned for ${s.name} on turn ${n.gameTurn+2}.`):`${s.name} cannot be fortified.`}RequiresAmount(e,t,n){return null}get countryCountNeeded(){return 1}Type(){return"Fortify"}ActionString(e,t,n,o=0){return e.length<1?"Fortify: No country selected.":`Fortifying ${e[e.length-1].name}`}}class Se extends fe{GetButtonText(e,t){if(e.length<1)return null;const n=e[e.length-1];return!n||n.owner!==t?null:`Buy armies for ${n.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<1)return"Select a friendly country to buy armies for.";const s=e[e.length-1];if(s.owner!==t)return"You must own the target country.";if(o<=0)return"Invalid number of armies to buy.";const r=o*D.armyCost;return t.money<r?`Not enough money. Need ${r.toLocaleString()}, have ${t.money.toLocaleString()}.`:(t.money-=r,s.armies+=o,`Bought ${o} armies for ${s.name} at a cost of ${r.toLocaleString()}.`)}RequiresAmount(e,t,n){const o=Math.floor(t.money/D.armyCost/1e3)*1e3;return o<1e3?null:[1e3,o]}get countryCountNeeded(){return 1}Type(){return"BuyArmies"}ActionString(e,t,n,o=0){if(e.length<1)return"Buy Armies: No country selected.";const s=e[e.length-1];return`Buying ${o} soldiers for ${s.name}`}}const te=class te{constructor(e,t){b(this,"player");b(this,"game");b(this,"actionPlan",[]);this.player=e,this.game=t}GetBestArmies(e){return!this.player.ownedCountries||this.player.ownedCountries.length===0?[]:this.player.ownedCountries.slice().sort((t,n)=>(n.armies||0)-(t.armies||0)).slice(0,e)}FindSpyOpportunities(){const e=new Qe,t=[];if(this.player.ownedCountries.length>0){const c=this.player.ownedCountries.reduce((u,w)=>w.armies>u.armies?w:u,this.player.ownedCountries[0]),d=this.game.worldMap,x=d.getCountries().filter(u=>u.owner&&u.owner!==this.player).map(u=>{const w=d.distance(c,u);return w!==null?{country:u,distance:w}:null}).filter(u=>u!==null).sort((u,w)=>u.distance-w.distance).slice(0,3);for(const{country:u,distance:w}of x){if(w>200)continue;const g=this.player.knowledge.find(p=>p.country===u);if(!g||this.game.gameTurn-g.gameTurn>3){const p=u.fortified?D.spyFortifiedCost:D.spyCost;if(this.player.money>=p){t.push(new X([u],0,e,1e4));break}}}}const n=this.getNonOwnedCountriesSortedByDistance(),r=this.game.worldMap.getCountries().filter(c=>c.owner&&c.owner!==this.player),i=Math.min(5,this.player.ownedCountries.length);let a=0;for(const c of r){const d=this.player.knowledge.find(h=>h.country===c);c.owner&&c.owner!==this.player?d&&this.game.gameTurn-d.gameTurn<=3&&a++:c.owner||d&&a++}let l=1;a<i&&(l=10);for(const{country:c,distance:d}of n){const h=this.player.knowledge.find(x=>x.country===c);if(!c.owner&&h||c.owner&&c.owner!==this.player&&h&&this.game.gameTurn-h.gameTurn<=3)continue;let f=3e3-Math.sqrt(d);if(f*=l,f>0){const x=c.fortified?D.spyFortifiedCost:D.spyCost;if(this.player.money>=x){const u=f*(this.player.totalIncome()/5e6);t.push(new X([c],0,e,u))}}}return t}FindAttackOpportunities(){const e=new Z,n=this.game.worldMap.getCountries(),o=[];for(const s of n){if(s.owner===this.player)continue;const[r,i]=this.countryBestAttackerScore(s);if(!r)continue;const a=Math.floor(r.armies*te.ATTACK_COMMIT/1e3)*1e3;a<1e3||o.push(new X([r,s],a,e,i*this.player.aggressivity))}return o}async takeAction(){if(this.player.actionsLeft<=0)return!1;if(this.player.actionsLeft>=4&&Math.random()<.2&&this.actionPlan.length===0)return this.PlanSurpriseAttack(),!0;let e=null;if(this.actionPlan.length>0){e=this.actionPlan.shift();const o=e.action,s=e.countries,r=e.amount;if(o instanceof ke){const i=s[0];if(!i||i.armies<r+1e3)return console.warn("Skipping invalid move from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof Z){const i=s[0],a=s[1];if(!i||!a||a.owner===this.player||i.armies<r)return console.warn("Skipping invalid attack from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof Se&&this.player.money<r*D.armyCost)return console.warn("Skipping invalid buy from actionPlan:",e),this.actionPlan=[],!1}else e=this.findBestOpportunity();if(!e)return!1;const t=await e.action.Act(e.countries,this.player,this.game,e.amount),n=e.countries.slice(-e.action.countryCountNeeded);return this.player.actionLog.push({actionType:e.action.Type(),countries:n,amount:e.amount,result:t??null}),e.followUp&&this.actionPlan.length===0&&this.actionPlan.push(e.followUp),this.player.useAction(),!0}countryDefenseEstimate(e){let t;const n=this.player.knowledge.find(s=>s.country===e),o=e.owner&&e.owner!==this.player;return o&&(!n||this.game.gameTurn-n.gameTurn>3)?t=1e5:!o&&!n?t=7e4:n?t=n.army:t=7e4,e.fortified&&(t*=2),t}countryScore(e){let t;const n=this.player.knowledge.find(s=>s.country===e);n&&typeof n.income=="number"?t=n.income:t=1e6;const o=this.countryDefenseEstimate(e);return t/o}countryBestAttackerScore(e){const t=this.countryDefenseEstimate(e);let n=0,o=null;for(const s of this.player.ownedCountries){const r=this.game.worldMap.distance(s,e);if(r===null)continue;const i=Math.round((s.armies||0)*te.ATTACK_COMMIT/1e3)*1e3;if(i<1e3)continue;const a=Z.AttackChance(i,t,r,!1,this.game);let l=0;a>=.7&&(l=a*a*this.countryScore(e)*1e3),l>n&&(n=l,o=s)}return[o,n]}FindMoveOpportunities(e){const t=[];if(this.player.ownedCountries.length===0)return t;const n=this.player.ownedCountries.reduce((l,c)=>c.armies>l.armies?c:l,this.player.ownedCountries[0]);let o=null,s=-1/0,r=null;for(const l of this.player.ownedCountries){const c=this.getReachableNonOwnedCountries(l);for(const{country:d,distance:h}of c){let f=1;h>100&&(f=Math.max(0,1-(h-100)/900));const x=this.countryScore(d)*f;x>s&&(s=x,o=l,r=d)}}if(o&&o!==n){const l=Math.floor(n.armies*.5/1e3)*1e3;if(l>0&&n!==o){let c=null;if(this.actionPlan.length===0&&r){const d=o.armies+l,h=Object.create(o);if(h.armies=d,this.isAttackFeasible(h,r,te.ATTACK_COMMIT)){const f=new Z,x=Math.floor(d*te.ATTACK_COMMIT/1e3)*1e3;c=new X([o,r],x,f,100)}}t.push(new X([n,o],l,e,s,c))}}const i=this.player.totalArmies()/this.player.ownedCountries.length,a=this.player.ownedCountries.reduce((l,c)=>c.armies<l.armies?c:l,this.player.ownedCountries[0]);if(a.armies<i/2&&a!==n){const l=i/2,c=Math.floor((l-a.armies)/1e3)*1e3,d=Math.max(0,Math.min(c,n.armies-1e3));d>0&&n!==a&&t.push(new X([n,a],d,e,i-a.armies))}return t}FindFortifyOpportunities(e){const t=[],n=this.player.ownedCountries.filter(o=>!o.fortified).length;for(const o of this.player.ownedCountries)if(o.canBeFortified()&&this.player.money>=D.fortifyCost){let s=o.income/100;s*=n,t.push(new X([o],0,e,s))}return t}FindBuyOpportunities(){if(this.player.money<=2e6)return[];const t=[],n=new Se,o=this.player.money,s=D.armyCost,r=Math.max(0,o-2e6);if(this.player.ownedCountries.length===0||r<s)return t;const i=Math.floor(this.player.totalArmies()/this.player.ownedCountries.length),a=this.player.ownedCountries.reduce((h,f)=>f.armies<h.armies?f:h,this.player.ownedCountries[0]);if(a.armies<i){const h=i-a.armies,f=Math.floor(r/s),x=Math.min(h,f,1e5),u=Math.floor(x/1e3)*1e3;if(u>0){let w=(i-a.armies)/1e3;a.unrestLevel>0&&(w+=10),t.push(new X([a],u,n,w))}}let l=null,c=-1/0,d=null;for(const h of this.player.ownedCountries){const f=this.getReachableNonOwnedCountries(h);for(const{country:x,distance:u}of f){let w=1;u>100&&(w=Math.max(0,1-(u-100)/900));const g=this.countryScore(x)*w;g>c&&(c=g,l=h,d=x)}}if(l||(l=this.player.homeCountry),l){const h=Math.floor((r-2e6)/s),f=Math.floor(h/1e3)*1e3;if(f>0){let x=null;if(this.actionPlan.length===0&&d){const u=l.armies+f,w=Object.create(l);if(w.armies=u,this.isAttackFeasible(w,d,te.ATTACK_COMMIT)){const g=new Z,p=Math.floor(u*te.ATTACK_COMMIT/1e3)*1e3;x=new X([l,d],p,g,100)}}t.push(new X([l],f,n,c*1e3,x))}}if(r>0&&this.player.ownedCountries.length>0){const h=this.findMostThreatenedOwnedCountry();if(!h)throw new Error("findMostThreatenedOwnedCountry() returned null, which should not happen if there are owned countries.");const f=Math.floor(r/s),x=Math.floor(f/1e3)*1e3;if(x>0){const u=r/1e3;t.push(new X([h],x,n,u))}}return t}findBestOpportunity(){const e=new ke,t=new Je,n=[];if(n.push(...this.FindSpyOpportunities()),n.push(...this.FindAttackOpportunities()),n.push(...this.FindMoveOpportunities(e)),n.push(...this.FindFortifyOpportunities(t)),n.push(...this.FindBuyOpportunities()),n.length===0)return null;const o=.5,s=Math.max(...n.map(d=>d.score)),r=n.map(d=>Math.exp((d.score-s)/o)),i=r.reduce((d,h)=>d+h,0),a=r.map(d=>d/i),l=Math.random();let c=0;for(let d=0;d<n.length;++d)if(c+=a[d],l<c)return n[d];throw new Error("Softmax selection failed to pick an opportunity.")}getNonOwnedCountriesSortedByDistance(){const e=this.game.worldMap,t=e.getCountries(),n=[];for(const o of t){if(o.owner===this.player)continue;let s=1e4;for(const r of this.player.ownedCountries){const i=e.distance(r,o);i!==null&&(s=Math.min(s,i))}n.push({country:o,distance:s})}return n.sort((o,s)=>o.distance-s.distance),n}getReachableNonOwnedCountries(e){const t=this.game.worldMap,n=t.getCountries(),o=[];for(const s of n){if(s.owner===this.player)continue;const r=t.distance(e,s);r!==null&&o.push({country:s,distance:r})}return o.sort((s,r)=>s.distance-r.distance),o}MakeAttackPlan(e){if(this.actionPlan.length>0)return;const t=Z,n=ke,o=Se,s=this.player.ownedCountries;if(s.length===0||e.owner===this.player)return;let r=1/0,i=null;for(const M of s){const T=this.game.worldMap.distance(M,e);T!==null&&T<r&&(r=T,i=M)}if(!i)return;const a=new Map;for(const M of s)a.set(M,M.armies);let l=this.player.money;const c=[],d=new o,h=D.armyCost,f=Math.floor(l/h);if(f>0){const M=Math.floor(f/1e3)*1e3;M>0&&(c.push(new X([i],M,d,1)),a.set(i,a.get(i)+M),l-=M*h)}const x=new n;let u=0,w=a.get(i);const g=s.filter(M=>M!==i).sort((M,T)=>T.armies-M.armies);for(const M of g){if(u>=2)break;const T=this.game.worldMap.distance(M,i),I=a.get(M);if(T!==null&&I>1e3){const C=Math.floor((I-1e3)/1e3)*1e3;C>0&&(c.push(new X([M,i],C,x,1)),a.set(M,I-C),w+=C,a.set(i,w),u++)}}const p=this.countryDefenseEstimate(e),y=this.game.worldMap.distance(i,e)||1,m=Math.floor(w*te.ATTACK_COMMIT/1e3)*1e3,v=t.AttackChance(m,p,y,e.fortified,this.game);if(v>.7&&m>=1e3){const M=new t;c.push(new X([i,e],m,M,v*100)),a.set(i,1e3),this.actionPlan.push(...c)}}PlanSurpriseAttack(){if(this.actionPlan.length>0)return;const e=this.game.worldMap.getCountries();let t=1/0,n=null;for(const r of e)if(!r.owner){const i=this.countryDefenseEstimate(r);i<t&&(t=i,n=r)}if(n){this.MakeAttackPlan(n);return}let o=1/0,s=null;for(const r of e)if(r.owner&&r.owner!==this.player){const i=this.countryDefenseEstimate(r);i<o&&(o=i,s=r)}s&&this.MakeAttackPlan(s)}isAttackFeasible(e,t,n=.8){if(!e||!t||e.owner!==this.player||t.owner===this.player||e===t)return!1;const o=e.neighbors.includes(t),s=e.oceanBorder.length>0&&t.oceanBorder.length>0;if(!o&&!s||typeof e.armies!="number"||e.armies<=1e3)return!1;const r=this.countryDefenseEstimate(t),i=this.game.worldMap.distance(e,t);if(i===null)return!1;const a=Math.floor(e.armies*n);return!(Z.AttackChance(a,r,i,t.fortified,this.game)<.7)}findMostThreatenedOwnedCountry(){if(!this.player.ownedCountries||this.player.ownedCountries.length===0)throw new Error("AI has no owned countries to evaluate for threat.");const e=this.game.worldMap,t=e.getCountries();let n=null,o=-1/0;for(const s of this.player.ownedCountries){let r=0;for(const i of t){if(!i.owner||i.owner===this.player)continue;const a=e.distance(s,i);a===null||a===0||(r+=1/a)}r>o&&(o=r,n=s)}if(!n)throw new Error("No threatened country found. This should not happen if there are enemy countries.");return n}};b(te,"ATTACK_COMMIT",.8);let ve=te;const V=class V{constructor(e,t,n=[],o=null,s=[],r=0,i=!1){b(this,"actionsLeft",V.ACTIONS_PER_TURN);b(this,"game");b(this,"actionLog",[]);b(this,"name");b(this,"color");b(this,"ownedCountries");b(this,"homeCountry");b(this,"isAI");b(this,"AI");b(this,"money");b(this,"knowledge");b(this,"plannedFortifications",[]);b(this,"aggressivity");this.name=e,this.color=t,this.ownedCountries=n,this.homeCountry=o,this.knowledge=s,this.money=r,this.isAI=i,this.actionsLeft=V.ACTIONS_PER_TURN,this.aggressivity=Math.floor(Math.random()*8)+2,this.AI=new ve(this,void 0)}resetActions(){this.actionsLeft=V.ACTIONS_PER_TURN}useAction(){this.actionsLeft>0&&this.actionsLeft--}get RGBColor(){return V.COLOR_RGBS[this.color]||"0,0,0"}getKnownCountries(){const e=new Set;this.knowledge.forEach(n=>e.add(n.country));const t=Array.from(e).filter(n=>!this.ownedCountries.includes(n));return{owned:[...this.ownedCountries],known:t}}getCountryInfo(e,t){if(e.owner===this)return{name:e.name,owner:e.owner,income:e.income,army:e.armies,recency:0};{const n=this.knowledge.find(o=>o.country===e);return{name:e.name,owner:e.owner,income:n?n.income:void 0,army:n?n.army:void 0,recency:n?t-n.gameTurn:void 0}}}totalIncome(){return this.ownedCountries.reduce((e,t)=>t.unrestLevel>0?e:e+(t.income??0),0)}totalArmies(){return this.ownedCountries.reduce((e,t)=>e+(t.armies??0),0)}startTurn(){this.resetActions()}get IncomeShare(){if(!this.game||!this.game.players||this.game.players.length===0)return 0;const e=this.game.players.reduce((t,n)=>{var o;return t+(((o=n.totalIncome)==null?void 0:o.call(n))??0)},0);return e===0?0:this.totalIncome()/e}armyKnown(e){if(e.owner===this)return!0;const t=this.knowledge.find(n=>n.country===e);return!!(!e.owner&&t||e.owner&&e.owner!==this&&t&&this.game&&t.gameTurn===this.game.gameTurn)}toJSON(){return{id:this.name,name:this.name,color:this.color,ownedCountryIds:this.ownedCountries.map(e=>e.name),homeCountryId:this.homeCountry?this.homeCountry.name:null,isAI:this.isAI,money:this.money,knowledge:this.knowledge.map(e=>({countryId:e.country.name,gameTurn:e.gameTurn,army:e.army,income:e.income})),plannedFortifications:this.plannedFortifications.map(([e,t])=>[e.name,t]),aggressivity:this.aggressivity,actionsLeft:this.actionsLeft}}static fromJSON(e,t){const n=new V(e.name,e.color,[],null,[],e.money,e.isAI);return n.aggressivity=e.aggressivity,n.actionsLeft=e.actionsLeft??V.ACTIONS_PER_TURN,n._ownedCountryIds=e.ownedCountryIds,n._homeCountryId=e.homeCountryId,n._knowledgeRaw=e.knowledge,n._plannedFortificationsRaw=e.plannedFortifications,n}resolveReferences(e){this.ownedCountries=(this._ownedCountryIds||[]).map(t=>e[t]).filter(Boolean),this.homeCountry=this._homeCountryId?e[this._homeCountryId]:null,this.knowledge=(this._knowledgeRaw||[]).map(t=>({country:e[t.countryId],gameTurn:t.gameTurn,army:t.army,income:t.income})),this.plannedFortifications=(this._plannedFortificationsRaw||[]).map(([t,n])=>[e[t],n]),delete this._ownedCountryIds,delete this._homeCountryId,delete this._knowledgeRaw,delete this._plannedFortificationsRaw}};b(V,"ACTIONS_PER_TURN",5),b(V,"COLOR_RGBS",{red:"255,0,0",blue:"0,0,255",green:"0,128,0",yellow:"255,255,0",purple:"128,0,128",orange:"255,140,0",teal:"0,128,128",brown:"139,69,19"}),b(V,"COLORS",["red","blue","green","yellow","purple","orange","teal","brown"]);let ce=V;const Tt=Object.freeze(Object.defineProperty({__proto__:null,Player:ce},Symbol.toStringTag,{value:"Module"})),Y=class Y{constructor(e,t=[]){b(this,"worldMap");b(this,"players");b(this,"gameTurn");b(this,"activePlayerIndex");b(this,"gui");b(this,"advisedOpportunity");this.worldMap=e,this.players=t,this.gameTurn=1,this.activePlayerIndex=0,this.advisedOpportunity=null,this.players.length>0&&this.activePlayer.startTurn()}get activePlayer(){return this.players[this.activePlayerIndex]}nextTurn(){this.activePlayer.money+=this.activePlayer.totalIncome(),this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayerIndex===0&&(this.gameTurn++,this.handleUnrest());const e=this.activePlayer;e.plannedFortifications=e.plannedFortifications.filter(([t,n])=>n===this.gameTurn?(t.fortified=!0,!1):!0),this.activePlayer.startTurn(),this.advisedOpportunity=null}static initNewGame(e,t,n){for(const d of t)d.money=Y.initialPlayerMoney,d.homeCountry=null,d.ownedCountries=[],d.isAI&&(d.AI=new ve(d,null));const o=e.getCountries();for(const d of o)d.income=Math.floor((5e5+Math.random()*2e6)/1e3)*1e3,d.owner=null;let s=-1,r=[];const i=t.length,a=10;function l(d,h){if(!d.center||!h.center)return 0;const[f,x]=d.center(),[u,w]=h.center();return Math.sqrt((f-u)**2+(x-w)**2)}for(let d=0;d<a;++d){const h=[...o];for(let u=h.length-1;u>0;u--){const w=Math.floor(Math.random()*(u+1));[h[u],h[w]]=[h[w],h[u]]}const f=h.slice(0,i);let x=1/0;for(let u=0;u<f.length;++u)for(let w=u+1;w<f.length;++w)x=Math.min(x,l(f[u],f[w]));x>s&&(s=x,r=f)}for(let d=0;d<t.length;++d){const h=r[d];t[d].homeCountry=h,h.owner=t[d],t[d].ownedCountries.push(h),h.income=Y.homeCountryIncome,h.fortified=!0,h.nationalPride=1e3}for(const d of e.getCountries())if(d.owner)d.armies=1e5;else{const h=Math.round((Math.random()*Math.random()*99e3+1e3)/1e3)*1e3;d.armies=h}const c=new Y(e,t);n&&(c.gui=n);for(const d of t)d.game=c,d.isAI&&d.AI&&(d.AI.game=c,d.AI.player=d);return c}toJSON(){var e;return{gameTurn:this.gameTurn,activePlayerName:((e=this.players[this.activePlayerIndex])==null?void 0:e.name)??null,playerNames:this.players.map(t=>t.name)}}static fromJSON(e,t,n){const o=new Y(n,t);o.gameTurn=e.gameTurn,o.activePlayerIndex=t.findIndex(s=>s.name===e.activePlayerName),o.activePlayerIndex===-1&&(o.activePlayerIndex=0);for(const s of t)s.game=o,s.isAI&&s.AI&&(s.AI.game=o,s.AI.player=s);return o}AddPlayer(e){return this.players.length>=8?!1:(this.players.push(e),!0)}static generateAIName(){const e=["Augustus","Charlemagne","Qin Shi Huang","Akbar","Justinian","Napoleon","Constantine","Ashoka","Catherine","Meiji","Trajan","Hadrian","Aurangzeb","Elizabeth","Peter","Victoria","Franz Joseph","Wilhelm","Haile Selassie","Menelik"];return e[Math.floor(Math.random()*e.length)]}handleUnrest(){for(const e of this.worldMap.getCountries()){if(!e.owner)continue;if(Math.floor(Math.random()*99e3)+1e3+e.armies<e.nationalPride?(e.unrestLevel=Math.min(e.unrestLevel+1,2),e.nationalPride=Math.min(e.nationalPride+1e3,1e5)):(e.unrestLevel=Math.max(e.unrestLevel-1,0),e.nationalPride=Math.max(e.nationalPride-1e3,1e3)),e.unrestLevel===2){const o=new ce(Y.generateAIName(),ce.COLORS[this.players.length%ce.COLORS.length],[],null,[],0,!0);if(this.AddPlayer(o)){const s=e.owner;s&&(s.ownedCountries=s.ownedCountries.filter(r=>r!==e)),this.UnKnowCountry(e),e.nationalPride=1e3,e.unrestLevel=0,e.income*=2,o.homeCountry=e,o.ownedCountries.push(e),e.owner=o,e.armies=e.nationalPride*2,e.fortified=!0,o.game=this,o.AI=new ve(o,this)}else{const s=e.owner;s&&(s.ownedCountries=s.ownedCountries.filter(r=>r!==e)),this.UnKnowCountry(e),e.owner=null,e.armies=e.nationalPride,e.fortified=!1}}}}UnKnowCountry(e){for(const t of this.players)t.knowledge=t.knowledge.filter(n=>n.country!==e)}};b(Y,"armyCost",100),b(Y,"spyCost",2e5),b(Y,"spyFortifiedCost",1e6),b(Y,"initialPlayerMoney",1e7),b(Y,"homeCountryIncome",4e6),b(Y,"fortifyCost",1e5),b(Y,"showArmies",!1),b(Y,"INCOME_SHARE_WIN",.8);let D=Y;const It=Object.freeze(Object.defineProperty({__proto__:null,Game:D},Symbol.toStringTag,{value:"Module"}));class Qe extends fe{GetButtonText(e,t){var r;if(e.length===0)return null;const n=e[e.length-1];if(n.owner==t)return null;const o=t.knowledge.find(i=>i.country===n),s=(r=t.game)==null?void 0:r.gameTurn;return!n.owner&&o||n.owner&&n.owner!==t&&o&&o.gameTurn===s?null:`Spy on ${n.name}`}async Act(e,t,n,o=0){if(e.length===0)return"Please select a country to spy on.";const s=e[e.length-1],r=s.fortified?D.spyFortifiedCost:D.spyCost;if(t.money<r)return`Not enough money to spy. You need $${r}.`;const i=t.knowledge.find(c=>c.country===s);if(!n)return"Internal error: currentGame is required.";const a=n.gameTurn;if(i&&i.gameTurn===a)return"You already have recent information about this country.";t.money-=r;const l={country:s,gameTurn:a,army:s.armies,income:s.income};return i?(i.gameTurn=l.gameTurn,i.army=l.army,i.income=l.income):t.knowledge.push(l),null}RequiresAmount(e,t,n){return null}get countryCountNeeded(){return 1}Type(){return"Spy"}ActionString(e,t,n,o=0){return e.length<1?"Spy: No country selected.":`Spying on ${e[e.length-1].name}`}}function Ye(S,e,t=S){return new Promise(n=>{const o=document.createElement("div");o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.5)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="10000";const s=document.createElement("div");s.style.background="#fff",s.style.padding="32px 40px",s.style.borderRadius="12px",s.style.boxShadow="0 2px 16px rgba(0,0,0,0.2)",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.gap="18px";const r=document.createElement("div");r.textContent="Select amount to commit:",r.style.fontSize="1.2rem",r.style.marginBottom="8px",s.appendChild(r);const i=document.createElement("div");i.textContent=`Maximum: ${e.toLocaleString()}`,i.style.fontSize="1rem",i.style.color="#555",i.style.marginBottom="4px",s.appendChild(i);let a=Math.max(S,Math.min(e,t));const l=document.createElement("div");l.textContent=a.toLocaleString(),l.style.fontSize="2rem",l.style.fontWeight="bold",l.style.margin="8px 0",s.appendChild(l);const c=document.createElement("div");c.style.display="flex",c.style.gap="6px";function d(w){a=Math.max(S,Math.min(e,w)),l.textContent=a.toLocaleString()}function h(w,g){const p=document.createElement("button");return p.textContent=w,p.style.padding="6px 14px",p.style.fontSize="1.1rem",p.style.border="none",p.style.borderRadius="6px",p.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",p.style.color="#fff",p.style.cursor="pointer",p.onclick=g,p}c.appendChild(h("-100k",()=>d(a-1e5))),c.appendChild(h("-10k",()=>d(a-1e4))),c.appendChild(h("-1k",()=>d(a-1e3))),c.appendChild(h("Min",()=>d(S))),c.appendChild(h("Half",()=>d(Math.floor(e/2/1e3)*1e3))),c.appendChild(h("Max",()=>d(e))),c.appendChild(h("+1k",()=>d(a+1e3))),c.appendChild(h("+10k",()=>d(a+1e4))),c.appendChild(h("+100k",()=>d(a+1e5))),s.appendChild(c);const f=document.createElement("div");f.style.display="flex",f.style.gap="12px",f.style.marginTop="18px";const x=h("OK",()=>{document.body.removeChild(o),n(a)});x.style.background="linear-gradient(90deg,#43cea2 0%,#43e97b 100%)",x.style.fontWeight="bold";const u=h("Cancel",()=>{document.body.removeChild(o),n(null)});u.style.background="linear-gradient(90deg,#e57373 0%,#ffb74d 100%)",f.appendChild(x),f.appendChild(u),s.appendChild(f),o.appendChild(s),document.body.appendChild(o),x.focus()})}class Et extends fe{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];if(n.owner!==t||n===o||!(t.knowledge&&t.knowledge.some(a=>a.country===o)))return null;const r=n.neighbors.includes(o),i=n.oceanBorder.length>0&&o.oceanBorder.length>0;return!r&&!i||o.owner===t?null:`Calculate attack chance for ${o.name} from ${n.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to calculate attack.";const s=e[e.length-2],r=e[e.length-1];if(s.owner!==t)return"You must own the attacking country.";const i=s.neighbors.includes(r),a=s.oceanBorder.length>0&&r.oceanBorder.length>0;if(!i&&!a)return"Target country must be a neighbor or reachable by naval attack.";if(r.owner===t)return"Cannot attack your own country.";if(o<=0||o>=s.armies)return"Invalid number of armies committed.";const l=t.getCountryInfo(r,n.gameTurn),c=n.worldMap.distance(s,r);let h=`Attack chance: ${(Z.AttackChance(s.armies,l.army||0,c||0,r.fortified,n)*100).toFixed(2)}%`;return l.recency&&l.recency>0&&(h+=`
Warning: Information about ${r.name} may be outdated (last spied ${l.recency} turn(s) ago).`),h}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}Type(){return"CalculateAttack"}get countryCountNeeded(){return 2}ActionString(e,t,n,o=0){if(e.length<2)return"Calculate Attack: Not enough countries selected.";const s=e[e.length-2];return`Calculating attack chance for ${e[e.length-1].name} from ${s.name} with ${o} soldiers`}}function Ve(S,e,t){let n=document.getElementById("gamegui-win-modal");if(n)return;n=document.createElement("div"),n.id="gamegui-win-modal",n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.85)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="99999";const o=document.createElement("canvas");o.width=window.innerWidth,o.height=window.innerHeight,o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.zIndex="0",o.style.pointerEvents="none",n.appendChild(o);function s(){o.width=window.innerWidth,o.height=window.innerHeight}window.addEventListener("resize",s);const r=document.createElement("div");r.style.width="50vw",r.style.height="50vh",r.style.background='url("Won.png") center/cover no-repeat',r.style.padding="48px 64px",r.style.borderRadius="24px",r.style.boxShadow="0 4px 32px rgba(0,0,0,0.25)",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="32px",r.style.position="relative",r.style.zIndex="1";const i=document.createElement("div");i.style.position="absolute",i.style.top="32px",i.style.right="48px",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="flex-end",i.style.zIndex="2",i.style.padding="12px 24px",i.style.background="rgba(255,255,255,0.0)";const a=document.createElement("div");a.textContent="WINNER",a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",a.style.fontSize="2.7rem",a.style.fontWeight="bold",a.style.color="#222",a.style.textShadow="0 2px 8px #fff,0 0 8px #000",i.appendChild(a);const l=document.createElement("div");l.textContent=S,l.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",l.style.fontSize="2.1rem",l.style.fontWeight="bold",l.style.color="#fff",l.style.marginTop="8px",l.style.textShadow="0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6",l.style.animation="win-glow 2.2s linear infinite";const c=document.createElement("style");c.textContent=`@keyframes win-glow {
    0% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
    25% { text-shadow: 0 0 24px #43cea2, 0 0 40px #ffd700, 0 0 56px #00e6e6, 0 0 72px #ff00cc; }
    50% { text-shadow: 0 0 32px #ff00cc, 0 0 48px #00e6e6, 0 0 64px #ffd700, 0 0 80px #43cea2; }
    75% { text-shadow: 0 0 24px #00e6e6, 0 0 40px #ff00cc, 0 0 56px #43cea2, 0 0 72px #ffd700; }
    100% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
  }`,document.head.appendChild(c),i.appendChild(l);const d=document.createElement("button");d.textContent="OK",d.style.marginTop="18px",d.style.padding="12px 36px",d.style.fontSize="1.3rem",d.style.border="none",d.style.borderRadius="8px",d.style.background="linear-gradient(90deg,#43cea2 0%,#ffd700 100%)",d.style.color="#222",d.style.fontWeight="bold",d.style.cursor="pointer",d.style.textShadow="0 2px 8px #fff,0 0 8px #000",d.onclick=()=>{g=!1,window.removeEventListener("resize",s),n&&n.parentNode&&n.parentNode.removeChild(n),t&&t()},i.appendChild(d),r.appendChild(i),n.appendChild(r),document.body.appendChild(n);const h=o.getContext("2d"),f=[];let x=o.height;function u(){const y=Math.random()*o.width*.8+o.width*.1,m=o.height*.02+Math.random()*o.height*.04,v=(Math.random()-.5)*2,M=(-8-Math.random()*4)*2,T=`hsl(${Math.random()*360},90%,60%)`;f.push({x:y,y:o.height,vx:v,vy:M,color:T,exploded:!1,particles:[],age:0,targetY:m})}function w(y){for(let m=0;m<48;m++){const v=m/48*2*Math.PI,M=2+Math.random()*2.5;y.particles.push({x:y.x,y:y.y,vx:Math.cos(v)*M,vy:Math.sin(v)*M,color:y.color,alpha:1,age:0})}}let g=!0;function p(){if(!(!g||!h)){h.clearRect(0,0,o.width,o.height),Math.random()<.06&&f.length<7&&u();for(const y of f)if(!y.exploded)y.x+=y.vx,y.y+=y.vy,y.vy+=.13,y.age++,y.y<x&&(x=y.y),h.save(),h.beginPath(),h.arc(y.x,y.y,4,0,2*Math.PI),h.fillStyle=y.color,h.globalAlpha=.9,h.shadowColor=y.color,h.shadowBlur=16,h.fill(),h.restore(),y.y<=y.targetY&&(y.exploded=!0,w(y));else{for(const m of y.particles)m.x+=m.vx,m.y+=m.vy,m.vy+=.04,m.alpha-=.012+Math.random()*.01,m.age++,h.save(),h.beginPath(),h.arc(m.x,m.y,2.2,0,2*Math.PI),h.fillStyle=m.color,h.globalAlpha=Math.max(0,m.alpha),h.shadowColor=m.color,h.shadowBlur=8,h.fill(),h.restore();y.particles=y.particles.filter(m=>m.alpha>.05&&m.age<90)}for(let y=f.length-1;y>=0;y--)f[y].exploded&&f[y].particles.length===0&&f.splice(y,1);requestAnimationFrame(p)}}p()}const Pt=Object.freeze(Object.defineProperty({__proto__:null,showWinDialog:Ve},Symbol.toStringTag,{value:"Module"}));class Nt{constructor(e,t,n,o){b(this,"overlay");b(this,"ctx");b(this,"width");b(this,"height");b(this,"fish",[]);b(this,"running",!1);b(this,"lastSpawn",0);b(this,"nextSpawn",0);b(this,"getOceanPredicate");b(this,"animationFrameId",null);b(this,"timeoutId",null);b(this,"loop",e=>{this.ctx.clearRect(0,0,this.width,this.height),this.fish=this.fish.filter(t=>!t.done);for(const t of this.fish)t.update(e),t.draw(this.ctx);e>this.nextSpawn&&(this.spawnFish(),this.scheduleNextSpawn()),this.fish.length>0||this.nextSpawn-e<2e3?this.animationFrameId=requestAnimationFrame(this.loop):(this.running=!1,this.timeoutId=setTimeout(()=>this.start(),this.nextSpawn-e))});this.width=t,this.height=n,this.getOceanPredicate=o,this.overlay=document.createElement("canvas"),this.overlay.width=t,this.overlay.height=n,this.overlay.style.position="absolute",this.overlay.style.left="0",this.overlay.style.top="0",this.overlay.style.pointerEvents="none",this.overlay.style.width="100%",this.overlay.style.height="100%",this.overlay.style.zIndex="20",e.appendChild(this.overlay);const s=this.overlay.getContext("2d");if(!s)throw new Error("Could not get canvas context for FishOverlay");this.ctx=s,this.scheduleNextSpawn(),this.start()}scheduleNextSpawn(){this.nextSpawn=performance.now()+5e3+Math.random()*1e4}spawnFish(){for(let e=0;e<10;e++){const t=Math.floor(Math.random()*this.width),n=Math.floor(this.height*(.4+.5*Math.random())),o=Math.random()<.5?1:-1,s=32+Math.random()*24,r=t+o*s;if(this.getOceanPredicate(t,n)&&this.getOceanPredicate(Math.round(r),n)){const i="#444";this.fish.push(new Ot(t,n,o,i));break}}}start(){this.running||(this.running=!0,this.animationFrameId=requestAnimationFrame(this.loop))}stop(){this.running=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}resume(){this.running||this.start()}}class Ot{constructor(e,t,n,o){b(this,"x0");b(this,"y0");b(this,"x1");b(this,"y1");b(this,"dir");b(this,"color","#444");b(this,"t0");b(this,"duration");b(this,"done",!1);b(this,"splash",!1);b(this,"splashStart",0);b(this,"splashDuration",1200);this.x0=e,this.y0=t;const s=32+Math.random()*24;this.x1=e+n*s,this.y1=t,this.dir=n,this.t0=performance.now(),this.duration=(1200+Math.random()*400)/2}update(e){const t=(e-this.t0)/this.duration;if(!this.splash&&t>.95&&(this.splash=!0,this.splashStart=e),t>1&&this.splash){e-this.splashStart>this.splashDuration&&(this.done=!0);return}if(t>1){this.done=!0;return}}draw(e){const t=performance.now(),n=Math.min(1,(t-this.t0)/this.duration),o=18,s=this.x0+(this.x1-this.x0)*n,r=this.y0-(1-4*Math.pow(n-.5,2))*o,i=1+.18*Math.sin(Math.PI*n),a=.5*Math.sin(Math.PI*n);if(n<=.95){e.save(),e.translate(s,r);const l=1/3,c=e.createRadialGradient(0,0,.3,0,0,7*i*l);c.addColorStop(0,"#222"),c.addColorStop(.7,"#666"),c.addColorStop(1,"#bbb"),e.fillStyle=c,e.beginPath(),e.ellipse(0,0,7*i*l,3*l,0,0,2*Math.PI),e.fill(),e.save(),e.beginPath(),e.moveTo(-7*i*l,0),e.lineTo(-11*i*l,-4*l),e.lineTo(-11*i*l,4*l),e.closePath(),e.fillStyle="#222",e.globalAlpha=.8,e.fill(),e.restore(),e.save(),e.beginPath(),e.ellipse(-2*i*l,2.2*l,2*l,.7*l,Math.PI/4+a,0,2*Math.PI),e.ellipse(-2*i*l,-2.2*l,2*l,.7*l,-Math.PI/4-a,0,2*Math.PI),e.fillStyle="#888",e.globalAlpha=.7,e.fill(),e.restore(),e.restore()}if(this.splash){const l=Math.min(1,(t-this.splashStart)/this.splashDuration);for(let c=0;c<3;c++){const d=10+12*l+c*6;e.save(),e.beginPath(),e.arc(this.x1,this.y1,d,0,2*Math.PI),e.strokeStyle=`rgba(10,10,10,${.7*(1-l)})`,e.lineWidth=2.5-c*.5,e.globalAlpha=1*(1-l),e.stroke(),e.restore()}}}}function Rt(S){var d;let e=document.getElementById("action-log-dialog");e&&e.remove();const t=document.createElement("div");t.id="action-log-dialog",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.6)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="99999",(d=ue.getInstance())==null||d.pauseGame();const n=document.createElement("div");n.style.background="#fff",n.style.width="100vw",n.style.height="100vh",n.style.padding="0",n.style.borderRadius="0",n.style.boxShadow="none",n.style.maxWidth="100vw",n.style.maxHeight="100vh",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="stretch",n.style.gap="0",n.style.overflow="hidden";const o=document.createElement("button");o.textContent="Close",o.style.alignSelf="flex-end",o.style.margin="16px 24px 0 0",o.style.padding="10px 32px",o.style.fontSize="1.2rem",o.style.border="none",o.style.borderRadius="8px",o.style.background="linear-gradient(90deg,#ff9966 0%,#ff5e62 100%)",o.style.color="#fff",o.style.cursor="pointer",o.onclick=()=>{var f,x;(f=ue.getInstance())==null||f.resumeGame(),t.remove();const h=ue.getInstance();h&&h.currentGame&&!h.canceled&&((x=h.currentGame.activePlayer)!=null&&x.isAI)&&setTimeout(()=>h.turnStarted(),0)},n.appendChild(o);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="row",s.style.alignItems="center",s.style.gap="16px",s.style.padding="24px 32px 8px 32px",s.style.background="#f5f5f5";const r=document.createElement("select");r.style.fontSize="1.1rem",r.style.padding="6px 12px";for(const h of S.players){const f=document.createElement("option");f.value=h.name,f.textContent=h.name+(h.isAI?" (AI)":""),r.appendChild(f)}s.appendChild(r);const i=document.createElement("input");i.type="text",i.placeholder="Filter (wildcard, all fields)",i.style.fontSize="1.1rem",i.style.padding="6px 12px",i.style.borderRadius="6px",i.style.border="1px solid #aaa",s.appendChild(i),n.appendChild(s);const a=document.createElement("div");a.style.overflow="auto",a.style.flex="1",a.style.padding="0 32px 32px 32px",a.style.background="#fff",n.appendChild(a);function l(h,f){a.innerHTML="";const x=document.createElement("table");x.style.width="100%",x.style.borderCollapse="collapse",x.style.fontSize="1.05rem";const u=document.createElement("thead"),w=document.createElement("tr");for(const y of["#","Action","Countries","Amount","Result"]){const m=document.createElement("th");m.textContent=y,m.style.borderBottom="2px solid #888",m.style.padding="8px 12px",m.style.background="#eee",w.appendChild(m)}u.appendChild(w),x.appendChild(u);const g=document.createElement("tbody");let p=h.actionLog;if(f.trim()){const y=f.trim().toLowerCase();p=p.filter(m=>m.actionType.toLowerCase().includes(y)||m.countries.map(v=>v.name).join(",").toLowerCase().includes(y)||(""+m.amount).includes(y)||(m.result?m.result.toLowerCase():"").includes(y))}p.forEach((y,m)=>{const v=document.createElement("tr");v.style.borderBottom="1px solid #ddd";const M=document.createElement("td");M.textContent=(m+1).toString(),M.style.padding="6px 12px",v.appendChild(M);const T=document.createElement("td");T.textContent=y.actionType,T.style.padding="6px 12px",v.appendChild(T);const I=document.createElement("td");I.textContent=y.countries.map(k=>k.name).join(", "),I.style.padding="6px 12px",v.appendChild(I);const C=document.createElement("td");C.textContent=y.amount.toString(),C.style.padding="6px 12px",v.appendChild(C);const A=document.createElement("td");A.textContent=y.result??"",A.style.padding="6px 12px",v.appendChild(A),g.appendChild(v)}),x.appendChild(g),a.appendChild(x)}let c=S.players[0];l(c,""),r.onchange=()=>{c=S.players.find(h=>h.name===r.value)||S.players[0],l(c,i.value)},i.oninput=()=>{l(c,i.value)},t.appendChild(n),document.body.appendChild(t)}class Ue{static serialize(e){const t=e.worldMap.getCountries(),n=e.players;return JSON.stringify({countries:t.map(o=>o.toJSON()),players:n.map(o=>o.toJSON()),game:e.toJSON()})}static deserialize(e){const t=JSON.parse(e),n={},o=t.countries.map(l=>Ie.fromJSON(l,{},n)),s={},r=t.players.map(l=>{const c=ce.fromJSON(l,n);return s[c.name]=c,c});o.forEach(l=>l.resolveReferences(s,n)),r.forEach(l=>l.resolveReferences(n));const i=At(o);return D.fromJSON(t.game,r,i)}}class Bt{constructor(e){b(this,"text");this.text=e}renderTo(e){e.innerHTML="",e.style.padding="2em",e.style.fontFamily='"UnifrakturCook", "Cinzel Decorative", "Old English Text MT", serif',e.style.color="#3a2c13",e.style.lineHeight="1.7",e.style.maxWidth="none",e.style.width="100%",e.style.margin="2em 0",e.style.boxSizing="border-box";const t=this.text.split(/\r?\n/);let n=!1,o="";t.forEach((r,i)=>{if(/^=+/.test(r)){const a=document.createElement("h1");a.textContent=r.replace(/=+/g,"").trim(),a.style.fontFamily="Cinzel Decorative, serif",a.style.fontSize="2.6em",a.style.letterSpacing="0.12em",a.style.textShadow="0 0 16px #fffbe6, 0 2px 8px #bfa76f",a.style.textAlign="center",a.style.margin="0.7em 0 0.5em 0",e.appendChild(a);return}if(/^\d+\./.test(r)){const a=document.createElement("h2");a.textContent=r.replace(/^\d+\./,"").trim(),a.style.fontFamily="Cinzel Decorative, serif",a.style.fontSize="1.7em",a.style.margin="1.2em 0 0.3em 0",a.style.color="#7a5c1b",a.style.textShadow="0 0 8px #fffbe6",e.appendChild(a);return}if(!/^-{2,}/.test(r)){if(/^\s*\- /.test(r)){if(!n){n=!0;const c=document.createElement("ul");c.style.margin="0.5em 0 0.5em 2em",c.style.fontSize="1.1em",c.style.listStyleType="square",e.appendChild(c)}const a=e.lastElementChild,l=document.createElement("li");l.innerHTML=this.parseInline(r.replace(/^\s*\- /,"")),a.appendChild(l);return}else n&&(n=!1);if(/^Q: /.test(r)){o+=`<div class="faq-q"><span class="faq-q-label">Q:</span> ${this.parseInline(r.slice(3))}</div>`;return}if(/^A: /.test(r)){if(o+=`<div class="faq-a"><span class="faq-a-label">A:</span> ${this.parseInline(r.slice(3))}</div>`,!/^Q: |^A: /.test(t[i+1]||"")){const a=document.createElement("div");a.className="faq-block",a.innerHTML=o,a.style.background="#fffbe6",a.style.border="2px solid #bfa76f",a.style.borderRadius="10px",a.style.margin="1.2em 0",a.style.padding="1em 1.5em",a.style.boxShadow="0 0 8px #bfa76f33",a.style.fontFamily="Cinzel, serif",a.style.fontSize="1.08em",e.appendChild(a),o=""}return}if(r.trim()===""){n&&(n=!1);return}if(e.childElementCount===0&&r.trim().length>0){const a=document.createElement("p");a.innerHTML=`<span style="float:left;font-size:2.2em;font-family:'Cinzel Decorative',serif;color:#bfa76f;line-height:0.8;margin-right:0.18em;">${r.trim()[0]}</span>${this.parseInline(r.trim().slice(1))}`,a.style.fontSize="1.18em",a.style.margin="1.2em 0 0.7em 0",a.style.textAlign="justify",e.appendChild(a);return}if(r.trim().length>0){const a=document.createElement("p");a.innerHTML=this.parseInline(r.trim()),a.style.fontSize="1.13em",a.style.margin="0.7em 0",a.style.textAlign="justify",e.appendChild(a);return}}});const s=document.createElement("style");s.textContent=`
      .faq-q-label { color: #b22222; font-weight: bold; margin-right: 0.3em; }
      .faq-a-label { color: #1a5c1a; font-weight: bold; margin-right: 0.3em; }
      .faq-q { margin-bottom: 0.2em; }
      .faq-a { margin-bottom: 0.7em; }
    `,e.appendChild(s)}parseInline(e){return e.replace(/\*\*(.+?)\*\*/g,"<b>$1</b>").replace(/__(.+?)__/g,"<b>$1</b>")}}const Gt=`1. Introduction\r
----------------\r
Armchair-General is a turn-based strategy game inspired by classic world domination board games. You play as a leader vying for control over a map of countries, managing armies, fortifications, and resources to outmaneuver your opponents.\r
\r
\r
2. Game Objective\r
------------------\r
The goal is to control 80% of the total income of all players. Income is generated by the countries you own. You win by accumulating enough territory and resources to reach this threshold, not necessarily by eliminating all opponents.\r
\r
\r
3. Game Components\r
-------------------\r
- **Countries**: Territories on the map that can be owned, fortified, and attacked.\r
- **Players**: Human or AI participants, each with their own resources and armies.\r
- **Armies**: Units used to defend and attack countries.\r
- **Money**: Used to buy armies and fortifications.\r
- **Turns**: The game progresses in rounds, with each player taking actions in turn.\r
\r
\r
4. Basic Gameplay\r
------------------\r
- At the start, each player controls a set of countries and receives a starting amount of money and armies.\r
- On your turn, you can perform up to 5 actions. Actions include buying armies, fortifying countries, moving armies, attacking opponents, and more. Plan your moves carefully, as you are limited to 5 actions per turn.\r
- After all players have taken their turn, the game advances to the next round.\r
- The game ends when one player controls 80% of the total income of all players.\r
\r
\r
5. Actions & Mechanics\r
-----------------------\r
- **Buy Armies**: Spend money to increase your armies in owned countries.\r
- **Fortify**: Spend money to plan a fortification for a country, which will be completed after a delay.\r
- **Move Armies**: Transfer armies between adjacent owned countries.\r
- **Attack**: Attempt to conquer an enemy country using your armies. The effectiveness of your attack is reduced by the distance between the centers of the attacking and defending countries—the greater the distance, the weaker your attack becomes. Normally, you can only attack neighboring (bordering) countries. However, if both countries have a coast, you may attack across water even if they do not share a border. When attacking across water, the distance is considered three times greater than the same distance across land, making such attacks significantly harder.\r
- **Spy**: Gather information about enemy countries (if available).\r
- **Income**: At the start of each turn, you receive money based on the countries you own.\r
- **Planned Fortifications**: Fortifications are not instant; they are scheduled and completed after a set number of turns.\r
\r
\r
6. User Interface Overview\r
---------------------------\r
- **Map Area**: The main view, showing all countries, their owners, and army counts.\r
- **Country Selection**: Click on countries to select them for actions.\r
- **Action Buttons**: Context-sensitive buttons appear for available actions (e.g., Fortify, Attack). To perform an action that needs 2 countries (attack, move), first select the origin country and then the target country. Available options for that combinations will appear (2 friendly countries => move, friendly and non friendly => attack)\r
\r
\r
7. The Advisor\r
-------------\r
In the bottom right corner of the screen, you will see your Advisor—a helpful character who suggests actions you might want to take on your turn. The Advisor analyzes the current game state and offers strategic recommendations, which you can follow or ignore as you see fit. The Advisor is especially useful for new players or when you are unsure of your next move.\r
\r
\r
8.  Frequently Asked Questions (FAQ)\r
------------------------------------\r
Q: How do I win?\r
A: You win by controlling 80% of the total income of all players. This is achieved by owning enough countries to generate the required income threshold.\r
\r
Q: How do I get more money?\r
A: You receive income each turn based on the countries you own.\r
\r
Q: How do fortifications work?\r
A: Fortifications are planned and completed after a delay. They make a country harder to conquer.\r
\r
Q: Can I play against the computer?\r
A: Yes, AI players are supported.\r
\r
Q: What happens if I run out of money?\r
A: You cannot buy armies or fortifications until you have enough money.\r
\r
Q: How do I move armies?\r
A: Select a country you own, then choose a destination country you also own. A move action button will appear.\r
`,we=class we{constructor(){b(this,"state");b(this,"currentGame",null);b(this,"rootContainer",null);b(this,"canceled",!1);b(this,"paused",!1);b(this,"clickedCountryNames",[]);b(this,"worldMapCanvas",null);b(this,"mapDirty",!0);b(this,"actions");b(this,"fishOverlay",null);b(this,"_onResize",()=>{this.markMapDirty(),this.rootContainer&&this.renderMainGui(this.rootContainer,this.currentGame)});b(this,"isProcessingAdvisorSynthetic",!1);b(this,"isAdvisorAnimationRunning",!1);this.state="initialized",this.actions=[new Qe,new Je,new Z,new Et,new ke,new Se],we._instance=this,window.addEventListener("keydown",e=>{e.key==="F9"&&this.currentGame&&Rt(this.currentGame),e.key==="F8"&&pe(()=>Promise.resolve().then(()=>Pt),void 0).then(t=>{var o,s;const n=((s=(o=this.currentGame)==null?void 0:o.activePlayer)==null?void 0:s.name)||"Player";t.showWinDialog(n,100)})})}pauseGame(){if(this.paused=!0,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.stop=="function"?(console.log("Pausing FishOverlay",this.fishOverlay),this.fishOverlay.stop()):console.log("No FishOverlay to pause")}resumeGame(){if(this.paused=!1,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.resume=="function"?(console.log("Resuming FishOverlay",this.fishOverlay),this.fishOverlay.resume()):console.log("No FishOverlay to resume")}isPaused(){return this.paused}static getInstance(){return we._instance}afterAction(){if(this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],n=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(n&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(n,this.currentGame.gameTurn),s=document.getElementById("country-info-panel");if(s){const r=n.unrestLevel>0?"color: red; font-style: italic;":"";n.unrestLevel>0;const i=n.unrestLevel>0?"color: red; text-decoration: line-through;":"";s.innerHTML=`
            <div><b>Name:</b> <span style="${r}">${o.name}</span></div>
            <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
            <div><b>Income:</b> <span style="${i}">${o.income!==void 0?o.income:"?"}</span></div>
            <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
          `}}}if(this.markMapDirty(),this.rootContainer&&(this.renderMainGui(this.rootContainer,this.currentGame),this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap)){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],n=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(n&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(n,this.currentGame.gameTurn),s=document.getElementById("country-info-panel");if(s){const r=n.unrestLevel>0?"color: red; font-style: italic;":"",i=n.unrestLevel>0?'<div style="color: red; font-style: italic;">Rioting</div>':"",a=n.unrestLevel>0?"color: red; text-decoration: line-through;":"";let l="";const c=this.currentGame.activePlayer;if(c.armyKnown(n))l='<span style="color: #4caf50; font-weight: bold;">Certified information</span>';else{const d=c.knowledge.find(h=>h.country===n);if(n.owner&&n.owner!==c&&d){const h=this.currentGame.gameTurn-d.gameTurn;l=`<span style="color: #ffd700; font-weight: bold;">${h} turn${h===1?"":"s"} old information</span>`}else l='<span style="color: #ff4444; font-weight: bold;">No information</span>'}s.innerHTML=`
              <div><b>Name:</b> <span style="${r}">${o.name}</span></div>
              <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
              <div><b>Income:</b> <span style="${a}">${o.income!==void 0?o.income:"?"} </span></div>
              <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
              <div>${l}</div>
              ${i}
            `}}if(!this.isProcessingAdvisorSynthetic&&this.currentGame.activePlayer&&this.currentGame.activePlayer.actionLog.length>0){const o=this.currentGame.activePlayer.actionLog[this.currentGame.activePlayer.actionLog.length-1];if(o.countries&&o.countries.length>0){const s=o.countries[o.countries.length-1];if(s&&s.name){this.clickedCountryNames.push(s.name);const r=this.rootContainer.querySelector('div[style*="flex: 3"]'),i=r?r.querySelector("canvas"):null;if(i&&r){const l=this.currentGame.worldMap.getCountries().find(c=>c.name===s.name);if(l){const[c,d]=l.center?l.center():[0,0],h=i.width,f=i.height,x=i.getBoundingClientRect(),u=x.width/h,w=x.height/f,g=c*u,p=d*w,y=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,clientX:x.left+g,clientY:x.top+p});i.dispatchEvent(y)}}}}}}this.updateActionButtons()}updateActionButtons(){if(this.paused)return;const e=document.querySelector('div[style*="flex: 3"]');let t=e?e.querySelector("#country-action-overlay"):null;t&&(t.remove(),t=null);const n=document.getElementById("action-buttons-area");if(n&&Array.from(n.children).forEach(i=>{i instanceof HTMLElement&&(i.classList.contains("persistent-action-btn")||n.removeChild(i))}),!this.currentGame||!this.currentGame.players||!this.currentGame.activePlayer)return;const o=this.currentGame.worldMap?this.currentGame.worldMap.getCountries():[],s=this.clickedCountryNames.map(i=>o.find(a=>a.name===i)).filter(Boolean);if(this.currentGame.activePlayer.actionsLeft<=0||s.length===0||!e)return;const r=[];for(const i of this.actions){const a=i.GetButtonText(s,this.currentGame.activePlayer);if(a){const l=document.createElement("button");l.textContent=a,l.style.padding="4px 10px",l.style.fontSize="0.95rem",l.style.background="rgba(0,0,0,0.18)",l.style.color="#b3e5fc",l.style.border="1px solid #555",l.style.borderRadius="6px",l.style.cursor="pointer",l.style.boxShadow="0 1px 4px rgba(30,32,34,0.10)",l.style.margin="0 6px 0 0",l.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",l.style.transition="background 0.15s, color 0.15s",l.onmouseenter=()=>{l.style.background="#ffd700",l.style.color="#222"},l.onmouseleave=()=>{l.style.background="rgba(0,0,0,0.18)",l.style.color="#b3e5fc"},l.onclick=async()=>{const c=i.RequiresAmount(s,this.currentGame.activePlayer,this.currentGame);let d=null,h=0;if(c){const[x,u]=c;let w=u;if(this.currentGame&&this.currentGame.advisedOpportunity){const p=this.currentGame.advisedOpportunity,y=this.currentGame.worldMap.getCountries();for(const I of p.countries){const C=y.find(A=>A.name===I.name);C&&C!==I&&(console.warn("[Advisor/Action] Country instance mismatch:",I.name,I,C),C.name===I.name&&console.error("[Advisor/Action] Country instance mismatch but names match:",I.name,I,C))}const m=p.action.Type()===i.Type();m||console.log("[Advisor/Action] Action type mismatch:",p.action.Type(),i.Type());const v=p.countries.length,M=s.slice(-v),T=M.length===v&&p.countries.every((I,C)=>I===M[C]);if(!T){console.log("[Advisor/Action] Country array mismatch:"),console.log("  opp.countries:",p.countries.map(I=>I.name)),console.log("  lastClicked:",M.map(I=>I&&I.name));for(let I=0;I<Math.max(p.countries.length,M.length);++I){const C=p.countries[I],A=M[I];C!==A&&(C&&A&&C.name===A.name?console.error("[Advisor/Action] Country instance mismatch at index",I,"but names match:",C.name,C,A):console.log("[Advisor/Action] Country mismatch at index",I,":",C,A))}}m&&T?(console.log("[Advisor/Action] Using advisor suggested amount:",p.amount),w=p.amount):console.log("[Advisor/Action] Not using advisor amount. sameAction:",m,"sameCountries:",T)}const g=await Ye(x,u,w);if(g===null)return;h=g,d=await i.Act(s,this.currentGame.activePlayer,this.currentGame,g)}else d=await i.Act(s,this.currentGame.activePlayer,this.currentGame);const f=s.slice(-i.countryCountNeeded);this.currentGame.activePlayer.actionLog.push({actionType:i.Type(),countries:f,amount:h,result:d??null}),this.currentGame.activePlayer.useAction(),typeof d=="string"&&d!==null?(this.afterAction(),this.showActionResult(d)):this.afterAction(),this.currentGame&&(this.currentGame.advisedOpportunity=null)},r.push(l)}}if(r.length>0){t=document.createElement("div"),t.id="country-action-overlay",t.style.position="absolute",t.style.pointerEvents="auto",t.style.background="rgba(40, 40, 60, 0.85)",t.style.border="1.5px solid #555",t.style.borderRadius="10px",t.style.padding="12px 18px",t.style.color="#b3e5fc",t.style.fontSize="0.95rem",t.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="10px",t.style.zIndex="21",t.style.minWidth="140px",t.style.maxWidth="340px",t.style.visibility="hidden",t.style.flexWrap="wrap",t.style.maxWidth="340px",t.style.minHeight="unset",r.forEach(a=>{a.style.width="100%",a.style.margin="0",a.style.textAlign="center",a.style.background="#b3e5fc",a.style.color="#1a237e",a.onmouseenter=()=>{a.style.background="#ffd700",a.style.color="#222"},a.onmouseleave=()=>{a.style.background="#b3e5fc",a.style.color="#1a237e"},t.appendChild(a)}),e.appendChild(t);const i=e.querySelector("canvas");if(i&&s.length===1){const a=s[0],[l,c]=a.center?a.center():[0,0],d=i.width,h=i.height,f=i.getBoundingClientRect(),x=f.width/d,u=f.height/h,w=l*x,g=c*u,p=e.querySelector("#country-info-overlay");p&&p.style.display!=="none"?requestAnimationFrame(()=>{const y=p.offsetHeight;t.style.left=`${w-t.offsetWidth/2}px`,t.style.top=`${g+y+2}px`,t.style.visibility="visible",t.style.flexWrap="wrap",t.style.maxWidth="340px",t.style.minHeight="unset"}):(t.style.left=`${w-t.offsetWidth/2}px`,t.style.top=`${g+8}px`,t.style.visibility="visible")}}}showActionResult(e){const t=document.getElementById("action-result-panel");t&&(t.innerHTML=`<span style="color:#fff">${e}</span>`)}clearActionResult(){const e=document.getElementById("action-result-panel");e&&(e.innerHTML='<span style="color:#888">No recent action.</span>')}markMapDirty(){this.mapDirty=!0}getWorldMapCanvas(){if(this.paused)throw new Error("Game is paused");if(!this.currentGame||!this.currentGame.worldMap)throw new Error("GameGui.getWorldMapCanvas: currentGame or worldMap is missing");if(this.mapDirty||!this.worldMapCanvas){let e=[];if(this.currentGame.activePlayer){const t=this.currentGame.activePlayer.getKnownCountries();e=t.owned.concat(t.known)}this.worldMapCanvas=xe.render(this.currentGame.worldMap,[],e,D.showArmies,this.currentGame.activePlayer),this.mapDirty=!1}return this.worldMapCanvas}async mount(e){this.rootContainer=e,window.addEventListener("resize",this._onResize),this.renderMainGui(e,this.currentGame)}unmount(){window.removeEventListener("resize",this._onResize)}async turnStarted(){var n,o;if(this.paused)return;if(this.clearActionResult(),this.currentGame&&this.currentGame.activePlayer&&this.currentGame.activePlayer.IncomeShare>=D.INCOME_SHARE_WIN){Ve(this.currentGame.activePlayer.name,D.INCOME_SHARE_WIN*100,()=>{this.canceled=!0}),this.canceled=!0;return}if(this.renderMainGui(this.rootContainer,this.currentGame),this.canceled||!((o=(n=this.currentGame)==null?void 0:n.activePlayer)!=null&&o.isAI))return;const e=this.currentGame.activePlayer.AI;if(!e)return;const t=async()=>{if(this.paused||this.canceled)return;const s=await e.takeAction();this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),s?setTimeout(()=>t(),100):(this.currentGame.nextTurn(),this.markMapDirty(),this.currentGame.activePlayer.isAI?setTimeout(()=>this.turnStarted(),100):this.turnStarted())};t()}async startNewGame(){this.canceled=!0;const e=this.rootContainer,{showNewGameDialog:t}=await pe(async()=>{const{showNewGameDialog:n}=await import("./NewGameDialog-DA8OtktU.js");return{showNewGameDialog:n}},[]);try{const n=await t(e),o=await pe(()=>Promise.resolve().then(()=>Tt),void 0),s=await pe(()=>Promise.resolve().then(()=>It),void 0);s.Game.showArmies=n.showArmies;const r=["#4fc3f7","#81c784","#ffb74d","#e57373","#ba68c8","#ffd54f","#64b5f6","#a1887f"],i=o.Player.COLORS??r,a=n.players.map((l,c)=>new o.Player(l.name,i[c%i.length],[],null,[],0,l.isAI));this.currentGame=s.Game.initNewGame(n.map,a,this),this.markMapDirty(),this.getWorldMapCanvas(),this.renderMainGui(e,this.currentGame),this.currentGame&&this.currentGame.players.length>0&&(this.canceled=!1,this.currentGame.activePlayer.startTurn(),this.turnStarted())}catch(n){console.error("NewGameDialog error or cancellation:",n)}}renderMainGui(e,t){if(this.paused)return;const n=this.rootContainer;if(!n)throw new Error("rootContainer is not set (null) in renderMainGui");const o=n.querySelector('div[style*="flex: 3"]');if(o&&o._fishOverlay){const C=o._fishOverlay;typeof C.stop=="function"&&C.stop(),C.overlay&&C.overlay.parentNode&&C.overlay.parentNode.removeChild(C.overlay),o._fishOverlay=null}n.innerHTML="";const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="row",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.background="linear-gradient(120deg, #232526 0%, #414345 100%)",s.style.borderRadius="0",s.style.boxShadow="none",s.style.overflow="hidden",s.style.margin="0",s.style.maxWidth="100vw";const r=document.createElement("div");r.style.flex="3",r.style.background="#222",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.position="relative",r.style.borderRight="2px solid #333";let i=null;t&&t.worldMap&&(i=this.getWorldMapCanvas()),this.clickedCountryNames||(this.clickedCountryNames=[]);let a=r.querySelector("#country-info-overlay");if(a||(a=document.createElement("div"),a.id="country-info-overlay",a.style.position="absolute",a.style.pointerEvents="auto",a.style.background="rgba(40, 40, 60, 0.85)",a.style.border="1.5px solid #555",a.style.borderRadius="10px",a.style.padding="14px 18px",a.style.color="#b3e5fc",a.style.fontSize="1.08rem",a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",a.style.minWidth="180px",a.style.maxWidth="320px",a.style.display="none",a.style.zIndex="20",r.appendChild(a)),i){let C=function(){k||(k=document.createElement("canvas"),k.width=i.width,k.height=i.height,k.style.position="absolute",k.style.left="0",k.style.top="0",k.style.pointerEvents="none",k.style.width="100%",k.style.height="100%",r.appendChild(k))},A=function(){if(k){const P=k.getContext("2d");P&&P.clearRect(0,0,k.width,k.height)}};i.style.width="100%",i.style.height="100%",i.style.display="block",r.appendChild(i);let k=null;if(!r._fishOverlay){const P=t.worldMap.getMap(),L=i.width,$=i.height,z=(N,G)=>N<0||G<0||G>=P.length||N>=P[0].length?!1:P[G][N]===Q;r._fishOverlay=new Nt(r,L,$,z)}this.fishOverlay=r._fishOverlay,i._countryClickHandler&&i.removeEventListener("mousedown",i._countryClickHandler);const E=P=>{if(this.paused)return;const L=i.width,$=i.height,z=Math.floor(P.offsetX*(L/i.clientWidth)),N=Math.floor(P.offsetY*($/i.clientHeight)),G=t.worldMap.getMap(),F=t.worldMap.getCountries();let O=null;if(z>=0&&N>=0&&N<G.length&&z<G[0].length){const J=G[N][z];if(J>=0&&F[J]){if(O=F[J],O&&!O.coordinates.some(([B,j])=>B===z&&j===N)&&console.warn(`[GameGui] Click at (${z},${N}) is not in coordinates of country: ${O.name}`),O&&this.clickedCountryNames.push(O.name),C(),A(),k&&O){const B=k.getContext("2d");if(B){xe.drawCountryGlow(B,O,[0,0,0],O.color);const[j,se]=O.center?O.center():[0,0],de=O.fortified?"🛡️ "+O.name:O.name;if(B.save(),B.font="bold 10px Verdana, Geneva, sans-serif",B.textAlign="center",B.textBaseline="middle",B.lineWidth=3,B.strokeStyle="black",B.strokeText(de,j,se),B.fillStyle="white",B.fillText(de,j,se),D.showArmies&&typeof O.armies=="number"){const oe=`${Math.round(O.armies/1e3)}k`;B.font="bold 9px Verdana, Geneva, sans-serif",B.lineWidth=2,B.strokeStyle="black",B.strokeText(oe,j,se+13),B.fillStyle="#FFD700",B.fillText(oe,j,se+13)}B.restore()}}if(O&&a&&t&&t.activePlayer&&typeof t.gameTurn=="number"){const B=t.activePlayer.getCountryInfo(O,t.gameTurn),j=O.unrestLevel>0?"color: #ff6666; font-style: italic;":"",se=O.unrestLevel>0?'<div style="color: #ff6666; font-style: italic;">Rioting</div>':"",de=O.unrestLevel>0?"color: #ff6666; text-decoration: line-through;":"";let oe="";const ye=t.activePlayer;if(ye.armyKnown(O))oe='<span style="color: #4caf50; font-weight: bold;">Certified information</span>';else{const ae=ye.knowledge.find(R=>R.country===O);if(O.owner&&O.owner!==ye&&ae){const R=t.gameTurn-ae.gameTurn;oe=`<span style="color: #ffd700; font-weight: bold;">${R} turn${R===1?"":"s"} old information</span>`}else oe='<span style="color: #ff4444; font-weight: bold;">No information</span>'}a.innerHTML=`
                <div><b>Name:</b> <span style="${j}">${B.name}</span></div>
                <div><b>Owner:</b> ${B.owner?B.owner.name:"None"}</div>
                <div><b>Income:</b> <span style="${de}">${B.income!==void 0?B.income:"?"} </span></div>
                <div><b>Army:</b> ${B.army!==void 0?B.army:"?"}</div>
                <div>${oe}</div>
                ${se}
              `;const[Ze,et]=O.center?O.center():[0,0],tt=i.width,nt=i.height,$e=i.getBoundingClientRect(),ot=$e.width/tt,rt=$e.height/nt,st=Ze*ot,it=et*rt;a.style.left=`${st-a.offsetWidth/2}px`,a.style.top=`${it-a.offsetHeight-18}px`,a.style.display="block",requestAnimationFrame(()=>{const ae=document.querySelector('div[style*="flex: 3"]');let R=ae?ae.querySelector("#country-action-overlay"):null;if(R&&(R.remove(),R=null),!t.activePlayer||t.activePlayer.actionsLeft<=0||!O)return;const at=t.worldMap.getCountries(),ie=this.clickedCountryNames.map(_=>at.find(Ce=>Ce.name===_)).filter(Boolean);if(ie.length===0)return;const Ee=[];for(const _ of this.actions){const Ce=_.GetButtonText(ie,t.activePlayer);if(Ce){const H=document.createElement("button");H.textContent=Ce,H.style.padding="4px 10px",H.style.fontSize="0.95rem",H.style.background="rgba(0,0,0,0.18)",H.style.color="#b3e5fc",H.style.border="1px solid #555",H.style.borderRadius="6px",H.style.cursor="pointer",H.style.boxShadow="0 1px 4px rgba(30,32,34,0.10)",H.style.margin="0 6px 0 0",H.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",H.style.transition="background 0.15s, color 0.15s",H.onmouseenter=()=>{H.style.background="#ffd700",H.style.color="#222"},H.onmouseleave=()=>{H.style.background="rgba(0,0,0,0.18)",H.style.color="#b3e5fc"},H.onclick=async()=>{if(ie.length===0)return;const Fe=_.RequiresAmount(ie,t.activePlayer,t);let he=null,De=0;if(Fe){const[lt,ze]=Fe;let _e=ze;if(t&&t.advisedOpportunity){const ee=t.advisedOpportunity,ct=t.worldMap.getCountries();for(const q of ee.countries){const U=ct.find(le=>le.name===q.name);U&&U!==q&&(console.warn("[Advisor/Action] Country instance mismatch:",q.name,q,U),U.name===q.name&&console.error("[Advisor/Action] Country instance mismatch but names match:",q.name,q,U))}const Ne=ee.action.Type()===_.Type();Ne||console.log("[Advisor/Action] Action type mismatch:",ee.action.Type(),_.Type());const qe=ee.countries.length,me=ie.slice(-qe),Oe=me.length===qe&&ee.countries.every((q,U)=>q===me[U]);if(!Oe){console.log("[Advisor/Action] Country array mismatch:"),console.log("  opp.countries:",ee.countries.map(q=>q.name)),console.log("  lastClicked:",me.map(q=>q&&q.name));for(let q=0;q<Math.max(ee.countries.length,me.length);++q){const U=ee.countries[q],le=me[q];U!==le&&(U&&le&&U.name===le.name?console.error("[Advisor/Action] Country instance mismatch at index",q,"but names match:",U.name,U,le):console.log("[Advisor/Action] Country mismatch at index",q,":",U,le))}}Ne&&Oe?(console.log("[Advisor/Action] Using advisor suggested amount:",ee.amount),_e=ee.amount):console.log("[Advisor/Action] Not using advisor amount. sameAction:",Ne,"sameCountries:",Oe)}const Pe=await Ye(lt,ze,_e);if(Pe===null)return;De=Pe,he=await _.Act(ie,t.activePlayer,t,Pe)}else he=await _.Act(ie,t.activePlayer,t);t.activePlayer.actionLog.push({actionType:_.Type(),countries:ie,amount:De,result:he??null}),t.activePlayer.useAction(),typeof he=="string"&&he!==null?(this.afterAction(),this.showActionResult(he)):this.afterAction(),t&&(t.advisedOpportunity=null)},Ee.push(H)}}Ee.length>0&&ae&&O&&(R=document.createElement("div"),R.id="country-action-overlay",R.style.position="absolute",R.style.pointerEvents="auto",R.style.background="rgba(40, 40, 60, 0.85)",R.style.border="1.5px solid #555",R.style.borderRadius="10px",R.style.padding="12px 18px",R.style.color="#b3e5fc",R.style.fontSize="0.95rem",R.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",R.style.display="flex",R.style.flexDirection="column",R.style.alignItems="center",R.style.justifyContent="center",R.style.gap="10px",R.style.zIndex="21",R.style.minWidth="140px",R.style.maxWidth="340px",R.style.visibility="hidden",R.style.flexWrap="wrap",R.style.maxWidth="340px",R.style.minHeight="unset",Ee.forEach(_=>{_.style.width="100%",_.style.margin="0",_.style.textAlign="center",_.style.background="#b3e5fc",_.style.color="#1a237e",_.onmouseenter=()=>{_.style.background="#ffd700",_.style.color="#222"},_.onmouseleave=()=>{_.style.background="#b3e5fc",_.style.color="#1a237e"},R.appendChild(_)}),ae.appendChild(R),R.style.left=`${a.offsetLeft}px`,R.style.top=`${a.offsetTop+a.offsetHeight+2}px`,R.style.visibility="visible",R.style.flexWrap="wrap",R.style.maxWidth="340px",R.style.minHeight="unset")})}}}this.isProcessingAdvisorSynthetic=!1};i.addEventListener("mousedown",E),i._countryClickHandler=E}else{const C=document.createElement("div");C.style.width="100%",C.style.height="100%",C.style.background="repeating-linear-gradient(135deg,#444 0 10px,#333 10px 20px)",C.style.border="4px solid #666",C.style.borderRadius="12px",C.style.display="flex",C.style.alignItems="center",C.style.justifyContent="center";const A=document.createElement("img");A.src="riskStartup.png",A.alt="Risk Startup",A.style.width="100%",A.style.height="100%",A.style.objectFit="cover",A.style.borderRadius="8px",C.appendChild(A),r.appendChild(C)}const l=document.createElement("div"),c=document.createElement("div");c.style.display="flex",c.style.flexDirection="row",c.style.justifyContent="center",c.style.alignItems="center",c.style.gap="18px",c.style.marginBottom="24px",c.style.width="100%",c.style.minWidth="0";function d(C,A,k){const E=document.createElement("img");return E.src=C,E.alt=A,E.style.flex="1 1 0",E.style.width="0",E.style.minWidth="0",E.style.height="auto",E.style.objectFit="contain",E.style.cursor="pointer",E.style.borderRadius="8px",E.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",E.style.transition="transform 0.1s, box-shadow 0.1s",E.addEventListener("mouseenter",()=>{E.style.transform="scale(1.08)",E.style.boxShadow="0 4px 16px #ffd700"}),E.addEventListener("mouseleave",()=>{E.style.transform="scale(1)",E.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)"}),E.onclick=k,E.style.display="block",E.style.margin="0 0",E}const h=d("newgame.png","New Game",()=>this.startNewGame()),f=d("savegame.png","Save Game",()=>{try{if(!this.currentGame)throw new Error("No game to save");const C=Ue.serialize(this.currentGame),A=new Blob([C],{type:"application/json"}),k=URL.createObjectURL(A),E=document.createElement("a");E.href=k,E.download="armchair-general-save.json",document.body.appendChild(E),E.click(),setTimeout(()=>{document.body.removeChild(E),URL.revokeObjectURL(k)},100)}catch(C){throw alert("Save failed: "+(C&&C.message?C.message:C)),C}}),x=d("loadgame.png","Load Game",()=>{const C=document.createElement("input");C.type="file",C.accept=".json,application/json",C.onchange=A=>{const k=A.target.files[0];if(!k)return;const E=new FileReader;E.onload=()=>{try{const P=E.result,L=Ue.deserialize(P);L.gui=this;for(const $ of L.players)$.game=L,$.isAI&&$.AI&&($.AI.game=L,$.AI.player=$);this.currentGame=L,this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted()}catch(P){throw alert("Load failed: "+(P&&P.message?P.message:P)),P}},E.readAsText(k)},C.click()}),u=document.createElement("img");u.src="manual.png",u.alt="Manual",u.style.display="block",u.style.marginLeft="auto",u.style.marginTop="12px",u.style.marginBottom="0",u.style.width="96px",u.style.height="auto",u.style.cursor="pointer",u.style.boxShadow="0 0 12px #bfa76f55",u.style.opacity="0.7",u.onclick=()=>{const C=document.createElement("div");C.style.position="fixed",C.style.left="0",C.style.top="0",C.style.width="100vw",C.style.height="100vh",C.style.background="rgba(40,30,10,0.20)",C.style.zIndex="99999",C.style.display="flex",C.style.alignItems="center",C.style.justifyContent="center";const A=document.createElement("div");A.style.width="80vw",A.style.maxWidth="none",A.style.height="80vh",A.style.overflowY="auto",A.style.background="rgba(255,250,230,0.85)",A.style.borderRadius="22px",A.style.boxShadow="0 0 64px #bfa76f99, 0 0 8px #fffbe6",A.style.position="relative";const k=document.createElement("button");k.textContent="×",k.style.position="absolute",k.style.top="18px",k.style.right="28px",k.style.fontSize="2.2em",k.style.background="none",k.style.border="none",k.style.color="#b22222",k.style.cursor="pointer",k.style.fontWeight="bold",k.style.zIndex="100000",k.onpointerdown=()=>{C.remove()},A.appendChild(k);const E=document.createElement("div");E.style.padding="2.5em 2.5em 2em 2.5em",new Bt(Gt).renderTo(E),A.appendChild(E),C.appendChild(A),document.body.appendChild(C)},c.appendChild(h),c.appendChild(f),c.appendChild(x),l.appendChild(c),l.appendChild(u);const w=document.createElement("div");w.style.marginBottom="32px";const g=document.createElement("div");if(g.style.fontSize="1.2rem",g.style.fontWeight="bold",t&&t.players&&t.players.length>0){const C=t.activePlayer;g.textContent=`Turn: ${t.gameTurn} | Player: ${C.name}`;const A=document.createElement("div"),k=C.constructor.ACTIONS_PER_TURN||5,E=C.actionsLeft;A.style.margin="8px 0 0 0",A.style.fontSize="2rem",A.style.letterSpacing="0.2rem";for(let L=0;L<k;L++){const $=document.createElement("span");$.textContent=L<E?"★":"☆",$.style.color=L<E?"#ffd700":"#888",A.appendChild($)}A.title=`${E} of ${k} actions remaining`;const P=document.createElement("div");P.style.display="flex",P.style.flexDirection="row",P.style.alignItems="center",P.style.justifyContent="space-between",P.appendChild(A),P.appendChild(u),w.appendChild(P)}if(w.appendChild(g),l.appendChild(w),t&&t.players&&t.players.length>0){const C=document.createElement("div");C.textContent="Players",C.style.fontWeight="bold",C.style.marginBottom="8px",l.appendChild(C);const A=document.createElement("ul");A.style.listStyle="none",A.style.padding="0",A.style.margin="0 0 24px 0";for(const k of t.players){const E=document.createElement("li");E.style.display="flex",E.style.alignItems="center",E.style.marginBottom="8px",k===t.activePlayer&&(E.style.boxShadow="0 0 16px 4px #ffd700, 0 0 4px 2px #fff",E.style.border="2px solid #ffd700",E.style.borderRadius="12px",E.style.background="rgba(255, 215, 0, 0.10)");const P=document.createElement("span");P.style.display="inline-block",P.style.width="16px",P.style.height="16px",P.style.borderRadius="50%",P.style.background=k.color,P.style.marginRight="8px",E.appendChild(P);const L=document.createElement("span");if(L.textContent=k.name+(k.isAI?" (AI)":""),L.style.flex="1",E.appendChild(L),typeof k.money=="number"){const $=document.createElement("span");$.textContent=`💰 ${k.money}`,$.style.marginLeft="8px",E.appendChild($);const z=document.createElement("span");z.style.display="inline-block",z.style.width="54px",z.style.height="12px",z.style.marginLeft="8px",z.style.verticalAlign="middle",z.style.background="#222",z.style.border="1px solid #444",z.style.borderRadius="6px",z.style.overflow="hidden";const N=document.createElement("span"),G=Math.min(k.IncomeShare/D.INCOME_SHARE_WIN,1);N.style.display="inline-block",N.style.height="100%",N.style.width=`${Math.round(G*100)}%`,N.style.background=G>=1?"linear-gradient(90deg,#43cea2,#ffd700)":"linear-gradient(90deg,#43cea2,#185a9d)",N.style.transition="width 0.3s",z.title=`Income share: ${(k.IncomeShare*100).toFixed(1)}% (win at ${(D.INCOME_SHARE_WIN*100).toFixed(0)}%)`,z.appendChild(N),E.appendChild(z)}A.appendChild(E)}l.appendChild(A)}const p=document.createElement("div");p.id="action-result-panel",p.style.background="#a67c52",p.style.border="1px solid #555",p.style.borderRadius="8px",p.style.padding="10px 12px",p.style.marginBottom="18px",p.style.color="#fff",p.style.fontSize="1.05rem",p.style.minHeight="60px",p.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",p.innerHTML='<span style="color:#888">No recent action.</span>',l.appendChild(p);const y=document.createElement("div");y.id="action-panel",y.style.display="flex",y.style.flexDirection="row",y.style.alignItems="flex-start",y.style.background="#a67c52",y.style.border="1px solid #555",y.style.borderRadius="8px",y.style.padding="20px 24px",y.style.marginTop="auto",y.style.marginBottom="18px",y.style.minHeight="140px",y.style.maxWidth="480px";const m=document.createElement("div");m.id="advisor-speech-bubble",m.style.position="relative",m.style.flex="1 1 0%",m.style.height="80%",m.style.background="white",m.style.color="#222",m.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",m.style.fontSize="1.18rem",m.style.padding="18px 24px",m.style.borderRadius="18px",m.style.boxShadow="0 2px 12px rgba(0,0,0,0.18)",m.style.border="2px solid #a67c52",m.style.display="none",m.style.zIndex="2",m.style.pointerEvents="none",m.style.transition="opacity 0.3s",m.style.opacity="0",m.style.textAlign="left",m.style.lineHeight="1.4",m.innerHTML="",m.style.setProperty("position","relative");const v=document.createElement("style");v.innerHTML=`
    #advisor-speech-bubble::after {
      content: '';
      position: absolute;
      right: -28px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 18px solid transparent;
      border-bottom: 18px solid transparent;
      border-left: 28px solid white;
      filter: drop-shadow(-2px 0 0 #a67c52);
      z-index: 3;
    }
    `,document.head.appendChild(v);const M=document.createElement("div");M.style.flex="0 0 144px",M.style.display="flex",M.style.flexDirection="column",M.style.alignItems="flex-end",M.style.justifyContent="center",M.style.height="100%",M.style.marginLeft="auto",y.appendChild(m),y.appendChild(M),l.appendChild(y);const T=document.createElement("button");T.textContent="End Turn",T.classList.add("persistent-action-btn"),T.style.padding="12px 0",T.style.fontSize="1.1rem",T.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",T.style.color="#fff",T.style.border="none",T.style.borderRadius="8px",T.style.cursor="pointer",T.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",T.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",T.style.marginBottom="18px",T.onclick=()=>{this.paused||this.currentGame&&(this.currentGame.nextTurn(),this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted())},l.appendChild(T),l.style.flex="1",l.style.background="#3b2412",l.style.display="flex",l.style.flexDirection="column",l.style.padding="32px 24px",l.style.color="#fff",l.style.minWidth="420px",l.style.maxWidth="520px",l.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",s.appendChild(r),s.appendChild(l),n.appendChild(s),M.addEventListener("click",async()=>{var E;if(console.log("[Advisor] advisor image clicked"),this.isAdvisorAnimationRunning){console.log("[Advisor] Animation already running, ignoring click");return}const C=(E=this.currentGame)==null?void 0:E.activePlayer;if(!C||!C.AI)return;C.AI.game=this.currentGame;const A=C.AI.findBestOpportunity();let k="";if(!A)k="Sorry, sir, I have no idea what to do!";else{let P=A.action.ActionString(A.countries,C,this.currentGame,A.amount);P.length>0&&(P=P.charAt(0).toLowerCase()+P.slice(1)),k=`I think, ${P} would be a good idea.`}if(m.innerHTML=k,m.style.display="block",m.style.opacity="1",A){this.currentGame&&(this.currentGame.advisedOpportunity=A);const{runAdvisorAnimation:P}=await pe(async()=>{const{runAdvisorAnimation:L}=await import("./AdvisorAnimation-DpQpr7s9.js");return{runAdvisorAnimation:L}},[]);this.isAdvisorAnimationRunning=!0,console.log("[Advisor] Starting advisor animation"),await P(this,A),this.isAdvisorAnimationRunning=!1}setTimeout(()=>{m.style.opacity="0",setTimeout(()=>m.style.display="none",5e3)},5e3)});const I=document.createElement("img");I.src="Advisor.png",I.alt="Advisor",I.style.maxWidth="100%",I.style.maxHeight="144px",I.style.objectFit="contain",I.style.borderRadius="6px",M.appendChild(I)}setClickedCountryNames(e){this.clickedCountryNames=e}};b(we,"_instance",null);let ue=we;function Lt(S,e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="10000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.pointerEvents="none",t.style.overflow="hidden";const n=document.createElement("div");n.innerText="Armchair",n.style.position="relative",n.style.color="#fffbe6",n.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',n.style.fontSize="6vw",n.style.fontWeight="bold",n.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",n.style.letterSpacing="0.18em",n.style.opacity="0",n.style.transform="translateX(-120%) skew(-12deg)",n.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",n.style.filter="drop-shadow(0 0 12px #fffbe6)",n.style.background="",n.style.webkitBackgroundClip="",n.style.backgroundClip="",n.style.webkitTextFillColor="";const o=document.createElement("div");o.innerText="General",o.style.position="relative",o.style.color="#fffbe6",o.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',o.style.fontSize="6vw",o.style.fontWeight="bold",o.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",o.style.letterSpacing="0.18em",o.style.opacity="0",o.style.transform="translateX(120%) skew(12deg)",o.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",o.style.filter="drop-shadow(0 0 12px #fffbe6)",o.style.background="",o.style.webkitBackgroundClip="",o.style.backgroundClip="",o.style.webkitTextFillColor="";const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.gap="1vw",s.style.pointerEvents="none",s.appendChild(n),s.appendChild(o),t.appendChild(s),S.appendChild(t);const r=document.createElement("canvas");r.width=S.offsetWidth||800,r.height=S.offsetHeight||600,r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.width="100%",r.style.height="100%",r.style.pointerEvents="none",t.appendChild(r);const i=r.getContext("2d"),a=10,l=[];r.width/2;const c=r.height*.8;for(let u=0;u<a;u++){const g=u%2===0?r.width*.05:r.width*.95,p=r.width*(.15+.7*Math.random()),y=c-r.height*.25+Math.random()*r.height*.1,m=c-r.height*.05+Math.random()*r.height*.18,v=1200+Math.random()*400,M=r.height*(.32+Math.random()*.12);l.push({startX:g,startY:y,endX:p,endY:m,duration:v,startTime:null,exploded:!1,explosionTime:null,arcHeight:M})}function d(u,w,g){i&&(i.save(),i.beginPath(),i.arc(u,w,18*g,0,2*Math.PI),i.fillStyle="rgba(40,40,40,0.95)",i.shadowColor="#222",i.shadowBlur=12*g,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(u-6*g,w-6*g,5*g,0,2*Math.PI),i.fillStyle="rgba(200,200,200,0.18)",i.fill(),i.restore())}function h(u,w,g){if(i){if(g<.15){const p=38+60*g;i.save(),i.beginPath(),i.arc(u,w,p,0,2*Math.PI),i.fillStyle=`rgba(255,255,220,${.7*(1-g/.15)})`,i.shadowColor="#fffbe6",i.shadowBlur=48,i.fill(),i.restore()}if(g<.6){const p=32+80*g;i.save(),i.beginPath(),i.arc(u,w,p,0,2*Math.PI),i.fillStyle=`rgba(255,120,40,${.5*(1-g/.6)})`,i.shadowColor="#ffae42",i.shadowBlur=32,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(u,w,p*.5,0,2*Math.PI),i.fillStyle=`rgba(255,220,120,${.7*(1-g/.6)})`,i.shadowColor="#fffbe6",i.shadowBlur=16,i.fill(),i.restore()}if(g>.2){const p=(g-.2)/.8;for(let y=0;y<4;y++){const m=Math.PI*2*(y/4)+Math.random()*.2,v=38+60*g+Math.random()*10,M=u+Math.cos(m)*v*.7*p,T=w+Math.sin(m)*v*.5*p+10*p;i.save(),i.beginPath(),i.arc(M,T,18+18*p,0,2*Math.PI),i.fillStyle=`rgba(80,60,40,${.18*(1-p)})`,i.shadowColor="#222",i.shadowBlur=8,i.fill(),i.restore()}}}}function f(u){i.clearRect(0,0,r.width,r.height);let w=!0;for(const g of l){g.startTime||(g.startTime=u);const p=u-g.startTime;if(g.exploded){if(g.explosionTime&&u-g.explosionTime<700){const y=(u-g.explosionTime)/700;h(g.endX,g.endY,y),w=!1}}else{w=!1;const y=Math.min(p/g.duration,1),m=g.startX+(g.endX-g.startX)*y,v=(1-y)*g.startY+y*g.endY-g.arcHeight*4*y*(1-y),M=.9+.3*(1-Math.abs(2*y-1));d(m,v,M),y>=1&&(g.exploded=!0,g.explosionTime=u)}}w||requestAnimationFrame(f)}requestAnimationFrame(f),setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(0) skew(0)",o.style.opacity="1",o.style.transform="translateX(0) skew(0)"},400),setTimeout(()=>{},3200);const x=document.createElement("link");x.rel="stylesheet",x.href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=UnifrakturCook:wght@700&display=swap",document.head.appendChild(x)}const $t="/Armchair-General/Balloon.png",Le=Array.from("Futuremagic-Productions"),Re=Le.length,be=.18,Be=192,Ft=.12,Dt=32,W=80,Me=W+80;function zt(S,e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="10000",t.style.pointerEvents="none",t.style.overflow="hidden",S.appendChild(t);const n=document.createElement("canvas");n.width=S.offsetWidth||800,n.height=S.offsetHeight||600,n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",t.appendChild(n);const o=n.getContext("2d"),s=new window.Image;s.src=$t,s.onload=()=>{g()};let r,i;const a=Math.floor(Math.random()*4),l=W+Math.random()*(n.width-2*W),c=W+Math.random()*(n.height-2*W);a===0?(r={x:-n.width*.2,y:c},i=Math.atan2(c-r.y,l-r.x)):a===1?(r={x:n.width+n.width*.2,y:c},i=Math.atan2(c-r.y,l-r.x)):a===2?(r={x:l,y:-n.height*.2},i=Math.atan2(c-r.y,l-r.x)):(r={x:l,y:n.height+n.height*.2},i=Math.atan2(c-r.y,l-r.x));let d=!1;const h=1,f=[],x=Math.ceil((Re+2)*Be);let u=be;const w=.002;function g(){performance.now();function p(y){let m=!1;const v=Dt;if(r.x<v||r.x>n.width-v||r.y<v||r.y>n.height-v){const N=n.width/2-r.x,G=n.height/2-r.y,O=(Math.atan2(G,N)-i+Math.PI*3)%(Math.PI*2)-Math.PI;i+=O*.04,m=!0}if(!m){let N=!1,G=null;if((r.x<Me||r.x>n.width-Me||r.y<Me||r.y>n.height-Me)&&(G={x:Math.max(W,Math.min(n.width-W,r.x)),y:Math.max(W,Math.min(n.height-W,r.y))},N=!0),N&&G){const F=n.width/2,O=n.height/2,B=(Math.atan2(O-r.y,F-r.x)-i+Math.PI*3)%(Math.PI*2)-Math.PI;i+=B*.04}else{const F=y*Ft*.001;i+=Math.sin(F*.5)*.005}}r.x+=Math.cos(i)*h,r.y+=Math.sin(i)*h,d?(r.x<W&&(r.x=W),r.x>n.width-W&&(r.x=n.width-W),r.y<W&&(r.y=W),r.y>n.height-W&&(r.y=n.height-W)):r.x>=W&&r.x<=n.width-W&&r.y>=W&&r.y<=n.height-W&&(d=!0);const M=performance.now()*12e-6%1,T=M*Math.PI*2,I=M*Math.PI*2*.73+1.7,C=M*Math.PI*2*.41+2.3,A=.18*Math.sin(I)+.12*Math.sin(T*1.31+.9)+.09*Math.sin(C);let k=be*(.7+.6*(.5+.5*Math.sin(T)+A)),E=k-u;Math.abs(E)>w&&(k=u+Math.sign(E)*w);let P=u+(k-u)*.18;const L=P-u;Math.abs(L)>w&&(P=u+Math.sign(L)*w),u=P,f.unshift({x:r.x,y:r.y,dir:i,scale3d:P}),f.length>x&&f.pop(),o.clearRect(0,0,n.width,n.height);const $=[];for(let N=0;N<Re;++N){const G=Math.floor(N*Be),F=f[G]||f[f.length-1]||{x:r.x,y:r.y,scale3d:be},O=F.scale3d,J=s.height*O;$.push({x:F.x,y:F.y-J*.1})}o.save(),o.strokeStyle="#bfa76f",o.lineWidth=2,o.shadowColor="#fffbe6",o.shadowBlur=6,o.beginPath();for(let N=0;N<$.length-1;++N){const G=$[N],F=$[N+1],O=(G.x+F.x)/2,J=(G.y+F.y)/2,B=Math.hypot(F.x-G.x,F.y-G.y),j=performance.now()*.001,se=18+12*Math.sin(j+N*.7),de=B*.18+se,oe=O,ye=J+de;N===0&&o.moveTo(G.x,G.y),o.quadraticCurveTo(oe,ye,F.x,F.y)}o.stroke(),o.shadowBlur=0,o.restore();const z=[];for(let N=0;N<Re;++N){const G=Math.floor(N*Be),F=f[G]||f[f.length-1]||{x:r.x,y:r.y,scale3d:be};z.push({i:N,x:F.x,y:F.y,scale3d:F.scale3d})}z.sort((N,G)=>N.scale3d-G.scale3d);for(const N of z){const{i:G,x:F,y:O,scale3d:J}=N,B=s.width*J,j=s.height*J;o.save(),o.globalAlpha=.98,o.drawImage(s,F-B/2,O-j,B,j),o.font=`bold ${Math.round(256*J)}px Cinzel, Arial, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillStyle="orange",o.strokeStyle="#fffbe6",o.lineWidth=2.2,o.shadowColor="orange",o.shadowBlur=24*J,o.strokeText(Le[G],F,O-j*.55),o.fillText(Le[G],F,O-j*.55),o.shadowBlur=0,o.restore()}requestAnimationFrame(p)}requestAnimationFrame(p)}setTimeout(()=>{},8e3)}const Ae=document.getElementById("app");if(Ae)Ae.innerHTML="",new ue().mount(Ae),setTimeout(()=>{const e=Ae.querySelector('div[style*="flex: 3"]');e&&(zt(e),Lt(e))},0);else throw new Error("No app element found in index.html");export{Ie as C,ce as P,xe as R,Ge as W};
