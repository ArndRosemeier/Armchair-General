var ot=Object.defineProperty;var rt=(T,e,t)=>e in T?ot(T,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):T[e]=t;var b=(T,e,t)=>rt(T,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();const st="modulepreload",it=function(T){return"/Armchair-General/"+T},Le={},de=function(e,t,n){let o=Promise.resolve();if(t&&t.length>0){let s=function(a){return Promise.all(a.map(l=>Promise.resolve(l).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=s(t.map(a=>{if(a=it(a),a in Le)return;Le[a]=!0;const l=a.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${d}`))return;const h=document.createElement("link");if(h.rel=l?"stylesheet":st,l||(h.as="script"),h.crossOrigin="",h.href=a,c&&h.setAttribute("nonce",c),document.head.appendChild(h),l)return new Promise((y,w)=>{h.addEventListener("load",y),h.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${a}`)))})}))}function r(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return o.then(s=>{for(const i of s||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})};class at{constructor(e=[]){b(this,"countries");this.countries=e}}const _e=Math.sqrt(3),lt=.5*(_e-1),he=(3-_e)/6,$e=T=>Math.floor(T)|0,Fe=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function Ce(T=Math.random){const e=ct(T),t=new Float64Array(e).map(o=>Fe[o%12*2]),n=new Float64Array(e).map(o=>Fe[o%12*2+1]);return function(r,s){let i=0,c=0,a=0;const l=(r+s)*lt,d=$e(r+l),h=$e(s+l),y=(d+h)*he,w=d-y,f=h-y,x=r-w,m=s-f;let p,u;x>m?(p=1,u=0):(p=0,u=1);const g=x-p+he,C=m-u+he,M=x-1+2*he,I=m-1+2*he,v=d&255,k=h&255;let A=.5-x*x-m*m;if(A>=0){const R=v+e[k],F=t[R],G=n[R];A*=A,i=A*A*(F*x+G*m)}let S=.5-g*g-C*C;if(S>=0){const R=v+p+e[k+u],F=t[R],G=n[R];S*=S,c=S*S*(F*g+G*C)}let E=.5-M*M-I*I;if(E>=0){const R=v+1+e[k+1],F=t[R],G=n[R];E*=E,a=E*E*(F*M+G*I)}return 70*(i+c+a)}}function ct(T){const t=new Uint8Array(512);for(let n=0;n<512/2;n++)t[n]=n;for(let n=0;n<512/2-1;n++){const o=n+~~(T()*(256-n)),r=t[n];t[n]=t[o],t[o]=r}for(let n=256;n<512;n++)t[n]=t[n-256];return t}function dt(T,e,t,n=1e3){var a;const o=T.length,r=((a=T[0])==null?void 0:a.length)||0,s=Array.from({length:o},()=>Array(r).fill(!1)),i=[[1,0],[-1,0],[0,1],[0,-1]],c=T.map(l=>l.slice());for(let l=0;l<o;l++)for(let d=0;d<r;d++)if(!s[l][d]&&T[l][d]===t){const h=[[l,d]],y=[[l,d]];for(s[l][d]=!0;h.length;){const[w,f]=h.shift();for(const[x,m]of i){const p=w+x,u=f+m;p>=0&&p<o&&u>=0&&u<r&&!s[p][u]&&T[p][u]===t&&(s[p][u]=!0,h.push([p,u]),y.push([p,u]))}}if(y.length<n)for(const[w,f]of y)c[w][f]=e}return c}function ht(T,e,t){var a;const n=T.length,o=((a=T[0])==null?void 0:a.length)||0,r=Array.from({length:n},()=>Array(o).fill(!1)),s=[];for(let l=0;l<o;l++)T[0][l]===e&&(s.push([0,l]),r[0][l]=!0),T[n-1][l]===e&&(s.push([n-1,l]),r[n-1][l]=!0);for(let l=1;l<n-1;l++)T[l][0]===e&&(s.push([l,0]),r[l][0]=!0),T[l][o-1]===e&&(s.push([l,o-1]),r[l][o-1]=!0);const i=[[1,0],[-1,0],[0,1],[0,-1]];for(;s.length;){const[l,d]=s.shift();for(const[h,y]of i){const w=l+h,f=d+y;w>=0&&w<n&&f>=0&&f<o&&!r[w][f]&&T[w][f]===e&&(r[w][f]=!0,s.push([w,f]))}}return T.map((l,d)=>l.map((h,y)=>h===e&&!r[d][y]?t:h))}function ut(T,e){return We(T,e,{scale:.0018,threshold:-.05,borderStrength:.5,borderWidth:.15,octaves:6,persistence:.5,seed:Math.floor(Math.random()*1e9)})}function We(T,e,t){const n=(t==null?void 0:t.scale)??.015,o=(t==null?void 0:t.threshold)??0,r=(t==null?void 0:t.seed)!==void 0?ft(t.seed):Math.random,s=Ce(r),i=(t==null?void 0:t.borderStrength)??.5,c=(t==null?void 0:t.borderWidth)??.2,a=(t==null?void 0:t.octaves)??4,l=(t==null?void 0:t.persistence)??.5,d=[];for(let y=0;y<e;y++){const w=[];for(let f=0;f<T;f++){const x=f-T/2,m=y-e/2;let p=0,u=0,g=1,C=1;for(let A=0;A<a;A++)p+=s(x*n*g,m*n*g)*C,u+=C,C*=l,g*=2;p/=u;const M=Math.min(f,T-1-f)/(T/2),I=Math.min(y,e-1-y)/(e/2),v=Math.min(M,I);let k=p;if(v<c){const A=i*(1-v/c);k=p*(1-A)+j*A}w.push(k>o?V:j)}d.push(w)}let h=ht(d,j,V);return h=dt(h,j,V,1e3),h}function ft(T){return function(){let e=T+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class ve{constructor(e,t=null,n=0,o=0){b(this,"name");b(this,"owner");b(this,"armies");b(this,"income");b(this,"coordinates");b(this,"border");b(this,"oceanBorder");b(this,"neighbors");b(this,"color");b(this,"fortified",!1);b(this,"nationalPride");b(this,"unrestLevel",0);b(this,"_center",null);this.name=e,this.owner=t,this.armies=n,this.income=o,this.coordinates=[],this.border=[],this.oceanBorder=[],this.neighbors=[],this.color=[Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150)];const r=1e3,s=1e5,i=Math.random()*Math.random();this.nationalPride=Math.floor(r+(s-r)*i),this.unrestLevel=0}setOwner(e){this.owner=e}setArmies(e){this.armies=e}center(){if(this._center)return this._center;if(!this.coordinates.length)return this._center=[0,0],this._center;let e=0,t=0;for(const[n,o]of this.coordinates)e+=n,t+=o;return this._center=[e/this.coordinates.length,t/this.coordinates.length],this._center}canBeFortified(){if(this.fortified)return!1;if(this.owner){for(const[e,t]of this.owner.plannedFortifications)if(e===this)return!1}return!0}toJSON(){return{id:this.name,name:this.name,ownerId:this.owner?this.owner.name:null,armies:this.armies,income:this.income,coordinates:this.coordinates,border:this.border,oceanBorder:this.oceanBorder,neighborIds:this.neighbors.map(e=>e.name),color:this.color,fortified:this.fortified,nationalPride:this.nationalPride,unrestLevel:this.unrestLevel}}static fromJSON(e,t,n){const o=new ve(e.name,null,e.armies,e.income);return o.coordinates=e.coordinates,o.border=e.border,o.oceanBorder=e.oceanBorder,o.color=e.color,o.fortified=e.fortified,o.nationalPride=e.nationalPride??1e3,o.unrestLevel=e.unrestLevel??0,o._ownerId=e.ownerId,o._neighborIds=e.neighborIds,n[e.name]=o,o}resolveReferences(e,t){this.owner=this._ownerId?e[this._ownerId]:null,this.neighbors=(this._neighborIds||[]).map(n=>t[n]).filter(Boolean),delete this._ownerId,delete this._neighborIds}}class yt{static generateCountriesMap(e,t={}){if(!e||e.length===0||!e[0])throw new Error("continentMap must be a non-empty 2D array");const n=e.length,o=e[0].length,r=t.countryCount??12,s=t.scale??.09,i=t.minResistance??10,c=t.maxResistance??50,a=t.skipProbability??.9,l=t.seed!==void 0?mt(t.seed):Math.random,d=Ce(l),h=[];for(let u=0;u<n;u++){const g=[];for(let C=0;C<o;C++)g.push(e[u][C]===V?i+(c-i)*Math.abs(d(C*s,u*s)):1/0);h.push(g)}const y=[],w=[];for(let u=0;u<n;u++)for(let g=0;g<o;g++)e[u][g]===V&&w.push([g,u]);for(let u=0;u<r&&w.length>0;u++){const g=Math.floor(l()*w.length),[C,M]=w.splice(g,1)[0];y.push({x:C,y:M,idx:u})}for(let u=0;u<n;u++)for(let g=0;g<o;g++)e[u][g]!==j&&(e[u][g]=V);for(const{x:u,y:g,idx:C}of y)e[g][u]=C;const f=y.map(({x:u,y:g,idx:C})=>[u,g,C]),x=(i+c)/2;for(;f.length>0;){const u=Math.floor(l()*f.length),[g,C,M]=f.splice(u,1)[0],I=[];for(const[v,k]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=g+v,S=C+k;A>=0&&A<o&&S>=0&&S<n&&e[S][A]===V&&I.push([A,S])}if(I.length!==0)for(const[v,k]of I)h[k][v]>x&&l()<a||(e[k][v]=M,f.push([v,k,M]))}const m=Array.from({length:n},()=>Array(o).fill(!1));let p=0;for(let u=0;u<n;u++)for(let g=0;g<o;g++)e[u][g]>=0&&e[u][g]+1>p&&(p=e[u][g]+1);for(let u=0;u<n;u++)for(let g=0;g<o;g++)if(e[u][g]===V&&!m[u][g]){const C=[[g,u]];for(m[u][g]=!0;C.length>0;){const[M,I]=C.pop();e[I][M]=p;for(const[v,k]of[[1,0],[0,1],[-1,0],[0,-1]]){const A=M+v,S=I+k;A>=0&&A<o&&S>=0&&S<n&&e[S][A]===V&&!m[S][A]&&(C.push([A,S]),m[S][A]=!0)}}p++}return e}static generateCountriesInternal(e,t){const n=this.generateCountriesMap(e,t);if(!n||n.length===0||!n[0])throw new Error("map must be a non-empty 2D array");const o=n.length,r=n[0].length,s={};for(let a=0;a<o;a++)for(let l=0;l<r;l++){const d=n[a][l];if(d>=0){if(!s[d]){const h=new ve(`Country ${d}`);h.id=d,s[d]=h}s[d].coordinates.push([l,a])}}const i=Math.max(...Object.keys(s).map(Number)),c=Array.from({length:i+1},(a,l)=>s[l]);return this.findCountryBorders(n,c,r,o),{map:n,countries:c}}static findCountryBorders(e,t,n,o){const r=[[1,0],[0,1],[-1,0],[0,-1]];for(const s of t){const i=s.id;s.border=[],s.oceanBorder=[];for(const[c,a]of s.coordinates){let l=!1,d=!1;for(const[h,y]of r){const w=c+h,f=a+y;(w<0||w>=n||f<0||f>=o||e[f][w]!==i)&&(l=!0,(w<0||w>=n||f<0||f>=o||e[f][w]===j)&&(d=!0))}l&&s.border.push([c,a]),d&&s.oceanBorder.push([c,a])}}}static findNeighbors(e){const t=new Map;for(const n of e)for(const[o,r]of n.border)t.set(`${o},${r}`,n);for(const n of e){const o=new Set;for(const[r,s]of n.border)for(const[i,c]of[[1,0],[0,1],[-1,0],[0,-1]]){const a=r+i,l=s+c,d=t.get(`${a},${l}`);d&&d!==n&&o.add(d)}n.neighbors=Array.from(o)}}static mergeSmallCountries(e,t=1e3,n){let o=!0;for(;o;){o=!1;for(let r=e.length-1;r>=0;r--){const s=e[r];if(s.coordinates.length<t&&s.neighbors.length>0){let i=s.neighbors[0];for(const c of s.neighbors)c.coordinates.length<i.coordinates.length&&(i=c);if(i.coordinates.push(...s.coordinates),n&&i.id!==void 0&&s.id!==void 0)for(const[c,a]of s.coordinates)n[a][c]=i.id;e.splice(r,1),o=!0}}o&&(this.findNeighbors(e),console.log("Merged countries"))}}static generateCountries(e,t={}){const{map:n,countries:o}=this.generateCountriesInternal(e,t);this.findNeighbors(o);const r=(t==null?void 0:t.minCountrySize)??1e3;if(this.mergeSmallCountries(o,r,n),!n||n.length===0||!n[0])throw new Error("map must be a non-empty 2D array");const s=n[0].length,i=n.length;return this.findCountryBorders(n,o,s,i),this.findNeighbors(o),{map:n,countries:o}}}function mt(T){return function(){let e=T+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function pt(T,e){return yt.generateCountries(T,{countryCount:e,minResistance:0,maxResistance:130,skipProbability:0})}const j=-1,V=-2,Q=class Q{constructor(e,t,n=[]){b(this,"countries");b(this,"map");b(this,"continents",[]);this.countries=n,this.map=Q.createOceanMap(e,t)}static logCountryNamesInOrder(e,t=""){const n=e.map((o,r)=>`${r}: ${o.name}`);console.log(`[WorldMap] Country order${t?" - "+t:""}:
`+n.join(", "))}static checkMapCountryConsistency(e,t){if(!Array.isArray(e)||!Array.isArray(t))return console.error("[WorldMap] Consistency check failed: map or countries not arrays"),!1;let n=!0;for(let o=0;o<e.length;++o)for(let r=0;r<e[o].length;++r){const s=e[o][r];s>=0&&(t[s]?typeof t[s].name!="string"&&(console.error(`[WorldMap] Inconsistent: countries[${s}] has no valid name at map[${o}][${r}]`),n=!1):(console.error(`[WorldMap] Inconsistent: map[${o}][${r}] = ${s}, but countries[${s}] is undefined`),n=!1))}return n}assignRandomCountryNames(){let e=!1;for(;!e;){const t=new Set;for(const n of this.countries){let o,r=0;do if(o=Q.generateRandomName(),r++,r>1e3)throw new Error("Failed to generate unique random country names");while(t.has(o));n.name=o,t.add(o)}e=t.size===this.countries.length}}assignRealCountryNames(){let e=!1;for(;!e;){const t=[...Q.REAL_COUNTRY_NAMES],n=new Set;for(const o of this.countries){let r;if(t.length>0){const s=Math.floor(Math.random()*t.length);r=t.splice(s,1)[0]}else{let s=0;do if(r=Q.generateRandomName(),s++,s>1e3)throw new Error("Failed to generate unique fallback country names");while(n.has(r))}o.name=r,n.add(r)}e=n.size===this.countries.length}}static generateRandomName(){const e=["zan","mor","vek","tal","rin","dor","lek","sha","val","nor","ka","bel","dra","sil","tur","gar","fen","mir","sol","vor","lin","sar","qu","zel","ron","bar","zen","tir","lom","kal","vin","lor","mel","dar","gol","han","jor","ken","lun","mar"],t=2+Math.floor(Math.random()*2);let n="";for(let o=0;o<t;o++)n+=e[Math.floor(Math.random()*e.length)];return n.charAt(0).toUpperCase()+n.slice(1)}static createOceanMap(e,t){return Array.from({length:t},()=>Array(e).fill(j))}static generateContinentsMap(e,t,n){return We(e,t,n)}static createMap(e,t,n=40,o=!0){const r=ut(e,t),{map:s,countries:i}=pt(r,n),c=new Q(e,t,i);return c.map=s,o?c.assignRealCountryNames():c.assignRandomCountryNames(),c.regenerateMapFromCountries(c.countries),c.createContinents(),c}addCountry(e){this.countries.push(e)}createContinents(){const e=new Set,t=[];for(const n of this.countries)if(!e.has(n)){const o=[n],r=[];for(e.add(n);o.length>0;){const s=o.shift();r.push(s);for(const i of s.neighbors)e.has(i)||(e.add(i),o.push(i))}t.push(new at(r))}this.continents=t}getCountries(){return this.countries}distance(e,t){const[n,o]=e.center(),[r,s]=t.center(),i=Math.sqrt((n-r)**2+(o-s)**2);if(e.neighbors.includes(t)||t.neighbors.includes(e))return i;const c=e.oceanBorder&&e.oceanBorder.length>0,a=t.oceanBorder&&t.oceanBorder.length>0;return c&&a?i*3:null}getMap(){return this.map}regenerateMapFromCountries(e){if(!this.map||!Array.isArray(this.map)||this.map.length===0||this.map[0].length===0)throw new Error("WorldMap.map is not initialized or has invalid dimensions");const t=this.map.length,n=this.map[0].length,o=Q.createOceanMap(n,t);for(let r=0;r<e.length;++r){const s=e[r];if(!s.coordinates||!Array.isArray(s.coordinates))throw new Error(`Country at index ${r} has no valid coordinates array`);for(const[i,c]of s.coordinates){if(typeof i!="number"||typeof c!="number"||i<0||i>=n||c<0||c>=t)throw new Error(`Country index ${r} has out-of-bounds coordinate (${i}, ${c})`);o[c][i]=r}}this.map=o}};b(Q,"REAL_COUNTRY_NAMES",["Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia"]);let Ie=Q;function gt(T){if(!T.length)throw new Error("No countries provided");let e=0,t=0;for(const s of T)for(const[i,c]of s.coordinates)i>e&&(e=i),c>t&&(t=c);const n=e+1,o=t+1,r=new Ie(n,o,T);return r.regenerateMapFromCountries(T),r.createContinents(),r}const H=class H{static render(e,t=[],n=[],o=!1,r=null){var w;const s=e.getMap(),i=((w=e.getCountries)==null?void 0:w.call(e))||[],c=s.length,a=s[0].length,l=document.createElement("canvas");l.width=a,l.height=c;const d=l.getContext("2d");if(!d)throw new Error("Could not get canvas context");const h=d.createImageData(a,c),y=h.data;for(let f=0;f<c;f++)for(let x=0;x<a;x++){const m=s[f][x],[p,u,g]=H.getRGBForValue(m,i,x,f,s),C=(f*a+x)*4;y[C]=p,y[C+1]=u,y[C+2]=g,y[C+3]=255}if(t&&t.length>0){for(const f of t)if(!(!f||!f.coordinates)){for(const[x,m]of f.coordinates)if(x>=0&&x<a&&m>=0&&m<c){const p=(m*a+x)*4;y[p]=Math.min(255,Math.round(.6*255+.4*y[p])),y[p+1]=Math.min(255,Math.round(.6*255+.4*y[p+1])),y[p+2]=Math.round(.4*y[p+2]),y[p+3]=255}}}for(const f of i){const x=f.owner&&f.owner.homeCountry===f,m=x?[255,140,0]:[0,0,0];for(const[p,u]of f.border||[])if(x)for(let g=-1;g<=1;g++)for(let C=-1;C<=1;C++){const M=p+C,I=u+g;if(M>=0&&M<a&&I>=0&&I<c){const v=(I*a+M)*4;y[v]=m[0],y[v+1]=m[1],y[v+2]=m[2],y[v+3]=255}}else if(p>=0&&p<a&&u>=0&&u<c){const g=(u*a+p)*4;y[g]=m[0],y[g+1]=m[1],y[g+2]=m[2],y[g+3]=255}}d.putImageData(h,0,0),d.save(),d.font="bold 10px MedievalSharp, Verdana, serif",d.textAlign="center",d.textBaseline="middle";for(const f of i){if(!f.name)continue;const[x,m]=f.center?f.center():[0,0],p=f.fortified?"üõ°Ô∏è "+f.name:f.name;d.lineWidth=3,d.strokeStyle="black",d.strokeText(p,x,m);const u=n.some(M=>M===f);f.unrestLevel>0?(d.font="italic bold 10px MedievalSharp, Verdana, serif",d.fillStyle="#FF0000",d.fillText(p,x,m)):(d.font="bold 10px MedievalSharp, Verdana, serif",d.fillStyle=u?"#90EE90":"white",d.fillText(p,x,m));let g=!1;(o||r&&f.owner===r&&!r.isAI||r&&typeof r.armyKnown=="function"&&r.armyKnown(f)&&!r.isAI)&&(g=!0);let C=13;if(g){const M=f.armies||0,I=`${Math.round(M/1e3)}k`;d.font="bold 9px MedievalSharp, Verdana, serif",d.lineWidth=2,d.strokeStyle="black",d.strokeText(I,x,m+C),d.fillStyle="#FFD700",d.fillText(I,x,m+C),d.font="bold 10px MedievalSharp, Verdana, serif",C+=13}f.unrestLevel>0&&(d.font="italic bold 8px MedievalSharp, Verdana, serif",d.strokeText("Rioting",x,m+C),d.fillStyle="#FF0000",d.fillText("Rioting",x,m+C))}return d.restore(),l}static displayWithPanZoom(e,t,n=512,o=512,r=[]){let s=null,i=H.render(e,[],r);const c=i.width,a=i.height,l=document.createElement("canvas");l.width=n,l.height=o,l.style.border="1px solid #888",t.appendChild(l);const d=l.getContext("2d");if(!d)throw new Error("Could not get canvas context");let h=Math.min(l.width/c,l.height/a),y=(l.width-c*h)/2,w=(l.height-a*h)/2,f=!1,x=0,m=0;function p(){i=H.render(e,s?[s]:[],r),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,l.width,l.height),d.setTransform(h,0,0,h,y,w),d.drawImage(i,0,0)}return l.addEventListener("mousedown",u=>{const g=l.getBoundingClientRect(),C=(u.clientX-g.left-y)/h,M=(u.clientY-g.top-w)/h,I=e.getMap(),v=e.getCountries(),k=Math.floor(C),A=Math.floor(M);let S=null;if(k>=0&&A>=0&&A<I.length&&k<I[0].length){const E=I[A][k];E>=0&&v[E]&&(S=v[E])}if(S){s=S,p();return}f=!0,x=u.clientX,m=u.clientY}),window.addEventListener("mousemove",u=>{if(!f)return;const g=u.clientX-x,C=u.clientY-m;y+=g,w+=C,x=u.clientX,m=u.clientY,p()}),window.addEventListener("mouseup",()=>{f=!1}),l.addEventListener("wheel",u=>{u.preventDefault();const g=u.offsetX,C=u.offsetY,M=Math.exp(-u.deltaY*.001);y=g-(g-y)*M,w=C-(C-w)*M,h*=M,p()}),p(),l}static getRGBForValue(e,t,n,o,r){var s,i,c;if(e===j){n=n??0,o=o??0,r=r??[];const a=((s=r[0])==null?void 0:s.length)||1024,l=r.length||768,d=o/l;let h=Math.round(30*(1-d)+10*d),y=Math.round(144*(1-d)+80*d),w=Math.round(255*(1-d)+180*d);const f=H._oceanNoise2D(n*.03,o*.03),x=Math.floor(18*f);h+=x,y+=x,w+=x;let m=!1;if(r&&n>0&&o>0&&n<a-1&&o<l-1)for(const[p,u]of[[1,0],[-1,0],[0,1],[0,-1]]){const g=n+p,C=o+u;if(r[C][g]!==j){m=!0;break}}return m&&(h=Math.min(255,h+40),y=Math.min(255,y+40),w=Math.min(255,w+40)),[h,y,w]}if(e===V){n=n??0,o=o??0,r=r??[];const a=((i=r[0])==null?void 0:i.length)||1024,l=r.length||768,d=H._landNoise2D(n*.04,o*.04),h=[34,139,34],y=[80,180,80],w=.5+.5*d;let f=Math.round(h[0]*(1-w)+y[0]*w),x=Math.round(h[1]*(1-w)+y[1]*w),m=Math.round(h[2]*(1-w)+y[2]*w),p=!1;if(r&&n>0&&o>0&&n<a-1&&o<l-1)for(const[u,g]of[[1,0],[-1,0],[0,1],[0,-1]]){const C=n+u,M=o+g;if(r[M][C]===j){p=!0;break}}return p&&(f=Math.min(255,f+30),x=Math.min(255,x+30),m=Math.min(255,m+30)),[f,x,m]}if(e>=0){const a=t[e];let l=[200,200,200];if(a)if(a.owner&&typeof a.owner.RGBColor=="string"){const v=a.owner.RGBColor.split(",").map(Number);v.length===3&&v.every(k=>!isNaN(k))&&(l=[v[0],v[1],v[2]])}else a.color&&(l=a.color);n=n??0,o=o??0,r=r??[];const d=((c=r[0])==null?void 0:c.length)||1024,h=r.length||768,y=H._landNoise2D(n*.02,o*.02),w=Math.round(18*y),f=l,x=[Math.max(0,l[0]-32),Math.max(0,l[1]-48),Math.max(0,l[2]-32)],m=.5+.5*y;let p=Math.round(f[0]*(1-m)+x[0]*m)+w,u=Math.round(f[1]*(1-m)+x[1]*m)+w,g=Math.round(f[2]*(1-m)+x[2]*m)+w;const C=H._landNoise2D(n*.006+100,o*.006+100),M=Math.round(18*C);p=Math.min(255,Math.max(0,p+M)),u=Math.min(255,Math.max(0,u+M)),g=Math.min(255,Math.max(0,g+M));let I=!1;if(r&&n>0&&o>0&&n<d-1&&o<h-1)for(const[v,k]of[[1,0],[-1,0],[0,1],[0,-1]]){const A=n+v,S=o+k;if(r[S][A]===j){I=!0;break}}return I&&(p=Math.min(255,p+12),u=Math.min(255,u+12),g=Math.min(255,g+12)),[p,u,g]}return[255,255,255]}static drawCountryGlow(e,t,n,o){function r(i,c,a){return[Math.round(i[0]+(c[0]-i[0])*a),Math.round(i[1]+(c[1]-i[1])*a),Math.round(i[2]+(c[2]-i[2])*a)]}let s=new Set(t.coordinates.map(([i,c])=>`${i},${c}`));for(let i=0;i<10;++i){const c=[];for(const d of s){const[h,y]=d.split(",").map(Number),w=[[h-1,y],[h+1,y],[h,y-1],[h,y+1]];for(const[f,x]of w)if(!s.has(`${f},${x}`)){c.push([h,y]);break}}const a=i/9,l=r(n,o,a);e.save(),e.fillStyle=`rgb(${l[0]},${l[1]},${l[2]})`;for(const[d,h]of c)e.fillRect(d,h,1,1);e.restore();for(const[d,h]of c)s.delete(`${d},${h}`);if(s.size===0)break}e.save();for(const i of s){const[c,a]=i.split(",").map(Number);let l=[200,200,200];if(t)if(t.owner&&typeof t.owner.RGBColor=="string"){const C=t.owner.RGBColor.split(",").map(Number);C.length===3&&C.every(M=>!isNaN(M))&&(l=[C[0],C[1],C[2]])}else t.color&&(l=t.color);const d=H._landNoise2D(c*.02,a*.02),h=Math.round(18*d),y=l,w=[Math.max(0,l[0]-32),Math.max(0,l[1]-48),Math.max(0,l[2]-32)],f=.5+.5*d;let x=Math.round(y[0]*(1-f)+w[0]*f)+h,m=Math.round(y[1]*(1-f)+w[1]*f)+h,p=Math.round(y[2]*(1-f)+w[2]*f)+h;const u=H._landNoise2D(c*.006+100,a*.006+100),g=Math.round(18*u);x=Math.min(255,Math.max(0,x+g)),m=Math.min(255,Math.max(0,m+g)),p=Math.min(255,Math.max(0,p+g)),e.fillStyle=`rgb(${x},${m},${p})`,e.fillRect(c,a,1,1)}e.restore()}};b(H,"drawBorders",!0),b(H,"_oceanNoise2D",Ce()),b(H,"_landNoise2D",Ce());let fe=H;class le{RequiresAmount(e,t,n){return null}}class q{constructor(e,t,n,o,r=null){b(this,"countries");b(this,"amount");b(this,"action");b(this,"score");b(this,"followUp");this.countries=e,this.amount=t,this.action=n,this.score=o,this.followUp=r}}class wt{constructor(e,t,n){b(this,"canvas");b(this,"ctx");b(this,"start");b(this,"end");this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Could not get canvas context");this.ctx=o,this.start=t,this.end=n}draw(){const e=this.ctx,{start:t,end:n}=this,o=(t.x+n.x)/2,r=(t.y+n.y)/2,s=n.x-t.x,i=n.y-t.y,c=Math.sqrt(s*s+i*i),a=.25*c,l=-i/c*a,d=s/c*a,h=o+l,y=r+d,w=e.createLinearGradient(t.x,t.y,n.x,n.y);w.addColorStop(0,"#fff"),w.addColorStop(.5,"#0ff"),w.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=12,e.strokeStyle=w,e.beginPath(),e.moveTo(t.x,t.y),e.quadraticCurveTo(h,y,n.x,n.y),e.stroke();const f=.95,x=this.getQuadraticPoint(t,{x:h,y},n,f),m=this.getQuadraticTangent(t,{x:h,y},n,f);this.drawArrowhead(x,m),e.restore()}getQuadraticPoint(e,t,n,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*t.x+o*o*n.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*t.y+o*o*n.y;return{x:r,y:s}}getQuadraticTangent(e,t,n,o){const r=2*(1-o)*(t.x-e.x)+2*o*(n.x-t.x),s=2*(1-o)*(t.y-e.y)+2*o*(n.y-t.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,t){const n=this.ctx;n.save(),n.translate(e.x,e.y);const o=Math.atan2(t.y,t.x);n.rotate(o),n.beginPath(),n.moveTo(0,0),n.lineTo(-18,7),n.lineTo(-12,0),n.lineTo(-18,-7),n.closePath(),n.fillStyle="rgba(0,255,255,0.95)",n.shadowColor="#fff",n.shadowBlur=8,n.fill(),n.restore()}}class xt{constructor(e,t,n){b(this,"canvas");b(this,"attacker");b(this,"defender");this.canvas=e,this.attacker=t,this.defender=n}async start(){const e=this.canvas.getContext("2d");if(!e)return;const[t,n]=this.attacker.center(),[o,r]=this.defender.center(),s={x:t,y:n},i={x:o,y:r};new wt(this.canvas,s,i);const c=500,a=this.attacker,l=this.defender;return new Promise(d=>{const h=y=>{const f=performance.now()-y,x=Math.min(f/c,1);e.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCountry(e,a,"attacker"),this.drawCountry(e,l,"defender"),this.drawAnimatedArrow(e,s,i,x),x<1?requestAnimationFrame(()=>h(y)):d()};requestAnimationFrame(y=>h(y))})}drawAnimatedArrow(e,t,n,o){const r=(t.x+n.x)/2,s=(t.y+n.y)/2,i=n.x-t.x,c=n.y-t.y,a=Math.sqrt(i*i+c*c),l=.25*a,d=-c/a*l,h=i/a*l,y=r+d,w=s+h,f=e.createLinearGradient(t.x,t.y,n.x,n.y);f.addColorStop(0,"#fff"),f.addColorStop(.5,"#0ff"),f.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=16,e.strokeStyle=f,e.beginPath(),e.moveTo(t.x,t.y);const x=60;for(let m=1;m<=Math.floor(x*o);++m){const p=m/x,u=this.getQuadraticPoint(t,{x:y,y:w},n,p);e.lineTo(u.x,u.y)}if(e.stroke(),o>.05){const m=o,p=this.getQuadraticPoint(t,{x:y,y:w},n,m),u=this.getQuadraticTangent(t,{x:y,y:w},n,m);this.drawArrowhead(e,p,u)}e.restore()}drawCountry(e,t,n){let o;n==="attacker"?o=[180,0,0]:n==="defender"?o=[0,0,180]:o=t.color||[200,200,200],fe.drawCountryGlow(e,t,o,t.color);const[r,s]=t.center?t.center():[0,0],i=t.fortified?"üõ°Ô∏è "+t.name:t.name;if(e.save(),e.font="bold 10px Verdana, Geneva, sans-serif",e.textAlign="center",e.textBaseline="middle",e.lineWidth=3,e.strokeStyle="black",e.strokeText(i,r,s),e.fillStyle="white",e.fillText(i,r,s),typeof t.armies=="number"&&B.showArmies){const c=`${Math.round(t.armies/1e3)}k`;e.font="bold 9px Verdana, Geneva, sans-serif",e.lineWidth=2,e.strokeStyle="black",e.strokeText(c,r,s+13),e.fillStyle="#FFD700",e.fillText(c,r,s+13)}e.restore()}getQuadraticPoint(e,t,n,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*t.x+o*o*n.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*t.y+o*o*n.y;return{x:r,y:s}}getQuadraticTangent(e,t,n,o){const r=2*(1-o)*(t.x-e.x)+2*o*(n.x-t.x),s=2*(1-o)*(t.y-e.y)+2*o*(n.y-t.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,t,n){e.save(),e.translate(t.x,t.y);const o=Math.atan2(n.y,n.x);e.rotate(o),e.beginPath(),e.moveTo(0,0),e.lineTo(-18,7),e.lineTo(-12,0),e.lineTo(-18,-7),e.closePath(),e.fillStyle="rgba(0,255,255,0.95)",e.shadowColor="#fff",e.shadowBlur=8,e.fill(),e.restore()}}class U extends le{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];if(n.owner!==t||n===o)return null;const r=n.neighbors.includes(o),s=n.oceanBorder.length>0&&o.oceanBorder.length>0;return!r&&!s||o.owner===t?null:`Attack ${o.name} from ${n.name}`}async Act(e,t,n,o=0){var u,g;if(!n)throw new Error("Internal error: currentGame is required.");if(e.length<2)throw new Error("Select source and target countries to attack.");const r=e[e.length-2],s=e[e.length-1];if(r.owner!==t)throw new Error("You must own the attacking country.");const i=r.neighbors.includes(s),c=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!c)throw new Error("Target country must be a neighbor or reachable by naval attack.");if(s.owner===t)throw new Error("Cannot attack your own country.");if(o<=0||o>=r.armies)throw new Error("Invalid number of armies committed.");if(!t.game)throw new Error("ActionAttack: activePlayer.game is missing");if(!t.game.gui)throw new Error("ActionAttack: activePlayer.game.gui is missing");const l=t.game.gui.getWorldMapCanvas(),d=l.parentElement;if(!d)throw new Error("ActionAttack: mapCanvas.parentElement is null");d.style.position="relative";let h=document.getElementById("attack-animation-overlay");h&&((u=h.parentElement)==null||u.removeChild(h));let y=document.createElement("canvas");y.id="attack-animation-overlay",y.width=l.width,y.height=l.height,y.style.position="absolute",y.style.left="0",y.style.top="0",y.style.pointerEvents="none",y.style.zIndex="9999",y.style.width="100%",y.style.height="100%",y.style.background="rgba(255,255,255,0.01)",d.appendChild(y),new xt(y,r,s).start(),await new Promise(C=>setTimeout(C,0)),await new Promise(C=>setTimeout(C,1e3)),(g=y==null?void 0:y.parentElement)==null||g.removeChild(y);const f=U.AttackChance(r.armies,s.armies,n.worldMap.distance(r,s)||0,s.fortified,n),x=Math.random(),m=Math.sqrt(Math.abs(x-f));let p="";if(r.armies-=o,x<f){const C=s.owner;C&&(C.ownedCountries=C.ownedCountries.filter(I=>I!==s),C.plannedFortifications=C.plannedFortifications.filter(([I,v])=>I!==s)),s.owner=t,t.ownedCountries.push(s);let M=Math.max(1,Math.round(o*Math.sqrt(m)));M>0&&(M=Math.max(1e3,Math.round(M/1e3)*1e3)),s.armies=M,s.fortified=!1,C&&C.ownedCountries.length===0&&n.players.includes(C)&&(n.players=n.players.filter(I=>I!==C),n.activePlayerIndex>=n.players.length&&(n.activePlayerIndex=0)),t.ownedCountries.length===0&&n.players.includes(t)&&(n.players=n.players.filter(I=>I!==t),n.activePlayerIndex>=n.players.length&&(n.activePlayerIndex=0));for(const I of n.players)I.knowledge=I.knowledge.filter(v=>v.country!==s);p=`Attack successful! ${M} of your ${o} armies occupy ${s.name}.`}else{let C=Math.round(s.armies*Math.sqrt(m));C>0&&(C=Math.max(1e3,Math.round(C/1e3)*1e3)),s.armies=Math.max(1,s.armies-C),s.armies>0&&(s.armies=Math.max(1e3,Math.round(s.armies/1e3)*1e3)),p=`Attack failed! All ${o} attacking armies lost. Defenders lost ${C} troops.`}return p}static AttackChance(e,t,n,o,r){return n===null?0:(t*=n/100,o&&(t*=2),e>=3*t?1:e<=t/3?0:e<t?.5*(e-t/3)/(t-t/3):.5+.5*(e-t)/(2*t))}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Attack"}ActionString(e,t,n,o=0){if(e.length<2)return"Attack: Not enough countries selected.";const r=e[e.length-2];return`Attacking ${e[e.length-1].name} from ${r.name} with ${o} soldiers`}}class we extends le{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];return!n||!o||n.owner!==t||o.owner!==t||n===o?null:`Move armies from ${n.name} to ${o.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to move armies.";const r=e[e.length-2],s=e[e.length-1];return r.owner!==t||s.owner!==t?"Both countries must be owned by you.":r===s?"Source and target countries must be different.":o<=0||o>=r.armies?"Invalid number of armies to move.":(r.armies-=o,s.armies+=o,`Moved ${o} armies from ${r.name} to ${s.name}.`)}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Move"}ActionString(e,t,n,o=0){if(e.length<2)return"Move: Not enough countries selected.";const r=e[e.length-2],s=e[e.length-1];return`Moving ${o} armies from ${r.name} to ${s.name}`}}class qe extends le{GetButtonText(e,t){if(e.length===0)return null;const n=e[e.length-1];return n.canBeFortified()?`Fortify ${n.name}`:null}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length===0)return"Please select a country to fortify.";const r=e[e.length-1];return r.canBeFortified()?t.money<B.fortifyCost?`Not enough money to fortify. You need $${B.fortifyCost}.`:(t.money-=B.fortifyCost,t.plannedFortifications.push([r,n.gameTurn+2]),`Fortification planned for ${r.name} on turn ${n.gameTurn+2}.`):`${r.name} cannot be fortified.`}RequiresAmount(e,t,n){return null}get countryCountNeeded(){return 1}Type(){return"Fortify"}ActionString(e,t,n,o=0){return e.length<1?"Fortify: No country selected.":`Fortifying ${e[e.length-1].name}`}}class xe extends le{GetButtonText(e,t){if(e.length<1)return null;const n=e[e.length-1];return!n||n.owner!==t?null:`Buy armies for ${n.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<1)return"Select a friendly country to buy armies for.";const r=e[e.length-1];if(r.owner!==t)return"You must own the target country.";if(o<=0)return"Invalid number of armies to buy.";const s=o*B.armyCost;return t.money<s?`Not enough money. Need ${s.toLocaleString()}, have ${t.money.toLocaleString()}.`:(t.money-=s,r.armies+=o,`Bought ${o} armies for ${r.name} at a cost of ${s.toLocaleString()}.`)}RequiresAmount(e,t,n){const o=Math.floor(t.money/B.armyCost/1e3)*1e3;return o<1e3?null:[1e3,o]}get countryCountNeeded(){return 1}Type(){return"BuyArmies"}ActionString(e,t,n,o=0){if(e.length<1)return"Buy Armies: No country selected.";const r=e[e.length-1];return`Buying ${o} soldiers for ${r.name}`}}const J=class J{constructor(e,t){b(this,"player");b(this,"game");b(this,"actionPlan",[]);this.player=e,this.game=t}GetBestArmies(e){return!this.player.ownedCountries||this.player.ownedCountries.length===0?[]:this.player.ownedCountries.slice().sort((t,n)=>(n.armies||0)-(t.armies||0)).slice(0,e)}FindSpyOpportunities(){const e=new He,t=[];if(this.player.ownedCountries.length>0){const l=this.player.ownedCountries.reduce((f,x)=>x.armies>f.armies?x:f,this.player.ownedCountries[0]),d=this.game.worldMap,w=d.getCountries().filter(f=>f.owner&&f.owner!==this.player).map(f=>{const x=d.distance(l,f);return x!==null?{country:f,distance:x}:null}).filter(f=>f!==null).sort((f,x)=>f.distance-x.distance).slice(0,3);for(const{country:f,distance:x}of w){if(x>200)continue;const m=this.player.knowledge.find(p=>p.country===f);if(!m||this.game.gameTurn-m.gameTurn>3){const p=f.fortified?B.spyFortifiedCost:B.spyCost;if(this.player.money>=p){t.push(new q([f],0,e,1e4));break}}}}const n=this.getNonOwnedCountriesSortedByDistance(),s=this.game.worldMap.getCountries().filter(l=>l.owner&&l.owner!==this.player),i=Math.min(5,this.player.ownedCountries.length);let c=0;for(const l of s){const d=this.player.knowledge.find(h=>h.country===l);l.owner&&l.owner!==this.player?d&&this.game.gameTurn-d.gameTurn<=3&&c++:l.owner||d&&c++}let a=1;c<i&&(a=10);for(const{country:l,distance:d}of n){const h=this.player.knowledge.find(w=>w.country===l);if(!l.owner&&h||l.owner&&l.owner!==this.player&&h&&this.game.gameTurn-h.gameTurn<=3)continue;let y=3e3-Math.sqrt(d);if(y*=a,y>0){const w=l.fortified?B.spyFortifiedCost:B.spyCost;if(this.player.money>=w){const f=y*(this.player.totalIncome()/5e6);t.push(new q([l],0,e,f))}}}return t}FindAttackOpportunities(){const e=new U,n=this.game.worldMap.getCountries(),o=[];for(const r of n){if(r.owner===this.player)continue;const[s,i]=this.countryBestAttackerScore(r);if(!s)continue;const c=Math.floor(s.armies*J.ATTACK_COMMIT/1e3)*1e3;c<1e3||o.push(new q([s,r],c,e,i*this.player.aggressivity))}return o}async takeAction(){if(this.player.actionsLeft<=0)return!1;if(this.player.actionsLeft>=4&&Math.random()<.2&&this.actionPlan.length===0)return this.PlanSurpriseAttack(),!0;let e=null;if(this.actionPlan.length>0){e=this.actionPlan.shift();const o=e.action,r=e.countries,s=e.amount;if(o instanceof we){const i=r[0];if(!i||i.armies<s+1e3)return console.warn("Skipping invalid move from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof U){const i=r[0],c=r[1];if(!i||!c||c.owner===this.player||i.armies<s)return console.warn("Skipping invalid attack from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof xe&&this.player.money<s*B.armyCost)return console.warn("Skipping invalid buy from actionPlan:",e),this.actionPlan=[],!1}else e=this.findBestOpportunity();if(!e)return!1;const t=await e.action.Act(e.countries,this.player,this.game,e.amount),n=e.countries.slice(-e.action.countryCountNeeded);return this.player.actionLog.push({actionType:e.action.Type(),countries:n,amount:e.amount,result:t??null}),e.followUp&&this.actionPlan.length===0&&this.actionPlan.push(e.followUp),this.player.useAction(),!0}countryDefenseEstimate(e){let t;const n=this.player.knowledge.find(r=>r.country===e),o=e.owner&&e.owner!==this.player;return o&&(!n||this.game.gameTurn-n.gameTurn>3)?t=1e5:!o&&!n?t=7e4:n?t=n.army:t=7e4,e.fortified&&(t*=2),t}countryScore(e){let t;const n=this.player.knowledge.find(r=>r.country===e);n&&typeof n.income=="number"?t=n.income:t=1e6;const o=this.countryDefenseEstimate(e);return t/o}countryBestAttackerScore(e){const t=this.countryDefenseEstimate(e);let n=0,o=null;for(const r of this.player.ownedCountries){const s=this.game.worldMap.distance(r,e);if(s===null)continue;const i=Math.round((r.armies||0)*J.ATTACK_COMMIT/1e3)*1e3;if(i<1e3)continue;const c=U.AttackChance(i,t,s,!1,this.game);let a=0;c>=.7&&(a=c*c*this.countryScore(e)*1e3),a>n&&(n=a,o=r)}return[o,n]}FindMoveOpportunities(e){const t=[];if(this.player.ownedCountries.length===0)return t;const n=this.player.ownedCountries.reduce((a,l)=>l.armies>a.armies?l:a,this.player.ownedCountries[0]);let o=null,r=-1/0,s=null;for(const a of this.player.ownedCountries){const l=this.getReachableNonOwnedCountries(a);for(const{country:d,distance:h}of l){let y=1;h>100&&(y=Math.max(0,1-(h-100)/900));const w=this.countryScore(d)*y;w>r&&(r=w,o=a,s=d)}}if(o&&o!==n){const a=Math.floor(n.armies*.5/1e3)*1e3;if(a>0&&n!==o){let l=null;if(this.actionPlan.length===0&&s){const d=o.armies+a,h=Object.create(o);if(h.armies=d,this.isAttackFeasible(h,s,J.ATTACK_COMMIT)){const y=new U,w=Math.floor(d*J.ATTACK_COMMIT/1e3)*1e3;l=new q([o,s],w,y,100)}}t.push(new q([n,o],a,e,r,l))}}const i=this.player.totalArmies()/this.player.ownedCountries.length,c=this.player.ownedCountries.reduce((a,l)=>l.armies<a.armies?l:a,this.player.ownedCountries[0]);if(c.armies<i/2&&c!==n){const a=i/2,l=Math.floor((a-c.armies)/1e3)*1e3,d=Math.max(0,Math.min(l,n.armies-1e3));d>0&&n!==c&&t.push(new q([n,c],d,e,i-c.armies))}return t}FindFortifyOpportunities(e){const t=[],n=this.player.ownedCountries.filter(o=>!o.fortified).length;for(const o of this.player.ownedCountries)if(o.canBeFortified()&&this.player.money>=B.fortifyCost){let r=o.income/100;r*=n,t.push(new q([o],0,e,r))}return t}FindBuyOpportunities(){if(this.player.money<=2e6)return[];const t=[],n=new xe,o=this.player.money,r=B.armyCost,s=Math.max(0,o-2e6);if(this.player.ownedCountries.length===0||s<r)return t;const i=Math.floor(this.player.totalArmies()/this.player.ownedCountries.length),c=this.player.ownedCountries.reduce((h,y)=>y.armies<h.armies?y:h,this.player.ownedCountries[0]);if(c.armies<i){const h=i-c.armies,y=Math.floor(s/r),w=Math.min(h,y,1e5),f=Math.floor(w/1e3)*1e3;if(f>0){let x=(i-c.armies)/1e3;c.unrestLevel>0&&(x+=10),t.push(new q([c],f,n,x))}}let a=null,l=-1/0,d=null;for(const h of this.player.ownedCountries){const y=this.getReachableNonOwnedCountries(h);for(const{country:w,distance:f}of y){let x=1;f>100&&(x=Math.max(0,1-(f-100)/900));const m=this.countryScore(w)*x;m>l&&(l=m,a=h,d=w)}}if(a||(a=this.player.homeCountry),a){const h=Math.floor((s-2e6)/r),y=Math.floor(h/1e3)*1e3;if(y>0){let w=null;if(this.actionPlan.length===0&&d){const f=a.armies+y,x=Object.create(a);if(x.armies=f,this.isAttackFeasible(x,d,J.ATTACK_COMMIT)){const m=new U,p=Math.floor(f*J.ATTACK_COMMIT/1e3)*1e3;w=new q([a,d],p,m,100)}}t.push(new q([a],y,n,l*1e3,w))}}if(s>0&&this.player.ownedCountries.length>0){const h=this.findMostThreatenedOwnedCountry();if(!h)throw new Error("findMostThreatenedOwnedCountry() returned null, which should not happen if there are owned countries.");const y=Math.floor(s/r),w=Math.floor(y/1e3)*1e3;if(w>0){const f=s/1e3;t.push(new q([h],w,n,f))}}return t}findBestOpportunity(){const e=new we,t=new qe,n=[];if(n.push(...this.FindSpyOpportunities()),n.push(...this.FindAttackOpportunities()),n.push(...this.FindMoveOpportunities(e)),n.push(...this.FindFortifyOpportunities(t)),n.push(...this.FindBuyOpportunities()),n.length===0)return null;const o=.5,r=Math.max(...n.map(d=>d.score)),s=n.map(d=>Math.exp((d.score-r)/o)),i=s.reduce((d,h)=>d+h,0),c=s.map(d=>d/i),a=Math.random();let l=0;for(let d=0;d<n.length;++d)if(l+=c[d],a<l)return n[d];throw new Error("Softmax selection failed to pick an opportunity.")}getNonOwnedCountriesSortedByDistance(){const e=this.game.worldMap,t=e.getCountries(),n=[];for(const o of t){if(o.owner===this.player)continue;let r=1e4;for(const s of this.player.ownedCountries){const i=e.distance(s,o);i!==null&&(r=Math.min(r,i))}n.push({country:o,distance:r})}return n.sort((o,r)=>o.distance-r.distance),n}getReachableNonOwnedCountries(e){const t=this.game.worldMap,n=t.getCountries(),o=[];for(const r of n){if(r.owner===this.player)continue;const s=t.distance(e,r);s!==null&&o.push({country:r,distance:s})}return o.sort((r,s)=>r.distance-s.distance),o}MakeAttackPlan(e){if(this.actionPlan.length>0)return;const t=U,n=we,o=xe,r=this.player.ownedCountries;if(r.length===0||e.owner===this.player)return;let s=1/0,i=null;for(const M of r){const I=this.game.worldMap.distance(M,e);I!==null&&I<s&&(s=I,i=M)}if(!i)return;const c=new Map;for(const M of r)c.set(M,M.armies);let a=this.player.money;const l=[],d=new o,h=B.armyCost,y=Math.floor(a/h);if(y>0){const M=Math.floor(y/1e3)*1e3;M>0&&(l.push(new q([i],M,d,1)),c.set(i,c.get(i)+M),a-=M*h)}const w=new n;let f=0,x=c.get(i);const m=r.filter(M=>M!==i).sort((M,I)=>I.armies-M.armies);for(const M of m){if(f>=2)break;const I=this.game.worldMap.distance(M,i),v=c.get(M);if(I!==null&&v>1e3){const k=Math.floor((v-1e3)/1e3)*1e3;k>0&&(l.push(new q([M,i],k,w,1)),c.set(M,v-k),x+=k,c.set(i,x),f++)}}const p=this.countryDefenseEstimate(e),u=this.game.worldMap.distance(i,e)||1,g=Math.floor(x*J.ATTACK_COMMIT/1e3)*1e3,C=t.AttackChance(g,p,u,e.fortified,this.game);if(C>.7&&g>=1e3){const M=new t;l.push(new q([i,e],g,M,C*100)),c.set(i,1e3),this.actionPlan.push(...l)}}PlanSurpriseAttack(){if(this.actionPlan.length>0)return;const e=this.game.worldMap.getCountries();let t=1/0,n=null;for(const s of e)if(!s.owner){const i=this.countryDefenseEstimate(s);i<t&&(t=i,n=s)}if(n){this.MakeAttackPlan(n);return}let o=1/0,r=null;for(const s of e)if(s.owner&&s.owner!==this.player){const i=this.countryDefenseEstimate(s);i<o&&(o=i,r=s)}r&&this.MakeAttackPlan(r)}isAttackFeasible(e,t,n=.8){if(!e||!t||e.owner!==this.player||t.owner===this.player||e===t)return!1;const o=e.neighbors.includes(t),r=e.oceanBorder.length>0&&t.oceanBorder.length>0;if(!o&&!r||typeof e.armies!="number"||e.armies<=1e3)return!1;const s=this.countryDefenseEstimate(t),i=this.game.worldMap.distance(e,t);if(i===null)return!1;const c=Math.floor(e.armies*n);return!(U.AttackChance(c,s,i,t.fortified,this.game)<.7)}findMostThreatenedOwnedCountry(){if(!this.player.ownedCountries||this.player.ownedCountries.length===0)throw new Error("AI has no owned countries to evaluate for threat.");const e=this.game.worldMap,t=e.getCountries();let n=null,o=-1/0;for(const r of this.player.ownedCountries){let s=0;for(const i of t){if(!i.owner||i.owner===this.player)continue;const c=e.distance(r,i);c===null||c===0||(s+=1/c)}s>o&&(o=s,n=r)}if(!n)throw new Error("No threatened country found. This should not happen if there are enemy countries.");return n}};b(J,"ATTACK_COMMIT",.8);let ye=J;const Y=class Y{constructor(e,t,n=[],o=null,r=[],s=0,i=!1){b(this,"actionsLeft",Y.ACTIONS_PER_TURN);b(this,"game");b(this,"actionLog",[]);b(this,"name");b(this,"color");b(this,"ownedCountries");b(this,"homeCountry");b(this,"isAI");b(this,"AI");b(this,"money");b(this,"knowledge");b(this,"plannedFortifications",[]);b(this,"aggressivity");this.name=e,this.color=t,this.ownedCountries=n,this.homeCountry=o,this.knowledge=r,this.money=s,this.isAI=i,this.actionsLeft=Y.ACTIONS_PER_TURN,this.aggressivity=Math.floor(Math.random()*8)+2,this.AI=new ye(this,void 0)}resetActions(){this.actionsLeft=Y.ACTIONS_PER_TURN}useAction(){this.actionsLeft>0&&this.actionsLeft--}get RGBColor(){return Y.COLOR_RGBS[this.color]||"0,0,0"}getKnownCountries(){const e=new Set;this.knowledge.forEach(n=>e.add(n.country));const t=Array.from(e).filter(n=>!this.ownedCountries.includes(n));return{owned:[...this.ownedCountries],known:t}}getCountryInfo(e,t){if(e.owner===this)return{name:e.name,owner:e.owner,income:e.income,army:e.armies,recency:0};{const n=this.knowledge.find(o=>o.country===e);return{name:e.name,owner:e.owner,income:n?n.income:void 0,army:n?n.army:void 0,recency:n?t-n.gameTurn:void 0}}}totalIncome(){return this.ownedCountries.reduce((e,t)=>t.unrestLevel>0?e:e+(t.income??0),0)}totalArmies(){return this.ownedCountries.reduce((e,t)=>e+(t.armies??0),0)}startTurn(){this.resetActions()}get IncomeShare(){if(!this.game||!this.game.players||this.game.players.length===0)return 0;const e=this.game.players.reduce((t,n)=>{var o;return t+(((o=n.totalIncome)==null?void 0:o.call(n))??0)},0);return e===0?0:this.totalIncome()/e}armyKnown(e){if(e.owner===this)return!0;const t=this.knowledge.find(n=>n.country===e);return!!(!e.owner&&t||e.owner&&e.owner!==this&&t&&this.game&&t.gameTurn===this.game.gameTurn)}toJSON(){return{id:this.name,name:this.name,color:this.color,ownedCountryIds:this.ownedCountries.map(e=>e.name),homeCountryId:this.homeCountry?this.homeCountry.name:null,isAI:this.isAI,money:this.money,knowledge:this.knowledge.map(e=>({countryId:e.country.name,gameTurn:e.gameTurn,army:e.army,income:e.income})),plannedFortifications:this.plannedFortifications.map(([e,t])=>[e.name,t]),aggressivity:this.aggressivity,actionsLeft:this.actionsLeft}}static fromJSON(e,t){const n=new Y(e.name,e.color,[],null,[],e.money,e.isAI);return n.aggressivity=e.aggressivity,n.actionsLeft=e.actionsLeft??Y.ACTIONS_PER_TURN,n._ownedCountryIds=e.ownedCountryIds,n._homeCountryId=e.homeCountryId,n._knowledgeRaw=e.knowledge,n._plannedFortificationsRaw=e.plannedFortifications,n}resolveReferences(e){this.ownedCountries=(this._ownedCountryIds||[]).map(t=>e[t]).filter(Boolean),this.homeCountry=this._homeCountryId?e[this._homeCountryId]:null,this.knowledge=(this._knowledgeRaw||[]).map(t=>({country:e[t.countryId],gameTurn:t.gameTurn,army:t.army,income:t.income})),this.plannedFortifications=(this._plannedFortificationsRaw||[]).map(([t,n])=>[e[t],n]),delete this._ownedCountryIds,delete this._homeCountryId,delete this._knowledgeRaw,delete this._plannedFortificationsRaw}};b(Y,"ACTIONS_PER_TURN",5),b(Y,"COLOR_RGBS",{red:"255,0,0",blue:"0,0,255",green:"0,128,0",yellow:"255,255,0",purple:"128,0,128",orange:"255,140,0",teal:"0,128,128",brown:"139,69,19"}),b(Y,"COLORS",["red","blue","green","yellow","purple","orange","teal","brown"]);let re=Y;const Ct=Object.freeze(Object.defineProperty({__proto__:null,Player:re},Symbol.toStringTag,{value:"Module"})),_=class _{constructor(e,t=[]){b(this,"worldMap");b(this,"players");b(this,"gameTurn");b(this,"activePlayerIndex");b(this,"gui");b(this,"advisedOpportunity");this.worldMap=e,this.players=t,this.gameTurn=1,this.activePlayerIndex=0,this.advisedOpportunity=null,this.players.length>0&&this.activePlayer.startTurn()}get activePlayer(){return this.players[this.activePlayerIndex]}nextTurn(){this.activePlayer.money+=this.activePlayer.totalIncome(),this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayerIndex===0&&(this.gameTurn++,this.handleUnrest());const e=this.activePlayer;e.plannedFortifications=e.plannedFortifications.filter(([t,n])=>n===this.gameTurn?(t.fortified=!0,!1):!0),this.activePlayer.startTurn(),this.advisedOpportunity=null}static initNewGame(e,t,n){for(const d of t)d.money=_.initialPlayerMoney,d.homeCountry=null,d.ownedCountries=[],d.isAI&&(d.AI=new ye(d,null));const o=e.getCountries();for(const d of o)d.income=Math.floor((5e5+Math.random()*2e6)/1e3)*1e3,d.owner=null;let r=-1,s=[];const i=t.length,c=10;function a(d,h){if(!d.center||!h.center)return 0;const[y,w]=d.center(),[f,x]=h.center();return Math.sqrt((y-f)**2+(w-x)**2)}for(let d=0;d<c;++d){const h=[...o];for(let f=h.length-1;f>0;f--){const x=Math.floor(Math.random()*(f+1));[h[f],h[x]]=[h[x],h[f]]}const y=h.slice(0,i);let w=1/0;for(let f=0;f<y.length;++f)for(let x=f+1;x<y.length;++x)w=Math.min(w,a(y[f],y[x]));w>r&&(r=w,s=y)}for(let d=0;d<t.length;++d){const h=s[d];t[d].homeCountry=h,h.owner=t[d],t[d].ownedCountries.push(h),h.income=_.homeCountryIncome,h.fortified=!0,h.nationalPride=1e3}for(const d of e.getCountries())if(d.owner)d.armies=1e5;else{const h=Math.round((Math.random()*Math.random()*99e3+1e3)/1e3)*1e3;d.armies=h}const l=new _(e,t);n&&(l.gui=n);for(const d of t)d.game=l,d.isAI&&d.AI&&(d.AI.game=l,d.AI.player=d);return l}toJSON(){var e;return{gameTurn:this.gameTurn,activePlayerName:((e=this.players[this.activePlayerIndex])==null?void 0:e.name)??null,playerNames:this.players.map(t=>t.name)}}static fromJSON(e,t,n){const o=new _(n,t);o.gameTurn=e.gameTurn,o.activePlayerIndex=t.findIndex(r=>r.name===e.activePlayerName),o.activePlayerIndex===-1&&(o.activePlayerIndex=0);for(const r of t)r.game=o,r.isAI&&r.AI&&(r.AI.game=o,r.AI.player=r);return o}AddPlayer(e){return this.players.length>=8?!1:(this.players.push(e),!0)}static generateAIName(){const e=["Augustus","Charlemagne","Qin Shi Huang","Akbar","Justinian","Napoleon","Constantine","Ashoka","Catherine","Meiji","Trajan","Hadrian","Aurangzeb","Elizabeth","Peter","Victoria","Franz Joseph","Wilhelm","Haile Selassie","Menelik"];return e[Math.floor(Math.random()*e.length)]}handleUnrest(){for(const e of this.worldMap.getCountries()){if(!e.owner)continue;if(Math.floor(Math.random()*99e3)+1e3+e.armies<e.nationalPride?(e.unrestLevel=Math.min(e.unrestLevel+1,2),e.nationalPride=Math.min(e.nationalPride+1e3,1e5)):(e.unrestLevel=Math.max(e.unrestLevel-1,0),e.nationalPride=Math.max(e.nationalPride-1e3,1e3)),e.unrestLevel===2){const o=new re(_.generateAIName(),re.COLORS[this.players.length%re.COLORS.length],[],null,[],0,!0);if(this.AddPlayer(o)){const r=e.owner;r&&(r.ownedCountries=r.ownedCountries.filter(s=>s!==e)),this.UnKnowCountry(e),e.nationalPride=1e3,e.unrestLevel=0,e.income*=2,o.homeCountry=e,o.ownedCountries.push(e),e.owner=o,e.armies=e.nationalPride*2,e.fortified=!0,o.game=this,o.AI=new ye(o,this)}else{const r=e.owner;r&&(r.ownedCountries=r.ownedCountries.filter(s=>s!==e)),this.UnKnowCountry(e),e.owner=null,e.armies=e.nationalPride,e.fortified=!1}}}}UnKnowCountry(e){for(const t of this.players)t.knowledge=t.knowledge.filter(n=>n.country!==e)}};b(_,"armyCost",100),b(_,"spyCost",2e5),b(_,"spyFortifiedCost",1e6),b(_,"initialPlayerMoney",1e7),b(_,"homeCountryIncome",4e6),b(_,"fortifyCost",1e5),b(_,"showArmies",!1),b(_,"INCOME_SHARE_WIN",.8);let B=_;const vt=Object.freeze(Object.defineProperty({__proto__:null,Game:B},Symbol.toStringTag,{value:"Module"}));class He extends le{GetButtonText(e,t){var s;if(e.length===0)return null;const n=e[e.length-1];if(n.owner==t)return null;const o=t.knowledge.find(i=>i.country===n),r=(s=t.game)==null?void 0:s.gameTurn;return!n.owner&&o||n.owner&&n.owner!==t&&o&&o.gameTurn===r?null:`Spy on ${n.name}`}async Act(e,t,n,o=0){if(e.length===0)return"Please select a country to spy on.";const r=e[e.length-1],s=r.fortified?B.spyFortifiedCost:B.spyCost;if(t.money<s)return`Not enough money to spy. You need $${s}.`;const i=t.knowledge.find(l=>l.country===r);if(!n)return"Internal error: currentGame is required.";const c=n.gameTurn;if(i&&i.gameTurn===c)return"You already have recent information about this country.";t.money-=s;const a={country:r,gameTurn:c,army:r.armies,income:r.income};return i?(i.gameTurn=a.gameTurn,i.army=a.army,i.income=a.income):t.knowledge.push(a),null}RequiresAmount(e,t,n){return null}get countryCountNeeded(){return 1}Type(){return"Spy"}ActionString(e,t,n,o=0){return e.length<1?"Spy: No country selected.":`Spying on ${e[e.length-1].name}`}}function De(T,e,t=T){return new Promise(n=>{const o=document.createElement("div");o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.5)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="10000";const r=document.createElement("div");r.style.background="#fff",r.style.padding="32px 40px",r.style.borderRadius="12px",r.style.boxShadow="0 2px 16px rgba(0,0,0,0.2)",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="18px";const s=document.createElement("div");s.textContent="Select amount to commit:",s.style.fontSize="1.2rem",s.style.marginBottom="8px",r.appendChild(s);const i=document.createElement("div");i.textContent=`Maximum: ${e.toLocaleString()}`,i.style.fontSize="1rem",i.style.color="#555",i.style.marginBottom="4px",r.appendChild(i);let c=Math.max(T,Math.min(e,t));const a=document.createElement("div");a.textContent=c.toLocaleString(),a.style.fontSize="2rem",a.style.fontWeight="bold",a.style.margin="8px 0",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";function d(x){c=Math.max(T,Math.min(e,x)),a.textContent=c.toLocaleString()}function h(x,m){const p=document.createElement("button");return p.textContent=x,p.style.padding="6px 14px",p.style.fontSize="1.1rem",p.style.border="none",p.style.borderRadius="6px",p.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",p.style.color="#fff",p.style.cursor="pointer",p.onclick=m,p}l.appendChild(h("-100k",()=>d(c-1e5))),l.appendChild(h("-10k",()=>d(c-1e4))),l.appendChild(h("-1k",()=>d(c-1e3))),l.appendChild(h("Min",()=>d(T))),l.appendChild(h("Half",()=>d(Math.floor(e/2/1e3)*1e3))),l.appendChild(h("Max",()=>d(e))),l.appendChild(h("+1k",()=>d(c+1e3))),l.appendChild(h("+10k",()=>d(c+1e4))),l.appendChild(h("+100k",()=>d(c+1e5))),r.appendChild(l);const y=document.createElement("div");y.style.display="flex",y.style.gap="12px",y.style.marginTop="18px";const w=h("OK",()=>{document.body.removeChild(o),n(c)});w.style.background="linear-gradient(90deg,#43cea2 0%,#43e97b 100%)",w.style.fontWeight="bold";const f=h("Cancel",()=>{document.body.removeChild(o),n(null)});f.style.background="linear-gradient(90deg,#e57373 0%,#ffb74d 100%)",y.appendChild(w),y.appendChild(f),r.appendChild(y),o.appendChild(r),document.body.appendChild(o),w.focus()})}class bt extends le{GetButtonText(e,t){if(e.length<2)return null;const n=e[e.length-2],o=e[e.length-1];if(n.owner!==t||n===o||!(t.knowledge&&t.knowledge.some(c=>c.country===o)))return null;const s=n.neighbors.includes(o),i=n.oceanBorder.length>0&&o.oceanBorder.length>0;return!s&&!i||o.owner===t?null:`Calculate attack chance for ${o.name} from ${n.name}`}async Act(e,t,n,o=0){if(!n)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to calculate attack.";const r=e[e.length-2],s=e[e.length-1];if(r.owner!==t)return"You must own the attacking country.";const i=r.neighbors.includes(s),c=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!c)return"Target country must be a neighbor or reachable by naval attack.";if(s.owner===t)return"Cannot attack your own country.";if(o<=0||o>=r.armies)return"Invalid number of armies committed.";const a=t.getCountryInfo(s,n.gameTurn),l=n.worldMap.distance(r,s);let h=`Attack chance: ${(U.AttackChance(r.armies,a.army||0,l||0,s.fortified,n)*100).toFixed(2)}%`;return a.recency&&a.recency>0&&(h+=`
Warning: Information about ${s.name} may be outdated (last spied ${a.recency} turn(s) ago).`),h}RequiresAmount(e,t,n){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}Type(){return"CalculateAttack"}get countryCountNeeded(){return 2}ActionString(e,t,n,o=0){if(e.length<2)return"Calculate Attack: Not enough countries selected.";const r=e[e.length-2];return`Calculating attack chance for ${e[e.length-1].name} from ${r.name} with ${o} soldiers`}}function je(T,e,t){let n=document.getElementById("gamegui-win-modal");if(n)return;n=document.createElement("div"),n.id="gamegui-win-modal",n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.85)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="99999";const o=document.createElement("canvas");o.width=window.innerWidth,o.height=window.innerHeight,o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.zIndex="0",o.style.pointerEvents="none",n.appendChild(o);function r(){o.width=window.innerWidth,o.height=window.innerHeight}window.addEventListener("resize",r);const s=document.createElement("div");s.style.width="50vw",s.style.height="50vh",s.style.background='url("Won.png") center/cover no-repeat',s.style.padding="48px 64px",s.style.borderRadius="24px",s.style.boxShadow="0 4px 32px rgba(0,0,0,0.25)",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.gap="32px",s.style.position="relative",s.style.zIndex="1";const i=document.createElement("div");i.style.position="absolute",i.style.top="32px",i.style.right="48px",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="flex-end",i.style.zIndex="2",i.style.padding="12px 24px",i.style.background="rgba(255,255,255,0.0)";const c=document.createElement("div");c.textContent="WINNER",c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",c.style.fontSize="2.7rem",c.style.fontWeight="bold",c.style.color="#222",c.style.textShadow="0 2px 8px #fff,0 0 8px #000",i.appendChild(c);const a=document.createElement("div");a.textContent=T,a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",a.style.fontSize="2.1rem",a.style.fontWeight="bold",a.style.color="#fff",a.style.marginTop="8px",a.style.textShadow="0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6",a.style.animation="win-glow 2.2s linear infinite";const l=document.createElement("style");l.textContent=`@keyframes win-glow {
    0% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
    25% { text-shadow: 0 0 24px #43cea2, 0 0 40px #ffd700, 0 0 56px #00e6e6, 0 0 72px #ff00cc; }
    50% { text-shadow: 0 0 32px #ff00cc, 0 0 48px #00e6e6, 0 0 64px #ffd700, 0 0 80px #43cea2; }
    75% { text-shadow: 0 0 24px #00e6e6, 0 0 40px #ff00cc, 0 0 56px #43cea2, 0 0 72px #ffd700; }
    100% { text-shadow: 0 0 16px #ffd700, 0 0 32px #43cea2, 0 0 48px #ff00cc, 0 0 64px #00e6e6; }
  }`,document.head.appendChild(l),i.appendChild(a);const d=document.createElement("button");d.textContent="OK",d.style.marginTop="18px",d.style.padding="12px 36px",d.style.fontSize="1.3rem",d.style.border="none",d.style.borderRadius="8px",d.style.background="linear-gradient(90deg,#43cea2 0%,#ffd700 100%)",d.style.color="#222",d.style.fontWeight="bold",d.style.cursor="pointer",d.style.textShadow="0 2px 8px #fff,0 0 8px #000",d.onclick=()=>{m=!1,window.removeEventListener("resize",r),n&&n.parentNode&&n.parentNode.removeChild(n),t&&t()},i.appendChild(d),s.appendChild(i),n.appendChild(s),document.body.appendChild(n);const h=o.getContext("2d"),y=[];let w=o.height;function f(){const u=Math.random()*o.width*.8+o.width*.1,g=o.height*.02+Math.random()*o.height*.04,C=(Math.random()-.5)*2,M=(-8-Math.random()*4)*2,I=`hsl(${Math.random()*360},90%,60%)`;y.push({x:u,y:o.height,vx:C,vy:M,color:I,exploded:!1,particles:[],age:0,targetY:g})}function x(u){for(let g=0;g<48;g++){const C=g/48*2*Math.PI,M=2+Math.random()*2.5;u.particles.push({x:u.x,y:u.y,vx:Math.cos(C)*M,vy:Math.sin(C)*M,color:u.color,alpha:1,age:0})}}let m=!0;function p(){if(!(!m||!h)){h.clearRect(0,0,o.width,o.height),Math.random()<.06&&y.length<7&&f();for(const u of y)if(!u.exploded)u.x+=u.vx,u.y+=u.vy,u.vy+=.13,u.age++,u.y<w&&(w=u.y),h.save(),h.beginPath(),h.arc(u.x,u.y,4,0,2*Math.PI),h.fillStyle=u.color,h.globalAlpha=.9,h.shadowColor=u.color,h.shadowBlur=16,h.fill(),h.restore(),u.y<=u.targetY&&(u.exploded=!0,x(u));else{for(const g of u.particles)g.x+=g.vx,g.y+=g.vy,g.vy+=.04,g.alpha-=.012+Math.random()*.01,g.age++,h.save(),h.beginPath(),h.arc(g.x,g.y,2.2,0,2*Math.PI),h.fillStyle=g.color,h.globalAlpha=Math.max(0,g.alpha),h.shadowColor=g.color,h.shadowBlur=8,h.fill(),h.restore();u.particles=u.particles.filter(g=>g.alpha>.05&&g.age<90)}for(let u=y.length-1;u>=0;u--)y[u].exploded&&y[u].particles.length===0&&y.splice(u,1);requestAnimationFrame(p)}}p()}const Mt=Object.freeze(Object.defineProperty({__proto__:null,showWinDialog:je},Symbol.toStringTag,{value:"Module"}));class At{constructor(e,t,n,o){b(this,"overlay");b(this,"ctx");b(this,"width");b(this,"height");b(this,"fish",[]);b(this,"running",!1);b(this,"lastSpawn",0);b(this,"nextSpawn",0);b(this,"getOceanPredicate");b(this,"animationFrameId",null);b(this,"timeoutId",null);b(this,"loop",e=>{this.ctx.clearRect(0,0,this.width,this.height),this.fish=this.fish.filter(t=>!t.done);for(const t of this.fish)t.update(e),t.draw(this.ctx);e>this.nextSpawn&&(this.spawnFish(),this.scheduleNextSpawn()),this.fish.length>0||this.nextSpawn-e<2e3?this.animationFrameId=requestAnimationFrame(this.loop):(this.running=!1,this.timeoutId=setTimeout(()=>this.start(),this.nextSpawn-e))});this.width=t,this.height=n,this.getOceanPredicate=o,this.overlay=document.createElement("canvas"),this.overlay.width=t,this.overlay.height=n,this.overlay.style.position="absolute",this.overlay.style.left="0",this.overlay.style.top="0",this.overlay.style.pointerEvents="none",this.overlay.style.width="100%",this.overlay.style.height="100%",this.overlay.style.zIndex="20",e.appendChild(this.overlay);const r=this.overlay.getContext("2d");if(!r)throw new Error("Could not get canvas context for FishOverlay");this.ctx=r,this.scheduleNextSpawn(),this.start()}scheduleNextSpawn(){this.nextSpawn=performance.now()+5e3+Math.random()*1e4}spawnFish(){for(let e=0;e<10;e++){const t=Math.floor(Math.random()*this.width),n=Math.floor(this.height*(.4+.5*Math.random())),o=Math.random()<.5?1:-1,r=32+Math.random()*24,s=t+o*r;if(this.getOceanPredicate(t,n)&&this.getOceanPredicate(Math.round(s),n)){const i="#444";this.fish.push(new kt(t,n,o,i));break}}}start(){this.running||(this.running=!0,this.animationFrameId=requestAnimationFrame(this.loop))}stop(){this.running=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}resume(){this.running||this.start()}}class kt{constructor(e,t,n,o){b(this,"x0");b(this,"y0");b(this,"x1");b(this,"y1");b(this,"dir");b(this,"color","#444");b(this,"t0");b(this,"duration");b(this,"done",!1);b(this,"splash",!1);b(this,"splashStart",0);b(this,"splashDuration",1200);this.x0=e,this.y0=t;const r=32+Math.random()*24;this.x1=e+n*r,this.y1=t,this.dir=n,this.t0=performance.now(),this.duration=(1200+Math.random()*400)/2}update(e){const t=(e-this.t0)/this.duration;if(!this.splash&&t>.95&&(this.splash=!0,this.splashStart=e),t>1&&this.splash){e-this.splashStart>this.splashDuration&&(this.done=!0);return}if(t>1){this.done=!0;return}}draw(e){const t=performance.now(),n=Math.min(1,(t-this.t0)/this.duration),o=18,r=this.x0+(this.x1-this.x0)*n,s=this.y0-(1-4*Math.pow(n-.5,2))*o,i=1+.18*Math.sin(Math.PI*n),c=.5*Math.sin(Math.PI*n);if(n<=.95){e.save(),e.translate(r,s);const a=1/3,l=e.createRadialGradient(0,0,.3,0,0,7*i*a);l.addColorStop(0,"#222"),l.addColorStop(.7,"#666"),l.addColorStop(1,"#bbb"),e.fillStyle=l,e.beginPath(),e.ellipse(0,0,7*i*a,3*a,0,0,2*Math.PI),e.fill(),e.save(),e.beginPath(),e.moveTo(-7*i*a,0),e.lineTo(-11*i*a,-4*a),e.lineTo(-11*i*a,4*a),e.closePath(),e.fillStyle="#222",e.globalAlpha=.8,e.fill(),e.restore(),e.save(),e.beginPath(),e.ellipse(-2*i*a,2.2*a,2*a,.7*a,Math.PI/4+c,0,2*Math.PI),e.ellipse(-2*i*a,-2.2*a,2*a,.7*a,-Math.PI/4-c,0,2*Math.PI),e.fillStyle="#888",e.globalAlpha=.7,e.fill(),e.restore(),e.restore()}if(this.splash){const a=Math.min(1,(t-this.splashStart)/this.splashDuration);for(let l=0;l<3;l++){const d=10+12*a+l*6;e.save(),e.beginPath(),e.arc(this.x1,this.y1,d,0,2*Math.PI),e.strokeStyle=`rgba(10,10,10,${.7*(1-a)})`,e.lineWidth=2.5-l*.5,e.globalAlpha=1*(1-a),e.stroke(),e.restore()}}}}function St(T){var d;let e=document.getElementById("action-log-dialog");e&&e.remove();const t=document.createElement("div");t.id="action-log-dialog",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.6)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="99999",(d=ae.getInstance())==null||d.pauseGame();const n=document.createElement("div");n.style.background="#fff",n.style.width="100vw",n.style.height="100vh",n.style.padding="0",n.style.borderRadius="0",n.style.boxShadow="none",n.style.maxWidth="100vw",n.style.maxHeight="100vh",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="stretch",n.style.gap="0",n.style.overflow="hidden";const o=document.createElement("button");o.textContent="Close",o.style.alignSelf="flex-end",o.style.margin="16px 24px 0 0",o.style.padding="10px 32px",o.style.fontSize="1.2rem",o.style.border="none",o.style.borderRadius="8px",o.style.background="linear-gradient(90deg,#ff9966 0%,#ff5e62 100%)",o.style.color="#fff",o.style.cursor="pointer",o.onclick=()=>{var y,w;(y=ae.getInstance())==null||y.resumeGame(),t.remove();const h=ae.getInstance();h&&h.currentGame&&!h.canceled&&((w=h.currentGame.activePlayer)!=null&&w.isAI)&&setTimeout(()=>h.turnStarted(),0)},n.appendChild(o);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.gap="16px",r.style.padding="24px 32px 8px 32px",r.style.background="#f5f5f5";const s=document.createElement("select");s.style.fontSize="1.1rem",s.style.padding="6px 12px";for(const h of T.players){const y=document.createElement("option");y.value=h.name,y.textContent=h.name+(h.isAI?" (AI)":""),s.appendChild(y)}r.appendChild(s);const i=document.createElement("input");i.type="text",i.placeholder="Filter (wildcard, all fields)",i.style.fontSize="1.1rem",i.style.padding="6px 12px",i.style.borderRadius="6px",i.style.border="1px solid #aaa",r.appendChild(i),n.appendChild(r);const c=document.createElement("div");c.style.overflow="auto",c.style.flex="1",c.style.padding="0 32px 32px 32px",c.style.background="#fff",n.appendChild(c);function a(h,y){c.innerHTML="";const w=document.createElement("table");w.style.width="100%",w.style.borderCollapse="collapse",w.style.fontSize="1.05rem";const f=document.createElement("thead"),x=document.createElement("tr");for(const u of["#","Action","Countries","Amount","Result"]){const g=document.createElement("th");g.textContent=u,g.style.borderBottom="2px solid #888",g.style.padding="8px 12px",g.style.background="#eee",x.appendChild(g)}f.appendChild(x),w.appendChild(f);const m=document.createElement("tbody");let p=h.actionLog;if(y.trim()){const u=y.trim().toLowerCase();p=p.filter(g=>g.actionType.toLowerCase().includes(u)||g.countries.map(C=>C.name).join(",").toLowerCase().includes(u)||(""+g.amount).includes(u)||(g.result?g.result.toLowerCase():"").includes(u))}p.forEach((u,g)=>{const C=document.createElement("tr");C.style.borderBottom="1px solid #ddd";const M=document.createElement("td");M.textContent=(g+1).toString(),M.style.padding="6px 12px",C.appendChild(M);const I=document.createElement("td");I.textContent=u.actionType,I.style.padding="6px 12px",C.appendChild(I);const v=document.createElement("td");v.textContent=u.countries.map(S=>S.name).join(", "),v.style.padding="6px 12px",C.appendChild(v);const k=document.createElement("td");k.textContent=u.amount.toString(),k.style.padding="6px 12px",C.appendChild(k);const A=document.createElement("td");A.textContent=u.result??"",A.style.padding="6px 12px",C.appendChild(A),m.appendChild(C)}),w.appendChild(m),c.appendChild(w)}let l=T.players[0];a(l,""),s.onchange=()=>{l=T.players.find(h=>h.name===s.value)||T.players[0],a(l,i.value)},i.oninput=()=>{a(l,i.value)},t.appendChild(n),document.body.appendChild(t)}class ze{static serialize(e){const t=e.worldMap.getCountries(),n=e.players;return JSON.stringify({countries:t.map(o=>o.toJSON()),players:n.map(o=>o.toJSON()),game:e.toJSON()})}static deserialize(e){const t=JSON.parse(e),n={},o=t.countries.map(a=>ve.fromJSON(a,{},n)),r={},s=t.players.map(a=>{const l=re.fromJSON(a,n);return r[l.name]=l,l});o.forEach(a=>a.resolveReferences(r,n)),s.forEach(a=>a.resolveReferences(n));const i=gt(o);return B.fromJSON(t.game,s,i)}}const ue=class ue{constructor(){b(this,"state");b(this,"currentGame",null);b(this,"rootContainer",null);b(this,"canceled",!1);b(this,"paused",!1);b(this,"clickedCountryNames",[]);b(this,"worldMapCanvas",null);b(this,"mapDirty",!0);b(this,"actions");b(this,"fishOverlay",null);b(this,"_onResize",()=>{this.markMapDirty(),this.rootContainer&&this.renderMainGui(this.rootContainer,this.currentGame)});b(this,"isProcessingAdvisorSynthetic",!1);b(this,"isAdvisorAnimationRunning",!1);this.state="initialized",this.actions=[new He,new qe,new U,new bt,new we,new xe],ue._instance=this,window.addEventListener("keydown",e=>{e.key==="F9"&&this.currentGame&&St(this.currentGame),e.key==="F8"&&de(()=>Promise.resolve().then(()=>Mt),void 0).then(t=>{var o,r;const n=((r=(o=this.currentGame)==null?void 0:o.activePlayer)==null?void 0:r.name)||"Player";t.showWinDialog(n,100)})})}pauseGame(){if(this.paused=!0,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.stop=="function"?(console.log("Pausing FishOverlay",this.fishOverlay),this.fishOverlay.stop()):console.log("No FishOverlay to pause")}resumeGame(){if(this.paused=!1,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.resume=="function"?(console.log("Resuming FishOverlay",this.fishOverlay),this.fishOverlay.resume()):console.log("No FishOverlay to resume")}isPaused(){return this.paused}static getInstance(){return ue._instance}afterAction(){if(this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],n=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(n&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(n,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");if(r){const s=n.unrestLevel>0?"color: red; font-style: italic;":"";n.unrestLevel>0;const i=n.unrestLevel>0?"color: red; text-decoration: line-through;":"";r.innerHTML=`
            <div><b>Name:</b> <span style="${s}">${o.name}</span></div>
            <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
            <div><b>Income:</b> <span style="${i}">${o.income!==void 0?o.income:"?"}</span></div>
            <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
          `}}}if(this.markMapDirty(),this.rootContainer&&(this.renderMainGui(this.rootContainer,this.currentGame),this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap)){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],n=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(n&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(n,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");if(r){const s=n.unrestLevel>0?"color: red; font-style: italic;":"",i=n.unrestLevel>0?'<div style="color: red; font-style: italic;">Rioting</div>':"",c=n.unrestLevel>0?"color: red; text-decoration: line-through;":"";let a="";const l=this.currentGame.activePlayer;if(l.armyKnown(n))a='<span style="color: #4caf50; font-weight: bold;">Certified information</span>';else{const d=l.knowledge.find(h=>h.country===n);if(n.owner&&n.owner!==l&&d){const h=this.currentGame.gameTurn-d.gameTurn;a=`<span style="color: #ffd700; font-weight: bold;">${h} turn${h===1?"":"s"} old information</span>`}else a='<span style="color: #ff4444; font-weight: bold;">No information</span>'}r.innerHTML=`
              <div><b>Name:</b> <span style="${s}">${o.name}</span></div>
              <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
              <div><b>Income:</b> <span style="${c}">${o.income!==void 0?o.income:"?"} </span></div>
              <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
              <div>${a}</div>
              ${i}
            `}}if(!this.isProcessingAdvisorSynthetic&&this.currentGame.activePlayer&&this.currentGame.activePlayer.actionLog.length>0){const o=this.currentGame.activePlayer.actionLog[this.currentGame.activePlayer.actionLog.length-1];if(o.countries&&o.countries.length>0){const r=o.countries[o.countries.length-1];if(r&&r.name){this.clickedCountryNames.push(r.name);const s=this.rootContainer.querySelector('div[style*="flex: 3"]'),i=s?s.querySelector("canvas"):null;if(i&&s){const a=this.currentGame.worldMap.getCountries().find(l=>l.name===r.name);if(a){const[l,d]=a.center?a.center():[0,0],h=i.width,y=i.height,w=i.getBoundingClientRect(),f=w.width/h,x=w.height/y,m=l*f,p=d*x,u=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,clientX:w.left+m,clientY:w.top+p});i.dispatchEvent(u)}}}}}}this.updateActionButtons()}updateActionButtons(){if(this.paused)return;const e=document.querySelector('div[style*="flex: 3"]');let t=e?e.querySelector("#country-action-overlay"):null;t&&(t.remove(),t=null);const n=document.getElementById("action-buttons-area");if(n&&Array.from(n.children).forEach(i=>{i instanceof HTMLElement&&(i.classList.contains("persistent-action-btn")||n.removeChild(i))}),!this.currentGame||!this.currentGame.players||!this.currentGame.activePlayer)return;const o=this.currentGame.worldMap?this.currentGame.worldMap.getCountries():[],r=this.clickedCountryNames.map(i=>o.find(c=>c.name===i)).filter(Boolean);if(this.currentGame.activePlayer.actionsLeft<=0||r.length===0||!e)return;const s=[];for(const i of this.actions){const c=i.GetButtonText(r,this.currentGame.activePlayer);if(c){const a=document.createElement("button");a.textContent=c,a.style.padding="4px 10px",a.style.fontSize="0.95rem",a.style.background="rgba(0,0,0,0.18)",a.style.color="#b3e5fc",a.style.border="1px solid #555",a.style.borderRadius="6px",a.style.cursor="pointer",a.style.boxShadow="0 1px 4px rgba(30,32,34,0.10)",a.style.margin="0 6px 0 0",a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",a.style.transition="background 0.15s, color 0.15s",a.onmouseenter=()=>{a.style.background="#ffd700",a.style.color="#222"},a.onmouseleave=()=>{a.style.background="rgba(0,0,0,0.18)",a.style.color="#b3e5fc"},a.onclick=async()=>{const l=i.RequiresAmount(r,this.currentGame.activePlayer,this.currentGame);let d=null,h=0;if(l){const[w,f]=l;let x=f;if(this.currentGame&&this.currentGame.advisedOpportunity){const p=this.currentGame.advisedOpportunity,u=this.currentGame.worldMap.getCountries();for(const v of p.countries){const k=u.find(A=>A.name===v.name);k&&k!==v&&(console.warn("[Advisor/Action] Country instance mismatch:",v.name,v,k),k.name===v.name&&console.error("[Advisor/Action] Country instance mismatch but names match:",v.name,v,k))}const g=p.action.Type()===i.Type();g||console.log("[Advisor/Action] Action type mismatch:",p.action.Type(),i.Type());const C=p.countries.length,M=r.slice(-C),I=M.length===C&&p.countries.every((v,k)=>v===M[k]);if(!I){console.log("[Advisor/Action] Country array mismatch:"),console.log("  opp.countries:",p.countries.map(v=>v.name)),console.log("  lastClicked:",M.map(v=>v&&v.name));for(let v=0;v<Math.max(p.countries.length,M.length);++v){const k=p.countries[v],A=M[v];k!==A&&(k&&A&&k.name===A.name?console.error("[Advisor/Action] Country instance mismatch at index",v,"but names match:",k.name,k,A):console.log("[Advisor/Action] Country mismatch at index",v,":",k,A))}}g&&I?(console.log("[Advisor/Action] Using advisor suggested amount:",p.amount),x=p.amount):console.log("[Advisor/Action] Not using advisor amount. sameAction:",g,"sameCountries:",I)}const m=await De(w,f,x);if(m===null)return;h=m,d=await i.Act(r,this.currentGame.activePlayer,this.currentGame,m)}else d=await i.Act(r,this.currentGame.activePlayer,this.currentGame);const y=r.slice(-i.countryCountNeeded);this.currentGame.activePlayer.actionLog.push({actionType:i.Type(),countries:y,amount:h,result:d??null}),this.currentGame.activePlayer.useAction(),typeof d=="string"&&d!==null?(this.afterAction(),this.showActionResult(d)):this.afterAction(),this.currentGame&&(this.currentGame.advisedOpportunity=null)},s.push(a)}}if(s.length>0){t=document.createElement("div"),t.id="country-action-overlay",t.style.position="absolute",t.style.pointerEvents="auto",t.style.background="rgba(40, 40, 60, 0.85)",t.style.border="1.5px solid #555",t.style.borderRadius="10px",t.style.padding="12px 18px",t.style.color="#b3e5fc",t.style.fontSize="0.95rem",t.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="10px",t.style.zIndex="21",t.style.minWidth="140px",t.style.maxWidth="340px",t.style.visibility="hidden",t.style.flexWrap="wrap",t.style.maxWidth="340px",t.style.minHeight="unset",s.forEach(c=>{c.style.width="100%",c.style.margin="0",c.style.textAlign="center",c.style.background="#b3e5fc",c.style.color="#1a237e",c.onmouseenter=()=>{c.style.background="#ffd700",c.style.color="#222"},c.onmouseleave=()=>{c.style.background="#b3e5fc",c.style.color="#1a237e"},t.appendChild(c)}),e.appendChild(t);const i=e.querySelector("canvas");if(i&&r.length===1){const c=r[0],[a,l]=c.center?c.center():[0,0],d=i.width,h=i.height,y=i.getBoundingClientRect(),w=y.width/d,f=y.height/h,x=a*w,m=l*f,p=e.querySelector("#country-info-overlay");p&&p.style.display!=="none"?requestAnimationFrame(()=>{const u=p.offsetHeight;t.style.left=`${x-t.offsetWidth/2}px`,t.style.top=`${m+u+2}px`,t.style.visibility="visible",t.style.flexWrap="wrap",t.style.maxWidth="340px",t.style.minHeight="unset"}):(t.style.left=`${x-t.offsetWidth/2}px`,t.style.top=`${m+8}px`,t.style.visibility="visible")}}}showActionResult(e){const t=document.getElementById("action-result-panel");t&&(t.innerHTML=`<span style="color:#fff">${e}</span>`)}clearActionResult(){const e=document.getElementById("action-result-panel");e&&(e.innerHTML='<span style="color:#888">No recent action.</span>')}markMapDirty(){this.mapDirty=!0}getWorldMapCanvas(){if(this.paused)throw new Error("Game is paused");if(!this.currentGame||!this.currentGame.worldMap)throw new Error("GameGui.getWorldMapCanvas: currentGame or worldMap is missing");if(this.mapDirty||!this.worldMapCanvas){let e=[];if(this.currentGame.activePlayer){const t=this.currentGame.activePlayer.getKnownCountries();e=t.owned.concat(t.known)}this.worldMapCanvas=fe.render(this.currentGame.worldMap,[],e,B.showArmies,this.currentGame.activePlayer),this.mapDirty=!1}return this.worldMapCanvas}async mount(e){this.rootContainer=e,window.addEventListener("resize",this._onResize),this.renderMainGui(e,this.currentGame)}unmount(){window.removeEventListener("resize",this._onResize)}async turnStarted(){var n,o;if(this.paused)return;if(this.clearActionResult(),this.currentGame&&this.currentGame.activePlayer&&this.currentGame.activePlayer.IncomeShare>=B.INCOME_SHARE_WIN){je(this.currentGame.activePlayer.name,B.INCOME_SHARE_WIN*100,()=>{this.canceled=!0}),this.canceled=!0;return}if(this.renderMainGui(this.rootContainer,this.currentGame),this.canceled||!((o=(n=this.currentGame)==null?void 0:n.activePlayer)!=null&&o.isAI))return;const e=this.currentGame.activePlayer.AI;if(!e)return;const t=async()=>{if(this.paused||this.canceled)return;const r=await e.takeAction();this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),r?setTimeout(()=>t(),100):(this.currentGame.nextTurn(),this.markMapDirty(),this.currentGame.activePlayer.isAI?setTimeout(()=>this.turnStarted(),100):this.turnStarted())};t()}async startNewGame(){this.canceled=!0;const e=this.rootContainer,{showNewGameDialog:t}=await de(async()=>{const{showNewGameDialog:n}=await import("./NewGameDialog-DL5DdwvI.js");return{showNewGameDialog:n}},[]);try{const n=await t(e),o=await de(()=>Promise.resolve().then(()=>Ct),void 0),r=await de(()=>Promise.resolve().then(()=>vt),void 0);r.Game.showArmies=n.showArmies;const s=["#4fc3f7","#81c784","#ffb74d","#e57373","#ba68c8","#ffd54f","#64b5f6","#a1887f"],i=o.Player.COLORS??s,c=n.players.map((a,l)=>new o.Player(a.name,i[l%i.length],[],null,[],0,a.isAI));this.currentGame=r.Game.initNewGame(n.map,c,this),this.markMapDirty(),this.getWorldMapCanvas(),this.renderMainGui(e,this.currentGame),this.currentGame&&this.currentGame.players.length>0&&(this.canceled=!1,this.currentGame.activePlayer.startTurn(),this.turnStarted())}catch(n){console.error("NewGameDialog error or cancellation:",n)}}renderMainGui(e,t){if(this.paused)return;const n=this.rootContainer;if(!n)throw new Error("rootContainer is not set (null) in renderMainGui");const o=n.querySelector('div[style*="flex: 3"]');if(o&&o._fishOverlay){const v=o._fishOverlay;typeof v.stop=="function"&&v.stop(),v.overlay&&v.overlay.parentNode&&v.overlay.parentNode.removeChild(v.overlay),o._fishOverlay=null}n.innerHTML="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100vw",r.style.height="100vh",r.style.background="linear-gradient(120deg, #232526 0%, #414345 100%)",r.style.borderRadius="0",r.style.boxShadow="none",r.style.overflow="hidden",r.style.margin="0",r.style.maxWidth="100vw";const s=document.createElement("div");s.style.flex="3",s.style.background="#222",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.position="relative",s.style.borderRight="2px solid #333";let i=null;t&&t.worldMap&&(i=this.getWorldMapCanvas()),this.clickedCountryNames||(this.clickedCountryNames=[]);let c=s.querySelector("#country-info-overlay");if(c||(c=document.createElement("div"),c.id="country-info-overlay",c.style.position="absolute",c.style.pointerEvents="auto",c.style.background="rgba(40, 40, 60, 0.85)",c.style.border="1.5px solid #555",c.style.borderRadius="10px",c.style.padding="14px 18px",c.style.color="#b3e5fc",c.style.fontSize="1.08rem",c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",c.style.minWidth="180px",c.style.maxWidth="320px",c.style.display="none",c.style.zIndex="20",s.appendChild(c)),i){let v=function(){A||(A=document.createElement("canvas"),A.width=i.width,A.height=i.height,A.style.position="absolute",A.style.left="0",A.style.top="0",A.style.pointerEvents="none",A.style.width="100%",A.style.height="100%",s.appendChild(A))},k=function(){if(A){const E=A.getContext("2d");E&&E.clearRect(0,0,A.width,A.height)}};i.style.width="100%",i.style.height="100%",i.style.display="block",s.appendChild(i);let A=null;if(!s._fishOverlay){const E=t.worldMap.getMap(),R=i.width,F=i.height,G=(z,X)=>z<0||X<0||X>=E.length||z>=E[0].length?!1:E[X][z]===j;s._fishOverlay=new At(s,R,F,G)}this.fishOverlay=s._fishOverlay,i._countryClickHandler&&i.removeEventListener("mousedown",i._countryClickHandler);const S=E=>{if(this.paused)return;const R=i.width,F=i.height,G=Math.floor(E.offsetX*(R/i.clientWidth)),z=Math.floor(E.offsetY*(F/i.clientHeight)),X=t.worldMap.getMap(),Ee=t.worldMap.getCountries();let N=null;if(G>=0&&z>=0&&z<X.length&&G<X[0].length){const be=X[z][G];if(be>=0&&Ee[be]){if(N=Ee[be],N&&!N.coordinates.some(([O,Z])=>O===G&&Z===z)&&console.warn(`[GameGui] Click at (${G},${z}) is not in coordinates of country: ${N.name}`),N&&this.clickedCountryNames.push(N.name),v(),k(),A&&N){const O=A.getContext("2d");if(O){fe.drawCountryGlow(O,N,[0,0,0],N.color);const[Z,se]=N.center?N.center():[0,0],me=N.fortified?"üõ°Ô∏è "+N.name:N.name;if(O.save(),O.font="bold 10px Verdana, Geneva, sans-serif",O.textAlign="center",O.textBaseline="middle",O.lineWidth=3,O.strokeStyle="black",O.strokeText(me,Z,se),O.fillStyle="white",O.fillText(me,Z,se),B.showArmies&&typeof N.armies=="number"){const te=`${Math.round(N.armies/1e3)}k`;O.font="bold 9px Verdana, Geneva, sans-serif",O.lineWidth=2,O.strokeStyle="black",O.strokeText(te,Z,se+13),O.fillStyle="#FFD700",O.fillText(te,Z,se+13)}O.restore()}}if(N&&c&&t&&t.activePlayer&&typeof t.gameTurn=="number"){const O=t.activePlayer.getCountryInfo(N,t.gameTurn),Z=N.unrestLevel>0?"color: #ff6666; font-style: italic;":"",se=N.unrestLevel>0?'<div style="color: #ff6666; font-style: italic;">Rioting</div>':"",me=N.unrestLevel>0?"color: #ff6666; text-decoration: line-through;":"";let te="";const Me=t.activePlayer;if(Me.armyKnown(N))te='<span style="color: #4caf50; font-weight: bold;">Certified information</span>';else{const ne=Me.knowledge.find(P=>P.country===N);if(N.owner&&N.owner!==Me&&ne){const P=t.gameTurn-ne.gameTurn;te=`<span style="color: #ffd700; font-weight: bold;">${P} turn${P===1?"":"s"} old information</span>`}else te='<span style="color: #ff4444; font-weight: bold;">No information</span>'}c.innerHTML=`
                <div><b>Name:</b> <span style="${Z}">${O.name}</span></div>
                <div><b>Owner:</b> ${O.owner?O.owner.name:"None"}</div>
                <div><b>Income:</b> <span style="${me}">${O.income!==void 0?O.income:"?"} </span></div>
                <div><b>Army:</b> ${O.army!==void 0?O.army:"?"}</div>
                <div>${te}</div>
                ${se}
              `;const[Ye,Ue]=N.center?N.center():[0,0],Xe=i.width,Ke=i.height,Pe=i.getBoundingClientRect(),Je=Pe.width/Xe,Ve=Pe.height/Ke,Qe=Ye*Je,Ze=Ue*Ve;c.style.left=`${Qe-c.offsetWidth/2}px`,c.style.top=`${Ze-c.offsetHeight-18}px`,c.style.display="block",requestAnimationFrame(()=>{const ne=document.querySelector('div[style*="flex: 3"]');let P=ne?ne.querySelector("#country-action-overlay"):null;if(P&&(P.remove(),P=null),!t.activePlayer||t.activePlayer.actionsLeft<=0||!N)return;const et=t.worldMap.getCountries(),ee=this.clickedCountryNames.map(L=>et.find(pe=>pe.name===L)).filter(Boolean);if(ee.length===0)return;const Ae=[];for(const L of this.actions){const pe=L.GetButtonText(ee,t.activePlayer);if(pe){const D=document.createElement("button");D.textContent=pe,D.style.padding="4px 10px",D.style.fontSize="0.95rem",D.style.background="rgba(0,0,0,0.18)",D.style.color="#b3e5fc",D.style.border="1px solid #555",D.style.borderRadius="6px",D.style.cursor="pointer",D.style.boxShadow="0 1px 4px rgba(30,32,34,0.10)",D.style.margin="0 6px 0 0",D.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",D.style.transition="background 0.15s, color 0.15s",D.onmouseenter=()=>{D.style.background="#ffd700",D.style.color="#222"},D.onmouseleave=()=>{D.style.background="rgba(0,0,0,0.18)",D.style.color="#b3e5fc"},D.onclick=async()=>{if(ee.length===0)return;const Ne=L.RequiresAmount(ee,t.activePlayer,t);let ie=null,Re=0;if(Ne){const[tt,Oe]=Ne;let Ge=Oe;if(t&&t.advisedOpportunity){const K=t.advisedOpportunity,nt=t.worldMap.getCountries();for(const $ of K.countries){const W=nt.find(oe=>oe.name===$.name);W&&W!==$&&(console.warn("[Advisor/Action] Country instance mismatch:",$.name,$,W),W.name===$.name&&console.error("[Advisor/Action] Country instance mismatch but names match:",$.name,$,W))}const Se=K.action.Type()===L.Type();Se||console.log("[Advisor/Action] Action type mismatch:",K.action.Type(),L.Type());const Be=K.countries.length,ce=ee.slice(-Be),Te=ce.length===Be&&K.countries.every(($,W)=>$===ce[W]);if(!Te){console.log("[Advisor/Action] Country array mismatch:"),console.log("  opp.countries:",K.countries.map($=>$.name)),console.log("  lastClicked:",ce.map($=>$&&$.name));for(let $=0;$<Math.max(K.countries.length,ce.length);++$){const W=K.countries[$],oe=ce[$];W!==oe&&(W&&oe&&W.name===oe.name?console.error("[Advisor/Action] Country instance mismatch at index",$,"but names match:",W.name,W,oe):console.log("[Advisor/Action] Country mismatch at index",$,":",W,oe))}}Se&&Te?(console.log("[Advisor/Action] Using advisor suggested amount:",K.amount),Ge=K.amount):console.log("[Advisor/Action] Not using advisor amount. sameAction:",Se,"sameCountries:",Te)}const ke=await De(tt,Oe,Ge);if(ke===null)return;Re=ke,ie=await L.Act(ee,t.activePlayer,t,ke)}else ie=await L.Act(ee,t.activePlayer,t);t.activePlayer.actionLog.push({actionType:L.Type(),countries:ee,amount:Re,result:ie??null}),t.activePlayer.useAction(),typeof ie=="string"&&ie!==null?(this.afterAction(),this.showActionResult(ie)):this.afterAction(),t&&(t.advisedOpportunity=null)},Ae.push(D)}}Ae.length>0&&ne&&N&&(P=document.createElement("div"),P.id="country-action-overlay",P.style.position="absolute",P.style.pointerEvents="auto",P.style.background="rgba(40, 40, 60, 0.85)",P.style.border="1.5px solid #555",P.style.borderRadius="10px",P.style.padding="12px 18px",P.style.color="#b3e5fc",P.style.fontSize="0.95rem",P.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",P.style.display="flex",P.style.flexDirection="column",P.style.alignItems="center",P.style.justifyContent="center",P.style.gap="10px",P.style.zIndex="21",P.style.minWidth="140px",P.style.maxWidth="340px",P.style.visibility="hidden",P.style.flexWrap="wrap",P.style.maxWidth="340px",P.style.minHeight="unset",Ae.forEach(L=>{L.style.width="100%",L.style.margin="0",L.style.textAlign="center",L.style.background="#b3e5fc",L.style.color="#1a237e",L.onmouseenter=()=>{L.style.background="#ffd700",L.style.color="#222"},L.onmouseleave=()=>{L.style.background="#b3e5fc",L.style.color="#1a237e"},P.appendChild(L)}),ne.appendChild(P),P.style.left=`${c.offsetLeft}px`,P.style.top=`${c.offsetTop+c.offsetHeight+2}px`,P.style.visibility="visible",P.style.flexWrap="wrap",P.style.maxWidth="340px",P.style.minHeight="unset")})}}}this.isProcessingAdvisorSynthetic=!1};i.addEventListener("mousedown",S),i._countryClickHandler=S}else{const v=document.createElement("div");v.style.width="100%",v.style.height="100%",v.style.background="repeating-linear-gradient(135deg,#444 0 10px,#333 10px 20px)",v.style.border="4px solid #666",v.style.borderRadius="12px",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center";const k=document.createElement("img");k.src="riskStartup.png",k.alt="Risk Startup",k.style.width="100%",k.style.height="100%",k.style.objectFit="cover",k.style.borderRadius="8px",v.appendChild(k),s.appendChild(v)}const a=document.createElement("div"),l=document.createElement("div");l.style.display="flex",l.style.flexDirection="row",l.style.justifyContent="center",l.style.alignItems="center",l.style.gap="18px",l.style.marginBottom="24px",l.style.width="100%",l.style.minWidth="0";function d(v,k,A){const S=document.createElement("img");return S.src=v,S.alt=k,S.style.flex="1 1 0",S.style.width="0",S.style.minWidth="0",S.style.height="auto",S.style.objectFit="contain",S.style.cursor="pointer",S.style.borderRadius="8px",S.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",S.style.transition="transform 0.1s, box-shadow 0.1s",S.addEventListener("mouseenter",()=>{S.style.transform="scale(1.08)",S.style.boxShadow="0 4px 16px #ffd700"}),S.addEventListener("mouseleave",()=>{S.style.transform="scale(1)",S.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)"}),S.onclick=A,S.style.display="block",S.style.margin="0 0",S}const h=d("newgame.png","New Game",()=>this.startNewGame()),y=d("savegame.png","Save Game",()=>{try{if(!this.currentGame)throw new Error("No game to save");const v=ze.serialize(this.currentGame),k=new Blob([v],{type:"application/json"}),A=URL.createObjectURL(k),S=document.createElement("a");S.href=A,S.download="armchair-general-save.json",document.body.appendChild(S),S.click(),setTimeout(()=>{document.body.removeChild(S),URL.revokeObjectURL(A)},100)}catch(v){throw alert("Save failed: "+(v&&v.message?v.message:v)),v}}),w=d("loadgame.png","Load Game",()=>{const v=document.createElement("input");v.type="file",v.accept=".json,application/json",v.onchange=k=>{const A=k.target.files[0];if(!A)return;const S=new FileReader;S.onload=()=>{try{const E=S.result,R=ze.deserialize(E);R.gui=this;for(const F of R.players)F.game=R,F.isAI&&F.AI&&(F.AI.game=R,F.AI.player=F);this.currentGame=R,this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted()}catch(E){throw alert("Load failed: "+(E&&E.message?E.message:E)),E}},S.readAsText(A)},v.click()});l.appendChild(h),l.appendChild(y),l.appendChild(w),a.appendChild(l);const f=document.createElement("div");f.style.marginBottom="32px";const x=document.createElement("div");if(x.style.fontSize="1.2rem",x.style.fontWeight="bold",t&&t.players&&t.players.length>0){const v=t.activePlayer;x.textContent=`Turn: ${t.gameTurn} | Player: ${v.name}`;const k=document.createElement("div"),A=v.constructor.ACTIONS_PER_TURN||5,S=v.actionsLeft;k.style.margin="8px 0 0 0",k.style.fontSize="2rem",k.style.letterSpacing="0.2rem";for(let E=0;E<A;E++){const R=document.createElement("span");R.textContent=E<S?"‚òÖ":"‚òÜ",R.style.color=E<S?"#ffd700":"#888",k.appendChild(R)}k.title=`${S} of ${A} actions remaining`,f.appendChild(k)}else x.textContent="No game loaded. Start a new game to play!";if(f.appendChild(x),a.appendChild(f),t&&t.players&&t.players.length>0){const v=document.createElement("div");v.textContent="Players",v.style.fontWeight="bold",v.style.marginBottom="8px",a.appendChild(v);const k=document.createElement("ul");k.style.listStyle="none",k.style.padding="0",k.style.margin="0 0 24px 0";for(const A of t.players){const S=document.createElement("li");S.style.display="flex",S.style.alignItems="center",S.style.marginBottom="8px",A===t.activePlayer&&(S.style.boxShadow="0 0 16px 4px #ffd700, 0 0 4px 2px #fff",S.style.border="2px solid #ffd700",S.style.borderRadius="12px",S.style.background="rgba(255, 215, 0, 0.10)");const E=document.createElement("span");E.style.display="inline-block",E.style.width="16px",E.style.height="16px",E.style.borderRadius="50%",E.style.background=A.color,E.style.marginRight="8px",S.appendChild(E);const R=document.createElement("span");if(R.textContent=A.name+(A.isAI?" (AI)":""),R.style.flex="1",S.appendChild(R),typeof A.money=="number"){const F=document.createElement("span");F.textContent=`üí∞ ${A.money}`,F.style.marginLeft="8px",S.appendChild(F);const G=document.createElement("span");G.style.display="inline-block",G.style.width="54px",G.style.height="12px",G.style.marginLeft="8px",G.style.verticalAlign="middle",G.style.background="#222",G.style.border="1px solid #444",G.style.borderRadius="6px",G.style.overflow="hidden";const z=document.createElement("span"),X=Math.min(A.IncomeShare/B.INCOME_SHARE_WIN,1);z.style.display="inline-block",z.style.height="100%",z.style.width=`${Math.round(X*100)}%`,z.style.background=X>=1?"linear-gradient(90deg,#43cea2,#ffd700)":"linear-gradient(90deg,#43cea2,#185a9d)",z.style.transition="width 0.3s",G.title=`Income share: ${(A.IncomeShare*100).toFixed(1)}% (win at ${(B.INCOME_SHARE_WIN*100).toFixed(0)}%)`,G.appendChild(z),S.appendChild(G)}k.appendChild(S)}a.appendChild(k)}const m=document.createElement("div");m.id="action-result-panel",m.style.background="#a67c52",m.style.border="1px solid #555",m.style.borderRadius="8px",m.style.padding="10px 12px",m.style.marginBottom="18px",m.style.color="#fff",m.style.fontSize="1.05rem",m.style.minHeight="60px",m.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",m.innerHTML='<span style="color:#888">No recent action.</span>',a.appendChild(m);const p=document.createElement("div");p.id="action-panel",p.style.display="flex",p.style.flexDirection="row",p.style.alignItems="flex-start",p.style.background="#a67c52",p.style.border="1px solid #555",p.style.borderRadius="8px",p.style.padding="20px 24px",p.style.marginTop="auto",p.style.marginBottom="18px",p.style.minHeight="140px",p.style.maxWidth="480px";const u=document.createElement("div");u.id="advisor-speech-bubble",u.style.position="relative",u.style.flex="1 1 0%",u.style.height="80%",u.style.background="white",u.style.color="#222",u.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",u.style.fontSize="1.18rem",u.style.padding="18px 24px",u.style.borderRadius="18px",u.style.boxShadow="0 2px 12px rgba(0,0,0,0.18)",u.style.border="2px solid #a67c52",u.style.display="none",u.style.zIndex="2",u.style.pointerEvents="none",u.style.transition="opacity 0.3s",u.style.opacity="0",u.style.textAlign="left",u.style.lineHeight="1.4",u.innerHTML="",u.style.setProperty("position","relative");const g=document.createElement("style");g.innerHTML=`
    #advisor-speech-bubble::after {
      content: '';
      position: absolute;
      right: -28px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 18px solid transparent;
      border-bottom: 18px solid transparent;
      border-left: 28px solid white;
      filter: drop-shadow(-2px 0 0 #a67c52);
      z-index: 3;
    }
    `,document.head.appendChild(g);const C=document.createElement("div");C.style.flex="0 0 144px",C.style.display="flex",C.style.flexDirection="column",C.style.alignItems="flex-end",C.style.justifyContent="center",C.style.height="100%",C.style.marginLeft="auto",p.appendChild(u),p.appendChild(C),a.appendChild(p);const M=document.createElement("button");M.textContent="End Turn",M.classList.add("persistent-action-btn"),M.style.padding="12px 0",M.style.fontSize="1.1rem",M.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",M.style.color="#fff",M.style.border="none",M.style.borderRadius="8px",M.style.cursor="pointer",M.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",M.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",M.style.marginBottom="18px",M.onclick=()=>{this.paused||this.currentGame&&(this.currentGame.nextTurn(),this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted())},a.appendChild(M),a.style.flex="1",a.style.background="#3b2412",a.style.display="flex",a.style.flexDirection="column",a.style.padding="32px 24px",a.style.color="#fff",a.style.minWidth="420px",a.style.maxWidth="520px",a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",r.appendChild(s),r.appendChild(a),n.appendChild(r),C.addEventListener("click",async()=>{var S;if(console.log("[Advisor] advisor image clicked"),this.isAdvisorAnimationRunning){console.log("[Advisor] Animation already running, ignoring click");return}const v=(S=this.currentGame)==null?void 0:S.activePlayer;if(!v||!v.AI)return;v.AI.game=this.currentGame;const k=v.AI.findBestOpportunity();let A="";if(!k)A="Sorry, sir, I have no idea what to do!";else{let E=k.action.ActionString(k.countries,v,this.currentGame,k.amount);E.length>0&&(E=E.charAt(0).toLowerCase()+E.slice(1)),A=`I think, ${E} would be a good idea.`}if(u.innerHTML=A,u.style.display="block",u.style.opacity="1",k){this.currentGame&&(this.currentGame.advisedOpportunity=k);const{runAdvisorAnimation:E}=await de(async()=>{const{runAdvisorAnimation:R}=await import("./AdvisorAnimation-DpQpr7s9.js");return{runAdvisorAnimation:R}},[]);this.isAdvisorAnimationRunning=!0,console.log("[Advisor] Starting advisor animation"),await E(this,k),this.isAdvisorAnimationRunning=!1}setTimeout(()=>{u.style.opacity="0",setTimeout(()=>u.style.display="none",5e3)},5e3)});const I=document.createElement("img");I.src="Advisor.png",I.alt="Advisor",I.style.maxWidth="100%",I.style.maxHeight="144px",I.style.objectFit="contain",I.style.borderRadius="6px",C.appendChild(I)}setClickedCountryNames(e){this.clickedCountryNames=e}};b(ue,"_instance",null);let ae=ue;function Tt(T,e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="10000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.pointerEvents="none",t.style.overflow="hidden";const n=document.createElement("div");n.innerText="Armchair",n.style.position="relative",n.style.color="#fffbe6",n.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',n.style.fontSize="6vw",n.style.fontWeight="bold",n.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",n.style.letterSpacing="0.18em",n.style.opacity="0",n.style.transform="translateX(-120%) skew(-12deg)",n.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",n.style.filter="drop-shadow(0 0 12px #fffbe6)",n.style.background="",n.style.webkitBackgroundClip="",n.style.backgroundClip="",n.style.webkitTextFillColor="";const o=document.createElement("div");o.innerText="General",o.style.position="relative",o.style.color="#fffbe6",o.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',o.style.fontSize="6vw",o.style.fontWeight="bold",o.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",o.style.letterSpacing="0.18em",o.style.opacity="0",o.style.transform="translateX(120%) skew(12deg)",o.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",o.style.filter="drop-shadow(0 0 12px #fffbe6)",o.style.background="",o.style.webkitBackgroundClip="",o.style.backgroundClip="",o.style.webkitTextFillColor="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="1vw",r.style.pointerEvents="none",r.appendChild(n),r.appendChild(o),t.appendChild(r),T.appendChild(t);const s=document.createElement("canvas");s.width=T.offsetWidth||800,s.height=T.offsetHeight||600,s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",t.appendChild(s);const i=s.getContext("2d"),c=10,a=[];s.width/2;const l=s.height*.8;for(let f=0;f<c;f++){const m=f%2===0?s.width*.05:s.width*.95,p=s.width*(.15+.7*Math.random()),u=l-s.height*.25+Math.random()*s.height*.1,g=l-s.height*.05+Math.random()*s.height*.18,C=1200+Math.random()*400,M=s.height*(.32+Math.random()*.12);a.push({startX:m,startY:u,endX:p,endY:g,duration:C,startTime:null,exploded:!1,explosionTime:null,arcHeight:M})}function d(f,x,m){i&&(i.save(),i.beginPath(),i.arc(f,x,18*m,0,2*Math.PI),i.fillStyle="rgba(40,40,40,0.95)",i.shadowColor="#222",i.shadowBlur=12*m,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(f-6*m,x-6*m,5*m,0,2*Math.PI),i.fillStyle="rgba(200,200,200,0.18)",i.fill(),i.restore())}function h(f,x,m){if(i){if(m<.15){const p=38+60*m;i.save(),i.beginPath(),i.arc(f,x,p,0,2*Math.PI),i.fillStyle=`rgba(255,255,220,${.7*(1-m/.15)})`,i.shadowColor="#fffbe6",i.shadowBlur=48,i.fill(),i.restore()}if(m<.6){const p=32+80*m;i.save(),i.beginPath(),i.arc(f,x,p,0,2*Math.PI),i.fillStyle=`rgba(255,120,40,${.5*(1-m/.6)})`,i.shadowColor="#ffae42",i.shadowBlur=32,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(f,x,p*.5,0,2*Math.PI),i.fillStyle=`rgba(255,220,120,${.7*(1-m/.6)})`,i.shadowColor="#fffbe6",i.shadowBlur=16,i.fill(),i.restore()}if(m>.2){const p=(m-.2)/.8;for(let u=0;u<4;u++){const g=Math.PI*2*(u/4)+Math.random()*.2,C=38+60*m+Math.random()*10,M=f+Math.cos(g)*C*.7*p,I=x+Math.sin(g)*C*.5*p+10*p;i.save(),i.beginPath(),i.arc(M,I,18+18*p,0,2*Math.PI),i.fillStyle=`rgba(80,60,40,${.18*(1-p)})`,i.shadowColor="#222",i.shadowBlur=8,i.fill(),i.restore()}}}}function y(f){i.clearRect(0,0,s.width,s.height);let x=!0;for(const m of a){m.startTime||(m.startTime=f);const p=f-m.startTime;if(m.exploded){if(m.explosionTime&&f-m.explosionTime<700){const u=(f-m.explosionTime)/700;h(m.endX,m.endY,u),x=!1}}else{x=!1;const u=Math.min(p/m.duration,1),g=m.startX+(m.endX-m.startX)*u,C=(1-u)*m.startY+u*m.endY-m.arcHeight*4*u*(1-u),M=.9+.3*(1-Math.abs(2*u-1));d(g,C,M),u>=1&&(m.exploded=!0,m.explosionTime=f)}}x||requestAnimationFrame(y)}requestAnimationFrame(y),setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(0) skew(0)",o.style.opacity="1",o.style.transform="translateX(0) skew(0)"},400),setTimeout(()=>{},3200);const w=document.createElement("link");w.rel="stylesheet",w.href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=UnifrakturCook:wght@700&display=swap",document.head.appendChild(w)}const ge=document.getElementById("app");if(ge)ge.innerHTML="",new ae().mount(ge),setTimeout(()=>{const e=ge.querySelector('div[style*="flex: 3"]');e&&Tt(e)},0);else throw new Error("No app element found in index.html");export{ve as C,re as P,fe as R,Ie as W};
