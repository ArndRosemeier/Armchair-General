var we=Object.defineProperty;var Ce=(M,e,n)=>e in M?we(M,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):M[e]=n;var v=(M,e,n)=>Ce(M,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const be="modulepreload",xe=function(M){return"/Armchair-General/"+M},ce={},Q=function(e,n,t){let o=Promise.resolve();if(n&&n.length>0){let s=function(a){return Promise.all(a.map(l=>Promise.resolve(l).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=s(n.map(a=>{if(a=xe(a),a in ce)return;ce[a]=!0;const l=a.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${d}`))return;const h=document.createElement("link");if(h.rel=l?"stylesheet":be,l||(h.as="script"),h.crossOrigin="",h.href=a,c&&h.setAttribute("nonce",c),document.head.appendChild(h),l)return new Promise((u,C)=>{h.addEventListener("load",u),h.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${a}`)))})}))}function r(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return o.then(s=>{for(const i of s||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})};class ve{constructor(e=[]){v(this,"countries");this.countries=e}}const fe=Math.sqrt(3),Me=.5*(fe-1),U=(3-fe)/6,de=M=>Math.floor(M)|0,he=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function te(M=Math.random){const e=Ae(M),n=new Float64Array(e).map(o=>he[o%12*2]),t=new Float64Array(e).map(o=>he[o%12*2+1]);return function(r,s){let i=0,c=0,a=0;const l=(r+s)*Me,d=de(r+l),h=de(s+l),u=(d+h)*U,C=d-u,f=h-u,g=r-C,y=s-f;let p,m;g>y?(p=1,m=0):(p=0,m=1);const w=g-p+U,b=y-m+U,x=g-1+2*U,A=y-1+2*U,k=d&255,I=h&255;let S=.5-g*g-y*y;if(S>=0){const N=k+e[I],z=n[N],W=t[N];S*=S,i=S*S*(z*g+W*y)}let E=.5-w*w-b*b;if(E>=0){const N=k+p+e[I+m],z=n[N],W=t[N];E*=E,c=E*E*(z*w+W*b)}let G=.5-x*x-A*A;if(G>=0){const N=k+1+e[I+1],z=n[N],W=t[N];G*=G,a=G*G*(z*x+W*A)}return 70*(i+c+a)}}function Ae(M){const n=new Uint8Array(512);for(let t=0;t<512/2;t++)n[t]=t;for(let t=0;t<512/2-1;t++){const o=t+~~(M()*(256-t)),r=n[t];n[t]=n[o],n[o]=r}for(let t=256;t<512;t++)n[t]=n[t-256];return n}function ke(M,e,n,t=1e3){var a;const o=M.length,r=((a=M[0])==null?void 0:a.length)||0,s=Array.from({length:o},()=>Array(r).fill(!1)),i=[[1,0],[-1,0],[0,1],[0,-1]],c=M.map(l=>l.slice());for(let l=0;l<o;l++)for(let d=0;d<r;d++)if(!s[l][d]&&M[l][d]===n){const h=[[l,d]],u=[[l,d]];for(s[l][d]=!0;h.length;){const[C,f]=h.shift();for(const[g,y]of i){const p=C+g,m=f+y;p>=0&&p<o&&m>=0&&m<r&&!s[p][m]&&M[p][m]===n&&(s[p][m]=!0,h.push([p,m]),u.push([p,m]))}}if(u.length<t)for(const[C,f]of u)c[C][f]=e}return c}function Ie(M,e,n){var a;const t=M.length,o=((a=M[0])==null?void 0:a.length)||0,r=Array.from({length:t},()=>Array(o).fill(!1)),s=[];for(let l=0;l<o;l++)M[0][l]===e&&(s.push([0,l]),r[0][l]=!0),M[t-1][l]===e&&(s.push([t-1,l]),r[t-1][l]=!0);for(let l=1;l<t-1;l++)M[l][0]===e&&(s.push([l,0]),r[l][0]=!0),M[l][o-1]===e&&(s.push([l,o-1]),r[l][o-1]=!0);const i=[[1,0],[-1,0],[0,1],[0,-1]];for(;s.length;){const[l,d]=s.shift();for(const[h,u]of i){const C=l+h,f=d+u;C>=0&&C<t&&f>=0&&f<o&&!r[C][f]&&M[C][f]===e&&(r[C][f]=!0,s.push([C,f]))}}return M.map((l,d)=>l.map((h,u)=>h===e&&!r[d][u]?n:h))}function Se(M,e){return me(M,e,{scale:.0018,threshold:-.05,borderStrength:.5,borderWidth:.15,octaves:6,persistence:.5,seed:Math.floor(Math.random()*1e9)})}function me(M,e,n){const t=(n==null?void 0:n.scale)??.015,o=(n==null?void 0:n.threshold)??0,r=(n==null?void 0:n.seed)!==void 0?Te(n.seed):Math.random,s=te(r),i=(n==null?void 0:n.borderStrength)??.5,c=(n==null?void 0:n.borderWidth)??.2,a=(n==null?void 0:n.octaves)??4,l=(n==null?void 0:n.persistence)??.5,d=[];for(let u=0;u<e;u++){const C=[];for(let f=0;f<M;f++){const g=f-M/2,y=u-e/2;let p=0,m=0,w=1,b=1;for(let S=0;S<a;S++)p+=s(g*t*w,y*t*w)*b,m+=b,b*=l,w*=2;p/=m;const x=Math.min(f,M-1-f)/(M/2),A=Math.min(u,e-1-u)/(e/2),k=Math.min(x,A);let I=p;if(k<c){const S=i*(1-k/c);I=p*(1-S)+$*S}C.push(I>o?_:$)}d.push(C)}let h=Ie(d,$,_);return h=ke(h,$,_,1e3),h}function Te(M){return function(){let e=M+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class re{constructor(e,n=null,t=0,o=0){v(this,"name");v(this,"owner");v(this,"armies");v(this,"income");v(this,"coordinates");v(this,"border");v(this,"oceanBorder");v(this,"neighbors");v(this,"color");v(this,"fortified",!1);v(this,"_center",null);this.name=e,this.owner=n,this.armies=t,this.income=o,this.coordinates=[],this.border=[],this.oceanBorder=[],this.neighbors=[],this.color=[Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150),Math.floor(80+Math.random()*150)]}setOwner(e){this.owner=e}setArmies(e){this.armies=e}center(){if(this._center)return this._center;if(!this.coordinates.length)return this._center=[0,0],this._center;let e=0,n=0;for(const[t,o]of this.coordinates)e+=t,n+=o;return this._center=[e/this.coordinates.length,n/this.coordinates.length],this._center}canBeFortified(){if(this.fortified)return!1;if(this.owner){for(const[e,n]of this.owner.plannedFortifications)if(e===this)return!1}return!0}toJSON(){return{id:this.name,name:this.name,ownerId:this.owner?this.owner.name:null,armies:this.armies,income:this.income,coordinates:this.coordinates,border:this.border,oceanBorder:this.oceanBorder,neighborIds:this.neighbors.map(e=>e.name),color:this.color,fortified:this.fortified}}static fromJSON(e,n,t){const o=new re(e.name,null,e.armies,e.income);return o.coordinates=e.coordinates,o.border=e.border,o.oceanBorder=e.oceanBorder,o.color=e.color,o.fortified=e.fortified,o._ownerId=e.ownerId,o._neighborIds=e.neighborIds,t[e.name]=o,o}resolveReferences(e,n){this.owner=this._ownerId?e[this._ownerId]:null,this.neighbors=(this._neighborIds||[]).map(t=>n[t]).filter(Boolean),delete this._ownerId,delete this._neighborIds}}class Ee{static generateCountriesMap(e,n={}){if(!e||e.length===0||!e[0])throw new Error("continentMap must be a non-empty 2D array");const t=e.length,o=e[0].length,r=n.countryCount??12,s=n.scale??.09,i=n.minResistance??10,c=n.maxResistance??50,a=n.skipProbability??.9,l=n.seed!==void 0?Ne(n.seed):Math.random,d=te(l),h=[];for(let m=0;m<t;m++){const w=[];for(let b=0;b<o;b++)w.push(e[m][b]===_?i+(c-i)*Math.abs(d(b*s,m*s)):1/0);h.push(w)}const u=[],C=[];for(let m=0;m<t;m++)for(let w=0;w<o;w++)e[m][w]===_&&C.push([w,m]);for(let m=0;m<r&&C.length>0;m++){const w=Math.floor(l()*C.length),[b,x]=C.splice(w,1)[0];u.push({x:b,y:x,idx:m})}for(let m=0;m<t;m++)for(let w=0;w<o;w++)e[m][w]!==$&&(e[m][w]=_);for(const{x:m,y:w,idx:b}of u)e[w][m]=b;const f=u.map(({x:m,y:w,idx:b})=>[m,w,b]),g=(i+c)/2;for(;f.length>0;){const m=Math.floor(l()*f.length),[w,b,x]=f.splice(m,1)[0],A=[];for(const[k,I]of[[1,0],[0,1],[-1,0],[0,-1]]){const S=w+k,E=b+I;S>=0&&S<o&&E>=0&&E<t&&e[E][S]===_&&A.push([S,E])}if(A.length!==0)for(const[k,I]of A)h[I][k]>g&&l()<a||(e[I][k]=x,f.push([k,I,x]))}const y=Array.from({length:t},()=>Array(o).fill(!1));let p=0;for(let m=0;m<t;m++)for(let w=0;w<o;w++)e[m][w]>=0&&e[m][w]+1>p&&(p=e[m][w]+1);for(let m=0;m<t;m++)for(let w=0;w<o;w++)if(e[m][w]===_&&!y[m][w]){const b=[[w,m]];for(y[m][w]=!0;b.length>0;){const[x,A]=b.pop();e[A][x]=p;for(const[k,I]of[[1,0],[0,1],[-1,0],[0,-1]]){const S=x+k,E=A+I;S>=0&&S<o&&E>=0&&E<t&&e[E][S]===_&&!y[E][S]&&(b.push([S,E]),y[E][S]=!0)}}p++}return e}static generateCountriesInternal(e,n){const t=this.generateCountriesMap(e,n);if(!t||t.length===0||!t[0])throw new Error("map must be a non-empty 2D array");const o=t.length,r=t[0].length,s={};for(let a=0;a<o;a++)for(let l=0;l<r;l++){const d=t[a][l];if(d>=0){if(!s[d]){const h=new re(`Country ${d}`);h.id=d,s[d]=h}s[d].coordinates.push([l,a])}}const i=Math.max(...Object.keys(s).map(Number)),c=Array.from({length:i+1},(a,l)=>s[l]);return this.findCountryBorders(t,c,r,o),{map:t,countries:c}}static findCountryBorders(e,n,t,o){const r=[[1,0],[0,1],[-1,0],[0,-1]];for(const s of n){const i=s.id;s.border=[],s.oceanBorder=[];for(const[c,a]of s.coordinates){let l=!1,d=!1;for(const[h,u]of r){const C=c+h,f=a+u;(C<0||C>=t||f<0||f>=o||e[f][C]!==i)&&(l=!0,(C<0||C>=t||f<0||f>=o||e[f][C]===$)&&(d=!0))}l&&s.border.push([c,a]),d&&s.oceanBorder.push([c,a])}}}static findNeighbors(e){const n=new Map;for(const t of e)for(const[o,r]of t.border)n.set(`${o},${r}`,t);for(const t of e){const o=new Set;for(const[r,s]of t.border)for(const[i,c]of[[1,0],[0,1],[-1,0],[0,-1]]){const a=r+i,l=s+c,d=n.get(`${a},${l}`);d&&d!==t&&o.add(d)}t.neighbors=Array.from(o)}}static mergeSmallCountries(e,n=1e3){let t=!0;for(;t;){t=!1;for(let o=e.length-1;o>=0;o--){const r=e[o];if(r.coordinates.length<n&&r.neighbors.length>0){let s=r.neighbors[0];for(const i of r.neighbors)i.coordinates.length<s.coordinates.length&&(s=i);s.coordinates.push(...r.coordinates),e.splice(o,1),t=!0}}t&&this.findNeighbors(e)}}static generateCountries(e,n={}){const{map:t,countries:o}=this.generateCountriesInternal(e,n);this.findNeighbors(o);const r=(n==null?void 0:n.minCountrySize)??1e3;if(this.mergeSmallCountries(o,r),!t||t.length===0||!t[0])throw new Error("map must be a non-empty 2D array");const s=t[0].length,i=t.length;return this.findCountryBorders(t,o,s,i),this.findNeighbors(o),{map:t,countries:o}}}function Ne(M){return function(){let e=M+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function Pe(M,e){return Ee.generateCountries(M,{countryCount:e,minResistance:0,maxResistance:130,skipProbability:0})}const $=-1,_=-2,q=class q{constructor(e,n,t=[]){v(this,"countries");v(this,"map");v(this,"continents",[]);this.countries=t,this.map=q.createOceanMap(e,n)}static logCountryNamesInOrder(e,n=""){const t=e.map((o,r)=>`${r}: ${o.name}`);console.log(`[WorldMap] Country order${n?" - "+n:""}:
`+t.join(", "))}static checkMapCountryConsistency(e,n){if(!Array.isArray(e)||!Array.isArray(n))return console.error("[WorldMap] Consistency check failed: map or countries not arrays"),!1;let t=!0;for(let o=0;o<e.length;++o)for(let r=0;r<e[o].length;++r){const s=e[o][r];s>=0&&(n[s]?typeof n[s].name!="string"&&(console.error(`[WorldMap] Inconsistent: countries[${s}] has no valid name at map[${o}][${r}]`),t=!1):(console.error(`[WorldMap] Inconsistent: map[${o}][${r}] = ${s}, but countries[${s}] is undefined`),t=!1))}return t}assignRandomCountryNames(){let e=!1;for(;!e;){const n=new Set;for(const t of this.countries){let o,r=0;do if(o=q.generateRandomName(),r++,r>1e3)throw new Error("Failed to generate unique random country names");while(n.has(o));t.name=o,n.add(o)}e=n.size===this.countries.length}}assignRealCountryNames(){let e=!1;for(;!e;){const n=[...q.REAL_COUNTRY_NAMES],t=new Set;for(const o of this.countries){let r;if(n.length>0){const s=Math.floor(Math.random()*n.length);r=n.splice(s,1)[0]}else{let s=0;do if(r=q.generateRandomName(),s++,s>1e3)throw new Error("Failed to generate unique fallback country names");while(t.has(r))}o.name=r,t.add(r)}e=t.size===this.countries.length}}static generateRandomName(){const e=["zan","mor","vek","tal","rin","dor","lek","sha","val","nor","ka","bel","dra","sil","tur","gar","fen","mir","sol","vor","lin","sar","qu","zel","ron","bar","zen","tir","lom","kal","vin","lor","mel","dar","gol","han","jor","ken","lun","mar"],n=2+Math.floor(Math.random()*2);let t="";for(let o=0;o<n;o++)t+=e[Math.floor(Math.random()*e.length)];return t.charAt(0).toUpperCase()+t.slice(1)}static createOceanMap(e,n){return Array.from({length:n},()=>Array(e).fill($))}static generateContinentsMap(e,n,t){return me(e,n,t)}static createMap(e,n,t=40,o=!0){const r=Se(e,n),{map:s,countries:i}=Pe(r,t),c=new q(e,n,i);return c.map=s,o?c.assignRealCountryNames():c.assignRandomCountryNames(),c.regenerateMapFromCountries(c.countries),c.createContinents(),c}addCountry(e){this.countries.push(e)}createContinents(){const e=new Set,n=[];for(const t of this.countries)if(!e.has(t)){const o=[t],r=[];for(e.add(t);o.length>0;){const s=o.shift();r.push(s);for(const i of s.neighbors)e.has(i)||(e.add(i),o.push(i))}n.push(new ve(r))}this.continents=n}getCountries(){return this.countries}distance(e,n){const[t,o]=e.center(),[r,s]=n.center(),i=Math.sqrt((t-r)**2+(o-s)**2);if(e.neighbors.includes(n)||n.neighbors.includes(e))return i;const c=e.oceanBorder&&e.oceanBorder.length>0,a=n.oceanBorder&&n.oceanBorder.length>0;return c&&a?i*3:null}getMap(){return this.map}regenerateMapFromCountries(e){if(!this.map||!Array.isArray(this.map)||this.map.length===0||this.map[0].length===0)throw new Error("WorldMap.map is not initialized or has invalid dimensions");const n=this.map.length,t=this.map[0].length,o=q.createOceanMap(t,n);for(let r=0;r<e.length;++r){const s=e[r];if(!s.coordinates||!Array.isArray(s.coordinates))throw new Error(`Country at index ${r} has no valid coordinates array`);for(const[i,c]of s.coordinates){if(typeof i!="number"||typeof c!="number"||i<0||i>=t||c<0||c>=n)throw new Error(`Country index ${r} has out-of-bounds coordinate (${i}, ${c})`);o[c][i]=r}}this.map=o}};v(q,"REAL_COUNTRY_NAMES",["Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia"]);let se=q;function Oe(M){if(!M.length)throw new Error("No countries provided");let e=0,n=0;for(const s of M)for(const[i,c]of s.coordinates)i>e&&(e=i),c>n&&(n=c);const t=e+1,o=n+1,r=new se(t,o,M);return r.regenerateMapFromCountries(M),r.createContinents(),r}const O=class O{static render(e,n=[],t=[],o=!1,r=null){var C;const s=e.getMap(),i=((C=e.getCountries)==null?void 0:C.call(e))||[],c=s.length,a=s[0].length,l=document.createElement("canvas");l.width=a,l.height=c;const d=l.getContext("2d");if(!d)throw new Error("Could not get canvas context");const h=d.createImageData(a,c),u=h.data;for(let f=0;f<c;f++)for(let g=0;g<a;g++){const y=s[f][g],[p,m,w]=O.getRGBForValue(y,i,g,f,s),b=(f*a+g)*4;u[b]=p,u[b+1]=m,u[b+2]=w,u[b+3]=255}if(n&&n.length>0){for(const f of n)if(!(!f||!f.coordinates)){for(const[g,y]of f.coordinates)if(g>=0&&g<a&&y>=0&&y<c){const p=(y*a+g)*4;u[p]=Math.min(255,Math.round(.6*255+.4*u[p])),u[p+1]=Math.min(255,Math.round(.6*255+.4*u[p+1])),u[p+2]=Math.round(.4*u[p+2]),u[p+3]=255}}}for(const f of i){const g=f.owner&&f.owner.homeCountry===f,y=g?[255,140,0]:[0,0,0];for(const[p,m]of f.border||[])if(g)for(let w=-1;w<=1;w++)for(let b=-1;b<=1;b++){const x=p+b,A=m+w;if(x>=0&&x<a&&A>=0&&A<c){const k=(A*a+x)*4;u[k]=y[0],u[k+1]=y[1],u[k+2]=y[2],u[k+3]=255}}else if(p>=0&&p<a&&m>=0&&m<c){const w=(m*a+p)*4;u[w]=y[0],u[w+1]=y[1],u[w+2]=y[2],u[w+3]=255}}d.putImageData(h,0,0),d.save(),d.font="bold 10px MedievalSharp, Verdana, serif",d.textAlign="center",d.textBaseline="middle";for(const f of i){if(!f.name)continue;const[g,y]=f.center?f.center():[0,0],p=f.fortified?"🛡️ "+f.name:f.name;d.lineWidth=3,d.strokeStyle="black",d.strokeText(p,g,y);const m=t.some(b=>b===f);d.fillStyle=m?"#90EE90":"white",d.fillText(p,g,y);let w=!1;if((o||r&&f.owner===r&&!r.isAI||r&&typeof r.armyKnown=="function"&&r.armyKnown(f)&&!r.isAI)&&(w=!0),w){const b=f.armies||0,x=`${Math.round(b/1e3)}k`;d.font="bold 9px MedievalSharp, Verdana, serif",d.lineWidth=2,d.strokeStyle="black",d.strokeText(x,g,y+13),d.fillStyle="#FFD700",d.fillText(x,g,y+13),d.font="bold 10px MedievalSharp, Verdana, serif"}}return d.restore(),l}static displayWithPanZoom(e,n,t=512,o=512,r=[]){let s=null,i=O.render(e,[],r);const c=i.width,a=i.height,l=document.createElement("canvas");l.width=t,l.height=o,l.style.border="1px solid #888",n.appendChild(l);const d=l.getContext("2d");if(!d)throw new Error("Could not get canvas context");let h=Math.min(l.width/c,l.height/a),u=(l.width-c*h)/2,C=(l.height-a*h)/2,f=!1,g=0,y=0;function p(){i=O.render(e,s?[s]:[],r),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,l.width,l.height),d.setTransform(h,0,0,h,u,C),d.drawImage(i,0,0)}return l.addEventListener("mousedown",m=>{const w=l.getBoundingClientRect(),b=(m.clientX-w.left-u)/h,x=(m.clientY-w.top-C)/h,A=e.getMap(),k=e.getCountries(),I=Math.floor(b),S=Math.floor(x);let E=null;if(I>=0&&S>=0&&S<A.length&&I<A[0].length){const G=A[S][I];G>=0&&k[G]&&(E=k[G])}if(E){s=E,p();return}f=!0,g=m.clientX,y=m.clientY}),window.addEventListener("mousemove",m=>{if(!f)return;const w=m.clientX-g,b=m.clientY-y;u+=w,C+=b,g=m.clientX,y=m.clientY,p()}),window.addEventListener("mouseup",()=>{f=!1}),l.addEventListener("wheel",m=>{m.preventDefault();const w=m.offsetX,b=m.offsetY,x=Math.exp(-m.deltaY*.001);u=w-(w-u)*x,C=b-(b-C)*x,h*=x,p()}),p(),l}static getRGBForValue(e,n,t,o,r){var s,i,c;if(e===$){t=t??0,o=o??0,r=r??[];const a=((s=r[0])==null?void 0:s.length)||1024,l=r.length||768,d=o/l;let h=Math.round(30*(1-d)+10*d),u=Math.round(144*(1-d)+80*d),C=Math.round(255*(1-d)+180*d);const f=O._oceanNoise2D(t*.03,o*.03),g=Math.floor(18*f);h+=g,u+=g,C+=g;let y=!1;if(r&&t>0&&o>0&&t<a-1&&o<l-1)for(const[p,m]of[[1,0],[-1,0],[0,1],[0,-1]]){const w=t+p,b=o+m;if(r[b][w]!==$){y=!0;break}}return y&&(h=Math.min(255,h+40),u=Math.min(255,u+40),C=Math.min(255,C+40)),[h,u,C]}if(e===_){t=t??0,o=o??0,r=r??[];const a=((i=r[0])==null?void 0:i.length)||1024,l=r.length||768,d=O._landNoise2D(t*.04,o*.04),h=[34,139,34],u=[80,180,80],C=.5+.5*d;let f=Math.round(h[0]*(1-C)+u[0]*C),g=Math.round(h[1]*(1-C)+u[1]*C),y=Math.round(h[2]*(1-C)+u[2]*C),p=!1;if(r&&t>0&&o>0&&t<a-1&&o<l-1)for(const[m,w]of[[1,0],[-1,0],[0,1],[0,-1]]){const b=t+m,x=o+w;if(r[x][b]===$){p=!0;break}}return p&&(f=Math.min(255,f+30),g=Math.min(255,g+30),y=Math.min(255,y+30)),[f,g,y]}if(e>=0){const a=n[e];let l=[200,200,200];if(a)if(a.owner&&typeof a.owner.RGBColor=="string"){const k=a.owner.RGBColor.split(",").map(Number);k.length===3&&k.every(I=>!isNaN(I))&&(l=[k[0],k[1],k[2]])}else a.color&&(l=a.color);t=t??0,o=o??0,r=r??[];const d=((c=r[0])==null?void 0:c.length)||1024,h=r.length||768,u=O._landNoise2D(t*.02,o*.02),C=Math.round(18*u),f=l,g=[Math.max(0,l[0]-32),Math.max(0,l[1]-48),Math.max(0,l[2]-32)],y=.5+.5*u;let p=Math.round(f[0]*(1-y)+g[0]*y)+C,m=Math.round(f[1]*(1-y)+g[1]*y)+C,w=Math.round(f[2]*(1-y)+g[2]*y)+C;const b=O._landNoise2D(t*.006+100,o*.006+100),x=Math.round(18*b);p=Math.min(255,Math.max(0,p+x)),m=Math.min(255,Math.max(0,m+x)),w=Math.min(255,Math.max(0,w+x));let A=!1;if(r&&t>0&&o>0&&t<d-1&&o<h-1)for(const[k,I]of[[1,0],[-1,0],[0,1],[0,-1]]){const S=t+k,E=o+I;if(r[E][S]===$){A=!0;break}}return A&&(p=Math.min(255,p+12),m=Math.min(255,m+12),w=Math.min(255,w+12)),[p,m,w]}return[255,255,255]}static drawCountryGlow(e,n,t,o){function r(i,c,a){return[Math.round(i[0]+(c[0]-i[0])*a),Math.round(i[1]+(c[1]-i[1])*a),Math.round(i[2]+(c[2]-i[2])*a)]}let s=new Set(n.coordinates.map(([i,c])=>`${i},${c}`));for(let i=0;i<10;++i){const c=[];for(const d of s){const[h,u]=d.split(",").map(Number),C=[[h-1,u],[h+1,u],[h,u-1],[h,u+1]];for(const[f,g]of C)if(!s.has(`${f},${g}`)){c.push([h,u]);break}}const a=i/9,l=r(t,o,a);e.save(),e.fillStyle=`rgb(${l[0]},${l[1]},${l[2]})`;for(const[d,h]of c)e.fillRect(d,h,1,1);e.restore();for(const[d,h]of c)s.delete(`${d},${h}`);if(s.size===0)break}e.save();for(const i of s){const[c,a]=i.split(",").map(Number);let l=[200,200,200];if(n)if(n.owner&&typeof n.owner.RGBColor=="string"){const b=n.owner.RGBColor.split(",").map(Number);b.length===3&&b.every(x=>!isNaN(x))&&(l=[b[0],b[1],b[2]])}else n.color&&(l=n.color);const d=O._landNoise2D(c*.02,a*.02),h=Math.round(18*d),u=l,C=[Math.max(0,l[0]-32),Math.max(0,l[1]-48),Math.max(0,l[2]-32)],f=.5+.5*d;let g=Math.round(u[0]*(1-f)+C[0]*f)+h,y=Math.round(u[1]*(1-f)+C[1]*f)+h,p=Math.round(u[2]*(1-f)+C[2]*f)+h;const m=O._landNoise2D(c*.006+100,a*.006+100),w=Math.round(18*m);g=Math.min(255,Math.max(0,g+w)),y=Math.min(255,Math.max(0,y+w)),p=Math.min(255,Math.max(0,p+w)),e.fillStyle=`rgb(${g},${y},${p})`,e.fillRect(c,a,1,1)}e.restore()}};v(O,"drawBorders",!0),v(O,"_oceanNoise2D",te()),v(O,"_landNoise2D",te());let K=O;class Y{RequiresAmount(e,n,t){return null}}class R{constructor(e,n,t,o,r=null){v(this,"countries");v(this,"amount");v(this,"action");v(this,"score");v(this,"followUp");this.countries=e,this.amount=n,this.action=t,this.score=o,this.followUp=r}}class Be{constructor(e,n,t){v(this,"canvas");v(this,"ctx");v(this,"start");v(this,"end");this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Could not get canvas context");this.ctx=o,this.start=n,this.end=t}draw(){const e=this.ctx,{start:n,end:t}=this,o=(n.x+t.x)/2,r=(n.y+t.y)/2,s=t.x-n.x,i=t.y-n.y,c=Math.sqrt(s*s+i*i),a=.25*c,l=-i/c*a,d=s/c*a,h=o+l,u=r+d,C=e.createLinearGradient(n.x,n.y,t.x,t.y);C.addColorStop(0,"#fff"),C.addColorStop(.5,"#0ff"),C.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=12,e.strokeStyle=C,e.beginPath(),e.moveTo(n.x,n.y),e.quadraticCurveTo(h,u,t.x,t.y),e.stroke();const f=.95,g=this.getQuadraticPoint(n,{x:h,y:u},t,f),y=this.getQuadraticTangent(n,{x:h,y:u},t,f);this.drawArrowhead(g,y),e.restore()}getQuadraticPoint(e,n,t,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*n.x+o*o*t.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*n.y+o*o*t.y;return{x:r,y:s}}getQuadraticTangent(e,n,t,o){const r=2*(1-o)*(n.x-e.x)+2*o*(t.x-n.x),s=2*(1-o)*(n.y-e.y)+2*o*(t.y-n.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,n){const t=this.ctx;t.save(),t.translate(e.x,e.y);const o=Math.atan2(n.y,n.x);t.rotate(o),t.beginPath(),t.moveTo(0,0),t.lineTo(-18,7),t.lineTo(-12,0),t.lineTo(-18,-7),t.closePath(),t.fillStyle="rgba(0,255,255,0.95)",t.shadowColor="#fff",t.shadowBlur=8,t.fill(),t.restore()}}class Re{constructor(e,n,t){v(this,"canvas");v(this,"attacker");v(this,"defender");this.canvas=e,this.attacker=n,this.defender=t}async start(){const e=this.canvas.getContext("2d");if(!e)return;const[n,t]=this.attacker.center(),[o,r]=this.defender.center(),s={x:n,y:t},i={x:o,y:r};new Be(this.canvas,s,i);const c=500,a=this.attacker,l=this.defender;return new Promise(d=>{const h=u=>{const f=performance.now()-u,g=Math.min(f/c,1);e.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCountry(e,a,"attacker"),this.drawCountry(e,l,"defender"),this.drawAnimatedArrow(e,s,i,g),g<1?requestAnimationFrame(()=>h(u)):d()};requestAnimationFrame(u=>h(u))})}drawAnimatedArrow(e,n,t,o){const r=(n.x+t.x)/2,s=(n.y+t.y)/2,i=t.x-n.x,c=t.y-n.y,a=Math.sqrt(i*i+c*c),l=.25*a,d=-c/a*l,h=i/a*l,u=r+d,C=s+h,f=e.createLinearGradient(n.x,n.y,t.x,t.y);f.addColorStop(0,"#fff"),f.addColorStop(.5,"#0ff"),f.addColorStop(1,"#00f"),e.save(),e.lineWidth=8,e.shadowColor="#0ff",e.shadowBlur=16,e.strokeStyle=f,e.beginPath(),e.moveTo(n.x,n.y);const g=60;for(let y=1;y<=Math.floor(g*o);++y){const p=y/g,m=this.getQuadraticPoint(n,{x:u,y:C},t,p);e.lineTo(m.x,m.y)}if(e.stroke(),o>.05){const y=o,p=this.getQuadraticPoint(n,{x:u,y:C},t,y),m=this.getQuadraticTangent(n,{x:u,y:C},t,y);this.drawArrowhead(e,p,m)}e.restore()}drawCountry(e,n,t){let o;t==="attacker"?o=[180,0,0]:t==="defender"?o=[0,0,180]:o=n.color||[200,200,200],K.drawCountryGlow(e,n,o,n.color);const[r,s]=n.center?n.center():[0,0],i=n.fortified?"🛡️ "+n.name:n.name;if(e.save(),e.font="bold 10px Verdana, Geneva, sans-serif",e.textAlign="center",e.textBaseline="middle",e.lineWidth=3,e.strokeStyle="black",e.strokeText(i,r,s),e.fillStyle="white",e.fillText(i,r,s),typeof n.armies=="number"&&P.showArmies){const c=`${Math.round(n.armies/1e3)}k`;e.font="bold 9px Verdana, Geneva, sans-serif",e.lineWidth=2,e.strokeStyle="black",e.strokeText(c,r,s+13),e.fillStyle="#FFD700",e.fillText(c,r,s+13)}e.restore()}getQuadraticPoint(e,n,t,o){const r=(1-o)*(1-o)*e.x+2*(1-o)*o*n.x+o*o*t.x,s=(1-o)*(1-o)*e.y+2*(1-o)*o*n.y+o*o*t.y;return{x:r,y:s}}getQuadraticTangent(e,n,t,o){const r=2*(1-o)*(n.x-e.x)+2*o*(t.x-n.x),s=2*(1-o)*(n.y-e.y)+2*o*(t.y-n.y),i=Math.sqrt(r*r+s*s);return{x:r/i,y:s/i}}drawArrowhead(e,n,t){e.save(),e.translate(n.x,n.y);const o=Math.atan2(t.y,t.x);e.rotate(o),e.beginPath(),e.moveTo(0,0),e.lineTo(-18,7),e.lineTo(-12,0),e.lineTo(-18,-7),e.closePath(),e.fillStyle="rgba(0,255,255,0.95)",e.shadowColor="#fff",e.shadowBlur=8,e.fill(),e.restore()}}class L extends Y{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];if(t.owner!==n||t===o)return null;const r=t.neighbors.includes(o),s=t.oceanBorder.length>0&&o.oceanBorder.length>0;return!r&&!s||o.owner===n?null:`Attack ${o.name} from ${t.name}`}async Act(e,n,t,o=0){var m,w;if(!t)throw new Error("Internal error: currentGame is required.");if(e.length<2)throw new Error("Select source and target countries to attack.");const r=e[e.length-2],s=e[e.length-1];if(r.owner!==n)throw new Error("You must own the attacking country.");const i=r.neighbors.includes(s),c=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!c)throw new Error("Target country must be a neighbor or reachable by naval attack.");if(s.owner===n)throw new Error("Cannot attack your own country.");if(o<=0||o>=r.armies)throw new Error("Invalid number of armies committed.");if(!n.game)throw new Error("ActionAttack: activePlayer.game is missing");if(!n.game.gui)throw new Error("ActionAttack: activePlayer.game.gui is missing");const l=n.game.gui.getWorldMapCanvas(),d=l.parentElement;if(!d)throw new Error("ActionAttack: mapCanvas.parentElement is null");d.style.position="relative";let h=document.getElementById("attack-animation-overlay");h&&((m=h.parentElement)==null||m.removeChild(h));let u=document.createElement("canvas");u.id="attack-animation-overlay",u.width=l.width,u.height=l.height,u.style.position="absolute",u.style.left="0",u.style.top="0",u.style.pointerEvents="none",u.style.zIndex="9999",u.style.width="100%",u.style.height="100%",u.style.background="rgba(255,255,255,0.01)",d.appendChild(u),new Re(u,r,s).start(),await new Promise(b=>setTimeout(b,0)),await new Promise(b=>setTimeout(b,1e3)),(w=u==null?void 0:u.parentElement)==null||w.removeChild(u);const f=L.AttackChance(r.armies,s.armies,t.worldMap.distance(r,s)||0,s.fortified,t),g=Math.random(),y=Math.sqrt(Math.abs(g-f));let p="";if(r.armies-=o,g<f){const b=s.owner;b&&(b.ownedCountries=b.ownedCountries.filter(A=>A!==s),b.plannedFortifications=b.plannedFortifications.filter(([A,k])=>A!==s)),s.owner=n,n.ownedCountries.push(s);let x=Math.max(1,Math.round(o*Math.sqrt(y)));x>0&&(x=Math.max(1e3,Math.round(x/1e3)*1e3)),s.armies=x,s.fortified=!1,b&&b.ownedCountries.length===0&&t.players.includes(b)&&(t.players=t.players.filter(A=>A!==b),t.activePlayerIndex>=t.players.length&&(t.activePlayerIndex=0)),n.ownedCountries.length===0&&t.players.includes(n)&&(t.players=t.players.filter(A=>A!==n),t.activePlayerIndex>=t.players.length&&(t.activePlayerIndex=0));for(const A of t.players)A.knowledge=A.knowledge.filter(k=>k.country!==s);p=`Attack successful! ${x} of your ${o} armies occupy ${s.name}.`}else{let b=Math.round(s.armies*Math.sqrt(y));b>0&&(b=Math.max(1e3,Math.round(b/1e3)*1e3)),s.armies=Math.max(1,s.armies-b),s.armies>0&&(s.armies=Math.max(1e3,Math.round(s.armies/1e3)*1e3)),p=`Attack failed! All ${o} attacking armies lost. Defenders lost ${b} troops.`}return p}static AttackChance(e,n,t,o,r){return t===null?0:(n*=t/100,o&&(n*=2),e>=3*n?1:e<=n/3?0:e<n?.5*(e-n/3)/(n-n/3):.5+.5*(e-n)/(2*n))}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Attack"}}class Z extends Y{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];return!t||!o||t.owner!==n||o.owner!==n||t===o?null:`Move armies from ${t.name} to ${o.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to move armies.";const r=e[e.length-2],s=e[e.length-1];return r.owner!==n||s.owner!==n?"Both countries must be owned by you.":r===s?"Source and target countries must be different.":o<=0||o>=r.armies?"Invalid number of armies to move.":(r.armies-=o,s.armies+=o,`Moved ${o} armies from ${r.name} to ${s.name}.`)}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}get countryCountNeeded(){return 2}Type(){return"Move"}}class ye extends Y{GetButtonText(e,n){if(e.length===0)return null;const t=e[e.length-1];return t.owner!==n||t.fortified?null:`Fortify ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length===0)return"Please select a country to fortify.";const r=e[e.length-1];return r.canBeFortified()?n.money<P.fortifyCost?`Not enough money to fortify. You need $${P.fortifyCost}.`:(n.money-=P.fortifyCost,n.plannedFortifications.push([r,t.gameTurn+2]),`Fortification planned for ${r.name} on turn ${t.gameTurn+2}.`):`${r.name} cannot be fortified.`}RequiresAmount(e,n,t){return null}get countryCountNeeded(){return 1}Type(){return"Fortify"}}class ee extends Y{GetButtonText(e,n){if(e.length<1)return null;const t=e[e.length-1];return!t||t.owner!==n?null:`Buy armies for ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<1)return"Select a friendly country to buy armies for.";const r=e[e.length-1];if(r.owner!==n)return"You must own the target country.";if(o<=0)return"Invalid number of armies to buy.";const s=o*P.armyCost;return n.money<s?`Not enough money. Need ${s.toLocaleString()}, have ${n.money.toLocaleString()}.`:(n.money-=s,r.armies+=o,`Bought ${o} armies for ${r.name} at a cost of ${s.toLocaleString()}.`)}RequiresAmount(e,n,t){const o=Math.floor(n.money/P.armyCost/1e3)*1e3;return o<1e3?null:[1e3,o]}get countryCountNeeded(){return 1}Type(){return"BuyArmies"}}const D=class D{constructor(e,n){v(this,"player");v(this,"game");v(this,"actionPlan",[]);this.player=e,this.game=n}GetBestArmies(e){return!this.player.ownedCountries||this.player.ownedCountries.length===0?[]:this.player.ownedCountries.slice().sort((n,t)=>(t.armies||0)-(n.armies||0)).slice(0,e)}FindSpyOpportunities(){const e=new pe,n=[],t=this.getNonOwnedCountriesSortedByDistance(),s=this.game.worldMap.getCountries().filter(l=>l.owner&&l.owner!==this.player),i=Math.min(5,this.player.ownedCountries.length);let c=0;for(const l of s){const d=this.player.knowledge.find(h=>h.country===l);l.owner&&l.owner!==this.player?d&&this.game.gameTurn-d.gameTurn<=3&&c++:l.owner||d&&c++}let a=1;c<i&&(a=10);for(const{country:l,distance:d}of t){const h=this.player.knowledge.find(C=>C.country===l);if(!l.owner&&h||l.owner&&l.owner!==this.player&&h&&this.game.gameTurn-h.gameTurn<=3)continue;let u=3e3-Math.sqrt(d);if(u*=a,u>0){const C=l.fortified?P.spyFortifiedCost:P.spyCost;if(this.player.money>=C){const f=u*(this.player.totalIncome()/5e6);n.push(new R([l],0,e,f))}}}return n}FindAttackOpportunities(){const e=new L,t=this.game.worldMap.getCountries(),o=[];for(const r of t){if(r.owner===this.player)continue;const[s,i]=this.countryBestAttackerScore(r);if(!s)continue;const c=Math.floor(s.armies*D.ATTACK_COMMIT/1e3)*1e3;c<1e3||o.push(new R([s,r],c,e,i*this.player.aggressivity))}return o}async takeAction(){if(this.player.actionsLeft<=0)return!1;if(this.player.actionsLeft>=4&&Math.random()<.2&&this.actionPlan.length===0)return this.PlanSurpriseAttack(),!0;let e=null;if(this.actionPlan.length>0){e=this.actionPlan.shift();const o=e.action,r=e.countries,s=e.amount;if(o instanceof Z){const i=r[0];if(!i||i.armies<s+1e3)return console.warn("Skipping invalid move from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof L){const i=r[0],c=r[1];if(!i||!c||c.owner===this.player||i.armies<s)return console.warn("Skipping invalid attack from actionPlan:",e),this.actionPlan=[],!1}else if(o instanceof ee&&this.player.money<s*P.armyCost)return console.warn("Skipping invalid buy from actionPlan:",e),this.actionPlan=[],!1}else e=this.findBestOpportunity();if(!e)return!1;const n=await e.action.Act(e.countries,this.player,this.game,e.amount),t=e.countries.slice(-e.action.countryCountNeeded);return this.player.actionLog.push({actionType:e.action.Type(),countries:t,amount:e.amount,result:n??null}),e.followUp&&this.actionPlan.length===0&&this.actionPlan.push(e.followUp),this.player.useAction(),!0}countryDefenseEstimate(e){let n;const t=this.player.knowledge.find(r=>r.country===e),o=e.owner&&e.owner!==this.player;return o&&(!t||this.game.gameTurn-t.gameTurn>3)?n=1e5:!o&&!t?n=7e4:t?n=t.army:n=7e4,e.fortified&&(n*=2),n}countryScore(e){let n;const t=this.player.knowledge.find(r=>r.country===e);t&&typeof t.income=="number"?n=t.income:n=1e6;const o=this.countryDefenseEstimate(e);return n/o}countryBestAttackerScore(e){const n=this.countryDefenseEstimate(e);let t=0,o=null;for(const r of this.player.ownedCountries){const s=this.game.worldMap.distance(r,e);if(s===null)continue;const i=Math.round((r.armies||0)*D.ATTACK_COMMIT/1e3)*1e3;if(i<1e3)continue;const c=L.AttackChance(i,n,s,!1,this.game);let a=0;c>=.7&&(a=c*c*this.countryScore(e)*1e3),a>t&&(t=a,o=r)}return[o,t]}FindMoveOpportunities(e){const n=[];if(this.player.ownedCountries.length===0)return n;const t=this.player.ownedCountries.reduce((a,l)=>l.armies>a.armies?l:a,this.player.ownedCountries[0]);let o=null,r=-1/0,s=null;for(const a of this.player.ownedCountries){const l=this.getReachableNonOwnedCountries(a);for(const{country:d,distance:h}of l){let u=1;h>100&&(u=Math.max(0,1-(h-100)/900));const C=this.countryScore(d)*u;C>r&&(r=C,o=a,s=d)}}if(o&&o!==t){const a=Math.floor(t.armies*.5/1e3)*1e3;if(a>0&&t!==o){let l=null;if(this.actionPlan.length===0&&s){const d=o.armies+a,h=Object.create(o);if(h.armies=d,this.isAttackFeasible(h,s,D.ATTACK_COMMIT)){const u=new L,C=Math.floor(d*D.ATTACK_COMMIT/1e3)*1e3;l=new R([o,s],C,u,100)}}n.push(new R([t,o],a,e,r,l))}}const i=this.player.totalArmies()/this.player.ownedCountries.length,c=this.player.ownedCountries.reduce((a,l)=>l.armies<a.armies?l:a,this.player.ownedCountries[0]);if(c.armies<i/2&&c!==t){const a=i/2,l=Math.floor((a-c.armies)/1e3)*1e3,d=Math.max(0,Math.min(l,t.armies-1e3));d>0&&t!==c&&n.push(new R([t,c],d,e,i-c.armies))}return n}FindFortifyOpportunities(e){const n=[],t=this.player.ownedCountries.filter(o=>!o.fortified).length;for(const o of this.player.ownedCountries)if(o.canBeFortified()&&this.player.money>=P.fortifyCost){let r=o.income/100;r*=t,n.push(new R([o],0,e,r))}return n}FindBuyOpportunities(){if(this.player.money<=2e6)return[];const n=[],t=new ee,o=this.player.money,r=P.armyCost,s=Math.max(0,o-2e6);if(this.player.ownedCountries.length===0||s<r)return n;const i=Math.floor(this.player.totalArmies()/this.player.ownedCountries.length),c=this.player.ownedCountries.reduce((h,u)=>u.armies<h.armies?u:h,this.player.ownedCountries[0]);if(c.armies<i){const h=i-c.armies,u=Math.floor(s/r),C=Math.min(h,u,1e5),f=Math.floor(C/1e3)*1e3;if(f>0){const g=(i-c.armies)/1e3;n.push(new R([c],f,t,g))}}let a=null,l=-1/0,d=null;for(const h of this.player.ownedCountries){const u=this.getReachableNonOwnedCountries(h);for(const{country:C,distance:f}of u){let g=1;f>100&&(g=Math.max(0,1-(f-100)/900));const y=this.countryScore(C)*g;y>l&&(l=y,a=h,d=C)}}if(a||(a=this.player.homeCountry),a){const h=Math.floor((s-2e6)/r),u=Math.floor(h/1e3)*1e3;if(u>0){let C=null;if(this.actionPlan.length===0&&d){const f=a.armies+u,g=Object.create(a);if(g.armies=f,this.isAttackFeasible(g,d,D.ATTACK_COMMIT)){const y=new L,p=Math.floor(f*D.ATTACK_COMMIT/1e3)*1e3;C=new R([a,d],p,y,100)}}n.push(new R([a],u,t,l*1e3,C))}}if(s>0&&this.player.ownedCountries.length>0){const h=this.findMostThreatenedOwnedCountry();if(!h)throw new Error("findMostThreatenedOwnedCountry() returned null, which should not happen if there are owned countries.");const u=Math.floor(s/r),C=Math.floor(u/1e3)*1e3;if(C>0){const f=s/1e3;n.push(new R([h],C,t,f))}}return n}findBestOpportunity(){const e=new Z,n=new ye,t=[];if(t.push(...this.FindSpyOpportunities()),t.push(...this.FindAttackOpportunities()),t.push(...this.FindMoveOpportunities(e)),t.push(...this.FindFortifyOpportunities(n)),t.push(...this.FindBuyOpportunities()),t.length===0)return null;const o=.5,r=Math.max(...t.map(d=>d.score)),s=t.map(d=>Math.exp((d.score-r)/o)),i=s.reduce((d,h)=>d+h,0),c=s.map(d=>d/i),a=Math.random();let l=0;for(let d=0;d<t.length;++d)if(l+=c[d],a<l)return t[d];throw new Error("Softmax selection failed to pick an opportunity.")}getNonOwnedCountriesSortedByDistance(){const e=this.game.worldMap,n=e.getCountries(),t=[];for(const o of n){if(o.owner===this.player)continue;let r=1e4;for(const s of this.player.ownedCountries){const i=e.distance(s,o);i!==null&&(r=Math.min(r,i))}t.push({country:o,distance:r})}return t.sort((o,r)=>o.distance-r.distance),t}getReachableNonOwnedCountries(e){const n=this.game.worldMap,t=n.getCountries(),o=[];for(const r of t){if(r.owner===this.player)continue;const s=n.distance(e,r);s!==null&&o.push({country:r,distance:s})}return o.sort((r,s)=>r.distance-s.distance),o}MakeAttackPlan(e){if(this.actionPlan.length>0)return;const n=L,t=Z,o=ee,r=this.player.ownedCountries;if(r.length===0||e.owner===this.player)return;let s=1/0,i=null;for(const x of r){const A=this.game.worldMap.distance(x,e);A!==null&&A<s&&(s=A,i=x)}if(!i)return;const c=new Map;for(const x of r)c.set(x,x.armies);let a=this.player.money;const l=[],d=new o,h=P.armyCost,u=Math.floor(a/h);if(u>0){const x=Math.floor(u/1e3)*1e3;x>0&&(l.push(new R([i],x,d,1)),c.set(i,c.get(i)+x),a-=x*h)}const C=new t;let f=0,g=c.get(i);const y=r.filter(x=>x!==i).sort((x,A)=>A.armies-x.armies);for(const x of y){if(f>=2)break;const A=this.game.worldMap.distance(x,i),k=c.get(x);if(A!==null&&k>1e3){const I=Math.floor((k-1e3)/1e3)*1e3;I>0&&(l.push(new R([x,i],I,C,1)),c.set(x,k-I),g+=I,c.set(i,g),f++)}}const p=this.countryDefenseEstimate(e),m=this.game.worldMap.distance(i,e)||1,w=Math.floor(g*D.ATTACK_COMMIT/1e3)*1e3,b=n.AttackChance(w,p,m,e.fortified,this.game);if(b>.7&&w>=1e3){const x=new n;l.push(new R([i,e],w,x,b*100)),c.set(i,1e3),this.actionPlan.push(...l)}}PlanSurpriseAttack(){if(this.actionPlan.length>0)return;const e=this.game.worldMap.getCountries();let n=1/0,t=null;for(const s of e)if(!s.owner){const i=this.countryDefenseEstimate(s);i<n&&(n=i,t=s)}if(t){this.MakeAttackPlan(t);return}let o=1/0,r=null;for(const s of e)if(s.owner&&s.owner!==this.player){const i=this.countryDefenseEstimate(s);i<o&&(o=i,r=s)}r&&this.MakeAttackPlan(r)}isAttackFeasible(e,n,t=.8){if(!e||!n||e.owner!==this.player||n.owner===this.player||e===n)return!1;const o=e.neighbors.includes(n),r=e.oceanBorder.length>0&&n.oceanBorder.length>0;if(!o&&!r||typeof e.armies!="number"||e.armies<=1e3)return!1;const s=this.countryDefenseEstimate(n),i=this.game.worldMap.distance(e,n);if(i===null)return!1;const c=Math.floor(e.armies*t);return!(L.AttackChance(c,s,i,n.fortified,this.game)<.7)}findMostThreatenedOwnedCountry(){if(!this.player.ownedCountries||this.player.ownedCountries.length===0)throw new Error("AI has no owned countries to evaluate for threat.");const e=this.game.worldMap,n=e.getCountries();let t=null,o=-1/0;for(const r of this.player.ownedCountries){let s=0;for(const i of n){if(!i.owner||i.owner===this.player)continue;const c=e.distance(r,i);c===null||c===0||(s+=1/c)}s>o&&(o=s,t=r)}if(!t)throw new Error("No threatened country found. This should not happen if there are enemy countries.");return t}};v(D,"ATTACK_COMMIT",.8);let ne=D;const B=class B{constructor(e,n=[]){v(this,"worldMap");v(this,"players");v(this,"gameTurn");v(this,"activePlayerIndex");v(this,"gui");this.worldMap=e,this.players=n,this.gameTurn=1,this.activePlayerIndex=0,this.players.length>0&&this.activePlayer.startTurn()}get activePlayer(){return this.players[this.activePlayerIndex]}nextTurn(){this.activePlayer.money+=this.activePlayer.totalIncome(),this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayerIndex===0&&this.gameTurn++;const e=this.activePlayer;e.plannedFortifications=e.plannedFortifications.filter(([n,t])=>t===this.gameTurn?(n.fortified=!0,!1):!0),this.activePlayer.startTurn()}static initNewGame(e,n,t){for(const d of n)d.money=B.initialPlayerMoney,d.homeCountry=null,d.ownedCountries=[],d.isAI&&(d.AI=new ne(d,null));const o=e.getCountries();for(const d of o)d.income=Math.floor((5e5+Math.random()*2e6)/1e3)*1e3,d.owner=null;let r=-1,s=[];const i=n.length,c=10;function a(d,h){if(!d.center||!h.center)return 0;const[u,C]=d.center(),[f,g]=h.center();return Math.sqrt((u-f)**2+(C-g)**2)}for(let d=0;d<c;++d){const h=[...o];for(let f=h.length-1;f>0;f--){const g=Math.floor(Math.random()*(f+1));[h[f],h[g]]=[h[g],h[f]]}const u=h.slice(0,i);let C=1/0;for(let f=0;f<u.length;++f)for(let g=f+1;g<u.length;++g)C=Math.min(C,a(u[f],u[g]));C>r&&(r=C,s=u)}for(let d=0;d<n.length;++d){const h=s[d];n[d].homeCountry=h,h.owner=n[d],n[d].ownedCountries.push(h),h.income=B.homeCountryIncome,h.fortified=!0}for(const d of e.getCountries())if(d.owner)d.armies=1e5;else{const h=Math.round((Math.random()*Math.random()*99e3+1e3)/1e3)*1e3;d.armies=h}const l=new B(e,n);t&&(l.gui=t);for(const d of n)d.game=l,d.isAI&&d.AI&&(d.AI.game=l,d.AI.player=d);return l}toJSON(){var e;return{gameTurn:this.gameTurn,activePlayerName:((e=this.players[this.activePlayerIndex])==null?void 0:e.name)??null,playerNames:this.players.map(n=>n.name)}}static fromJSON(e,n,t){const o=new B(t,n);o.gameTurn=e.gameTurn,o.activePlayerIndex=n.findIndex(r=>r.name===e.activePlayerName),o.activePlayerIndex===-1&&(o.activePlayerIndex=0);for(const r of n)r.game=o,r.isAI&&r.AI&&(r.AI.game=o,r.AI.player=r);return o}};v(B,"armyCost",100),v(B,"spyCost",2e5),v(B,"spyFortifiedCost",1e6),v(B,"initialPlayerMoney",1e7),v(B,"homeCountryIncome",4e6),v(B,"fortifyCost",1e5),v(B,"showArmies",!1),v(B,"INCOME_SHARE_WIN",.8);let P=B;const Ge=Object.freeze(Object.defineProperty({__proto__:null,Game:P},Symbol.toStringTag,{value:"Module"}));class pe extends Y{GetButtonText(e,n){if(e.length===0)return null;const t=e[e.length-1];return t.owner==n?null:`Spy on ${t.name}`}async Act(e,n,t,o=0){if(e.length===0)return"Please select a country to spy on.";const r=e[e.length-1],s=r.fortified?P.spyFortifiedCost:P.spyCost;if(n.money<s)return`Not enough money to spy. You need $${s}.`;const i=n.knowledge.find(l=>l.country===r);if(!t)return"Internal error: currentGame is required.";const c=t.gameTurn;if(i&&i.gameTurn===c)return"You already have recent information about this country.";n.money-=s;const a={country:r,gameTurn:c,army:r.armies,income:r.income};return i?(i.gameTurn=a.gameTurn,i.army=a.army,i.income=a.income):n.knowledge.push(a),null}RequiresAmount(e,n,t){return null}get countryCountNeeded(){return 1}Type(){return"Spy"}}function $e(M,e,n=M){return new Promise(t=>{const o=document.createElement("div");o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.5)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="10000";const r=document.createElement("div");r.style.background="#fff",r.style.padding="32px 40px",r.style.borderRadius="12px",r.style.boxShadow="0 2px 16px rgba(0,0,0,0.2)",r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.gap="18px";const s=document.createElement("div");s.textContent="Select amount to commit:",s.style.fontSize="1.2rem",s.style.marginBottom="8px",r.appendChild(s);const i=document.createElement("div");i.textContent=`Maximum: ${e.toLocaleString()}`,i.style.fontSize="1rem",i.style.color="#555",i.style.marginBottom="4px",r.appendChild(i);let c=Math.max(M,Math.min(e,e));const a=document.createElement("div");a.textContent=c.toLocaleString(),a.style.fontSize="2rem",a.style.fontWeight="bold",a.style.margin="8px 0",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";function d(g){c=Math.max(M,Math.min(e,g)),a.textContent=c.toLocaleString()}function h(g,y){const p=document.createElement("button");return p.textContent=g,p.style.padding="6px 14px",p.style.fontSize="1.1rem",p.style.border="none",p.style.borderRadius="6px",p.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",p.style.color="#fff",p.style.cursor="pointer",p.onclick=y,p}l.appendChild(h("-100k",()=>d(c-1e5))),l.appendChild(h("-10k",()=>d(c-1e4))),l.appendChild(h("-1k",()=>d(c-1e3))),l.appendChild(h("Min",()=>d(M))),l.appendChild(h("Half",()=>d(Math.floor(e/2/1e3)*1e3))),l.appendChild(h("Max",()=>d(e))),l.appendChild(h("+1k",()=>d(c+1e3))),l.appendChild(h("+10k",()=>d(c+1e4))),l.appendChild(h("+100k",()=>d(c+1e5))),r.appendChild(l);const u=document.createElement("div");u.style.display="flex",u.style.gap="12px",u.style.marginTop="18px";const C=h("OK",()=>{document.body.removeChild(o),t(c)});C.style.background="linear-gradient(90deg,#43cea2 0%,#43e97b 100%)",C.style.fontWeight="bold";const f=h("Cancel",()=>{document.body.removeChild(o),t(null)});f.style.background="linear-gradient(90deg,#e57373 0%,#ffb74d 100%)",u.appendChild(C),u.appendChild(f),r.appendChild(u),o.appendChild(r),document.body.appendChild(o),C.focus()})}class Fe extends Y{GetButtonText(e,n){if(e.length<2)return null;const t=e[e.length-2],o=e[e.length-1];if(t.owner!==n||t===o||!(n.knowledge&&n.knowledge.some(c=>c.country===o)))return null;const s=t.neighbors.includes(o),i=t.oceanBorder.length>0&&o.oceanBorder.length>0;return!s&&!i||o.owner===n?null:`Calculate attack chance for ${o.name} from ${t.name}`}async Act(e,n,t,o=0){if(!t)return"Internal error: currentGame is required.";if(e.length<2)return"Select source and target countries to calculate attack.";const r=e[e.length-2],s=e[e.length-1];if(r.owner!==n)return"You must own the attacking country.";const i=r.neighbors.includes(s),c=r.oceanBorder.length>0&&s.oceanBorder.length>0;if(!i&&!c)return"Target country must be a neighbor or reachable by naval attack.";if(s.owner===n)return"Cannot attack your own country.";if(o<=0||o>=r.armies)return"Invalid number of armies committed.";const a=n.getCountryInfo(s,t.gameTurn),l=t.worldMap.distance(r,s);let h=`Attack chance: ${(L.AttackChance(r.armies,a.army||0,l||0,s.fortified,t)*100).toFixed(2)}%`;return a.recency&&a.recency>0&&(h+=`
Warning: Information about ${s.name} may be outdated (last spied ${a.recency} turn(s) ago).`),h}RequiresAmount(e,n,t){if(e.length<2)return null;const o=e[e.length-2];return!o||typeof o.armies!="number"||o.armies<=1?null:[1e3,o.armies-1e3]}Type(){return"CalculateAttack"}get countryCountNeeded(){return 2}}function ge(M,e,n){let t=document.getElementById("gamegui-win-modal");if(t)return;t=document.createElement("div"),t.id="gamegui-win-modal",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.85)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="99999";const o=document.createElement("canvas");o.width=window.innerWidth,o.height=window.innerHeight,o.style.position="fixed",o.style.left="0",o.style.top="0",o.style.width="100vw",o.style.height="100vh",o.style.zIndex="0",o.style.pointerEvents="none",t.appendChild(o);function r(){o.width=window.innerWidth,o.height=window.innerHeight}window.addEventListener("resize",r);const s=document.createElement("div");s.style.width="50vw",s.style.height="50vh",s.style.background='url("Won.png") center/cover no-repeat',s.style.padding="48px 64px",s.style.borderRadius="24px",s.style.boxShadow="0 4px 32px rgba(0,0,0,0.25)",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.gap="32px",s.style.position="relative",s.style.zIndex="1";const i=document.createElement("div");i.innerHTML=`<div style="font-size:2.5rem;font-weight:bold;color:#222;text-shadow:0 2px 8px #fff,0 0 8px #000">🎉 ${M} WINS! 🎉</div><div style="font-size:1.3rem;color:#333;margin-top:18px;text-shadow:0 2px 8px #fff,0 0 8px #000">has reached ${e.toFixed(0)}% of world income!</div>`,s.appendChild(i);const c=document.createElement("button");c.textContent="OK",c.style.marginTop="24px",c.style.padding="12px 36px",c.style.fontSize="1.3rem",c.style.border="none",c.style.borderRadius="8px",c.style.background="linear-gradient(90deg,#43cea2 0%,#ffd700 100%)",c.style.color="#222",c.style.fontWeight="bold",c.style.cursor="pointer",c.style.textShadow="0 2px 8px #fff,0 0 8px #000",c.onclick=()=>{C=!1,window.removeEventListener("resize",r),t&&t.parentNode&&t.parentNode.removeChild(t),n&&n()},s.appendChild(c),t.appendChild(s),document.body.appendChild(t);const a=o.getContext("2d"),l=[];let d=o.height;function h(){const g=Math.random()*o.width*.8+o.width*.1,y=o.height*.02+Math.random()*o.height*.04,p=(Math.random()-.5)*2,m=(-8-Math.random()*4)*2,w=`hsl(${Math.random()*360},90%,60%)`;l.push({x:g,y:o.height,vx:p,vy:m,color:w,exploded:!1,particles:[],age:0,targetY:y})}function u(g){for(let y=0;y<48;y++){const p=y/48*2*Math.PI,m=2+Math.random()*2.5;g.particles.push({x:g.x,y:g.y,vx:Math.cos(p)*m,vy:Math.sin(p)*m,color:g.color,alpha:1,age:0})}}let C=!0;function f(){if(!(!C||!a)){a.clearRect(0,0,o.width,o.height),Math.random()<.06&&l.length<7&&h();for(const g of l)if(!g.exploded)g.x+=g.vx,g.y+=g.vy,g.vy+=.13,g.age++,g.y<d&&(d=g.y),a.save(),a.beginPath(),a.arc(g.x,g.y,4,0,2*Math.PI),a.fillStyle=g.color,a.globalAlpha=.9,a.shadowColor=g.color,a.shadowBlur=16,a.fill(),a.restore(),g.y<=g.targetY&&(g.exploded=!0,u(g));else{for(const y of g.particles)y.x+=y.vx,y.y+=y.vy,y.vy+=.04,y.alpha-=.012+Math.random()*.01,y.age++,a.save(),a.beginPath(),a.arc(y.x,y.y,2.2,0,2*Math.PI),a.fillStyle=y.color,a.globalAlpha=Math.max(0,y.alpha),a.shadowColor=y.color,a.shadowBlur=8,a.fill(),a.restore();g.particles=g.particles.filter(y=>y.alpha>.05&&y.age<90)}for(let g=l.length-1;g>=0;g--)l[g].exploded&&l[g].particles.length===0&&l.splice(g,1);requestAnimationFrame(f)}}f()}const Le=Object.freeze(Object.defineProperty({__proto__:null,showWinDialog:ge},Symbol.toStringTag,{value:"Module"}));class De{constructor(e,n,t,o){v(this,"overlay");v(this,"ctx");v(this,"width");v(this,"height");v(this,"fish",[]);v(this,"running",!1);v(this,"lastSpawn",0);v(this,"nextSpawn",0);v(this,"getOceanPredicate");v(this,"animationFrameId",null);v(this,"timeoutId",null);v(this,"loop",e=>{this.ctx.clearRect(0,0,this.width,this.height),this.fish=this.fish.filter(n=>!n.done);for(const n of this.fish)n.update(e),n.draw(this.ctx);e>this.nextSpawn&&(this.spawnFish(),this.scheduleNextSpawn()),this.fish.length>0||this.nextSpawn-e<2e3?this.animationFrameId=requestAnimationFrame(this.loop):(this.running=!1,this.timeoutId=setTimeout(()=>this.start(),this.nextSpawn-e))});this.width=n,this.height=t,this.getOceanPredicate=o,this.overlay=document.createElement("canvas"),this.overlay.width=n,this.overlay.height=t,this.overlay.style.position="absolute",this.overlay.style.left="0",this.overlay.style.top="0",this.overlay.style.pointerEvents="none",this.overlay.style.width="100%",this.overlay.style.height="100%",this.overlay.style.zIndex="20",e.appendChild(this.overlay);const r=this.overlay.getContext("2d");if(!r)throw new Error("Could not get canvas context for FishOverlay");this.ctx=r,this.scheduleNextSpawn(),this.start()}scheduleNextSpawn(){this.nextSpawn=performance.now()+5e3+Math.random()*1e4}spawnFish(){for(let e=0;e<10;e++){const n=Math.floor(Math.random()*this.width),t=Math.floor(this.height*(.4+.5*Math.random())),o=Math.random()<.5?1:-1,r=32+Math.random()*24,s=n+o*r;if(this.getOceanPredicate(n,t)&&this.getOceanPredicate(Math.round(s),t)){const i="#444";this.fish.push(new _e(n,t,o,i));break}}}start(){this.running||(this.running=!0,this.animationFrameId=requestAnimationFrame(this.loop))}stop(){this.running=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}resume(){this.running||this.start()}}class _e{constructor(e,n,t,o){v(this,"x0");v(this,"y0");v(this,"x1");v(this,"y1");v(this,"dir");v(this,"color","#444");v(this,"t0");v(this,"duration");v(this,"done",!1);v(this,"splash",!1);v(this,"splashStart",0);v(this,"splashDuration",1200);this.x0=e,this.y0=n;const r=32+Math.random()*24;this.x1=e+t*r,this.y1=n,this.dir=t,this.t0=performance.now(),this.duration=(1200+Math.random()*400)/2}update(e){const n=(e-this.t0)/this.duration;if(!this.splash&&n>.95&&(this.splash=!0,this.splashStart=e),n>1&&this.splash){e-this.splashStart>this.splashDuration&&(this.done=!0);return}if(n>1){this.done=!0;return}}draw(e){const n=performance.now(),t=Math.min(1,(n-this.t0)/this.duration),o=18,r=this.x0+(this.x1-this.x0)*t,s=this.y0-(1-4*Math.pow(t-.5,2))*o,i=1+.18*Math.sin(Math.PI*t),c=.5*Math.sin(Math.PI*t);if(t<=.95){e.save(),e.translate(r,s);const a=1/3,l=e.createRadialGradient(0,0,.3,0,0,7*i*a);l.addColorStop(0,"#222"),l.addColorStop(.7,"#666"),l.addColorStop(1,"#bbb"),e.fillStyle=l,e.beginPath(),e.ellipse(0,0,7*i*a,3*a,0,0,2*Math.PI),e.fill(),e.save(),e.beginPath(),e.moveTo(-7*i*a,0),e.lineTo(-11*i*a,-4*a),e.lineTo(-11*i*a,4*a),e.closePath(),e.fillStyle="#222",e.globalAlpha=.8,e.fill(),e.restore(),e.save(),e.beginPath(),e.ellipse(-2*i*a,2.2*a,2*a,.7*a,Math.PI/4+c,0,2*Math.PI),e.ellipse(-2*i*a,-2.2*a,2*a,.7*a,-Math.PI/4-c,0,2*Math.PI),e.fillStyle="#888",e.globalAlpha=.7,e.fill(),e.restore(),e.restore()}if(this.splash){const a=Math.min(1,(n-this.splashStart)/this.splashDuration);for(let l=0;l<3;l++){const d=10+12*a+l*6;e.save(),e.beginPath(),e.arc(this.x1,this.y1,d,0,2*Math.PI),e.strokeStyle=`rgba(10,10,10,${.7*(1-a)})`,e.lineWidth=2.5-l*.5,e.globalAlpha=1*(1-a),e.stroke(),e.restore()}}}}function ze(M){var d;let e=document.getElementById("action-log-dialog");e&&e.remove();const n=document.createElement("div");n.id="action-log-dialog",n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.6)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="99999",(d=j.getInstance())==null||d.pauseGame();const t=document.createElement("div");t.style.background="#fff",t.style.width="100vw",t.style.height="100vh",t.style.padding="0",t.style.borderRadius="0",t.style.boxShadow="none",t.style.maxWidth="100vw",t.style.maxHeight="100vh",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="stretch",t.style.gap="0",t.style.overflow="hidden";const o=document.createElement("button");o.textContent="Close",o.style.alignSelf="flex-end",o.style.margin="16px 24px 0 0",o.style.padding="10px 32px",o.style.fontSize="1.2rem",o.style.border="none",o.style.borderRadius="8px",o.style.background="linear-gradient(90deg,#ff9966 0%,#ff5e62 100%)",o.style.color="#fff",o.style.cursor="pointer",o.onclick=()=>{var u,C;(u=j.getInstance())==null||u.resumeGame(),n.remove();const h=j.getInstance();h&&h.currentGame&&!h.canceled&&((C=h.currentGame.activePlayer)!=null&&C.isAI)&&setTimeout(()=>h.turnStarted(),0)},t.appendChild(o);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.gap="16px",r.style.padding="24px 32px 8px 32px",r.style.background="#f5f5f5";const s=document.createElement("select");s.style.fontSize="1.1rem",s.style.padding="6px 12px";for(const h of M.players){const u=document.createElement("option");u.value=h.name,u.textContent=h.name+(h.isAI?" (AI)":""),s.appendChild(u)}r.appendChild(s);const i=document.createElement("input");i.type="text",i.placeholder="Filter (wildcard, all fields)",i.style.fontSize="1.1rem",i.style.padding="6px 12px",i.style.borderRadius="6px",i.style.border="1px solid #aaa",r.appendChild(i),t.appendChild(r);const c=document.createElement("div");c.style.overflow="auto",c.style.flex="1",c.style.padding="0 32px 32px 32px",c.style.background="#fff",t.appendChild(c);function a(h,u){c.innerHTML="";const C=document.createElement("table");C.style.width="100%",C.style.borderCollapse="collapse",C.style.fontSize="1.05rem";const f=document.createElement("thead"),g=document.createElement("tr");for(const m of["#","Action","Countries","Amount","Result"]){const w=document.createElement("th");w.textContent=m,w.style.borderBottom="2px solid #888",w.style.padding="8px 12px",w.style.background="#eee",g.appendChild(w)}f.appendChild(g),C.appendChild(f);const y=document.createElement("tbody");let p=h.actionLog;if(u.trim()){const m=u.trim().toLowerCase();p=p.filter(w=>w.actionType.toLowerCase().includes(m)||w.countries.map(b=>b.name).join(",").toLowerCase().includes(m)||(""+w.amount).includes(m)||(w.result?w.result.toLowerCase():"").includes(m))}p.forEach((m,w)=>{const b=document.createElement("tr");b.style.borderBottom="1px solid #ddd";const x=document.createElement("td");x.textContent=(w+1).toString(),x.style.padding="6px 12px",b.appendChild(x);const A=document.createElement("td");A.textContent=m.actionType,A.style.padding="6px 12px",b.appendChild(A);const k=document.createElement("td");k.textContent=m.countries.map(E=>E.name).join(", "),k.style.padding="6px 12px",b.appendChild(k);const I=document.createElement("td");I.textContent=m.amount.toString(),I.style.padding="6px 12px",b.appendChild(I);const S=document.createElement("td");S.textContent=m.result??"",S.style.padding="6px 12px",b.appendChild(S),y.appendChild(b)}),C.appendChild(y),c.appendChild(C)}let l=M.players[0];a(l,""),s.onchange=()=>{l=M.players.find(h=>h.name===s.value)||M.players[0],a(l,i.value)},i.oninput=()=>{a(l,i.value)},n.appendChild(t),document.body.appendChild(n)}const F=class F{constructor(e,n,t=[],o=null,r=[],s=0,i=!1){v(this,"actionsLeft",F.ACTIONS_PER_TURN);v(this,"game");v(this,"actionLog",[]);v(this,"name");v(this,"color");v(this,"ownedCountries");v(this,"homeCountry");v(this,"isAI");v(this,"AI");v(this,"money");v(this,"knowledge");v(this,"plannedFortifications",[]);v(this,"aggressivity");this.name=e,this.color=n,this.ownedCountries=t,this.homeCountry=o,this.knowledge=r,this.money=s,this.isAI=i,this.actionsLeft=F.ACTIONS_PER_TURN,this.aggressivity=Math.floor(Math.random()*8)+2}resetActions(){this.actionsLeft=F.ACTIONS_PER_TURN}useAction(){this.actionsLeft>0&&this.actionsLeft--}get RGBColor(){return F.COLOR_RGBS[this.color]||"0,0,0"}getKnownCountries(){const e=new Set;this.knowledge.forEach(t=>e.add(t.country));const n=Array.from(e).filter(t=>!this.ownedCountries.includes(t));return{owned:[...this.ownedCountries],known:n}}getCountryInfo(e,n){if(e.owner===this)return{name:e.name,owner:e.owner,income:e.income,army:e.armies,recency:0};{const t=this.knowledge.find(o=>o.country===e);return{name:e.name,owner:e.owner,income:t?t.income:void 0,army:t?t.army:void 0,recency:t?n-t.gameTurn:void 0}}}totalIncome(){return this.ownedCountries.reduce((e,n)=>e+(n.income??0),0)}totalArmies(){return this.ownedCountries.reduce((e,n)=>e+(n.armies??0),0)}startTurn(){this.resetActions()}get IncomeShare(){if(!this.game||!this.game.players||this.game.players.length===0)return 0;const e=this.game.players.reduce((n,t)=>{var o;return n+(((o=t.totalIncome)==null?void 0:o.call(t))??0)},0);return e===0?0:this.totalIncome()/e}armyKnown(e){if(e.owner===this)return!0;const n=this.knowledge.find(t=>t.country===e);return!!(!e.owner&&n||e.owner&&e.owner!==this&&n&&this.game&&n.gameTurn===this.game.gameTurn)}toJSON(){return{id:this.name,name:this.name,color:this.color,ownedCountryIds:this.ownedCountries.map(e=>e.name),homeCountryId:this.homeCountry?this.homeCountry.name:null,isAI:this.isAI,money:this.money,knowledge:this.knowledge.map(e=>({countryId:e.country.name,gameTurn:e.gameTurn,army:e.army,income:e.income})),plannedFortifications:this.plannedFortifications.map(([e,n])=>[e.name,n]),aggressivity:this.aggressivity,actionsLeft:this.actionsLeft}}static fromJSON(e,n){const t=new F(e.name,e.color,[],null,[],e.money,e.isAI);return t.aggressivity=e.aggressivity,t.actionsLeft=e.actionsLeft??F.ACTIONS_PER_TURN,t._ownedCountryIds=e.ownedCountryIds,t._homeCountryId=e.homeCountryId,t._knowledgeRaw=e.knowledge,t._plannedFortificationsRaw=e.plannedFortifications,t}resolveReferences(e){this.ownedCountries=(this._ownedCountryIds||[]).map(n=>e[n]).filter(Boolean),this.homeCountry=this._homeCountryId?e[this._homeCountryId]:null,this.knowledge=(this._knowledgeRaw||[]).map(n=>({country:e[n.countryId],gameTurn:n.gameTurn,army:n.army,income:n.income})),this.plannedFortifications=(this._plannedFortificationsRaw||[]).map(([n,t])=>[e[n],t]),delete this._ownedCountryIds,delete this._homeCountryId,delete this._knowledgeRaw,delete this._plannedFortificationsRaw}};v(F,"ACTIONS_PER_TURN",5),v(F,"COLOR_RGBS",{red:"255,0,0",blue:"0,0,255",green:"0,128,0",yellow:"255,255,0"}),v(F,"COLORS",["red","blue","green","yellow"]);let oe=F;const qe=Object.freeze(Object.defineProperty({__proto__:null,Player:oe},Symbol.toStringTag,{value:"Module"}));class ue{static serialize(e){const n=e.worldMap.getCountries(),t=e.players;return JSON.stringify({countries:n.map(o=>o.toJSON()),players:t.map(o=>o.toJSON()),game:e.toJSON()})}static deserialize(e){const n=JSON.parse(e),t={},o=n.countries.map(a=>re.fromJSON(a,{},t)),r={},s=n.players.map(a=>{const l=oe.fromJSON(a,t);return r[l.name]=l,l});o.forEach(a=>a.resolveReferences(r,t)),s.forEach(a=>a.resolveReferences(t));for(const a of s)a.isAI&&(a.AI||(a.AI=new ne(a,{})));const i=Oe(o),c=P.fromJSON(n.game,s,i);for(const a of s)a.isAI&&a.AI&&(a.AI.game=c,a.AI.player=a);return c}}const X=class X{constructor(){v(this,"state");v(this,"currentGame",null);v(this,"rootContainer",null);v(this,"canceled",!1);v(this,"paused",!1);v(this,"clickedCountryNames",[]);v(this,"worldMapCanvas",null);v(this,"mapDirty",!0);v(this,"actions");v(this,"fishOverlay",null);v(this,"_onResize",()=>{this.markMapDirty(),this.rootContainer&&this.renderMainGui(this.rootContainer,this.currentGame)});this.state="initialized",this.actions=[new pe,new ye,new L,new Fe,new Z,new ee],X._instance=this,window.addEventListener("keydown",e=>{e.key==="F9"&&this.currentGame&&ze(this.currentGame),e.key==="F8"&&Q(()=>Promise.resolve().then(()=>Le),void 0).then(n=>{var o,r;const t=((r=(o=this.currentGame)==null?void 0:o.activePlayer)==null?void 0:r.name)||"Player";n.showWinDialog(t,100)})})}pauseGame(){if(this.paused=!0,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.stop=="function"?(console.log("Pausing FishOverlay",this.fishOverlay),this.fishOverlay.stop()):console.log("No FishOverlay to pause")}resumeGame(){if(this.paused=!1,!this.fishOverlay){const e=document.querySelector('div[style*="flex: 3"]');e&&e._fishOverlay&&(this.fishOverlay=e._fishOverlay)}this.fishOverlay&&typeof this.fishOverlay.resume=="function"?(console.log("Resuming FishOverlay",this.fishOverlay),this.fishOverlay.resume()):console.log("No FishOverlay to resume")}isPaused(){return this.paused}static getInstance(){return X._instance}afterAction(){if(this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],t=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(t&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(t,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");r&&(r.innerHTML=`
            <div><b>Name:</b> ${o.name}</div>
            <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
            <div><b>Income:</b> ${o.income!==void 0?o.income:"?"}</div>
            <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
            <div><b>Recency:</b> ${o.recency!==void 0?o.recency:"?"}</div>
          `)}}if(this.markMapDirty(),this.rootContainer&&(this.renderMainGui(this.rootContainer,this.currentGame),this.clickedCountryNames.length>0&&this.currentGame&&this.currentGame.worldMap)){const e=this.clickedCountryNames[this.clickedCountryNames.length-1],t=this.currentGame.worldMap.getCountries().find(o=>o.name===e);if(t&&this.currentGame.activePlayer&&typeof this.currentGame.gameTurn=="number"){const o=this.currentGame.activePlayer.getCountryInfo(t,this.currentGame.gameTurn),r=document.getElementById("country-info-panel");r&&(r.innerHTML=`
              <div><b>Name:</b> ${o.name}</div>
              <div><b>Owner:</b> ${o.owner?o.owner.name:"None"}</div>
              <div><b>Income:</b> ${o.income!==void 0?o.income:"?"}</div>
              <div><b>Army:</b> ${o.army!==void 0?o.army:"?"}</div>
              <div><b>Recency:</b> ${o.recency!==void 0?o.recency:"?"}</div>
            `)}}this.updateActionButtons()}updateActionButtons(){if(this.paused)return;const e=document.getElementById("action-buttons-area");if(!e)return;const n=[];if(Array.from(e.children).forEach(s=>{s instanceof HTMLElement&&(s.classList.contains("persistent-action-btn")?(n.push(s),s.textContent&&s.textContent.trim()==="New Game"&&(s.disabled=!1)):e.removeChild(s))}),!this.currentGame||!this.currentGame.players||!this.currentGame.activePlayer)return;const t=this.currentGame.worldMap?this.currentGame.worldMap.getCountries():[],o=this.clickedCountryNames.map(s=>t.find(i=>i.name===s)).filter(Boolean);if(this.currentGame.activePlayer.actionsLeft<=0){const s=document.createElement("div");s.textContent="You are out of actions for this turn!",s.style.background="linear-gradient(90deg,#ff5e62 0%,#ff9966 100%)",s.style.color="#fff",s.style.fontSize="1.5rem",s.style.fontWeight="bold",s.style.padding="32px 0",s.style.borderRadius="12px",s.style.textAlign="center",s.style.margin="24px 0",e.appendChild(s);return}const r=[];for(const s of this.actions){const i=s.GetButtonText(o,this.currentGame.activePlayer);if(i){const c=document.createElement("button");c.textContent=i,c.style.padding="12px 0",c.style.fontSize="1.1rem",c.style.background="linear-gradient(90deg,#00c3ff 0%,#ffff1c 100%)",c.style.color="#222",c.style.border="none",c.style.borderRadius="8px",c.style.cursor="pointer",c.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",c.style.marginBottom="8px",c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",c.onclick=async()=>{const a=s.RequiresAmount(o,this.currentGame.activePlayer,this.currentGame);let l=null,d=0;if(a){const[u,C]=a,f=await $e(u,C,u);if(f===null)return;d=f,l=await s.Act(o,this.currentGame.activePlayer,this.currentGame,f)}else l=await s.Act(o,this.currentGame.activePlayer,this.currentGame);const h=o.slice(-s.countryCountNeeded);this.currentGame.activePlayer.actionLog.push({actionType:s.Type(),countries:h,amount:d,result:l??null}),this.currentGame.activePlayer.useAction(),typeof l=="string"&&l!==null?(this.afterAction(),this.showActionResult(l)):this.afterAction()},r.push(c)}}if(r.length&&n.length){const s=document.createElement("div");s.style.height="16px",s.style.width="100%",e.insertBefore(s,n[0]),r.forEach(i=>e.insertBefore(i,s))}else r.length&&r.forEach(s=>e.appendChild(s))}showActionResult(e){const n=document.getElementById("action-result-panel");n&&(n.innerHTML=`<span style="color:#fff">${e}</span>`)}clearActionResult(){const e=document.getElementById("action-result-panel");e&&(e.innerHTML='<span style="color:#888">No recent action.</span>')}markMapDirty(){this.mapDirty=!0}getWorldMapCanvas(){if(this.paused)throw new Error("Game is paused");if(!this.currentGame||!this.currentGame.worldMap)throw new Error("GameGui.getWorldMapCanvas: currentGame or worldMap is missing");if(this.mapDirty||!this.worldMapCanvas){let e=[];if(this.currentGame.activePlayer){const n=this.currentGame.activePlayer.getKnownCountries();e=n.owned.concat(n.known)}this.worldMapCanvas=K.render(this.currentGame.worldMap,[],e,P.showArmies,this.currentGame.activePlayer),this.mapDirty=!1}return this.worldMapCanvas}async mount(e){this.rootContainer=e,window.addEventListener("resize",this._onResize),this.renderMainGui(e,this.currentGame)}unmount(){window.removeEventListener("resize",this._onResize)}async turnStarted(){var t,o;if(this.paused)return;if(this.clearActionResult(),this.currentGame&&this.currentGame.activePlayer&&this.currentGame.activePlayer.IncomeShare>=P.INCOME_SHARE_WIN){ge(this.currentGame.activePlayer.name,P.INCOME_SHARE_WIN*100,()=>{this.canceled=!0}),this.canceled=!0;return}if(this.renderMainGui(this.rootContainer,this.currentGame),this.canceled||!((o=(t=this.currentGame)==null?void 0:t.activePlayer)!=null&&o.isAI))return;const e=this.currentGame.activePlayer.AI;if(!e)return;const n=async()=>{if(this.paused||this.canceled)return;const r=await e.takeAction();this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),r?setTimeout(()=>n(),100):(this.currentGame.nextTurn(),this.markMapDirty(),this.currentGame.activePlayer.isAI?setTimeout(()=>this.turnStarted(),100):this.turnStarted())};n()}async startNewGame(){this.canceled=!0;const e=this.rootContainer,{showNewGameDialog:n}=await Q(async()=>{const{showNewGameDialog:t}=await import("./NewGameDialog-CDYDEQ37.js");return{showNewGameDialog:t}},[]);try{const t=await n(e),o=await Q(()=>Promise.resolve().then(()=>qe),void 0),r=await Q(()=>Promise.resolve().then(()=>Ge),void 0);r.Game.showArmies=t.showArmies;const s=["#4fc3f7","#81c784","#ffb74d","#e57373","#ba68c8","#ffd54f","#64b5f6","#a1887f"],i=o.Player.COLORS??s,c=t.players.map((a,l)=>new o.Player(a.name,i[l%i.length],[],null,[],0,a.isAI));this.currentGame=r.Game.initNewGame(t.map,c,this),this.markMapDirty(),this.getWorldMapCanvas(),this.renderMainGui(e,this.currentGame),this.currentGame&&this.currentGame.players.length>0&&(this.canceled=!1,this.currentGame.activePlayer.startTurn(),this.turnStarted())}catch(t){console.error("NewGameDialog error or cancellation:",t)}}renderMainGui(e,n){if(this.paused)return;const t=this.rootContainer;if(!t)throw new Error("rootContainer is not set (null) in renderMainGui");const o=t.querySelector('div[style*="flex: 3"]');if(o&&o._fishOverlay){const p=o._fishOverlay;typeof p.stop=="function"&&p.stop(),p.overlay&&p.overlay.parentNode&&p.overlay.parentNode.removeChild(p.overlay),o._fishOverlay=null}t.innerHTML="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="row",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100vw",r.style.height="100vh",r.style.background="linear-gradient(120deg, #232526 0%, #414345 100%)",r.style.borderRadius="0",r.style.boxShadow="none",r.style.overflow="hidden",r.style.margin="0",r.style.maxWidth="100vw";const s=document.createElement("div");s.style.flex="3",s.style.background="#222",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.position="relative",s.style.borderRight="2px solid #333";let i=null;n&&n.worldMap&&(i=this.getWorldMapCanvas()),this.clickedCountryNames||(this.clickedCountryNames=[]);const c=document.createElement("div");if(c.id="country-info-panel",c.style.background="#a67c52",c.style.border="1px solid #555",c.style.borderRadius="8px",c.style.padding="10px 12px",c.style.marginBottom="18px",c.style.color="#b3e5fc",c.style.fontSize="1.05rem",c.style.minHeight="100px",c.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",c.innerHTML='<span style="color:#888">Click a country to view details.</span>',i){let p=function(){w||(w=document.createElement("canvas"),w.width=i.width,w.height=i.height,w.style.position="absolute",w.style.left="0",w.style.top="0",w.style.pointerEvents="none",w.style.width="100%",w.style.height="100%",s.appendChild(w))},m=function(){if(w){const x=w.getContext("2d");x&&x.clearRect(0,0,w.width,w.height)}};i.style.width="100%",i.style.height="100%",i.style.display="block",s.appendChild(i);let w=null;if(!s._fishOverlay){const x=n.worldMap.getMap(),A=i.width,k=i.height,I=(S,E)=>S<0||E<0||E>=x.length||S>=x[0].length?!1:x[E][S]===$;s._fishOverlay=new De(s,A,k,I)}this.fishOverlay=s._fishOverlay,i._countryClickHandler&&i.removeEventListener("mousedown",i._countryClickHandler);const b=x=>{if(this.paused)return;const A=i.width,k=i.height,I=Math.floor(x.offsetX*(A/i.clientWidth)),S=Math.floor(x.offsetY*(k/i.clientHeight)),E=n.worldMap.getMap(),G=n.worldMap.getCountries();let N=null;if(I>=0&&S>=0&&S<E.length&&I<E[0].length){const z=E[S][I];if(z>=0&&G[z]){if(N=G[z],N.coordinates.some(([T,H])=>T===I&&H===S)||console.warn(`[GameGui] Click at (${I},${S}) is not in coordinates of country: ${N.name}`),this.clickedCountryNames.push(N.name),p(),m(),w&&N){const T=w.getContext("2d");if(T){K.drawCountryGlow(T,N,[0,0,0],N.color);const[H,J]=N.center?N.center():[0,0],ae=N.fortified?"🛡️ "+N.name:N.name;if(T.save(),T.font="bold 10px Verdana, Geneva, sans-serif",T.textAlign="center",T.textBaseline="middle",T.lineWidth=3,T.strokeStyle="black",T.strokeText(ae,H,J),T.fillStyle="white",T.fillText(ae,H,J),P.showArmies&&typeof N.armies=="number"){const le=`${Math.round(N.armies/1e3)}k`;T.font="bold 9px Verdana, Geneva, sans-serif",T.lineWidth=2,T.strokeStyle="black",T.strokeText(le,H,J+13),T.fillStyle="#FFD700",T.fillText(le,H,J+13)}T.restore()}}this.updateActionButtons();const W=document.getElementById("country-info-panel");if(W&&n&&n.activePlayer&&typeof n.gameTurn=="number"){const T=n.activePlayer.getCountryInfo(N,n.gameTurn);W.innerHTML=`
                <div><b>Name:</b> ${T.name}</div>
                <div><b>Owner:</b> ${T.owner?T.owner.name:"None"}</div>
                <div><b>Income:</b> ${T.income!==void 0?T.income:"?"}</div>
                <div><b>Army:</b> ${T.army!==void 0?T.army:"?"}</div>
                <div><b>Recency:</b> ${T.recency!==void 0?T.recency:"?"}</div>
              `}const ie=document.getElementById("last-clicked-country-info-panel");if(ie&&n&&n.activePlayer&&typeof n.gameTurn=="number"){const T=n.activePlayer.getCountryInfo(N,n.gameTurn);ie.innerHTML=`
                <b>Last Clicked Country Info</b><br>
                <div><b>Name:</b> ${T.name}</div>
                <div><b>Owner:</b> ${T.owner?T.owner.name:"None"}</div>
                <div><b>Income:</b> ${T.income!==void 0?T.income:"?"}</div>
                <div><b>Army:</b> ${T.army!==void 0?T.army:"?"}</div>
                <div><b>Recency:</b> ${T.recency!==void 0?T.recency:"?"}</div>
              `}}}};i.addEventListener("mousedown",b),i._countryClickHandler=b}else{const p=document.createElement("div");p.style.width="100%",p.style.height="100%",p.style.background="repeating-linear-gradient(135deg,#444 0 10px,#333 10px 20px)",p.style.border="4px solid #666",p.style.borderRadius="12px",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center";const m=document.createElement("img");m.src="riskStartup.png",m.alt="Risk Startup",m.style.width="100%",m.style.height="100%",m.style.objectFit="cover",m.style.borderRadius="8px",p.appendChild(m),s.appendChild(p)}const a=document.createElement("div"),l=document.createElement("button");l.textContent="New Game",l.classList.add("persistent-action-btn"),l.style.padding="12px 0",l.style.fontSize="1.1rem",l.style.background="linear-gradient(90deg,#00c3ff 0%,#ffff1c 100%)",l.style.color="#222",l.style.border="none",l.style.borderRadius="8px",l.style.cursor="pointer",l.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",l.style.marginBottom="24px",l.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",l.onclick=()=>{this.startNewGame()},a.appendChild(l);const d=document.createElement("button");d.textContent="Save Game",d.style.padding="12px 0",d.style.fontSize="1.1rem",d.style.background="linear-gradient(90deg,#43cea2 0%,#ffd700 100%)",d.style.color="#222",d.style.border="none",d.style.borderRadius="8px",d.style.cursor="pointer",d.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",d.style.marginBottom="12px",d.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",d.onclick=()=>{try{if(!this.currentGame)throw new Error("No game to save");const p=ue.serialize(this.currentGame),m=new Blob([p],{type:"application/json"}),w=URL.createObjectURL(m),b=document.createElement("a");b.href=w,b.download="armchair-general-save.json",document.body.appendChild(b),b.click(),setTimeout(()=>{document.body.removeChild(b),URL.revokeObjectURL(w)},100)}catch(p){throw alert("Save failed: "+(p&&p.message?p.message:p)),p}},a.appendChild(d);const h=document.createElement("button");h.textContent="Load Game",h.style.padding="12px 0",h.style.fontSize="1.1rem",h.style.background="linear-gradient(90deg,#ff5e62 0%,#00c3ff 100%)",h.style.color="#222",h.style.border="none",h.style.borderRadius="8px",h.style.cursor="pointer",h.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",h.style.marginBottom="24px",h.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",h.onclick=()=>{const p=document.createElement("input");p.type="file",p.accept=".json,application/json",p.onchange=m=>{const w=m.target.files[0];if(!w)return;const b=new FileReader;b.onload=()=>{try{const x=b.result,A=ue.deserialize(x);A.gui=this;for(const k of A.players)k.game=A,k.isAI&&k.AI&&(k.AI.game=A,k.AI.player=k);this.currentGame=A,this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted()}catch(x){throw alert("Load failed: "+(x&&x.message?x.message:x)),x}},b.readAsText(w)},p.click()},a.appendChild(h),a.appendChild(c),a.style.flex="1",a.style.background="#3b2412",a.style.display="flex",a.style.flexDirection="column",a.style.padding="32px 24px",a.style.color="#fff",a.style.minWidth="320px",a.style.fontFamily="'MedievalSharp', 'Times New Roman', serif";const u=document.createElement("div");u.style.marginBottom="32px";const C=document.createElement("div");if(C.style.fontSize="1.2rem",C.style.fontWeight="bold",n&&n.players&&n.players.length>0){const p=n.activePlayer;C.textContent=`Turn: ${n.gameTurn} | Player: ${p.name}`;const m=document.createElement("div"),w=p.constructor.ACTIONS_PER_TURN||5,b=p.actionsLeft;m.style.margin="8px 0 0 0",m.style.fontSize="2rem",m.style.letterSpacing="0.2rem";for(let x=0;x<w;x++){const A=document.createElement("span");A.textContent=x<b?"★":"☆",A.style.color=x<b?"#ffd700":"#888",m.appendChild(A)}m.title=`${b} of ${w} actions remaining`,u.appendChild(m)}else C.textContent="No game loaded. Start a new game to play!";if(u.appendChild(C),a.appendChild(u),n&&n.players&&n.players.length>0){const p=document.createElement("div");p.textContent="Players",p.style.fontWeight="bold",p.style.marginBottom="8px",a.appendChild(p);const m=document.createElement("ul");m.style.listStyle="none",m.style.padding="0",m.style.margin="0 0 24px 0";for(const w of n.players){const b=document.createElement("li");b.style.display="flex",b.style.alignItems="center",b.style.marginBottom="8px",w===n.activePlayer&&(b.style.boxShadow="0 0 16px 4px #ffd700, 0 0 4px 2px #fff",b.style.border="2px solid #ffd700",b.style.borderRadius="12px",b.style.background="rgba(255, 215, 0, 0.10)");const x=document.createElement("span");x.style.display="inline-block",x.style.width="16px",x.style.height="16px",x.style.borderRadius="50%",x.style.background=w.color,x.style.marginRight="8px",b.appendChild(x);const A=document.createElement("span");if(A.textContent=w.name+(w.isAI?" (AI)":""),A.style.flex="1",b.appendChild(A),typeof w.money=="number"){const k=document.createElement("span");k.textContent=`💰 ${w.money}`,k.style.marginLeft="8px",b.appendChild(k);const I=document.createElement("span");I.style.display="inline-block",I.style.width="54px",I.style.height="12px",I.style.marginLeft="8px",I.style.verticalAlign="middle",I.style.background="#222",I.style.border="1px solid #444",I.style.borderRadius="6px",I.style.overflow="hidden";const S=document.createElement("span"),E=Math.min(w.IncomeShare/P.INCOME_SHARE_WIN,1);S.style.display="inline-block",S.style.height="100%",S.style.width=`${Math.round(E*100)}%`,S.style.background=E>=1?"linear-gradient(90deg,#43cea2,#ffd700)":"linear-gradient(90deg,#43cea2,#185a9d)",S.style.transition="width 0.3s",I.title=`Income share: ${(w.IncomeShare*100).toFixed(1)}% (win at ${(P.INCOME_SHARE_WIN*100).toFixed(0)}%)`,I.appendChild(S),b.appendChild(I)}m.appendChild(b)}a.appendChild(m)}const f=document.createElement("div");f.id="action-result-panel",f.style.background="#a67c52",f.style.border="1px solid #555",f.style.borderRadius="8px",f.style.padding="10px 12px",f.style.marginBottom="18px",f.style.color="#fff",f.style.fontSize="1.05rem",f.style.minHeight="60px",f.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",f.innerHTML='<span style="color:#888">No recent action.</span>',a.appendChild(f);const g=document.createElement("div");g.id="action-buttons-area",g.style.display="flex",g.style.flexDirection="column",g.style.gap="12px",g.style.marginTop="auto";const y=document.createElement("button");y.textContent="End Turn",y.classList.add("persistent-action-btn"),y.style.padding="12px 0",y.style.fontSize="1.1rem",y.style.background="linear-gradient(90deg,#43cea2 0%,#185a9d 100%)",y.style.color="#fff",y.style.border="none",y.style.borderRadius="8px",y.style.cursor="pointer",y.style.boxShadow="0 2px 8px rgba(30,32,34,0.13)",y.style.fontFamily="'MedievalSharp', 'Times New Roman', serif",y.onclick=()=>{this.paused||this.currentGame&&(this.currentGame.nextTurn(),this.markMapDirty(),this.renderMainGui(this.rootContainer,this.currentGame),this.turnStarted())},g.appendChild(y),a.appendChild(g),r.appendChild(s),r.appendChild(a),t.appendChild(r)}};v(X,"_instance",null);let j=X;function We(M,e){const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.width="100%",n.style.height="100%",n.style.zIndex="10000",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="none",n.style.overflow="hidden";const t=document.createElement("div");t.innerText="Armchair",t.style.position="relative",t.style.color="#fffbe6",t.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',t.style.fontSize="6vw",t.style.fontWeight="bold",t.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",t.style.letterSpacing="0.18em",t.style.opacity="0",t.style.transform="translateX(-120%) skew(-12deg)",t.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",t.style.filter="drop-shadow(0 0 12px #fffbe6)",t.style.background="",t.style.webkitBackgroundClip="",t.style.backgroundClip="",t.style.webkitTextFillColor="";const o=document.createElement("div");o.innerText="General",o.style.position="relative",o.style.color="#fffbe6",o.style.fontFamily='"Cinzel Decorative", "Old English Text MT", "UnifrakturCook", "Times New Roman", serif',o.style.fontSize="6vw",o.style.fontWeight="bold",o.style.textShadow="0 0 60px #b22222, 0 0 16px #fffbe6, 0 0 8px #bfa76f, 0 0 2px #fff, 0 4px 24px #b22222, 0 0 32px #ffd700",o.style.letterSpacing="0.18em",o.style.opacity="0",o.style.transform="translateX(120%) skew(12deg)",o.style.transition="opacity 0.7s, transform 1.7s cubic-bezier(0.22,1,0.36,1)",o.style.filter="drop-shadow(0 0 12px #fffbe6)",o.style.background="",o.style.webkitBackgroundClip="",o.style.backgroundClip="",o.style.webkitTextFillColor="";const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="1vw",r.style.pointerEvents="none",r.appendChild(t),r.appendChild(o),n.appendChild(r),M.appendChild(n);const s=document.createElement("canvas");s.width=M.offsetWidth||800,s.height=M.offsetHeight||600,s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",n.appendChild(s);const i=s.getContext("2d"),c=10,a=[];s.width/2;const l=s.height*.8;for(let f=0;f<c;f++){const y=f%2===0?s.width*.05:s.width*.95,p=s.width*(.15+.7*Math.random()),m=l-s.height*.25+Math.random()*s.height*.1,w=l-s.height*.05+Math.random()*s.height*.18,b=1200+Math.random()*400,x=s.height*(.32+Math.random()*.12);a.push({startX:y,startY:m,endX:p,endY:w,duration:b,startTime:null,exploded:!1,explosionTime:null,arcHeight:x})}function d(f,g,y){i&&(i.save(),i.beginPath(),i.arc(f,g,18*y,0,2*Math.PI),i.fillStyle="rgba(40,40,40,0.95)",i.shadowColor="#222",i.shadowBlur=12*y,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(f-6*y,g-6*y,5*y,0,2*Math.PI),i.fillStyle="rgba(200,200,200,0.18)",i.fill(),i.restore())}function h(f,g,y){if(i){if(y<.15){const p=38+60*y;i.save(),i.beginPath(),i.arc(f,g,p,0,2*Math.PI),i.fillStyle=`rgba(255,255,220,${.7*(1-y/.15)})`,i.shadowColor="#fffbe6",i.shadowBlur=48,i.fill(),i.restore()}if(y<.6){const p=32+80*y;i.save(),i.beginPath(),i.arc(f,g,p,0,2*Math.PI),i.fillStyle=`rgba(255,120,40,${.5*(1-y/.6)})`,i.shadowColor="#ffae42",i.shadowBlur=32,i.fill(),i.restore(),i.save(),i.beginPath(),i.arc(f,g,p*.5,0,2*Math.PI),i.fillStyle=`rgba(255,220,120,${.7*(1-y/.6)})`,i.shadowColor="#fffbe6",i.shadowBlur=16,i.fill(),i.restore()}if(y>.2){const p=(y-.2)/.8;for(let m=0;m<4;m++){const w=Math.PI*2*(m/4)+Math.random()*.2,b=38+60*y+Math.random()*10,x=f+Math.cos(w)*b*.7*p,A=g+Math.sin(w)*b*.5*p+10*p;i.save(),i.beginPath(),i.arc(x,A,18+18*p,0,2*Math.PI),i.fillStyle=`rgba(80,60,40,${.18*(1-p)})`,i.shadowColor="#222",i.shadowBlur=8,i.fill(),i.restore()}}}}function u(f){i.clearRect(0,0,s.width,s.height);let g=!0;for(const y of a){y.startTime||(y.startTime=f);const p=f-y.startTime;if(y.exploded){if(y.explosionTime&&f-y.explosionTime<700){const m=(f-y.explosionTime)/700;h(y.endX,y.endY,m),g=!1}}else{g=!1;const m=Math.min(p/y.duration,1),w=y.startX+(y.endX-y.startX)*m,b=(1-m)*y.startY+m*y.endY-y.arcHeight*4*m*(1-m),x=.9+.3*(1-Math.abs(2*m-1));d(w,b,x),m>=1&&(y.exploded=!0,y.explosionTime=f)}}g||requestAnimationFrame(u)}requestAnimationFrame(u),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(0) skew(0)",o.style.opacity="1",o.style.transform="translateX(0) skew(0)"},400),setTimeout(()=>{},3200);const C=document.createElement("link");C.rel="stylesheet",C.href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=UnifrakturCook:wght@700&display=swap",document.head.appendChild(C)}const V=document.getElementById("app");if(V)V.innerHTML="",new j().mount(V),setTimeout(()=>{const e=V.querySelector('div[style*="flex: 3"]');e&&We(e)},0);else throw new Error("No app element found in index.html");export{re as C,K as R,se as W};
